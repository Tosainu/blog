<!DOCTYPE HTML><html lang="ja"><head><meta charset="utf-8"><meta content="Tosainu" name="author"><meta content="Zynq はソフトウェアだけにフォーカスしても構成するものが多く、動かすまでがとにかく大変です。Zynq UltraScale+ MPSoC をターゲットにして、APU で Linux を動かしつつ、RPU ではベアメタルアプリケーションを動かして相互に通信…とかやっていくのは実際気の遠くなる作業で" name="description"><meta content="Hakyll" name="generator"><meta content="width=device-width, initial-scale=1" name="viewport"><meta property="twitter:card" content="summary"><meta property="twitter:site" content="myon___"><meta property="twitter:creator" content="myon___"><meta property="og:type" content="article"><meta property="og:url" content="https://blog.myon.info/entry/2022/09/19/earthly-zynqmp/index.html"><meta property="og:title" content="とにかく複雑な Zynq のソフトウェアを Earthly でビルドする | Tosainu Lab"><meta property="og:description" content="Zynq はソフトウェアだけにフォーカスしても構成するものが多く、動かすまでがとにかく大変です。Zynq UltraScale+ MPSoC をターゲットにして、APU で Linux を動かしつつ、RPU ではベアメタルアプリケーションを動かして相互に通信…とかやっていくのは実際気の遠くなる作業で"><meta property="og:site_name" content="Tosainu Lab"><meta property="og:image" content="https://blog.myon.info/images/icon/cocoa-512.jpg"><title>とにかく複雑な Zynq のソフトウェアを Earthly でビルドする | Tosainu Lab</title><link href="/vendor/normalize.css/normalize.css" rel="stylesheet"><link href="/stylesheets/style.css" rel="stylesheet"><link href="/stylesheets/highlight.css" rel="stylesheet"><link href="/vendor/fontawesome/style.css" rel="stylesheet"><link href="/vendor/katex/katex.min.css" rel="stylesheet"><link href="/feed.xml" title="Atom Feed" type="application/atom+xml" rel="alternate"><script async src="https://www.googletagmanager.com/gtag/js?id=G-X1CGBSMEQW"></script><script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments);}gtag('js',new Date());gtag('config','G-X1CGBSMEQW');</script></head><body><header class="site-header"><div class="container"><h1><a href="/" title="home">Tosainu Lab</a></h1></div></header><main class="post"><article><header class="post-header"><div class="container"><h1><a href="/entry/2022/09/19/earthly-zynqmp/">とにかく複雑な Zynq のソフトウェアを Earthly でビルドする</a></h1><ul class="post-meta"><li><svg class="svg-inline--fa fa-calendar" focusable="false" aria-hidden="true" role="img" viewBox="0 0 448 512" data-icon="calendar" data-prefix="fas" xmlns="http://www.w3.org/2000/svg"><path d="M96 32V64H48C21.5 64 0 85.5 0 112v48H448V112c0-26.5-21.5-48-48-48H352V32c0-17.7-14.3-32-32-32s-32 14.3-32 32V64H160V32c0-17.7-14.3-32-32-32S96 14.3 96 32zM448 192H0V464c0 26.5 21.5 48 48 48H400c26.5 0 48-21.5 48-48V192z" fill="currentColor"></path></svg></li><li class="date">2022/09/19 21:32</li><li><svg class="svg-inline--fa fa-tags" focusable="false" aria-hidden="true" role="img" viewBox="0 0 512 512" data-icon="tags" data-prefix="fas" xmlns="http://www.w3.org/2000/svg"><path d="M345 39.1L472.8 168.4c52.4 53 52.4 138.2 0 191.2L360.8 472.9c-9.3 9.4-24.5 9.5-33.9 .2s-9.5-24.5-.2-33.9L438.6 325.9c33.9-34.3 33.9-89.4 0-123.7L310.9 72.9c-9.3-9.4-9.2-24.6 .2-33.9s24.6-9.2 33.9 .2zM0 229.5V80C0 53.5 21.5 32 48 32H197.5c17 0 33.3 6.7 45.3 18.7l168 168c25 25 25 65.5 0 90.5L277.3 442.7c-25 25-65.5 25-90.5 0l-168-168C6.7 262.7 0 246.5 0 229.5zM144 144c0-17.7-14.3-32-32-32s-32 14.3-32 32s14.3 32 32 32s32-14.3 32-32z" fill="currentColor"></path></svg></li><li><ul class="tag-list"><li><a href="/entry/tags/fpga/"><span>FPGA</span></a></li></ul></li></ul></div></header><div class="container"><div class="post-contents"><p>Zynq はソフトウェアだけにフォーカスしても構成するものが多く、動かすまでがとにかく大変です。Zynq UltraScale+ MPSoC をターゲットにして、APU で Linux を動かしつつ、RPU ではベアメタルアプリケーションを動かして相互に通信…とかやっていくのは実際気の遠くなる作業です。おまけに各種ツールが絶妙にアレなので、この規模にもなると edit-build-run のループを回すのに一苦労です。</p>
<p>Zynq に限らず、規模の大きくなったソフトウェアは edit-build-run あるいは build-test-release-deploy 一連のタスクが複雑になりがちです。複数のプログラミング言語やライブラリが絡むために異なるツールを呼び出さないといけなかったり、ビルドした個々のソフトウェアをパッケージするためにビルドツールを伴わないファイル操作などが絡んだり…。クリーンな状態から1度だけの実行を想定したものでよければ適当なスクリプトで解決するかもしれません。でも普段の開発での利用も想定すると、個々のビルドプロセスとその依存関係を適切に管理できたり、キャッシュなどを使って必要なところだけをいい感じにビルドし直してくれたりするもの、言葉にするなら <em>Build automation tool</em> がほしくなってきます。</p>
<p>なにかいいツールがないかなーと探し回り、あるときはいっそ自分で作ってやろうかと考えたこともありました。そんなときに見つけたのが <a href="https://earthly.dev/" target="_blank" rel="nofollow noopener">Earthly</a> です。これが自分が探していたものにかなり近く、Zynq ソフトウェアプロジェクトをはじめ様々な用途で使ってみていい感じだったので紹介しようとおもいます。</p>
<!--more-->
<h2 id="earthly">Earthly</h2>
<p><a href="https://earthly.dev/" target="_blank" rel="nofollow noopener">Earthly</a> はコンテナを活用した Build automation tool です。<code>Makefile</code> と <code>Dockerfile</code> を組み合わせたかのような <code>Earthfile</code> を見れば、これがどんなことをしてくれるものなのかすぐにイメージできるんじゃないかなと思います。実際、Earthly は buikdkit をバックエンドに使っていて、Docker の <a href="https://docs.docker.com/develop/develop-images/multistage-build/" target="_blank" rel="nofollow noopener">multi-stage build</a> にかなり近い動作をします。各ターゲットはそれぞれ独立したコンテナ環境で実行されるので、ちゃんと設定さえすればどの実行環境でもほぼ同じビルドが再現できますし、ある別のターゲットで作られたものやリポジトリ管理外のファイルを暗黙的に参照してしまうこともありません。また、ターゲット間の依存関係に問題なければ可能な限り並列で実行してくれたり、一度実行したターゲットは自身が依存するファイルや別のターゲットに変更がない限りキャッシュが効いてくれるのもポイントです。これだけの利点がありながら、Earthly の導入作業は基本的には普段の dockerize と同じ感覚なので、個々のビルド方法自体は大きく変えなくてよく、比較的敷居が低いのも強みです。</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode dockerfile"><code class="sourceCode dockerfile"><span id="cb1-1"><a href="/entry/2022/09/19/earthly-zynqmp/#cb1-1" aria-hidden="true" tabindex="-1"></a>hoge:</span>
<span id="cb1-2"><a href="/entry/2022/09/19/earthly-zynqmp/#cb1-2" aria-hidden="true" tabindex="-1"></a>    <span class="kw">FROM</span> alpine</span>
<span id="cb1-3"><a href="/entry/2022/09/19/earthly-zynqmp/#cb1-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">RUN</span> <span class="bu">echo</span> <span class="st">&quot;Hoge!&quot;</span> <span class="op">&gt;</span> awesome.txt</span>
<span id="cb1-4"><a href="/entry/2022/09/19/earthly-zynqmp/#cb1-4" aria-hidden="true" tabindex="-1"></a>    SAVE ARTIFACT awesome.txt</span>
<span id="cb1-5"><a href="/entry/2022/09/19/earthly-zynqmp/#cb1-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-6"><a href="/entry/2022/09/19/earthly-zynqmp/#cb1-6" aria-hidden="true" tabindex="-1"></a>fuga:</span>
<span id="cb1-7"><a href="/entry/2022/09/19/earthly-zynqmp/#cb1-7" aria-hidden="true" tabindex="-1"></a>    <span class="kw">FROM</span> alpine</span>
<span id="cb1-8"><a href="/entry/2022/09/19/earthly-zynqmp/#cb1-8" aria-hidden="true" tabindex="-1"></a>    <span class="kw">RUN</span> <span class="bu">echo</span> <span class="st">&quot;Fuga!&quot;</span> <span class="op">&gt;</span> awesome.txt</span>
<span id="cb1-9"><a href="/entry/2022/09/19/earthly-zynqmp/#cb1-9" aria-hidden="true" tabindex="-1"></a>    SAVE ARTIFACT awesome.txt</span>
<span id="cb1-10"><a href="/entry/2022/09/19/earthly-zynqmp/#cb1-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-11"><a href="/entry/2022/09/19/earthly-zynqmp/#cb1-11" aria-hidden="true" tabindex="-1"></a>myon:</span>
<span id="cb1-12"><a href="/entry/2022/09/19/earthly-zynqmp/#cb1-12" aria-hidden="true" tabindex="-1"></a>    <span class="kw">FROM</span> alpine</span>
<span id="cb1-13"><a href="/entry/2022/09/19/earthly-zynqmp/#cb1-13" aria-hidden="true" tabindex="-1"></a>    <span class="kw">COPY</span> +hoge/awesome.txt a.txt</span>
<span id="cb1-14"><a href="/entry/2022/09/19/earthly-zynqmp/#cb1-14" aria-hidden="true" tabindex="-1"></a>    <span class="kw">COPY</span> +fuga/awesome.txt b.txt</span>
<span id="cb1-15"><a href="/entry/2022/09/19/earthly-zynqmp/#cb1-15" aria-hidden="true" tabindex="-1"></a>    <span class="kw">RUN</span> <span class="fu">cat</span> a.txt b.txt <span class="op">&gt;</span> awesome.txt</span>
<span id="cb1-16"><a href="/entry/2022/09/19/earthly-zynqmp/#cb1-16" aria-hidden="true" tabindex="-1"></a>    SAVE ARTIFACT awesome.txt</span></code></pre></div>
<p>Earthly のインストールは、<a href="https://earthly.dev/get-earthly" target="_blank" rel="nofollow noopener">公式の手順</a>の通りビルド済みのバイナリを使うのが簡単です。ただ自分なら不必要に root で作業したくないので、例えばインストール先は <code>~/.local/bin</code> にして、また <code>/usr</code> 下に書き込もうとしてくる <code>earthly bootstrap --with-autocomplete</code> は実行しないと思います<a href="/entry/2022/09/19/earthly-zynqmp/#fn1" class="footnote-ref" id="fnref1" role="doc-noteref"><sup>1</sup></a>。</p>
<pre><code>$ curl -L https://github.com/earthly/earthly/releases/latest/download/earthly-linux-amd64 \
    -o ~/.local/bin/earthly
$ chmod +x $_</code></pre>
<p>インストールが済んだら早速 Earthly を動かしてみます。適当な場所に空のディレクトリを作り、そこに先ほどあげた <code>Earthfile</code> の例を保存してください。<code>Earthfile</code> に定義されたあるターゲットを実行するには <code>earthly +&lt;ターゲット名&gt;</code> を実行します。例えば <code>hoge</code> と <code>fuga</code> を実行するならそれぞれこうなります。</p>
<pre><code>$ earthly +hoge
$ earthly +fuga</code></pre>
<p>ターゲット <code>myon</code> は <code>hoge</code> と <code>fuga</code> で作ったファイルに依存しています。あるターゲットで作ったものを後段のタスクや Earthly 実行ホストに渡すには、そのファイルを <a href="https://docs.earthly.dev/docs/earthfile#save-artifact" target="_blank" rel="nofollow noopener"><code>SAVE ARTIFACT</code></a> コマンドで指定します。そして、別のターゲットからそれを参照するには <a href="https://docs.earthly.dev/docs/earthfile#copy" target="_blank" rel="nofollow noopener"><code>COPY</code></a> コマンドを使います。</p>
<p>実際に <code>myon</code> を動かしてみると、<code>myon</code> が依存するターゲットである <code>hoge</code> と <code>fuga</code> が実行されようとしたこと、またそれらターゲットは先程ビルドしたばかりなのでキャッシュが参照されたことがわかります。</p>
<pre><code> 2. Build 🔧
————————————————————————————————————————————————————————————————————————————————

      alpine | --&gt; Load metadata linux/amd64
       +fuga | --&gt; FROM alpine
       +fuga | [██████████] 100% resolve docker.io/library/alpine@sha256:bc41182d7ef5ffc53a40b044e725193bc10142a1243f395ee852a8d9730fc2ad
       +fuga | *cached* --&gt; RUN echo &quot;Fuga!&quot; &gt; awesome.txt
       +hoge | *cached* --&gt; RUN echo &quot;Hoge!&quot; &gt; awesome.txt
       +hoge | --&gt; SAVE ARTIFACT awesome.txt +hoge/awesome.txt
       +fuga | --&gt; SAVE ARTIFACT awesome.txt +fuga/awesome.txt
       +myon | --&gt; COPY +hoge/awesome.txt a.txt
       +myon | --&gt; COPY +fuga/awesome.txt b.txt
       +myon | --&gt; RUN cat a.txt b.txt &gt; awesome.txt
      output | --&gt; exporting outputs</code></pre>
<p>Earthly で作られたものを実行ホスト側に持ってくるには <code>earthly --artifact</code> コマンドを使います。<code>myon</code> で作ったファイル <code>awesome.txt</code> をカレントディレクトリ直下の <code>build/</code> にコピーするならこうなります。コピー先として渡すパスは末尾を必ず <code>/</code> にします。また先程カレントディレクトリと書きましたが、Earthly は相対パス受け取ったとき、それが <code>Earthfile</code> のあるディレクトリを基準としたものと解釈するのにも注意です。ターゲットからコピーするファイルの指定には <code>*</code> が使えます。たぶん Go 製アプリにありがちな <a href="https://pkg.go.dev/path/filepath#Match" target="_blank" rel="nofollow noopener"><code>filepath.Match</code></a> を使うやつです。シェルの設定次第では <code>*</code> を glob として展開しちゃう場合があるのでエスケープしておくと安心です。</p>
<pre><code>$ earthly --artifact +myon/awesome.txt ./build/

$ earthly --artifact +myon/\* ./build/</code></pre>
<p>Earthly の主要操作はだいたいこんな感じです。基本的には <code>Dockerfile</code> と同じなので、Docker を使ったことさえあればあまり難しいことはないと思います。</p>
<h2 id="実際に-zynq-をターゲットにした何かを作ってみる">実際に Zynq をターゲットにした何かを作ってみる</h2>
<h3 id="l-チカ">L チカ…？</h3>
<p>それでは本題、Earthly をどうやって Zynq UltraScale+ のソフトウェアプロジェクトに適用したかです。この紹介にあたって、こんなものを作ってみました。</p>
<video controls loop>
<source src="/entry/2022/09/19/earthly-zynqmp/led.mp4" type="video/mp4">
</video>
<p>一言でいえば、特に理由もなく面倒なことをしている L チカの亜種です。RPU で動く LED 制御のベアメタルアプリケーションと APU 上の Ubuntu で動くアプリケーションが IPI (Inter-Processor Interrupt) を飛ばし合います。APU から RPU への IPI で LED 点滅開始、その後 APU が RPU から飛んでくる IPI に応答し続けないと LED は消えてしまうというものです。題材を複雑にしすぎても準備が大変なだけだし、かといって簡単にしすぎてもおもしろくないし…と悩んだ末のものになります。ソースコードはすべて GitHub リポジトリ <a href="https://github.com/Tosainu/earthly-zynqmp-example" target="_blank" rel="nofollow noopener">Tosainu/earthly-zynqmp-example</a> にあり、この記事は <a href="https://github.com/Tosainu/earthly-zynqmp-example/tree/322ce449da698ac1db1641cf12240bbfaa36d6eb" target="_blank" rel="nofollow noopener"><code>322ce449</code></a> をベースに書いています。</p>
<p>ちなみに、FPGA としての機能をほぼ使っていないのでブロックデザインは実質 PS だけです。Ultra96 ちゃん、XCZU3EG-1SBVA484E ちゃんごめんね…</p>
<h3 id="コンテナ内に必要なツールをそろえる">コンテナ内に必要なツールをそろえる</h3>
<p>最初に書く <code>Earthfile</code> のターゲットが、ビルドなど全体のタスク実行に必要なツール類をインストールしてベースイメージのように使うものです。ほかのターゲットから <code>FROM +prep</code> みたいにして使います。</p>
<p>必要になるのは RPU と APU で動かすアプリケーションをビルドするクロスコンパイラ、ディスクイメージ作成のためにファイルシステムやパーティションテーブル操作系のツール、そして <code>.xsa</code> から BSP や FSBL, PMUFW などを生成するための Xilinx のツール類です。クロスコンパイラの大半と Xilinx のツール類は、PetaLinux Tools などで使われているらしい <a href="https://github.com/Xilinx/meta-xilinx-tools/blob/e2ff6325931b008565f558cb35ac38dfb01116c9/classes/xsct-tarball.bbclass#L7" target="_blank" rel="nofollow noopener">xsct-trim</a> から拝借しました。xsct-trim には AArch64 Linux 向けクロスコンパイラは入っていないので、かわりに Ubuntu の <code>crossbuild-essential-arm64</code> パッケージを使うことにしました。</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode dockerfile"><code class="sourceCode dockerfile"><span id="cb6-1"><a href="/entry/2022/09/19/earthly-zynqmp/#cb6-1" aria-hidden="true" tabindex="-1"></a>prep:</span>
<span id="cb6-2"><a href="/entry/2022/09/19/earthly-zynqmp/#cb6-2" aria-hidden="true" tabindex="-1"></a>    <span class="kw">FROM</span> ubuntu:jammy@sha256:20fa2d7bb4de7723f542be5923b06c4d704370f0390e4ae9e1c833c8785644c1</span>
<span id="cb6-3"><a href="/entry/2022/09/19/earthly-zynqmp/#cb6-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">RUN</span> <span class="op">\</span></span>
<span id="cb6-4"><a href="/entry/2022/09/19/earthly-zynqmp/#cb6-4" aria-hidden="true" tabindex="-1"></a>        <span class="ex">apt-get</span> update <span class="kw">&amp;&amp;</span> <span class="dt">\</span></span>
<span id="cb6-5"><a href="/entry/2022/09/19/earthly-zynqmp/#cb6-5" aria-hidden="true" tabindex="-1"></a>        <span class="va">DEBIAN_FRONTEND</span><span class="op">=</span>noninteractive <span class="ex">apt-get</span> install <span class="at">-y</span> <span class="at">--no-install-recommends</span> <span class="dt">\</span></span>
<span id="cb6-6"><a href="/entry/2022/09/19/earthly-zynqmp/#cb6-6" aria-hidden="true" tabindex="-1"></a>            autoconf automake bc bison build-essential ca-certificates cmake cpio <span class="dt">\</span></span>
<span id="cb6-7"><a href="/entry/2022/09/19/earthly-zynqmp/#cb6-7" aria-hidden="true" tabindex="-1"></a>            crossbuild-essential-arm64 curl dbus-x11 dosfstools e2fsprogs fdisk flex gzip <span class="dt">\</span></span>
<span id="cb6-8"><a href="/entry/2022/09/19/earthly-zynqmp/#cb6-8" aria-hidden="true" tabindex="-1"></a>            kmod libncurses-dev libssl-dev libtinfo5 libtool-bin locales rsync xz-utils zstd <span class="kw">&amp;&amp;</span> <span class="dt">\</span></span>
<span id="cb6-9"><a href="/entry/2022/09/19/earthly-zynqmp/#cb6-9" aria-hidden="true" tabindex="-1"></a>        <span class="fu">rm</span> <span class="at">-rf</span> /var/lib/apt/lists/<span class="pp">*</span> <span class="kw">&amp;&amp;</span> <span class="dt">\</span></span>
<span id="cb6-10"><a href="/entry/2022/09/19/earthly-zynqmp/#cb6-10" aria-hidden="true" tabindex="-1"></a>        <span class="fu">sed</span> <span class="at">-i</span> <span class="st">&#39;s/^#\s*\(en_US.UTF-8\)/\1/&#39;</span> /etc/locale.gen <span class="kw">&amp;&amp;</span> <span class="dt">\</span></span>
<span id="cb6-11"><a href="/entry/2022/09/19/earthly-zynqmp/#cb6-11" aria-hidden="true" tabindex="-1"></a>        <span class="ex">dpkg-reconfigure</span> <span class="at">--frontend</span> noninteractive locales</span>
<span id="cb6-12"><a href="/entry/2022/09/19/earthly-zynqmp/#cb6-12" aria-hidden="true" tabindex="-1"></a>    <span class="kw">ARG</span> XSCT_URL=https://petalinux.xilinx.com/sswreleases/rel-v2022/xsct-trim/xsct-2022-1.tar.xz</span>
<span id="cb6-13"><a href="/entry/2022/09/19/earthly-zynqmp/#cb6-13" aria-hidden="true" tabindex="-1"></a>    <span class="kw">ARG</span> XSCT_SHA256SUM=e343a8b386398e292f636f314a057076e551a8173723b8ea0bc1bbd879c05259</span>
<span id="cb6-14"><a href="/entry/2022/09/19/earthly-zynqmp/#cb6-14" aria-hidden="true" tabindex="-1"></a>    <span class="kw">RUN</span> <span class="op">--mount=type=tmpfs,target=/tmp</span> <span class="op">\</span></span>
<span id="cb6-15"><a href="/entry/2022/09/19/earthly-zynqmp/#cb6-15" aria-hidden="true" tabindex="-1"></a>        <span class="ex">curl</span> <span class="at">--no-progress-meter</span> <span class="at">-L</span> <span class="st">&quot;</span><span class="va">${XSCT_URL}</span><span class="st">&quot;</span> <span class="at">-o</span> /tmp/xsct.tar.xz <span class="kw">&amp;&amp;</span> <span class="dt">\</span></span>
<span id="cb6-16"><a href="/entry/2022/09/19/earthly-zynqmp/#cb6-16" aria-hidden="true" tabindex="-1"></a>        <span class="bu">echo</span> <span class="st">&quot;</span><span class="va">${XSCT_SHA256SUM}</span><span class="st"> /tmp/xsct.tar.xz&quot;</span> <span class="kw">|</span> <span class="fu">sha256sum</span> <span class="at">-c</span> <span class="at">-</span> <span class="kw">&amp;&amp;</span> <span class="dt">\</span></span>
<span id="cb6-17"><a href="/entry/2022/09/19/earthly-zynqmp/#cb6-17" aria-hidden="true" tabindex="-1"></a>        <span class="fu">mkdir</span> <span class="at">-p</span> /opt/xsct <span class="kw">&amp;&amp;</span> <span class="dt">\</span></span>
<span id="cb6-18"><a href="/entry/2022/09/19/earthly-zynqmp/#cb6-18" aria-hidden="true" tabindex="-1"></a>        <span class="fu">tar</span> xf /tmp/xsct.tar.xz <span class="at">-C</span> /opt/xsct <span class="at">--strip-components</span><span class="op">=</span>2</span>
<span id="cb6-19"><a href="/entry/2022/09/19/earthly-zynqmp/#cb6-19" aria-hidden="true" tabindex="-1"></a>    <span class="kw">ENV</span> PATH=<span class="st">&quot;/opt/xsct/bin:/opt/xsct/gnu/aarch64/lin/aarch64-none/bin:/opt/xsct/gnu/armr5/lin/gcc-arm-none-eabi/bin:/opt/xsct/gnu/microblaze/lin/bin:${PATH}&quot;</span></span>
<span id="cb6-20"><a href="/entry/2022/09/19/earthly-zynqmp/#cb6-20" aria-hidden="true" tabindex="-1"></a>    <span class="kw">WORKDIR</span> /build</span></code></pre></div>
<p>今回は <code>Earthfile</code> の中にこうしたターゲットを書いていますが、よりビルドの再現性を重視したいのであれば別のアプローチを取るべきです。<code>apt-get</code> などのコマンドは、パッケージの更新などのために実行するタイミングで結果が大きく変わりうるためです。対策の一例としては、この部分だけ独立したコンテナイメージ化し、レジストリで管理するなどがあると思います。</p>
<h3 id="xsct-trim-で-fsbl-pmufw-bsp-devicetree-を出力させる">xsct-trim で FSBL, PMUFW, BSP, Devicetree を出力させる</h3>
<p>次は FSBL、PMUFW、RPU ベアメタルアプリケーションの BSP、そして Devicetree のテンプレートなど、Vitis でいう platform に相当するものたちを xsct-trim に入っている <a href="https://docs.xilinx.com/r/en-US/ug1400-vitis-embedded/XSCT-Commands" target="_blank" rel="nofollow noopener">XSCT</a> に出力させます。</p>
<p>いつもの XSCT コマンドを並べた TCL スクリプトを作っておきます。コマンドラインから <code>.xsa</code> ファイルのパスを受け取ったり、<code>Earthfile</code> 側から <code>.bit</code> ファイルを常に同じファイル名で扱えるように symlink を張るようにもしておきます。</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode tcl"><code class="sourceCode tcl"><span id="cb7-1"><a href="/entry/2022/09/19/earthly-zynqmp/#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="kw">set</span> xsa_file <span class="kw">[lindex</span> <span class="dt">$argv</span> <span class="dv">0</span><span class="kw">]</span></span>
<span id="cb7-2"><a href="/entry/2022/09/19/earthly-zynqmp/#cb7-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-3"><a href="/entry/2022/09/19/earthly-zynqmp/#cb7-3" aria-hidden="true" tabindex="-1"></a>hsi open_hw_design <span class="dt">$xsa_file</span></span>
<span id="cb7-4"><a href="/entry/2022/09/19/earthly-zynqmp/#cb7-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-5"><a href="/entry/2022/09/19/earthly-zynqmp/#cb7-5" aria-hidden="true" tabindex="-1"></a><span class="kw">set</span> bit_file <span class="kw">[lindex</span> <span class="kw">[</span>hsi get_hw_files<span class="ot"> -filter</span> <span class="kw">{</span>TYPE==bit<span class="kw">}]</span> <span class="dv">0</span><span class="kw">]</span></span>
<span id="cb7-6"><a href="/entry/2022/09/19/earthly-zynqmp/#cb7-6" aria-hidden="true" tabindex="-1"></a><span class="kw">file</span> <span class="ot">link -symbolic</span> <span class="ot">system</span>.bit <span class="dt">$bit_file</span></span>
<span id="cb7-7"><a href="/entry/2022/09/19/earthly-zynqmp/#cb7-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-8"><a href="/entry/2022/09/19/earthly-zynqmp/#cb7-8" aria-hidden="true" tabindex="-1"></a>hsi set_repo_path embeddedsw</span>
<span id="cb7-9"><a href="/entry/2022/09/19/earthly-zynqmp/#cb7-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-10"><a href="/entry/2022/09/19/earthly-zynqmp/#cb7-10" aria-hidden="true" tabindex="-1"></a>hsi create_sw_design fsbl<span class="ot"> -proc</span> psu_cortexa53_0<span class="ot"> -os</span> standalone</span>
<span id="cb7-11"><a href="/entry/2022/09/19/earthly-zynqmp/#cb7-11" aria-hidden="true" tabindex="-1"></a>hsi set_property CONFIG.stdin  psu_uart_1 <span class="kw">[</span>hsi get_os<span class="kw">]</span></span>
<span id="cb7-12"><a href="/entry/2022/09/19/earthly-zynqmp/#cb7-12" aria-hidden="true" tabindex="-1"></a>hsi set_property CONFIG.stdout psu_uart_1 <span class="kw">[</span>hsi get_os<span class="kw">]</span></span>
<span id="cb7-13"><a href="/entry/2022/09/19/earthly-zynqmp/#cb7-13" aria-hidden="true" tabindex="-1"></a>hsi add_library xilffs</span>
<span id="cb7-14"><a href="/entry/2022/09/19/earthly-zynqmp/#cb7-14" aria-hidden="true" tabindex="-1"></a>hsi add_library xilpm</span>
<span id="cb7-15"><a href="/entry/2022/09/19/earthly-zynqmp/#cb7-15" aria-hidden="true" tabindex="-1"></a>hsi add_library xilsecure</span>
<span id="cb7-16"><a href="/entry/2022/09/19/earthly-zynqmp/#cb7-16" aria-hidden="true" tabindex="-1"></a>hsi generate_app<span class="ot"> -app</span> zynqmp_fsbl<span class="ot"> -dir</span> fsbl</span>
<span id="cb7-17"><a href="/entry/2022/09/19/earthly-zynqmp/#cb7-17" aria-hidden="true" tabindex="-1"></a>hsi close_sw_design <span class="kw">[</span>hsi current_sw_design<span class="kw">]</span></span>
<span id="cb7-18"><a href="/entry/2022/09/19/earthly-zynqmp/#cb7-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-19"><a href="/entry/2022/09/19/earthly-zynqmp/#cb7-19" aria-hidden="true" tabindex="-1"></a>hsi create_sw_design pmufw<span class="ot"> -proc</span> psu_pmu_0<span class="ot"> -os</span> standalone</span>
<span id="cb7-20"><a href="/entry/2022/09/19/earthly-zynqmp/#cb7-20" aria-hidden="true" tabindex="-1"></a>hsi set_property CONFIG.stdin  psu_uart_1 <span class="kw">[</span>hsi get_os<span class="kw">]</span></span>
<span id="cb7-21"><a href="/entry/2022/09/19/earthly-zynqmp/#cb7-21" aria-hidden="true" tabindex="-1"></a>hsi set_property CONFIG.stdout psu_uart_1 <span class="kw">[</span>hsi get_os<span class="kw">]</span></span>
<span id="cb7-22"><a href="/entry/2022/09/19/earthly-zynqmp/#cb7-22" aria-hidden="true" tabindex="-1"></a>hsi add_library xilfpga</span>
<span id="cb7-23"><a href="/entry/2022/09/19/earthly-zynqmp/#cb7-23" aria-hidden="true" tabindex="-1"></a>hsi add_library xilsecure</span>
<span id="cb7-24"><a href="/entry/2022/09/19/earthly-zynqmp/#cb7-24" aria-hidden="true" tabindex="-1"></a>hsi add_library xilskey</span>
<span id="cb7-25"><a href="/entry/2022/09/19/earthly-zynqmp/#cb7-25" aria-hidden="true" tabindex="-1"></a>hsi generate_app<span class="ot"> -app</span> zynqmp_pmufw<span class="ot"> -dir</span> pmufw</span>
<span id="cb7-26"><a href="/entry/2022/09/19/earthly-zynqmp/#cb7-26" aria-hidden="true" tabindex="-1"></a>hsi close_sw_design <span class="kw">[</span>hsi current_sw_design<span class="kw">]</span></span>
<span id="cb7-27"><a href="/entry/2022/09/19/earthly-zynqmp/#cb7-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-28"><a href="/entry/2022/09/19/earthly-zynqmp/#cb7-28" aria-hidden="true" tabindex="-1"></a>hsi create_sw_design bsp_psu_cortexr5_0<span class="ot"> -proc</span> psu_cortexr5_0<span class="ot"> -os</span> standalone</span>
<span id="cb7-29"><a href="/entry/2022/09/19/earthly-zynqmp/#cb7-29" aria-hidden="true" tabindex="-1"></a>hsi set_property CONFIG.stdin  psu_uart_1 <span class="kw">[</span>hsi get_os<span class="kw">]</span></span>
<span id="cb7-30"><a href="/entry/2022/09/19/earthly-zynqmp/#cb7-30" aria-hidden="true" tabindex="-1"></a>hsi set_property CONFIG.stdout psu_uart_1 <span class="kw">[</span>hsi get_os<span class="kw">]</span></span>
<span id="cb7-31"><a href="/entry/2022/09/19/earthly-zynqmp/#cb7-31" aria-hidden="true" tabindex="-1"></a><span class="co"># hsi add_library xilffs</span></span>
<span id="cb7-32"><a href="/entry/2022/09/19/earthly-zynqmp/#cb7-32" aria-hidden="true" tabindex="-1"></a><span class="co"># hsi add_library xilfpga</span></span>
<span id="cb7-33"><a href="/entry/2022/09/19/earthly-zynqmp/#cb7-33" aria-hidden="true" tabindex="-1"></a><span class="co"># hsi add_library xilmailbox</span></span>
<span id="cb7-34"><a href="/entry/2022/09/19/earthly-zynqmp/#cb7-34" aria-hidden="true" tabindex="-1"></a><span class="co"># hsi add_library xilpm</span></span>
<span id="cb7-35"><a href="/entry/2022/09/19/earthly-zynqmp/#cb7-35" aria-hidden="true" tabindex="-1"></a><span class="co"># hsi add_library xilsecure</span></span>
<span id="cb7-36"><a href="/entry/2022/09/19/earthly-zynqmp/#cb7-36" aria-hidden="true" tabindex="-1"></a><span class="co"># hsi add_library xilskey</span></span>
<span id="cb7-37"><a href="/entry/2022/09/19/earthly-zynqmp/#cb7-37" aria-hidden="true" tabindex="-1"></a>hsi generate_bsp<span class="ot"> -dir</span> bsp_psu_cortexr5_0</span>
<span id="cb7-38"><a href="/entry/2022/09/19/earthly-zynqmp/#cb7-38" aria-hidden="true" tabindex="-1"></a>hsi close_sw_design <span class="kw">[</span>hsi current_sw_design<span class="kw">]</span></span>
<span id="cb7-39"><a href="/entry/2022/09/19/earthly-zynqmp/#cb7-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-40"><a href="/entry/2022/09/19/earthly-zynqmp/#cb7-40" aria-hidden="true" tabindex="-1"></a>hsi set_repo_path device-tree-xlnx</span>
<span id="cb7-41"><a href="/entry/2022/09/19/earthly-zynqmp/#cb7-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-42"><a href="/entry/2022/09/19/earthly-zynqmp/#cb7-42" aria-hidden="true" tabindex="-1"></a>hsi create_sw_design device-tree<span class="ot"> -proc</span> psu_cortexa53_0<span class="ot"> -os</span> device_tree</span>
<span id="cb7-43"><a href="/entry/2022/09/19/earthly-zynqmp/#cb7-43" aria-hidden="true" tabindex="-1"></a>hsi set_property CONFIG.console_device psu_uart_1 <span class="kw">[</span>hsi get_os<span class="kw">]</span></span>
<span id="cb7-44"><a href="/entry/2022/09/19/earthly-zynqmp/#cb7-44" aria-hidden="true" tabindex="-1"></a>hsi generate_target<span class="ot"> -dir</span> device-tree</span></code></pre></div>
<p>あとはこれを <code>xsct</code> に実行させれば OK です。ビルド時に可変なパラメータを宣言する <a href="https://docs.earthly.dev/docs/earthfile#arg" target="_blank" rel="nofollow noopener"><code>ARG</code></a> で <code>.xsa</code> ファイルへのパスを渡せるようにしておきます。生成したファイルは全部 <code>SAVE ARTIFACT</code> して別のターゲットから取り出せるようにしておきます。FSBL, PMUFW, BSP のビルドはそれぞれ独立したターゲットにして、ターゲット単位のビルド並列化が効くようにします<a href="/entry/2022/09/19/earthly-zynqmp/#fn2" class="footnote-ref" id="fnref2" role="doc-noteref"><sup>2</sup></a>。</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode dockerfile"><code class="sourceCode dockerfile"><span id="cb8-1"><a href="/entry/2022/09/19/earthly-zynqmp/#cb8-1" aria-hidden="true" tabindex="-1"></a>generate-src:</span>
<span id="cb8-2"><a href="/entry/2022/09/19/earthly-zynqmp/#cb8-2" aria-hidden="true" tabindex="-1"></a>    <span class="kw">ARG</span> --required XSA_FILE</span>
<span id="cb8-3"><a href="/entry/2022/09/19/earthly-zynqmp/#cb8-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-4"><a href="/entry/2022/09/19/earthly-zynqmp/#cb8-4" aria-hidden="true" tabindex="-1"></a>    <span class="kw">FROM</span> +xsct</span>
<span id="cb8-5"><a href="/entry/2022/09/19/earthly-zynqmp/#cb8-5" aria-hidden="true" tabindex="-1"></a>    <span class="kw">COPY</span> generate.tcl .</span>
<span id="cb8-6"><a href="/entry/2022/09/19/earthly-zynqmp/#cb8-6" aria-hidden="true" tabindex="-1"></a>    <span class="kw">COPY</span> $XSA_FILE system.xsa</span>
<span id="cb8-7"><a href="/entry/2022/09/19/earthly-zynqmp/#cb8-7" aria-hidden="true" tabindex="-1"></a>    <span class="kw">RUN</span> <span class="va">USER</span><span class="op">=</span><span class="st">&quot;</span><span class="va">$(</span><span class="fu">id</span> <span class="at">-u</span> <span class="at">-n</span><span class="va">)</span><span class="st">&quot;</span> <span class="ex">xsct</span> <span class="at">-sdx</span> <span class="at">-nodisp</span> generate.tcl system.xsa</span>
<span id="cb8-8"><a href="/entry/2022/09/19/earthly-zynqmp/#cb8-8" aria-hidden="true" tabindex="-1"></a>    SAVE ARTIFACT bsp_psu_cortexr5_0</span>
<span id="cb8-9"><a href="/entry/2022/09/19/earthly-zynqmp/#cb8-9" aria-hidden="true" tabindex="-1"></a>    SAVE ARTIFACT device-tree</span>
<span id="cb8-10"><a href="/entry/2022/09/19/earthly-zynqmp/#cb8-10" aria-hidden="true" tabindex="-1"></a>    SAVE ARTIFACT fsbl</span>
<span id="cb8-11"><a href="/entry/2022/09/19/earthly-zynqmp/#cb8-11" aria-hidden="true" tabindex="-1"></a>    SAVE ARTIFACT pmufw</span>
<span id="cb8-12"><a href="/entry/2022/09/19/earthly-zynqmp/#cb8-12" aria-hidden="true" tabindex="-1"></a>    SAVE ARTIFACT system.bit</span>
<span id="cb8-13"><a href="/entry/2022/09/19/earthly-zynqmp/#cb8-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-14"><a href="/entry/2022/09/19/earthly-zynqmp/#cb8-14" aria-hidden="true" tabindex="-1"></a>fsbl.elf:</span>
<span id="cb8-15"><a href="/entry/2022/09/19/earthly-zynqmp/#cb8-15" aria-hidden="true" tabindex="-1"></a>    <span class="kw">FROM</span> +prep</span>
<span id="cb8-16"><a href="/entry/2022/09/19/earthly-zynqmp/#cb8-16" aria-hidden="true" tabindex="-1"></a>    <span class="kw">COPY</span> +generate-src/fsbl .</span>
<span id="cb8-17"><a href="/entry/2022/09/19/earthly-zynqmp/#cb8-17" aria-hidden="true" tabindex="-1"></a>    <span class="kw">RUN</span> <span class="fu">make</span></span>
<span id="cb8-18"><a href="/entry/2022/09/19/earthly-zynqmp/#cb8-18" aria-hidden="true" tabindex="-1"></a>    SAVE ARTIFACT executable.elf /fsbl.elf</span>
<span id="cb8-19"><a href="/entry/2022/09/19/earthly-zynqmp/#cb8-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-20"><a href="/entry/2022/09/19/earthly-zynqmp/#cb8-20" aria-hidden="true" tabindex="-1"></a>pmufw.elf:</span>
<span id="cb8-21"><a href="/entry/2022/09/19/earthly-zynqmp/#cb8-21" aria-hidden="true" tabindex="-1"></a>    <span class="kw">FROM</span> +prep</span>
<span id="cb8-22"><a href="/entry/2022/09/19/earthly-zynqmp/#cb8-22" aria-hidden="true" tabindex="-1"></a>    <span class="kw">COPY</span> +generate-src/pmufw .</span>
<span id="cb8-23"><a href="/entry/2022/09/19/earthly-zynqmp/#cb8-23" aria-hidden="true" tabindex="-1"></a>    <span class="kw">RUN</span> <span class="fu">make</span> CFLAGS=<span class="st">&quot;-DENABLE_MOD_ULTRA96 -DULTRA96_VERSION=2 -DPMU_MIO_INPUT_PIN_VAL=1 -DBOARD_SHUTDOWN_PIN_VAL=1 -DBOARD_SHUTDOWN_PIN_STATE_VAL=1&quot;</span></span>
<span id="cb8-24"><a href="/entry/2022/09/19/earthly-zynqmp/#cb8-24" aria-hidden="true" tabindex="-1"></a>    SAVE ARTIFACT executable.elf /pmufw.elf</span>
<span id="cb8-25"><a href="/entry/2022/09/19/earthly-zynqmp/#cb8-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-26"><a href="/entry/2022/09/19/earthly-zynqmp/#cb8-26" aria-hidden="true" tabindex="-1"></a>bsp-r5-0:</span>
<span id="cb8-27"><a href="/entry/2022/09/19/earthly-zynqmp/#cb8-27" aria-hidden="true" tabindex="-1"></a>    <span class="kw">FROM</span> +prep</span>
<span id="cb8-28"><a href="/entry/2022/09/19/earthly-zynqmp/#cb8-28" aria-hidden="true" tabindex="-1"></a>    <span class="kw">COPY</span> +generate-src/bsp_psu_cortexr5_0 .</span>
<span id="cb8-29"><a href="/entry/2022/09/19/earthly-zynqmp/#cb8-29" aria-hidden="true" tabindex="-1"></a>    <span class="kw">RUN</span> <span class="fu">make</span></span>
<span id="cb8-30"><a href="/entry/2022/09/19/earthly-zynqmp/#cb8-30" aria-hidden="true" tabindex="-1"></a>    SAVE ARTIFACT psu_cortexr5_0/include /include</span>
<span id="cb8-31"><a href="/entry/2022/09/19/earthly-zynqmp/#cb8-31" aria-hidden="true" tabindex="-1"></a>    SAVE ARTIFACT psu_cortexr5_0/lib/*a /lib/</span></code></pre></div>
<h3 id="rpu-と-apu-のアプリケーション">RPU と APU のアプリケーション</h3>
<p>RPU アプリケーションは、素直に Vitis を使ってテンプレートプロジェクトを作りました。xsct-trim と <a href="https://github.com/Xilinx/embeddedsw" target="_blank" rel="nofollow noopener">Xilinx/embeddedsw</a> の組み合わせでは standalone のテンプレートが出てこなかったためです。でもアプリケーションのビルドは Vitis ではなく自分たちでやりたいので、<a href="https://github.com/Tosainu/earthly-zynqmp-example/blob/27538797d4663eb2637bf9e8570dc23e7465f126/apps/r5_0/lscript.ld" target="_blank" rel="nofollow noopener"><code>lscript.ld</code></a> など必要なものだけを持ってくるのと、コンパイラに渡しているオプションの確認が済んだら Vitis の出番は終了です。</p>
<p>コードは CMake でビルドできるようにしました。<a href="https://github.com/Tosainu/earthly-zynqmp-example/blob/27538797d4663eb2637bf9e8570dc23e7465f126/apps/r5_0/cmake/Modules/FindLibXil.cmake" target="_blank" rel="nofollow noopener"><code>FindLibXil.cmake</code></a> を書いたので、<code>libxil.a</code> などを <code>find_package()</code> で探せるようになっています。BSP をビルドしたターゲット <code>bsp-r5-0</code> からライブラリとヘッダファイルをコピーしてきて、それを <code>FindLibXil.cmake</code> が探せるように <code>-DLibXil_ROOT=</code> でパスを渡します。またクロスコンパイラを使ってビルドするために、CMake に toolchain file を渡して指示します。CMake は <code>-S</code>, <code>-B</code>, <code>-DLibXil_ROOT</code> などがカレントディレクトリからの相対パスを受け付けてくれるのに対して、<code>--toolchain</code> は絶対パス、またはビルドディレクトリ・ソースディレクトリからの相対パスを要求してくるのに注意です。</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode dockerfile"><code class="sourceCode dockerfile"><span id="cb9-1"><a href="/entry/2022/09/19/earthly-zynqmp/#cb9-1" aria-hidden="true" tabindex="-1"></a>app-r5-0:</span>
<span id="cb9-2"><a href="/entry/2022/09/19/earthly-zynqmp/#cb9-2" aria-hidden="true" tabindex="-1"></a>    <span class="kw">FROM</span> +prep</span>
<span id="cb9-3"><a href="/entry/2022/09/19/earthly-zynqmp/#cb9-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">COPY</span> +bsp-r5-0/ libxil</span>
<span id="cb9-4"><a href="/entry/2022/09/19/earthly-zynqmp/#cb9-4" aria-hidden="true" tabindex="-1"></a>    <span class="kw">COPY</span> apps/r5_0 src</span>
<span id="cb9-5"><a href="/entry/2022/09/19/earthly-zynqmp/#cb9-5" aria-hidden="true" tabindex="-1"></a>    <span class="kw">COPY</span> apps/toolchain/armr5-none-eabi.cmake .</span>
<span id="cb9-6"><a href="/entry/2022/09/19/earthly-zynqmp/#cb9-6" aria-hidden="true" tabindex="-1"></a>    <span class="kw">RUN</span> <span class="fu">cmake</span> <span class="dt">\</span></span>
<span id="cb9-7"><a href="/entry/2022/09/19/earthly-zynqmp/#cb9-7" aria-hidden="true" tabindex="-1"></a>        <span class="at">--toolchain</span> <span class="va">$PWD</span>/armr5-none-eabi.cmake <span class="dt">\</span></span>
<span id="cb9-8"><a href="/entry/2022/09/19/earthly-zynqmp/#cb9-8" aria-hidden="true" tabindex="-1"></a>        <span class="at">-S</span> src <span class="dt">\</span></span>
<span id="cb9-9"><a href="/entry/2022/09/19/earthly-zynqmp/#cb9-9" aria-hidden="true" tabindex="-1"></a>        <span class="at">-B</span> build <span class="dt">\</span></span>
<span id="cb9-10"><a href="/entry/2022/09/19/earthly-zynqmp/#cb9-10" aria-hidden="true" tabindex="-1"></a>        <span class="at">-DCMAKE_BUILD_TYPE</span><span class="op">=</span>Release <span class="dt">\</span></span>
<span id="cb9-11"><a href="/entry/2022/09/19/earthly-zynqmp/#cb9-11" aria-hidden="true" tabindex="-1"></a>        <span class="at">-DCMAKE_INSTALL_PREFIX</span><span class="op">=</span>install <span class="dt">\</span></span>
<span id="cb9-12"><a href="/entry/2022/09/19/earthly-zynqmp/#cb9-12" aria-hidden="true" tabindex="-1"></a>        <span class="at">-DLibXil_ROOT</span><span class="op">=</span>libxil</span>
<span id="cb9-13"><a href="/entry/2022/09/19/earthly-zynqmp/#cb9-13" aria-hidden="true" tabindex="-1"></a>    <span class="kw">RUN</span> <span class="fu">cmake</span> <span class="at">--build</span> build <span class="at">--</span> install</span>
<span id="cb9-14"><a href="/entry/2022/09/19/earthly-zynqmp/#cb9-14" aria-hidden="true" tabindex="-1"></a>    SAVE ARTIFACT install/* /</span></code></pre></div>
<p>APU のアプリケーションも C++ で書いて CMake でビルドします。RPU と違って標準ライブラリと Linux の機能しか使わないので、クロスコンパイルのために toolchain file を渡す以外は特別な設定もなくいつもどおりです。</p>
<div class="sourceCode" id="cb10"><pre class="sourceCode dockerfile"><code class="sourceCode dockerfile"><span id="cb10-1"><a href="/entry/2022/09/19/earthly-zynqmp/#cb10-1" aria-hidden="true" tabindex="-1"></a>app-a53:</span>
<span id="cb10-2"><a href="/entry/2022/09/19/earthly-zynqmp/#cb10-2" aria-hidden="true" tabindex="-1"></a>    <span class="kw">FROM</span> +prep</span>
<span id="cb10-3"><a href="/entry/2022/09/19/earthly-zynqmp/#cb10-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">COPY</span> apps/a53 src</span>
<span id="cb10-4"><a href="/entry/2022/09/19/earthly-zynqmp/#cb10-4" aria-hidden="true" tabindex="-1"></a>    <span class="kw">COPY</span> apps/toolchain/aarch64-linux-gnu.cmake .</span>
<span id="cb10-5"><a href="/entry/2022/09/19/earthly-zynqmp/#cb10-5" aria-hidden="true" tabindex="-1"></a>    <span class="kw">RUN</span> <span class="fu">cmake</span> <span class="dt">\</span></span>
<span id="cb10-6"><a href="/entry/2022/09/19/earthly-zynqmp/#cb10-6" aria-hidden="true" tabindex="-1"></a>        <span class="at">--toolchain</span> <span class="va">$PWD</span>/aarch64-linux-gnu.cmake <span class="dt">\</span></span>
<span id="cb10-7"><a href="/entry/2022/09/19/earthly-zynqmp/#cb10-7" aria-hidden="true" tabindex="-1"></a>        <span class="at">-S</span> src <span class="dt">\</span></span>
<span id="cb10-8"><a href="/entry/2022/09/19/earthly-zynqmp/#cb10-8" aria-hidden="true" tabindex="-1"></a>        <span class="at">-B</span> build <span class="dt">\</span></span>
<span id="cb10-9"><a href="/entry/2022/09/19/earthly-zynqmp/#cb10-9" aria-hidden="true" tabindex="-1"></a>        <span class="at">-DCMAKE_BUILD_TYPE</span><span class="op">=</span>Release <span class="dt">\</span></span>
<span id="cb10-10"><a href="/entry/2022/09/19/earthly-zynqmp/#cb10-10" aria-hidden="true" tabindex="-1"></a>        <span class="at">-DCMAKE_INSTALL_PREFIX</span><span class="op">=</span>install/usr</span>
<span id="cb10-11"><a href="/entry/2022/09/19/earthly-zynqmp/#cb10-11" aria-hidden="true" tabindex="-1"></a>    <span class="kw">RUN</span> <span class="fu">cmake</span> <span class="at">--build</span> build <span class="at">--</span> install</span>
<span id="cb10-12"><a href="/entry/2022/09/19/earthly-zynqmp/#cb10-12" aria-hidden="true" tabindex="-1"></a>    SAVE ARTIFACT install/* /</span></code></pre></div>
<h3 id="linux-カーネルの-.deb-パッケージ">Linux カーネルの .deb パッケージ</h3>
<p>組み込みで Linux を使うなら、やっぱりカーネルのコンフィグはプロジェクト単位で細かく設定したいです。ということでカーネルも一緒にビルドします。今回作る Linux 環境は Ubuntu なので、<code>make bindeb-pkg</code> で <code>.deb</code> パッケージを作ることにしました。</p>
<p>カーネルのコンフィグファイルは実行環境に依存しない <code>defconfig</code> 形式を使うのが望ましいのですが、手抜きをして <code>menuconfig</code> で作ったものをそのままリポジトリに入れています。<code>SAVE ARTIFACT</code> するのは作った <code>.deb</code> パッケージと、あとで <code>.dts</code> をコンパイルするときに使うヘッダファイルです。</p>
<div class="sourceCode" id="cb11"><pre class="sourceCode dockerfile"><code class="sourceCode dockerfile"><span id="cb11-1"><a href="/entry/2022/09/19/earthly-zynqmp/#cb11-1" aria-hidden="true" tabindex="-1"></a>linux:</span>
<span id="cb11-2"><a href="/entry/2022/09/19/earthly-zynqmp/#cb11-2" aria-hidden="true" tabindex="-1"></a>    <span class="kw">FROM</span> +prep</span>
<span id="cb11-3"><a href="/entry/2022/09/19/earthly-zynqmp/#cb11-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">RUN</span> <span class="op">--mount=type=tmpfs,target=/tmp</span> <span class="op">\</span></span>
<span id="cb11-4"><a href="/entry/2022/09/19/earthly-zynqmp/#cb11-4" aria-hidden="true" tabindex="-1"></a>        <span class="ex">curl</span> <span class="at">--no-progress-meter</span> <span class="at">-L</span> https://github.com/Xilinx/linux-xlnx/archive/75872fda9ad270b611ee6ae2433492da1e22b688.tar.gz <span class="at">-o</span> /tmp/archive.tar.gz <span class="kw">&amp;&amp;</span> <span class="dt">\</span></span>
<span id="cb11-5"><a href="/entry/2022/09/19/earthly-zynqmp/#cb11-5" aria-hidden="true" tabindex="-1"></a>        <span class="bu">echo</span> <span class="st">&#39;75e40c693484710cd7fc5cd972adb272414d196121c66a6ee2ca6ef762cb60c9  /tmp/archive.tar.gz&#39;</span> <span class="kw">|</span> <span class="fu">sha256sum</span> <span class="at">-c</span> <span class="kw">&amp;&amp;</span> <span class="dt">\</span></span>
<span id="cb11-6"><a href="/entry/2022/09/19/earthly-zynqmp/#cb11-6" aria-hidden="true" tabindex="-1"></a>        <span class="fu">tar</span> xf /tmp/archive.tar.gz <span class="at">--strip-components</span><span class="op">=</span>1</span>
<span id="cb11-7"><a href="/entry/2022/09/19/earthly-zynqmp/#cb11-7" aria-hidden="true" tabindex="-1"></a>    <span class="kw">COPY</span> linux/.config .</span>
<span id="cb11-8"><a href="/entry/2022/09/19/earthly-zynqmp/#cb11-8" aria-hidden="true" tabindex="-1"></a>    <span class="kw">ARG</span> nproc=$(nproc)</span>
<span id="cb11-9"><a href="/entry/2022/09/19/earthly-zynqmp/#cb11-9" aria-hidden="true" tabindex="-1"></a>    <span class="kw">RUN</span> <span class="va">CROSS_COMPILE</span><span class="op">=</span>aarch64-linux-gnu- <span class="fu">make</span> <span class="at">-j</span><span class="va">$nproc</span> ARCH=arm64 bindeb-pkg</span>
<span id="cb11-10"><a href="/entry/2022/09/19/earthly-zynqmp/#cb11-10" aria-hidden="true" tabindex="-1"></a>    SAVE ARTIFACT include/dt-bindings /include/dt-bindings</span>
<span id="cb11-11"><a href="/entry/2022/09/19/earthly-zynqmp/#cb11-11" aria-hidden="true" tabindex="-1"></a>    SAVE ARTIFACT /*.deb</span></code></pre></div>
<h3 id="ubuntu-の-rootfs">Ubuntu の rootfs</h3>
<p>今回のアプリケーションを動かす環境として、Ubuntu は完全にオーバーキルです。それどころかブート時間やデータ量などの面でマイナスです。それでも Ubuntu にしたのは、構築後もその上で変更を加えられて、デスクトップ用途でも使ったことがあるだろう環境が動いてほしいという風潮を感じたためです。Linux From Scratch 的なことをしはじめると <code>crossbuild-essential-arm64</code> と少し相性が悪くなってくるのと、単純に説明が面倒になるからというのもあります。</p>
<p>Ubuntu 環境の構築には <code>mmdebstrap</code> を使ってみました。よく知られた <code>debootstrap</code> と比較して、処理時間が早いことや、より小さな環境を作りやすかったりするのがウリだそうです。</p>
<div class="sourceCode" id="cb12"><pre class="sourceCode dockerfile"><code class="sourceCode dockerfile"><span id="cb12-1"><a href="/entry/2022/09/19/earthly-zynqmp/#cb12-1" aria-hidden="true" tabindex="-1"></a>rootfs-base.tar:</span>
<span id="cb12-2"><a href="/entry/2022/09/19/earthly-zynqmp/#cb12-2" aria-hidden="true" tabindex="-1"></a>    <span class="kw">FROM</span> <span class="op">--platform=linux/arm64</span> ubuntu:jammy@sha256:1bc0bc3815bdcfafefa6b3ef1d8fd159564693d0f8fbb37b8151074651a11ffb</span>
<span id="cb12-3"><a href="/entry/2022/09/19/earthly-zynqmp/#cb12-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">RUN</span> <span class="ex">apt-get</span> update <span class="kw">&amp;&amp;</span> <span class="dt">\</span></span>
<span id="cb12-4"><a href="/entry/2022/09/19/earthly-zynqmp/#cb12-4" aria-hidden="true" tabindex="-1"></a>        <span class="ex">apt-get</span> install <span class="at">-y</span> <span class="at">--no-install-recommends</span> mmdebstrap <span class="kw">&amp;&amp;</span> <span class="dt">\</span></span>
<span id="cb12-5"><a href="/entry/2022/09/19/earthly-zynqmp/#cb12-5" aria-hidden="true" tabindex="-1"></a>        <span class="fu">rm</span> <span class="at">-rf</span> /var/lib/apt/lists/<span class="pp">*</span></span>
<span id="cb12-6"><a href="/entry/2022/09/19/earthly-zynqmp/#cb12-6" aria-hidden="true" tabindex="-1"></a>    <span class="kw">COPY</span> +linux/*.deb kernels/</span>
<span id="cb12-7"><a href="/entry/2022/09/19/earthly-zynqmp/#cb12-7" aria-hidden="true" tabindex="-1"></a>    <span class="kw">RUN</span> <span class="ex">mmdebstrap</span> <span class="dt">\</span></span>
<span id="cb12-8"><a href="/entry/2022/09/19/earthly-zynqmp/#cb12-8" aria-hidden="true" tabindex="-1"></a>        <span class="at">--verbose</span> <span class="dt">\</span></span>
<span id="cb12-9"><a href="/entry/2022/09/19/earthly-zynqmp/#cb12-9" aria-hidden="true" tabindex="-1"></a>        <span class="at">--components</span><span class="op">=</span><span class="st">&#39;main restricted universe multiverse&#39;</span> <span class="dt">\</span></span>
<span id="cb12-10"><a href="/entry/2022/09/19/earthly-zynqmp/#cb12-10" aria-hidden="true" tabindex="-1"></a>        <span class="at">--variant</span><span class="op">=</span><span class="st">&#39;minbase&#39;</span> <span class="dt">\</span></span>
<span id="cb12-11"><a href="/entry/2022/09/19/earthly-zynqmp/#cb12-11" aria-hidden="true" tabindex="-1"></a>        <span class="at">--include</span><span class="op">=</span><span class="st">&#39;apt dbus e2fsprogs init iproute2 iputils-ping kmod libstdc++6 parted sudo systemd-timesyncd udev&#39;</span> <span class="dt">\</span></span>
<span id="cb12-12"><a href="/entry/2022/09/19/earthly-zynqmp/#cb12-12" aria-hidden="true" tabindex="-1"></a>        <span class="at">--customize-hook</span><span class="op">=</span><span class="st">&#39;cp -r kernels &quot;$1/&quot; &amp;&amp; chroot &quot;$1&quot; sh -c &quot;dpkg -i /kernels/*.deb&quot; &amp;&amp; rm -rf &quot;$1/kernels&quot;&#39;</span> <span class="dt">\</span></span>
<span id="cb12-13"><a href="/entry/2022/09/19/earthly-zynqmp/#cb12-13" aria-hidden="true" tabindex="-1"></a>        <span class="at">--customize-hook</span><span class="op">=</span><span class="st">&#39;sed -i &quot;s/^#\s*\(%sudo\)/\1/&quot; &quot;$1/etc/sudoers&quot;&#39;</span> <span class="dt">\</span></span>
<span id="cb12-14"><a href="/entry/2022/09/19/earthly-zynqmp/#cb12-14" aria-hidden="true" tabindex="-1"></a>        <span class="at">--customize-hook</span><span class="op">=</span><span class="st">&#39;chroot &quot;$1&quot; adduser --disabled-password user&#39;</span> <span class="dt">\</span></span>
<span id="cb12-15"><a href="/entry/2022/09/19/earthly-zynqmp/#cb12-15" aria-hidden="true" tabindex="-1"></a>        <span class="at">--customize-hook</span><span class="op">=</span><span class="st">&#39;chroot &quot;$1&quot; adduser user sudo&#39;</span> <span class="dt">\</span></span>
<span id="cb12-16"><a href="/entry/2022/09/19/earthly-zynqmp/#cb12-16" aria-hidden="true" tabindex="-1"></a>        <span class="at">--customize-hook</span><span class="op">=</span><span class="st">&#39;echo &quot;user:user&quot; | chroot &quot;$1&quot; chpasswd&#39;</span> <span class="dt">\</span></span>
<span id="cb12-17"><a href="/entry/2022/09/19/earthly-zynqmp/#cb12-17" aria-hidden="true" tabindex="-1"></a>        <span class="at">--customize-hook</span><span class="op">=</span><span class="st">&#39;chroot &quot;$1&quot; passwd --expire user&#39;</span> <span class="dt">\</span></span>
<span id="cb12-18"><a href="/entry/2022/09/19/earthly-zynqmp/#cb12-18" aria-hidden="true" tabindex="-1"></a>        <span class="at">--customize-hook</span><span class="op">=</span><span class="st">&#39;chroot &quot;$1&quot; passwd --lock root&#39;</span> <span class="dt">\</span></span>
<span id="cb12-19"><a href="/entry/2022/09/19/earthly-zynqmp/#cb12-19" aria-hidden="true" tabindex="-1"></a>        <span class="at">--dpkgopt</span><span class="op">=</span><span class="st">&#39;path-exclude=/usr/share/man/*&#39;</span> <span class="dt">\</span></span>
<span id="cb12-20"><a href="/entry/2022/09/19/earthly-zynqmp/#cb12-20" aria-hidden="true" tabindex="-1"></a>        <span class="at">--dpkgopt</span><span class="op">=</span><span class="st">&#39;path-include=/usr/share/man/man[1-9]/*&#39;</span> <span class="dt">\</span></span>
<span id="cb12-21"><a href="/entry/2022/09/19/earthly-zynqmp/#cb12-21" aria-hidden="true" tabindex="-1"></a>        <span class="at">--dpkgopt</span><span class="op">=</span><span class="st">&#39;path-exclude=/usr/share/locale/*&#39;</span> <span class="dt">\</span></span>
<span id="cb12-22"><a href="/entry/2022/09/19/earthly-zynqmp/#cb12-22" aria-hidden="true" tabindex="-1"></a>        <span class="at">--dpkgopt</span><span class="op">=</span><span class="st">&#39;path-include=/usr/share/locale/locale.alias&#39;</span> <span class="dt">\</span></span>
<span id="cb12-23"><a href="/entry/2022/09/19/earthly-zynqmp/#cb12-23" aria-hidden="true" tabindex="-1"></a>        <span class="at">--dpkgopt</span><span class="op">=</span><span class="st">&#39;path-exclude=/usr/share/doc/*&#39;</span> <span class="dt">\</span></span>
<span id="cb12-24"><a href="/entry/2022/09/19/earthly-zynqmp/#cb12-24" aria-hidden="true" tabindex="-1"></a>        <span class="at">--dpkgopt</span><span class="op">=</span><span class="st">&#39;path-include=/usr/share/doc/*/copyright&#39;</span> <span class="dt">\</span></span>
<span id="cb12-25"><a href="/entry/2022/09/19/earthly-zynqmp/#cb12-25" aria-hidden="true" tabindex="-1"></a>        jammy rootfs-base.tar http://ports.ubuntu.com/ubuntu-ports</span>
<span id="cb12-26"><a href="/entry/2022/09/19/earthly-zynqmp/#cb12-26" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Use .tar format since SAVE ARTIFACT and COPY drop permissions for some reason even specifying with the --keep-own option...</span></span>
<span id="cb12-27"><a href="/entry/2022/09/19/earthly-zynqmp/#cb12-27" aria-hidden="true" tabindex="-1"></a>    SAVE ARTIFACT rootfs-base.tar</span></code></pre></div>
<p>これまでのターゲットと違い、<code>FROM</code> には <code>--platform=linux/arm64</code> を渡して 64 bit ARM の Ubuntu が設定されています。Earthly にビルドさせる前に qemu-user-static と binfnt_misc を設定しておきましょう。<code>mmdebstrap</code> にこれを勝手にやってくれる機能もあるようですが、Earthly の起動するコンテナ内でやってもらおうとするとたぶん <code>--privileged</code> が必要なので使っていません。<code>mmdebstrap</code> 出力形式はディレクトリではなく <code>.tar</code> にしています。<code>SAVE ARTIFACT</code> や <code>COPY</code> にディレクトリを渡したとき、<code>-–keep-own</code> を渡したとしてもファイルのオーナーが root に変わってしまう現象があったためです。ちなみに無圧縮な <code>.tar</code> なのは時間短縮のためです。このターゲット内での処理は QEMU を介して動いてしまうのを忘れてはいけません<a href="/entry/2022/09/19/earthly-zynqmp/#fn3" class="footnote-ref" id="fnref3" role="doc-noteref"><sup>3</sup></a>。</p>
<p><code>mmdebstrap</code> は、<code>--customize-hook=</code> などのコマンドラインオプションで構築中の環境に対して任意のコマンドを実行できます。しかし、このターゲット内でのカスタマイズは最低限のもの、具体的には <code>chroot</code> を介さないと難しいものだけにとどめています。これは、なにか変更をしようとしたときに毎回 <code>mmdebstrap</code> が走ってしまうのを防ぐためです。いくら <code>mmdebstrap</code> が速さをアピールしているといえ、ファイル追加といった簡単なタスクに対しても毎回 <code>mmdebstrap</code> が走ってしまうのはかなり不便なので。</p>
<p>作った Ubuntu の <code>.tar</code> にファイルの追加をしているのがこのターゲットです。追加するのは APU のアプリケーションやその他設定ファイル類です。ファイルを追加するだけなら <code>tar</code> を展開しなくてもできます。</p>
<div class="sourceCode" id="cb13"><pre class="sourceCode dockerfile"><code class="sourceCode dockerfile"><span id="cb13-1"><a href="/entry/2022/09/19/earthly-zynqmp/#cb13-1" aria-hidden="true" tabindex="-1"></a>rootfs.tar:</span>
<span id="cb13-2"><a href="/entry/2022/09/19/earthly-zynqmp/#cb13-2" aria-hidden="true" tabindex="-1"></a>    <span class="kw">FROM</span> +prep</span>
<span id="cb13-3"><a href="/entry/2022/09/19/earthly-zynqmp/#cb13-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">COPY</span> +rootfs-base.tar/rootfs-base.tar rootfs.tar</span>
<span id="cb13-4"><a href="/entry/2022/09/19/earthly-zynqmp/#cb13-4" aria-hidden="true" tabindex="-1"></a>    <span class="kw">COPY</span> linux/rootfs rootfs</span>
<span id="cb13-5"><a href="/entry/2022/09/19/earthly-zynqmp/#cb13-5" aria-hidden="true" tabindex="-1"></a>    <span class="kw">COPY</span> +app-a53/ rootfs</span>
<span id="cb13-6"><a href="/entry/2022/09/19/earthly-zynqmp/#cb13-6" aria-hidden="true" tabindex="-1"></a>    <span class="kw">RUN</span> <span class="fu">tar</span> <span class="at">--append</span> <span class="at">-f</span> rootfs.tar <span class="at">--xattrs</span> <span class="at">--xattrs-include</span><span class="op">=</span><span class="st">&#39;*&#39;</span> <span class="at">-C</span> rootfs .</span>
<span id="cb13-7"><a href="/entry/2022/09/19/earthly-zynqmp/#cb13-7" aria-hidden="true" tabindex="-1"></a>    SAVE ARTIFACT rootfs.tar</span></code></pre></div>
<h3 id="u-boot">U-Boot</h3>
<p>U-Boot のビルドは、<code>ARCH</code> に渡す値が <code>aarch64</code> に変わるくらいで Linux とほぼ同じです。ビルドで一緒に作られるツール <code>dtc</code> と <code>mkimage</code> がこの後の作業で必要なので、これらも忘れず <code>SAVE ARTIFACT</code> しておきます。</p>
<div class="sourceCode" id="cb14"><pre class="sourceCode dockerfile"><code class="sourceCode dockerfile"><span id="cb14-1"><a href="/entry/2022/09/19/earthly-zynqmp/#cb14-1" aria-hidden="true" tabindex="-1"></a>u-boot:</span>
<span id="cb14-2"><a href="/entry/2022/09/19/earthly-zynqmp/#cb14-2" aria-hidden="true" tabindex="-1"></a>    <span class="kw">FROM</span> +prep</span>
<span id="cb14-3"><a href="/entry/2022/09/19/earthly-zynqmp/#cb14-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">RUN</span> <span class="op">--mount=type=tmpfs,target=/tmp</span> <span class="op">\</span></span>
<span id="cb14-4"><a href="/entry/2022/09/19/earthly-zynqmp/#cb14-4" aria-hidden="true" tabindex="-1"></a>        <span class="ex">curl</span> <span class="at">--no-progress-meter</span> <span class="at">-L</span> https://github.com/Xilinx/u-boot-xlnx/archive/refs/tags/xilinx-v2022.1.tar.gz <span class="at">-o</span> /tmp/archive.tar.gz <span class="kw">&amp;&amp;</span> <span class="dt">\</span></span>
<span id="cb14-5"><a href="/entry/2022/09/19/earthly-zynqmp/#cb14-5" aria-hidden="true" tabindex="-1"></a>        <span class="bu">echo</span> <span class="st">&#39;a02adc8d80f736050772367ea6f868214faaf47b6b3539781d6972dab26b227c  /tmp/archive.tar.gz&#39;</span> <span class="kw">|</span> <span class="fu">sha256sum</span> <span class="at">-c</span> <span class="kw">&amp;&amp;</span> <span class="dt">\</span></span>
<span id="cb14-6"><a href="/entry/2022/09/19/earthly-zynqmp/#cb14-6" aria-hidden="true" tabindex="-1"></a>        <span class="fu">tar</span> xf /tmp/archive.tar.gz <span class="at">--strip-components</span><span class="op">=</span>1</span>
<span id="cb14-7"><a href="/entry/2022/09/19/earthly-zynqmp/#cb14-7" aria-hidden="true" tabindex="-1"></a>    <span class="kw">ARG</span> nproc=$(nproc)</span>
<span id="cb14-8"><a href="/entry/2022/09/19/earthly-zynqmp/#cb14-8" aria-hidden="true" tabindex="-1"></a>    <span class="kw">COPY</span> u-boot.config .config</span>
<span id="cb14-9"><a href="/entry/2022/09/19/earthly-zynqmp/#cb14-9" aria-hidden="true" tabindex="-1"></a>    <span class="kw">RUN</span> <span class="va">CROSS_COMPILE</span><span class="op">=</span>aarch64-linux-gnu- <span class="va">ARCH</span><span class="op">=</span>aarch64 <span class="dt">\</span></span>
<span id="cb14-10"><a href="/entry/2022/09/19/earthly-zynqmp/#cb14-10" aria-hidden="true" tabindex="-1"></a>        <span class="fu">make</span> <span class="at">-j</span><span class="va">$nproc</span> u-boot.elf</span>
<span id="cb14-11"><a href="/entry/2022/09/19/earthly-zynqmp/#cb14-11" aria-hidden="true" tabindex="-1"></a>    SAVE ARTIFACT u-boot.elf</span>
<span id="cb14-12"><a href="/entry/2022/09/19/earthly-zynqmp/#cb14-12" aria-hidden="true" tabindex="-1"></a>    SAVE ARTIFACT scripts/dtc/dtc /dtc</span>
<span id="cb14-13"><a href="/entry/2022/09/19/earthly-zynqmp/#cb14-13" aria-hidden="true" tabindex="-1"></a>    SAVE ARTIFACT tools/mkimage /mkimage</span></code></pre></div>
<p>Linux と同様に、コンフィグはこちらも <code>menuconfig</code> で作ったものをそのまま入れています。ちなみにこのコンフィグは <code>xilinx_zynqmp_virt_defconfig</code> をベースに使わない機能を削り、U-Boot 自身が使う Devicetree Blob をどうロードするかを変更したものです。Devicetree は FSBL にロードさせたいので <code>CONFIG_OF_BOARD</code> に変更しています。</p>
<pre><code>Device Tree Control  ---&gt;
    Provider of DTB for DT control (Provided by the board (e.g a previous loader) at runtime)  ---&gt;
        (X) Provided by the board (e.g a previous loader) at runtime</code></pre>
<h3 id="trusted-firmware-a-tf-a">Trusted Firmware-A (TF-A)</h3>
<p>以前は arm-trusted-firmware やそれを略して ATF と呼ばれていたやつです。これもいつもどおりの方法でビルドします。<code>ZYNQMP_CONSOLE=cadence1</code> をつけるとメッセージ出力先が UART1 になってくれます。</p>
<div class="sourceCode" id="cb16"><pre class="sourceCode dockerfile"><code class="sourceCode dockerfile"><span id="cb16-1"><a href="/entry/2022/09/19/earthly-zynqmp/#cb16-1" aria-hidden="true" tabindex="-1"></a>tf-a:</span>
<span id="cb16-2"><a href="/entry/2022/09/19/earthly-zynqmp/#cb16-2" aria-hidden="true" tabindex="-1"></a>    <span class="kw">FROM</span> +prep</span>
<span id="cb16-3"><a href="/entry/2022/09/19/earthly-zynqmp/#cb16-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">RUN</span> <span class="op">--mount=type=tmpfs,target=/tmp</span> <span class="op">\</span></span>
<span id="cb16-4"><a href="/entry/2022/09/19/earthly-zynqmp/#cb16-4" aria-hidden="true" tabindex="-1"></a>        <span class="ex">curl</span> <span class="at">--no-progress-meter</span> <span class="at">-L</span> https://github.com/Xilinx/arm-trusted-firmware/archive/refs/tags/xilinx-v2022.1.tar.gz <span class="at">-o</span> /tmp/archive.tar.gz <span class="kw">&amp;&amp;</span> <span class="dt">\</span></span>
<span id="cb16-5"><a href="/entry/2022/09/19/earthly-zynqmp/#cb16-5" aria-hidden="true" tabindex="-1"></a>        <span class="bu">echo</span> <span class="st">&#39;e7d6a4f30d35b19ec54d27e126e7edc2c6a9ad6d53940c6b04aa1b782c55284e  /tmp/archive.tar.gz&#39;</span> <span class="kw">|</span> <span class="fu">sha256sum</span> <span class="at">-c</span> <span class="kw">&amp;&amp;</span> <span class="dt">\</span></span>
<span id="cb16-6"><a href="/entry/2022/09/19/earthly-zynqmp/#cb16-6" aria-hidden="true" tabindex="-1"></a>        <span class="fu">tar</span> xf /tmp/archive.tar.gz <span class="at">--strip-components</span><span class="op">=</span>1</span>
<span id="cb16-7"><a href="/entry/2022/09/19/earthly-zynqmp/#cb16-7" aria-hidden="true" tabindex="-1"></a>    <span class="kw">ARG</span> nproc=$(nproc)</span>
<span id="cb16-8"><a href="/entry/2022/09/19/earthly-zynqmp/#cb16-8" aria-hidden="true" tabindex="-1"></a>    <span class="kw">RUN</span> <span class="va">CROSS_COMPILE</span><span class="op">=</span>aarch64-linux-gnu- <span class="va">ARCH</span><span class="op">=</span>aarch64 <span class="dt">\</span></span>
<span id="cb16-9"><a href="/entry/2022/09/19/earthly-zynqmp/#cb16-9" aria-hidden="true" tabindex="-1"></a>        <span class="fu">make</span> <span class="at">-j</span><span class="va">$nproc</span> PLAT=zynqmp RESET_TO_BL31=1 ZYNQMP_CONSOLE=cadence1</span>
<span id="cb16-10"><a href="/entry/2022/09/19/earthly-zynqmp/#cb16-10" aria-hidden="true" tabindex="-1"></a>    SAVE ARTIFACT build/zynqmp/release/bl31/bl31.elf /</span></code></pre></div>
<h3 id="devicetree-blob">Devicetree Blob</h3>
<p>XSCT で生成した <code>.dts</code> に必要なものを追記して、それを U-Boot と Linux の両方にロードさせることにします。<code>gcc</code> はプリプロセッサを処理するために呼んでいます。渡しているオプションは <a href="https://github.com/Xilinx/linux-xlnx/blob/75872fda9ad270b611ee6ae2433492da1e22b688/scripts/Makefile.lib#L351-L355" target="_blank" rel="nofollow noopener">Linux カーネルにならった</a>ものです。</p>
<div class="sourceCode" id="cb17"><pre class="sourceCode dockerfile"><code class="sourceCode dockerfile"><span id="cb17-1"><a href="/entry/2022/09/19/earthly-zynqmp/#cb17-1" aria-hidden="true" tabindex="-1"></a>system.dtb:</span>
<span id="cb17-2"><a href="/entry/2022/09/19/earthly-zynqmp/#cb17-2" aria-hidden="true" tabindex="-1"></a>    <span class="kw">FROM</span> +prep</span>
<span id="cb17-3"><a href="/entry/2022/09/19/earthly-zynqmp/#cb17-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">COPY</span> +generate-src/device-tree .</span>
<span id="cb17-4"><a href="/entry/2022/09/19/earthly-zynqmp/#cb17-4" aria-hidden="true" tabindex="-1"></a>    <span class="kw">COPY</span> +linux/include include</span>
<span id="cb17-5"><a href="/entry/2022/09/19/earthly-zynqmp/#cb17-5" aria-hidden="true" tabindex="-1"></a>    <span class="kw">COPY</span> +u-boot/dtc .</span>
<span id="cb17-6"><a href="/entry/2022/09/19/earthly-zynqmp/#cb17-6" aria-hidden="true" tabindex="-1"></a>    <span class="kw">COPY</span> system-top-append.dts .</span>
<span id="cb17-7"><a href="/entry/2022/09/19/earthly-zynqmp/#cb17-7" aria-hidden="true" tabindex="-1"></a>    <span class="kw">RUN</span> <span class="fu">cat</span> system-top-append.dts <span class="op">&gt;&gt;</span> system-top.dts <span class="kw">&amp;&amp;</span> <span class="dt">\</span></span>
<span id="cb17-8"><a href="/entry/2022/09/19/earthly-zynqmp/#cb17-8" aria-hidden="true" tabindex="-1"></a>        <span class="fu">gcc</span> <span class="at">-E</span> <span class="at">-nostdinc</span> <span class="at">-undef</span> <span class="at">-D__DTS__</span> <span class="at">-x</span> assembler-with-cpp <span class="at">-Iinclude</span> <span class="at">-o</span> <span class="at">-</span> system-top.dts <span class="kw">|</span> <span class="ex">./dtc</span> <span class="at">-@</span> <span class="at">-p</span> 0x1000 <span class="at">-I</span> dts <span class="at">-O</span> dtb <span class="at">-o</span> system.dtb</span>
<span id="cb17-9"><a href="/entry/2022/09/19/earthly-zynqmp/#cb17-9" aria-hidden="true" tabindex="-1"></a>    SAVE ARTIFACT system.dtb</span></code></pre></div>
<h3 id="bootgen-と-boot.bin">Bootgen と boot.bin</h3>
<p><code>boot.bin</code> の生成に使う <code>bootgen</code> は <a href="https://github.com/Xilinx/bootgen" target="_blank" rel="nofollow noopener">GitHub にソースコードがあります</a>。まずこれをビルドします。ソースコードを持ってきて <code>make</code> すれば、同じディレクトリ内に実行ファイル <code>bootgen</code> が出来上がります。</p>
<div class="sourceCode" id="cb18"><pre class="sourceCode dockerfile"><code class="sourceCode dockerfile"><span id="cb18-1"><a href="/entry/2022/09/19/earthly-zynqmp/#cb18-1" aria-hidden="true" tabindex="-1"></a>bootgen:</span>
<span id="cb18-2"><a href="/entry/2022/09/19/earthly-zynqmp/#cb18-2" aria-hidden="true" tabindex="-1"></a>    <span class="kw">FROM</span> +prep</span>
<span id="cb18-3"><a href="/entry/2022/09/19/earthly-zynqmp/#cb18-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">RUN</span> <span class="op">--mount=type=tmpfs,target=/tmp</span> <span class="op">\</span></span>
<span id="cb18-4"><a href="/entry/2022/09/19/earthly-zynqmp/#cb18-4" aria-hidden="true" tabindex="-1"></a>        <span class="ex">curl</span> <span class="at">--no-progress-meter</span> <span class="at">-L</span> https://github.com/Xilinx/bootgen/archive/refs/tags/xilinx_v2022.1.tar.gz <span class="at">-o</span> /tmp/archive.tar.gz <span class="kw">&amp;&amp;</span> <span class="dt">\</span></span>
<span id="cb18-5"><a href="/entry/2022/09/19/earthly-zynqmp/#cb18-5" aria-hidden="true" tabindex="-1"></a>        <span class="bu">echo</span> <span class="st">&#39;a7db095abda9820babbd0406e7036d663e89e8c7c27696bf4227d8a2a4276d13  /tmp/archive.tar.gz&#39;</span> <span class="kw">|</span> <span class="fu">sha256sum</span> <span class="at">-c</span> <span class="kw">&amp;&amp;</span> <span class="dt">\</span></span>
<span id="cb18-6"><a href="/entry/2022/09/19/earthly-zynqmp/#cb18-6" aria-hidden="true" tabindex="-1"></a>        <span class="fu">tar</span> xf /tmp/archive.tar.gz <span class="at">--strip-components</span><span class="op">=</span>1</span>
<span id="cb18-7"><a href="/entry/2022/09/19/earthly-zynqmp/#cb18-7" aria-hidden="true" tabindex="-1"></a>    <span class="kw">RUN</span> <span class="fu">make</span></span>
<span id="cb18-8"><a href="/entry/2022/09/19/earthly-zynqmp/#cb18-8" aria-hidden="true" tabindex="-1"></a>    SAVE ARTIFACT bootgen</span></code></pre></div>
<p>次に <code>boot.bin</code> に含めるファイルとその構成を指示する <code>.bif</code> ファイルを作ります。ここに書いた <code>system.dtb</code> は U-Boot が使うものです。ロード先のアドレス <code>0x100000</code> は U-Boot の <code>CONFIG_XILINX_OF_BOARD_DTB_ADDR=0x100000</code> に対応しています。<a href="https://docs.xilinx.com/r/en-US/ug1283-bootgen-user-guide/destination_cpu" target="_blank" rel="nofollow noopener">UG1283</a> にある通り、PMUFW のロードのさせ方には <code>[pmufw_image]</code> と <code>[destination_cpu=pmu]</code> の2通りあり、その違いは BootROM にロードさせるか FSBL にロードさせるかです。BootROM にロードさせると PMUFW 実行直後のバージョンなどの方法が出てこない気がする<a href="/entry/2022/09/19/earthly-zynqmp/#fn4" class="footnote-ref" id="fnref4" role="doc-noteref"><sup>4</sup></a>ので FSBL にロードさせています。</p>
<pre><code>all:
{
  [destination_cpu=a53-0, bootloader]                       fsbl.elf
  [destination_cpu=pmu]                                     pmufw.elf
  [destination_device=pl]                                   system.bit
  [destination_cpu=a53-0, exception_level=el-3, trustzone]  bl31.elf
  [destination_cpu=a53-0, exception_level=el-2]             u-boot.elf
  [destination_cpu=a53-0, load=0x100000]                    system.dtb
  [destination_cpu=r5-lockstep]                             ipi-led.elf
}</code></pre>
<p>あとはこれまでのターゲットでビルドしてきた必要なファイルと <code>.bif</code> ファイルを持ってきて、<code>bootgen</code> コマンドを実行すれば OK です。</p>
<div class="sourceCode" id="cb20"><pre class="sourceCode dockerfile"><code class="sourceCode dockerfile"><span id="cb20-1"><a href="/entry/2022/09/19/earthly-zynqmp/#cb20-1" aria-hidden="true" tabindex="-1"></a>boot.bin:</span>
<span id="cb20-2"><a href="/entry/2022/09/19/earthly-zynqmp/#cb20-2" aria-hidden="true" tabindex="-1"></a>    <span class="kw">FROM</span> +prep</span>
<span id="cb20-3"><a href="/entry/2022/09/19/earthly-zynqmp/#cb20-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">COPY</span> +app-r5-0/bin/ipi-led.elf .</span>
<span id="cb20-4"><a href="/entry/2022/09/19/earthly-zynqmp/#cb20-4" aria-hidden="true" tabindex="-1"></a>    <span class="kw">COPY</span> +bootgen/bootgen .</span>
<span id="cb20-5"><a href="/entry/2022/09/19/earthly-zynqmp/#cb20-5" aria-hidden="true" tabindex="-1"></a>    <span class="kw">COPY</span> +fsbl.elf/ .</span>
<span id="cb20-6"><a href="/entry/2022/09/19/earthly-zynqmp/#cb20-6" aria-hidden="true" tabindex="-1"></a>    <span class="kw">COPY</span> +generate-src/system.bit .</span>
<span id="cb20-7"><a href="/entry/2022/09/19/earthly-zynqmp/#cb20-7" aria-hidden="true" tabindex="-1"></a>    <span class="kw">COPY</span> +pmufw.elf/ .</span>
<span id="cb20-8"><a href="/entry/2022/09/19/earthly-zynqmp/#cb20-8" aria-hidden="true" tabindex="-1"></a>    <span class="kw">COPY</span> +system.dtb/ .</span>
<span id="cb20-9"><a href="/entry/2022/09/19/earthly-zynqmp/#cb20-9" aria-hidden="true" tabindex="-1"></a>    <span class="kw">COPY</span> +tf-a/bl31.elf .</span>
<span id="cb20-10"><a href="/entry/2022/09/19/earthly-zynqmp/#cb20-10" aria-hidden="true" tabindex="-1"></a>    <span class="kw">COPY</span> +u-boot/u-boot.elf .</span>
<span id="cb20-11"><a href="/entry/2022/09/19/earthly-zynqmp/#cb20-11" aria-hidden="true" tabindex="-1"></a>    <span class="kw">COPY</span> boot.bif .</span>
<span id="cb20-12"><a href="/entry/2022/09/19/earthly-zynqmp/#cb20-12" aria-hidden="true" tabindex="-1"></a>    <span class="kw">RUN</span> <span class="ex">./bootgen</span> <span class="at">-arch</span> zynqmp <span class="at">-image</span> boot.bif <span class="at">-o</span> boot.bin</span>
<span id="cb20-13"><a href="/entry/2022/09/19/earthly-zynqmp/#cb20-13" aria-hidden="true" tabindex="-1"></a>    SAVE ARTIFACT boot.bin</span></code></pre></div>
<h3 id="boot.scr">boot.scr</h3>
<p>U-Boot には、ブートデバイスのファイルシステム直下にあるスクリプト <code>boot.scr</code> を実行してくれる機能があります。これを使ってカーネルがある場所を指示したり、ロードしたカーネルでブートさせたりします。<code>boot.scr</code> は、U-Boot のコマンドをテキストファイルに書き、<code>mkimage</code> に渡して作ります。</p>
<div class="sourceCode" id="cb21"><pre class="sourceCode dockerfile"><code class="sourceCode dockerfile"><span id="cb21-1"><a href="/entry/2022/09/19/earthly-zynqmp/#cb21-1" aria-hidden="true" tabindex="-1"></a>boot.scr:</span>
<span id="cb21-2"><a href="/entry/2022/09/19/earthly-zynqmp/#cb21-2" aria-hidden="true" tabindex="-1"></a>    <span class="kw">FROM</span> +prep</span>
<span id="cb21-3"><a href="/entry/2022/09/19/earthly-zynqmp/#cb21-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">COPY</span> +u-boot/mkimage .</span>
<span id="cb21-4"><a href="/entry/2022/09/19/earthly-zynqmp/#cb21-4" aria-hidden="true" tabindex="-1"></a>    <span class="kw">COPY</span> boot.cmd .</span>
<span id="cb21-5"><a href="/entry/2022/09/19/earthly-zynqmp/#cb21-5" aria-hidden="true" tabindex="-1"></a>    <span class="kw">RUN</span> <span class="ex">./mkimage</span> <span class="at">-c</span> none <span class="at">-A</span> arm64 <span class="at">-T</span> script <span class="at">-d</span> boot.cmd boot.scr</span>
<span id="cb21-6"><a href="/entry/2022/09/19/earthly-zynqmp/#cb21-6" aria-hidden="true" tabindex="-1"></a>    SAVE ARTIFACT boot.scr</span></code></pre></div>
<p>ブートデバイスとして使う SD カードには2つのパーティションを作り、1つ目のパーティションに <code>boot.bin</code>, <code>boot.scr</code>, <code>system.dtb</code> を、2つ目のパーティションに Ubuntu ということにします。開発時の書き換えやすさを優先して、<code>system.dtb</code> も1つ目のパーティションに置いています。ということで <code>boot.cmd</code> はこんな感じです。カーネルは2つ目のパーティションの <code>/boot</code> にあるので <code>mmc 0:2 ...</code>, <code>system.dtb</code> は1つ目のパーティション直下にあるので <code>mmc 0:1 ...</code> になります。あとはファイルをロードしたアドレスを <code>booti</code> コマンドに渡してブートさせます。initramfs を使わないので、<code>booti</code> の第2引数は <code>-</code> にします。</p>
<div class="sourceCode" id="cb22"><pre class="sourceCode sh"><code class="sourceCode bash"><span id="cb22-1"><a href="/entry/2022/09/19/earthly-zynqmp/#cb22-1" aria-hidden="true" tabindex="-1"></a><span class="ex">load</span> mmc 0:2 <span class="va">${kernel_addr_r}</span> /boot/vmlinuz-5.15.19</span>
<span id="cb22-2"><a href="/entry/2022/09/19/earthly-zynqmp/#cb22-2" aria-hidden="true" tabindex="-1"></a><span class="ex">load</span> mmc 0:1 <span class="va">${fdt_addr_r}</span> /system.dtb</span>
<span id="cb22-3"><a href="/entry/2022/09/19/earthly-zynqmp/#cb22-3" aria-hidden="true" tabindex="-1"></a><span class="ex">booti</span> <span class="va">${kernel_addr_r}</span> <span class="at">-</span> <span class="va">${fdt_addr_r}</span></span></code></pre></div>
<p>ちなみに、<code>bindeb-pkg</code> で作ったカーネルの <code>.deb</code> パッケージは、Linux カーネルに含まれる <code>.dts</code> から作った <code>.dtb</code> を <code>/usr/lib/linux-image-*</code> にインストールするようです。カーネルにあるもので十分なケースではこちらのパスを設定すればよいです。</p>
<h3 id="sd-カードのディスクイメージも作っちゃう">SD カードのディスクイメージも作っちゃう</h3>
<p>ここまでで必要なファイルが全て揃いました。でも、これですぐ Ultra96 で動かせるかといえば ✗ です。SD カードにパーティションを切って、それぞれフォーマットして、ファイルをコピーして…と、地味に面倒な作業が残っています。少しでも作業を減らすために、<code>Earthfile</code> の中で SD カードのディスクイメージまで作ってしまいます。</p>
<p>最初にパーティション毎にイメージを作ってフォーマット &amp; データのコピー、最後にそれらを結合して <code>sfdisk</code> でパーティションテーブルの書き込み、という感じのことをやっています。<code>loop</code> デバイスの作成や <code>mount</code> などを実行しているため、ここだけは仕方なく <code>--privileged</code> をつけています。いきなりディスクイメージを作らずパーティション毎にファイルを分けて構築しているのは、コンテナ内で <code>mount</code> は動くけど <code>losetup</code> はうまく動いてくれない場合があったことと、そもそもカーネルモジュール <code>loop</code> のパラメータ <code>max_part</code> が指定しなければ大抵0なため、パーティションを持つ <code>loop</code> デバイスの作成がコンテナ内だけの処理で完結しにくいためです。</p>
<div class="sourceCode" id="cb23"><pre class="sourceCode dockerfile"><code class="sourceCode dockerfile"><span id="cb23-1"><a href="/entry/2022/09/19/earthly-zynqmp/#cb23-1" aria-hidden="true" tabindex="-1"></a>disk.img.zst:</span>
<span id="cb23-2"><a href="/entry/2022/09/19/earthly-zynqmp/#cb23-2" aria-hidden="true" tabindex="-1"></a>    <span class="kw">FROM</span> +prep</span>
<span id="cb23-3"><a href="/entry/2022/09/19/earthly-zynqmp/#cb23-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">COPY</span> +boot.tar/ .</span>
<span id="cb23-4"><a href="/entry/2022/09/19/earthly-zynqmp/#cb23-4" aria-hidden="true" tabindex="-1"></a>    <span class="kw">COPY</span> +rootfs.tar/ .</span>
<span id="cb23-5"><a href="/entry/2022/09/19/earthly-zynqmp/#cb23-5" aria-hidden="true" tabindex="-1"></a>    <span class="kw">ARG</span> DISK_IMG_PART1_SIZE=16M</span>
<span id="cb23-6"><a href="/entry/2022/09/19/earthly-zynqmp/#cb23-6" aria-hidden="true" tabindex="-1"></a>    <span class="kw">ARG</span> DISK_IMG_PART2_SIZE=256M</span>
<span id="cb23-7"><a href="/entry/2022/09/19/earthly-zynqmp/#cb23-7" aria-hidden="true" tabindex="-1"></a>    <span class="kw">RUN</span> <span class="op">--mount=type=tmpfs,target=/tmp</span> <span class="op">--privileged</span> <span class="op">\</span></span>
<span id="cb23-8"><a href="/entry/2022/09/19/earthly-zynqmp/#cb23-8" aria-hidden="true" tabindex="-1"></a>        <span class="fu">truncate</span> <span class="at">-s</span> <span class="st">&quot;</span><span class="va">$DISK_IMG_PART1_SIZE</span><span class="st">&quot;</span> /tmp/boot.img <span class="kw">&amp;&amp;</span> <span class="dt">\</span></span>
<span id="cb23-9"><a href="/entry/2022/09/19/earthly-zynqmp/#cb23-9" aria-hidden="true" tabindex="-1"></a>        <span class="ex">mkfs.vfat</span> <span class="at">-F</span> 16 /tmp/boot.img <span class="kw">&amp;&amp;</span> <span class="dt">\</span></span>
<span id="cb23-10"><a href="/entry/2022/09/19/earthly-zynqmp/#cb23-10" aria-hidden="true" tabindex="-1"></a>        <span class="fu">mount</span> /tmp/boot.img /mnt <span class="kw">&amp;&amp;</span> <span class="dt">\</span></span>
<span id="cb23-11"><a href="/entry/2022/09/19/earthly-zynqmp/#cb23-11" aria-hidden="true" tabindex="-1"></a>        <span class="fu">tar</span> xf boot.tar <span class="at">-C</span> /mnt <span class="kw">&amp;&amp;</span> <span class="dt">\</span></span>
<span id="cb23-12"><a href="/entry/2022/09/19/earthly-zynqmp/#cb23-12" aria-hidden="true" tabindex="-1"></a>        <span class="fu">umount</span> /mnt <span class="kw">&amp;&amp;</span> <span class="dt">\</span></span>
<span id="cb23-13"><a href="/entry/2022/09/19/earthly-zynqmp/#cb23-13" aria-hidden="true" tabindex="-1"></a>        <span class="fu">truncate</span> <span class="at">-s</span> <span class="st">&quot;</span><span class="va">$DISK_IMG_PART2_SIZE</span><span class="st">&quot;</span> /tmp/root.img <span class="kw">&amp;&amp;</span> <span class="dt">\</span></span>
<span id="cb23-14"><a href="/entry/2022/09/19/earthly-zynqmp/#cb23-14" aria-hidden="true" tabindex="-1"></a>        <span class="ex">mkfs.ext4</span> /tmp/root.img <span class="kw">&amp;&amp;</span> <span class="dt">\</span></span>
<span id="cb23-15"><a href="/entry/2022/09/19/earthly-zynqmp/#cb23-15" aria-hidden="true" tabindex="-1"></a>        <span class="fu">mount</span> /tmp/root.img /mnt <span class="kw">&amp;&amp;</span> <span class="dt">\</span></span>
<span id="cb23-16"><a href="/entry/2022/09/19/earthly-zynqmp/#cb23-16" aria-hidden="true" tabindex="-1"></a>        <span class="fu">tar</span> xf rootfs.tar <span class="at">--xattrs</span> <span class="at">--xattrs-include</span><span class="op">=</span><span class="st">&#39;*&#39;</span> <span class="at">-C</span> /mnt <span class="kw">&amp;&amp;</span> <span class="dt">\</span></span>
<span id="cb23-17"><a href="/entry/2022/09/19/earthly-zynqmp/#cb23-17" aria-hidden="true" tabindex="-1"></a>        <span class="fu">umount</span> /mnt <span class="kw">&amp;&amp;</span> <span class="dt">\</span></span>
<span id="cb23-18"><a href="/entry/2022/09/19/earthly-zynqmp/#cb23-18" aria-hidden="true" tabindex="-1"></a>        <span class="fu">truncate</span> <span class="at">-s</span> 1M /tmp/header.img <span class="kw">&amp;&amp;</span> <span class="dt">\</span></span>
<span id="cb23-19"><a href="/entry/2022/09/19/earthly-zynqmp/#cb23-19" aria-hidden="true" tabindex="-1"></a>        <span class="fu">cat</span> /tmp/header.img /tmp/boot.img /tmp/root.img <span class="op">&gt;</span> /tmp/disk.img <span class="kw">&amp;&amp;</span> <span class="dt">\</span></span>
<span id="cb23-20"><a href="/entry/2022/09/19/earthly-zynqmp/#cb23-20" aria-hidden="true" tabindex="-1"></a>        <span class="bu">echo</span> <span class="st">&quot;label: dos\n1M,</span><span class="va">${DISK_IMG_PART1_SIZE}</span><span class="st">,e\n,</span><span class="va">${DISK_IMG_PART2_SIZE}</span><span class="st">,L\n&quot;</span> <span class="kw">|</span> <span class="ex">sfdisk</span> /tmp/disk.img <span class="kw">&amp;&amp;</span> <span class="dt">\</span></span>
<span id="cb23-21"><a href="/entry/2022/09/19/earthly-zynqmp/#cb23-21" aria-hidden="true" tabindex="-1"></a>        <span class="ex">zstd</span> <span class="at">--no-progress</span> <span class="at">-9</span> /tmp/disk.img <span class="at">-o</span> disk.img.zst</span>
<span id="cb23-22"><a href="/entry/2022/09/19/earthly-zynqmp/#cb23-22" aria-hidden="true" tabindex="-1"></a>    SAVE ARTIFACT disk.img.zst</span>
<span id="cb23-23"><a href="/entry/2022/09/19/earthly-zynqmp/#cb23-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb23-24"><a href="/entry/2022/09/19/earthly-zynqmp/#cb23-24" aria-hidden="true" tabindex="-1"></a>boot.tar:</span>
<span id="cb23-25"><a href="/entry/2022/09/19/earthly-zynqmp/#cb23-25" aria-hidden="true" tabindex="-1"></a>    <span class="kw">FROM</span> +prep</span>
<span id="cb23-26"><a href="/entry/2022/09/19/earthly-zynqmp/#cb23-26" aria-hidden="true" tabindex="-1"></a>    <span class="kw">COPY</span> +boot.scr/boot.scr boot/</span>
<span id="cb23-27"><a href="/entry/2022/09/19/earthly-zynqmp/#cb23-27" aria-hidden="true" tabindex="-1"></a>    <span class="kw">COPY</span> +boot.bin/ boot/</span>
<span id="cb23-28"><a href="/entry/2022/09/19/earthly-zynqmp/#cb23-28" aria-hidden="true" tabindex="-1"></a>    <span class="kw">COPY</span> +system.dtb/ boot/</span>
<span id="cb23-29"><a href="/entry/2022/09/19/earthly-zynqmp/#cb23-29" aria-hidden="true" tabindex="-1"></a>    <span class="kw">RUN</span> <span class="fu">tar</span> <span class="at">--create</span> <span class="at">-f</span> boot.tar <span class="at">-C</span> boot .</span>
<span id="cb23-30"><a href="/entry/2022/09/19/earthly-zynqmp/#cb23-30" aria-hidden="true" tabindex="-1"></a>    SAVE ARTIFACT boot.tar</span></code></pre></div>
<p>もちろんディスクイメージを作ったからといって、なにか変更を加えたときに毎回焼き直す必要はありません。例えば RPU のアプリケーションや Devicetree を変更しただけなら第1パーティションだけ、といった感じに2回目以降は変更があった箇所だけ書き直せば十分です。またせっかく載せたリッチな Linux 環境を活用して、USB メモリやネットワーク経由でファイルが転送できると思います。APU のアプリケーションは、何かしらの修正を加えたものをシュッと転送してすぐ試す、ができます。</p>
<p>もちろん Ultra96 は SD カードからしかブートできないわけではありません。JTAG を使ってロードし直すのもアリですね。</p>
<h3 id="ビルド">ビルド！</h3>
<p>Earthly は1回のコマンド実行で1つのターゲットしか呼び出せないので、最終的に必要となるものをまとめるターゲットを作っておくのが便利です。今回の <code>Earthfile</code> では <code>build</code> がこれに対応します。<code>RUN</code> などのコマンドを使わないなら、<code>FROM</code> に <code>scratch</code> が指定できます。</p>
<div class="sourceCode" id="cb24"><pre class="sourceCode dockerfile"><code class="sourceCode dockerfile"><span id="cb24-1"><a href="/entry/2022/09/19/earthly-zynqmp/#cb24-1" aria-hidden="true" tabindex="-1"></a>build:</span>
<span id="cb24-2"><a href="/entry/2022/09/19/earthly-zynqmp/#cb24-2" aria-hidden="true" tabindex="-1"></a>    <span class="kw">FROM</span> scratch</span>
<span id="cb24-3"><a href="/entry/2022/09/19/earthly-zynqmp/#cb24-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">COPY</span> +disk.img.zst/ .</span>
<span id="cb24-4"><a href="/entry/2022/09/19/earthly-zynqmp/#cb24-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-5"><a href="/entry/2022/09/19/earthly-zynqmp/#cb24-5" aria-hidden="true" tabindex="-1"></a>    <span class="kw">COPY</span> +app-r5-0/bin/ipi-led.elf .</span>
<span id="cb24-6"><a href="/entry/2022/09/19/earthly-zynqmp/#cb24-6" aria-hidden="true" tabindex="-1"></a>    <span class="kw">COPY</span> +boot.bin/ .</span>
<span id="cb24-7"><a href="/entry/2022/09/19/earthly-zynqmp/#cb24-7" aria-hidden="true" tabindex="-1"></a>    <span class="kw">COPY</span> +boot.scr/ .</span>
<span id="cb24-8"><a href="/entry/2022/09/19/earthly-zynqmp/#cb24-8" aria-hidden="true" tabindex="-1"></a>    <span class="kw">COPY</span> +fsbl.elf/ .</span>
<span id="cb24-9"><a href="/entry/2022/09/19/earthly-zynqmp/#cb24-9" aria-hidden="true" tabindex="-1"></a>    <span class="kw">COPY</span> +generate-src/system.bit .</span>
<span id="cb24-10"><a href="/entry/2022/09/19/earthly-zynqmp/#cb24-10" aria-hidden="true" tabindex="-1"></a>    <span class="kw">COPY</span> +pmufw.elf/ .</span>
<span id="cb24-11"><a href="/entry/2022/09/19/earthly-zynqmp/#cb24-11" aria-hidden="true" tabindex="-1"></a>    <span class="kw">COPY</span> +system.dtb/ .</span>
<span id="cb24-12"><a href="/entry/2022/09/19/earthly-zynqmp/#cb24-12" aria-hidden="true" tabindex="-1"></a>    <span class="kw">COPY</span> +tf-a/bl31.elf .</span>
<span id="cb24-13"><a href="/entry/2022/09/19/earthly-zynqmp/#cb24-13" aria-hidden="true" tabindex="-1"></a>    <span class="kw">COPY</span> +u-boot/u-boot.elf .</span>
<span id="cb24-14"><a href="/entry/2022/09/19/earthly-zynqmp/#cb24-14" aria-hidden="true" tabindex="-1"></a>    SAVE ARTIFACT ./*</span></code></pre></div>
<p>早速このターゲットをビルドします。<code>rootfs-base.tar</code> のために qemu-user-static が準備できていることを再確認した上で次のコマンドを実行します。できたディスクイメージなどはローカルに持ってきたいので <code>--artifact</code> を、<code>--privileged</code> を付けたターゲット <code>disk.img.zst</code> のために <code>--allow-privileged</code> を付けます。</p>
<pre><code>$ earthly --artifact --allow-privileged +build/\* --XSA_FILE=design_1_wrapper.xsa ./build/</code></pre>
<p>あとはこんな感じで <code>disk.img.zst</code> を SD カードに焼けば実機で動かせると思います。</p>
<pre><code>$ zstdcat build/disk.img.zst | sudo dd of=/dev/sdX bs=1M status=progress</code></pre>
<h2 id="github-actions">GitHub Actions</h2>
<p>せっかく Vivado/Vitis を使うことなく (xsct-trim は使っていますが) ビルドできるようになったので、GitHub Actions 上でビルドするようにしてみました。ソフトウェアのパートに絞り、かつ GitHub Actions の設定は最低限のもののみであるとはいえ、あのバージョン管理ツールでさえ導入しにくさに定評のある Xilinx の開発環境を必要とするはずのものが GitHub Actions 上で動いているのは、Earthly 導入の副次効果であるとはいえ大きなことではないかと思います。</p>
<h2 id="今後なんとかしたいこと">今後なんとかしたいこと</h2>
<h3 id="デバッグ関連">デバッグ関連</h3>
<p>なんとかできるといいなと思っていることの1つがデバッグです。Earthly でビルドしたバイナリはデバッグシンボルに含まれるファイルパスがコンテナ内のものなので、ホスト側環境のデバッガー等に食わせるとちゃんと認識してくれません。GDB は <code>set substitute-path</code> でファイルパスの置換ができますが、Xilinx の XSDB はできません。単なるマイコンと違って FPGA の bitstream をロードだとかもできてほしいので、じゃあ GDB だけ使おうってわけにもいかないんです。</p>
<blockquote class="twitter-tweet tw-align-center" data-dnt="true">
<p lang="ja" dir="ltr">
なんか OpenOCD + GDB で Ultra96 の R5 で動いてるアプリのデバッグいけたっぽい <a href="https://t.co/EzRcJhCYyo" target="_blank" rel="nofollow noopener">pic.twitter.com/EzRcJhCYyo</a>
</p>
— ✧<em>。ヾ(｡ᐳ﹏ᐸ｡)ﾉﾞ。</em>✧ (@myon___) <a href="https://twitter.com/myon___/status/1564703405435928577?ref_src=twsrc%5Etfw" target="_blank" rel="nofollow noopener">August 30, 2022</a>
</blockquote>
<script async src="https://platform.twitter.com/widgets.js" charset="utf-8"></script>
<h3 id="ビルドをもっと速くしたい">ビルドをもっと速くしたい</h3>
<p>Earthly は、基本的に同じ入力に対するビルドは1回きりで、それ以降はキャッシュを使ってくれます。言い換えれば、何かしらのターゲットが依存するファイルを少しでも変更すれば、その影響を受けた箇所以降を <code>RUN</code> などのコマンド単位で再実行しなくてはいけません。今回の <code>Earthfile</code> だと、例えば Linux カーネルをビルドする <code>linux</code> ターゲットでそれが顕著に出てくると思います。コンフィグを変更しない限り<a href="/entry/2022/09/19/earthly-zynqmp/#fn5" class="footnote-ref" id="fnref5" role="doc-noteref"><sup>5</sup></a>リビルドは起きません。しかしコンフィグを1行だけでも書き換えたのなら、前回のビルド結果の再利用もなく <code>RUN make</code> からやり直しです。<code>RUN –-mount=type=cache</code> や <code>CACHE</code> コマンドを使って追加のキャッシュを設定すれば何とかできたりしますが、同時に制御しづらい状態に依存を作ってしまいます。使いどころがちょっと難しいのですよね<a href="/entry/2022/09/19/earthly-zynqmp/#fn6" class="footnote-ref" id="fnref6" role="doc-noteref"><sup>6</sup></a>。</p>
<p>もう一つビルド高速化に関連して、ターゲット内のビルド実行のジョブ数をどーやって決めるか問題があります。Earthly はターゲット間の依存関係に問題ない限り並列に実行してくれます。しかしターゲットのビルドに見込まれる時間やどれくらいの計算リソースが必要かなどはもちろん考慮してくれません。Earthly の並列実行を見込んでタスク内のジョブ数を減らせは (例えば1)、CPU が暇をしまくっているにもかかわらず時間のかかるターゲット1つだけがのんびり実行されることになったり。逆に <code>$(nproc)</code> などにすれば、一時的に CPU やメモリ、時にはディスクアクセスがすごいことになるのが十分に予想できます。今回は手抜きで <code>$(nproc)</code> を設定している箇所がいくつかあります。GitHub Actions でもメモリ不足で殺されることなく動いているようですし、<a href="/entry/2020/09/01/thinkpad-x13/">ThinkPad X13 Gen2</a> の 16GB RAM と約 6 GB のスワップという環境でも、一瞬スワップの使用量がグンと上がる程度でなんとかなっているのでまぁ許容範囲？です。ブラウザのタブをめっちゃ開いていたらいくつかクラッシュしちゃうかもですが。</p>
<h2 id="おわり">おわり</h2>
<p>Earthly という Build automation tool の紹介と、それを Zynq のソフトウェアプロジェクトに導入してみた例を紹介しました。Earthly が個々のソフトウェアのビルド方法自体は大きく変えなくてよく比較的簡単に導入できること、そしてコンテナ内でのビルドで様々な恩恵が得られることが伝わればと思います。Zynq に関しては、イマドキできて当たり前の開発ワークフローでさえ導入しづらく苦労していたものが、Earthly のおかげで随分と開発環境を改善できました。</p>
<h2 id="おまけ-内部実装いろいろ">おまけ: 内部実装いろいろ</h2>
<h3 id="zynq-ultrascale-の-ipi-をそのまま使う">Zynq UltraScale+ の IPI をそのまま使う</h3>
<p>今回の IPI の用途はとても単純なので、この文脈でよく出てくる libmetal や OpenAMP は使っていません。RPU は embeddedsw に含まれる <code>XIpiPsu</code> で、APU 側は Userspace I/O を介して IPI を直接操作しています。</p>
<p>IPI の基本操作 (主要レジスタ) は、割り込みの有効・無効 (<code>IER</code>, <code>IDR</code>)、IPI の Trigger (<code>TRIG</code>)、割り込みを受けたときのステータス確認とクリア (<code>ISR</code>)、割り込みを起こせたか・ターゲットがそれをクリアしたかの確認 (<code>OBS</code>) です。どの操作も、読み書きする値はターゲットの channel に対応するビットマスクです。今回の実装では、RPU 0 をデフォルトの channel 1 に, APU を channel 7 を割り当てました<a href="/entry/2022/09/19/earthly-zynqmp/#fn7" class="footnote-ref" id="fnref7" role="doc-noteref"><sup>7</sup></a>。ビットマスクはそれぞれ 8 bit 目と 24 bit 目がこれに対応します。</p>
<p>ということで、まずは embeddedsw の <code>XIpiPsu</code> を使った RPU 側アプリケーションの例です。<code>XIpiPsu</code> は、レジスタの操作ほぼそのままのインターフェイスを提供しているようです。<code>xparameters.h</code> には channel 7 に相当する <code>XPAR_XIPIPS_TARGET_PSU_CORTEXA53_0_CH0_MASK</code> のような定数がないので、コードのなかで定義しています。</p>
<div class="sourceCode" id="cb27"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb27-1"><a href="/entry/2022/09/19/earthly-zynqmp/#cb27-1" aria-hidden="true" tabindex="-1"></a><span class="kw">inline</span> <span class="kw">constexpr</span> <span class="bu">std::</span>uint32_t<span class="op"> </span>IPI_TRIG_CH7_MASK <span class="op">=</span> <span class="bu">std::</span>uint32_t<span class="op">{</span><span class="dv">1</span><span class="op">}</span> <span class="op">&lt;&lt;</span> <span class="dv">24</span><span class="op">;</span></span>
<span id="cb27-2"><a href="/entry/2022/09/19/earthly-zynqmp/#cb27-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-3"><a href="/entry/2022/09/19/earthly-zynqmp/#cb27-3" aria-hidden="true" tabindex="-1"></a>XIpiPsu ipi<span class="op">{};</span></span>
<span id="cb27-4"><a href="/entry/2022/09/19/earthly-zynqmp/#cb27-4" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb27-5"><a href="/entry/2022/09/19/earthly-zynqmp/#cb27-5" aria-hidden="true" tabindex="-1"></a>  <span class="kw">auto</span> cfg <span class="op">=</span> XIpiPsu_LookupConfig<span class="op">(</span>XPAR_PSU_IPI_1_DEVICE_ID<span class="op">);</span></span>
<span id="cb27-6"><a href="/entry/2022/09/19/earthly-zynqmp/#cb27-6" aria-hidden="true" tabindex="-1"></a>  XIpiPsu_CfgInitialize<span class="op">(&amp;</span>ipi<span class="op">,</span> cfg<span class="op">,</span> cfg<span class="op">-&gt;</span>BaseAddress<span class="op">);</span></span>
<span id="cb27-7"><a href="/entry/2022/09/19/earthly-zynqmp/#cb27-7" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb27-8"><a href="/entry/2022/09/19/earthly-zynqmp/#cb27-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-9"><a href="/entry/2022/09/19/earthly-zynqmp/#cb27-9" aria-hidden="true" tabindex="-1"></a>XIpiPsu_InterruptEnable<span class="op">(&amp;</span>ipi<span class="op">,</span> IPI_TRIG_CH7_MASK<span class="op">);</span>       <span class="co">// IER</span></span>
<span id="cb27-10"><a href="/entry/2022/09/19/earthly-zynqmp/#cb27-10" aria-hidden="true" tabindex="-1"></a>XIpiPsu_InterruptDisable<span class="op">(&amp;</span>ipi<span class="op">,</span> IPI_TRIG_CH7_MASK<span class="op">);</span>      <span class="co">// IDR</span></span>
<span id="cb27-11"><a href="/entry/2022/09/19/earthly-zynqmp/#cb27-11" aria-hidden="true" tabindex="-1"></a>XIpiPsu_TriggerIpi<span class="op">(&amp;</span>ipi<span class="op">,</span> IPI_TRIG_CH7_MASK<span class="op">);</span>            <span class="co">// TRIG</span></span>
<span id="cb27-12"><a href="/entry/2022/09/19/earthly-zynqmp/#cb27-12" aria-hidden="true" tabindex="-1"></a>XIpiPsu_ClearInterruptStatus<span class="op">(&amp;</span>ipi<span class="op">,</span> IPI_TRIG_CH7_MASK<span class="op">);</span>  <span class="co">// ISR write (clear)</span></span>
<span id="cb27-13"><a href="/entry/2022/09/19/earthly-zynqmp/#cb27-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-14"><a href="/entry/2022/09/19/earthly-zynqmp/#cb27-14" aria-hidden="true" tabindex="-1"></a>XIpiPsu_GetInterruptStatus<span class="op">(</span>ipi<span class="op">);</span>  <span class="co">// ISR read</span></span>
<span id="cb27-15"><a href="/entry/2022/09/19/earthly-zynqmp/#cb27-15" aria-hidden="true" tabindex="-1"></a>XIpiPsu_GetObsStatus<span class="op">(&amp;</span>ipi<span class="op">)</span>        <span class="co">// OBS</span></span></code></pre></div>
<p>続いて Linux 側です。IPI のレジスタを UIO で使えるように、カーネルは <code>CONFIG_UIO_PDRV_GENIRQ</code> を有効にしておきます。</p>
<pre><code>Device Drivers  ---&gt;
    &lt;*&gt; Userspace I/O drivers  ---&gt;
        &lt;M&gt;   Userspace I/O platform driver with generic IRQ handling</code></pre>
<p>そして Devicetree に UIO デバイスのノードを追加します。<code>compatible</code> や <code>uio_pdrv_genirq.of_id</code> に設定する文字列は、この界隈の慣習 (?) にならって <code>generic-uio</code> にしています。実際は何でもよいはずです。node-name も名前がかぶらなければ何でもよいと思います。一応 <a href="https://www.devicetree.org/specifications/" target="_blank" rel="nofollow noopener">Devicetree Specification</a> には Generic Names Recommendation というセクションがありますが、これに当てはまりそうなものはなさそうです。unit-address は対応するもののベースアドレスにしておくのが無難です。</p>
<div class="sourceCode" id="cb29"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb29-1"><a href="/entry/2022/09/19/earthly-zynqmp/#cb29-1" aria-hidden="true" tabindex="-1"></a><span class="op">/</span> <span class="op">{</span></span>
<span id="cb29-2"><a href="/entry/2022/09/19/earthly-zynqmp/#cb29-2" aria-hidden="true" tabindex="-1"></a>  ipi<span class="op">-</span>ctrl@ff340000 <span class="op">{</span></span>
<span id="cb29-3"><a href="/entry/2022/09/19/earthly-zynqmp/#cb29-3" aria-hidden="true" tabindex="-1"></a>    compatible <span class="op">=</span> <span class="st">&quot;generic-uio&quot;</span><span class="op">;</span></span>
<span id="cb29-4"><a href="/entry/2022/09/19/earthly-zynqmp/#cb29-4" aria-hidden="true" tabindex="-1"></a>    reg <span class="op">=</span> <span class="op">&lt;</span><span class="bn">0x0</span> <span class="bn">0xff340000</span> <span class="bn">0x0</span> <span class="bn">0x1000</span><span class="op">&gt;;</span></span>
<span id="cb29-5"><a href="/entry/2022/09/19/earthly-zynqmp/#cb29-5" aria-hidden="true" tabindex="-1"></a>    interrupt<span class="op">-</span>parent <span class="op">=</span> <span class="op">&lt;&amp;</span>gic<span class="op">&gt;;</span></span>
<span id="cb29-6"><a href="/entry/2022/09/19/earthly-zynqmp/#cb29-6" aria-hidden="true" tabindex="-1"></a>    interrupts <span class="op">=</span> <span class="op">&lt;</span><span class="dv">0</span> <span class="dv">29</span> <span class="dv">4</span><span class="op">&gt;;</span></span>
<span id="cb29-7"><a href="/entry/2022/09/19/earthly-zynqmp/#cb29-7" aria-hidden="true" tabindex="-1"></a>  <span class="op">};</span></span>
<span id="cb29-8"><a href="/entry/2022/09/19/earthly-zynqmp/#cb29-8" aria-hidden="true" tabindex="-1"></a><span class="op">};</span></span></code></pre></div>
<p>これで IPI のレジスタなどに <code>/dev/uioN</code> でアクセスできます。実際に操作するコードは例えばこんな感じです。まぁ UIO で見えるようになったレジスタに対して値を読み書きするだけですね。</p>
<div class="sourceCode" id="cb30"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb30-1"><a href="/entry/2022/09/19/earthly-zynqmp/#cb30-1" aria-hidden="true" tabindex="-1"></a><span class="kw">inline</span> <span class="kw">constexpr</span> <span class="bu">std::</span>size_t<span class="op"> </span>IPI_TRIG <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> <span class="co">// Interrupt Trigger</span></span>
<span id="cb30-2"><a href="/entry/2022/09/19/earthly-zynqmp/#cb30-2" aria-hidden="true" tabindex="-1"></a><span class="kw">inline</span> <span class="kw">constexpr</span> <span class="bu">std::</span>size_t<span class="op"> </span>IPI_OBS <span class="op">=</span> <span class="dv">1</span><span class="op">;</span>  <span class="co">// Interrupt Observation</span></span>
<span id="cb30-3"><a href="/entry/2022/09/19/earthly-zynqmp/#cb30-3" aria-hidden="true" tabindex="-1"></a><span class="kw">inline</span> <span class="kw">constexpr</span> <span class="bu">std::</span>size_t<span class="op"> </span>IPI_ISR <span class="op">=</span> <span class="dv">4</span><span class="op">;</span>  <span class="co">// Interrupt Status and Clear</span></span>
<span id="cb30-4"><a href="/entry/2022/09/19/earthly-zynqmp/#cb30-4" aria-hidden="true" tabindex="-1"></a><span class="kw">inline</span> <span class="kw">constexpr</span> <span class="bu">std::</span>size_t<span class="op"> </span>IPI_IMR <span class="op">=</span> <span class="dv">5</span><span class="op">;</span>  <span class="co">// Interrupt Mask</span></span>
<span id="cb30-5"><a href="/entry/2022/09/19/earthly-zynqmp/#cb30-5" aria-hidden="true" tabindex="-1"></a><span class="kw">inline</span> <span class="kw">constexpr</span> <span class="bu">std::</span>size_t<span class="op"> </span>IPI_IER <span class="op">=</span> <span class="dv">6</span><span class="op">;</span>  <span class="co">// Interrupt Enable</span></span>
<span id="cb30-6"><a href="/entry/2022/09/19/earthly-zynqmp/#cb30-6" aria-hidden="true" tabindex="-1"></a><span class="kw">inline</span> <span class="kw">constexpr</span> <span class="bu">std::</span>size_t<span class="op"> </span>IPI_IDR <span class="op">=</span> <span class="dv">7</span><span class="op">;</span>  <span class="co">// Interrupt Disable</span></span>
<span id="cb30-7"><a href="/entry/2022/09/19/earthly-zynqmp/#cb30-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-8"><a href="/entry/2022/09/19/earthly-zynqmp/#cb30-8" aria-hidden="true" tabindex="-1"></a><span class="kw">inline</span> <span class="kw">constexpr</span> <span class="bu">std::</span>uint32_t<span class="op"> </span>IPI_TRIG_RPU0_MASK <span class="op">=</span> <span class="bu">std::</span>uint32_t<span class="op">{</span><span class="dv">1</span><span class="op">}</span> <span class="op">&lt;&lt;</span> <span class="dv">8</span><span class="op">;</span></span>
<span id="cb30-9"><a href="/entry/2022/09/19/earthly-zynqmp/#cb30-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-10"><a href="/entry/2022/09/19/earthly-zynqmp/#cb30-10" aria-hidden="true" tabindex="-1"></a><span class="dt">int</span> fd <span class="op">=</span> <span class="op">::</span>open<span class="op">(</span><span class="st">&quot;/dev/uioN&quot;</span><span class="op">,</span> O_RDWR <span class="op">|</span> O_CLOEXEC<span class="op">);</span></span>
<span id="cb30-11"><a href="/entry/2022/09/19/earthly-zynqmp/#cb30-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-12"><a href="/entry/2022/09/19/earthly-zynqmp/#cb30-12" aria-hidden="true" tabindex="-1"></a><span class="kw">auto</span> reg <span class="op">=</span> <span class="kw">static_cast</span><span class="op">&lt;</span><span class="bu">std::</span>uint32_t<span class="op">*&gt;(</span></span>
<span id="cb30-13"><a href="/entry/2022/09/19/earthly-zynqmp/#cb30-13" aria-hidden="true" tabindex="-1"></a>    <span class="op">::</span>mmap<span class="op">(</span><span class="kw">nullptr</span><span class="op">,</span> mapsize<span class="op">,</span> PROT_READ <span class="op">|</span> PROT_WRITE<span class="op">,</span> MAP_SHARED<span class="op">,</span> fd<span class="op">,</span> <span class="dv">0</span><span class="op">));</span></span>
<span id="cb30-14"><a href="/entry/2022/09/19/earthly-zynqmp/#cb30-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-15"><a href="/entry/2022/09/19/earthly-zynqmp/#cb30-15" aria-hidden="true" tabindex="-1"></a>reg<span class="op">[</span>IPI_IER<span class="op">]</span> <span class="op">=</span> IPI_TRIG_RPU0_MASK<span class="op">;</span>   <span class="co">// IER</span></span>
<span id="cb30-16"><a href="/entry/2022/09/19/earthly-zynqmp/#cb30-16" aria-hidden="true" tabindex="-1"></a>reg<span class="op">[</span>IPI_IDR<span class="op">]</span> <span class="op">=</span> IPI_TRIG_RPU0_MASK<span class="op">;</span>   <span class="co">// IDR</span></span>
<span id="cb30-17"><a href="/entry/2022/09/19/earthly-zynqmp/#cb30-17" aria-hidden="true" tabindex="-1"></a>reg<span class="op">[</span>IPI_TRIG<span class="op">]</span> <span class="op">=</span> IPI_TRIG_RPU0_MASK<span class="op">;</span>  <span class="co">// TRIG</span></span>
<span id="cb30-18"><a href="/entry/2022/09/19/earthly-zynqmp/#cb30-18" aria-hidden="true" tabindex="-1"></a>reg<span class="op">[</span>IPI_ISR<span class="op">]</span> <span class="op">=</span> IPI_TRIG_RPU0_MASK<span class="op">;</span>   <span class="co">// ISR write (clear)</span></span>
<span id="cb30-19"><a href="/entry/2022/09/19/earthly-zynqmp/#cb30-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-20"><a href="/entry/2022/09/19/earthly-zynqmp/#cb30-20" aria-hidden="true" tabindex="-1"></a><span class="at">const</span> <span class="kw">auto</span> isr <span class="op">=</span> reg<span class="op">[</span>IPI_ISR<span class="op">];</span>  <span class="co">// ISR read</span></span>
<span id="cb30-21"><a href="/entry/2022/09/19/earthly-zynqmp/#cb30-21" aria-hidden="true" tabindex="-1"></a><span class="at">const</span> <span class="kw">auto</span> obs <span class="op">=</span> reg<span class="op">[</span>IPI_OBS<span class="op">];</span>  <span class="co">// OBS</span></span></code></pre></div>
<p>UIO を使った場合の割り込みはちょっとおもしろいです。<code>open</code> したときの file descriptor に1 (non-zero value) を <code>write</code> すると、割り込みが来たタイミングで <code>read</code> が返ってくるというインターフェイスになっています。読み出した値は使っていませんが、カーネルの実装を見た感じでは割り込み毎に増えていくカウンタのようですね。</p>
<div class="sourceCode" id="cb31"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb31-1"><a href="/entry/2022/09/19/earthly-zynqmp/#cb31-1" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> <span class="op">(;;)</span> <span class="op">{</span></span>
<span id="cb31-2"><a href="/entry/2022/09/19/earthly-zynqmp/#cb31-2" aria-hidden="true" tabindex="-1"></a>  <span class="bu">std::</span>uint32_t<span class="op"> </span>irq <span class="op">=</span> <span class="dv">1</span><span class="op">;</span></span>
<span id="cb31-3"><a href="/entry/2022/09/19/earthly-zynqmp/#cb31-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-4"><a href="/entry/2022/09/19/earthly-zynqmp/#cb31-4" aria-hidden="true" tabindex="-1"></a>  <span class="co">// 次の read() で割り込みを受け取る</span></span>
<span id="cb31-5"><a href="/entry/2022/09/19/earthly-zynqmp/#cb31-5" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> <span class="op">(::</span>write<span class="op">(</span>fd <span class="op">&amp;</span>irq<span class="op">,</span> <span class="kw">sizeof</span> irq<span class="op">)</span> <span class="op">&lt;</span> <span class="dv">0</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb31-6"><a href="/entry/2022/09/19/earthly-zynqmp/#cb31-6" aria-hidden="true" tabindex="-1"></a>    <span class="bu">std::</span>perror<span class="op">(</span><span class="st">&quot;write&quot;</span><span class="op">);</span></span>
<span id="cb31-7"><a href="/entry/2022/09/19/earthly-zynqmp/#cb31-7" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="op">-</span><span class="dv">1</span><span class="op">;</span></span>
<span id="cb31-8"><a href="/entry/2022/09/19/earthly-zynqmp/#cb31-8" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb31-9"><a href="/entry/2022/09/19/earthly-zynqmp/#cb31-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-10"><a href="/entry/2022/09/19/earthly-zynqmp/#cb31-10" aria-hidden="true" tabindex="-1"></a>  <span class="co">// 割り込みを待つ</span></span>
<span id="cb31-11"><a href="/entry/2022/09/19/earthly-zynqmp/#cb31-11" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> <span class="op">(::</span>read<span class="op">(</span>fd<span class="op">,</span> <span class="op">&amp;</span>irq<span class="op">,</span> <span class="kw">sizeof</span> irq<span class="op">)</span> <span class="op">&lt;</span> <span class="dv">0</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb31-12"><a href="/entry/2022/09/19/earthly-zynqmp/#cb31-12" aria-hidden="true" tabindex="-1"></a>    <span class="bu">std::</span>perror<span class="op">(</span><span class="st">&quot;read&quot;</span><span class="op">);</span></span>
<span id="cb31-13"><a href="/entry/2022/09/19/earthly-zynqmp/#cb31-13" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="op">-</span><span class="dv">1</span><span class="op">;</span></span>
<span id="cb31-14"><a href="/entry/2022/09/19/earthly-zynqmp/#cb31-14" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb31-15"><a href="/entry/2022/09/19/earthly-zynqmp/#cb31-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-16"><a href="/entry/2022/09/19/earthly-zynqmp/#cb31-16" aria-hidden="true" tabindex="-1"></a>  <span class="co">// 割り込みクリア</span></span>
<span id="cb31-17"><a href="/entry/2022/09/19/earthly-zynqmp/#cb31-17" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> <span class="op">(</span>reg<span class="op">[</span>IPI_ISR<span class="op">]</span> <span class="op">&amp;</span> IPI_TRIG_RPU0_MASK<span class="op">)</span> <span class="op">{</span></span>
<span id="cb31-18"><a href="/entry/2022/09/19/earthly-zynqmp/#cb31-18" aria-hidden="true" tabindex="-1"></a>    reg<span class="op">[</span>IPI_ISR<span class="op">]</span> <span class="op">=</span> IPI_TRIG_RPU0_MASK<span class="op">;</span></span>
<span id="cb31-19"><a href="/entry/2022/09/19/earthly-zynqmp/#cb31-19" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb31-20"><a href="/entry/2022/09/19/earthly-zynqmp/#cb31-20" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>さて、これで互いに IPI を飛ばせるようになりました。では IPI を飛ばしたタイミングで何かしらのデータをやりとりしたい場合はどうするかです。今回は <a href="https://docs.xilinx.com/v/u/en-US/ug1085-zynq-ultrascale-trm" target="_blank" rel="nofollow noopener">Technical Reference Manual (TRM, UG1085)</a> の IPI と同じ場所で言及されている Message Buffer を使いました。Message Buffer は、IPI の requester/responder の組み合わせ1つあたりに request/response それぞれ 32 byte が確保されたメモリ空間です。IPI を使うプロセッサなど (TRM の言葉だと Agent) は8つあるので、Agent 毎に 0x20 * 2 * 8 = 0x200 byte ですね。</p>
<p>この Message Buffer の厄介なところが、ある IPI の request/response でどこを使えばいいのかがわかりにくいところです。channel と buffer index がとてもまぎらわしいし、おまけに TRM に書いてあるアドレスと <code>xparameters.h</code> の値がなんか違う気がします。今回の構成における値を<code>xparameters.h</code> の値をもとに表にしてみました。環境・構成によっては変わってくるかもしれないことに注意です。</p>
<table>
<thead>
<tr class="header">
<th>Channel Number</th>
<th>Owner</th>
<th>Message Buffer Index</th>
<th>Address</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td>Channel 0</td>
<td>APU</td>
<td>2</td>
<td><code>0xff99&#39;0400</code></td>
</tr>
<tr class="even">
<td>Channel 1</td>
<td>RPU 0</td>
<td>0</td>
<td><code>0xff99&#39;0000</code></td>
</tr>
<tr class="odd">
<td>Channel 2</td>
<td>RPU 1</td>
<td>1</td>
<td><code>0xff99&#39;0200</code></td>
</tr>
<tr class="even">
<td>Channel 3</td>
<td>PMU</td>
<td>7</td>
<td><code>0xff99&#39;0e00</code></td>
</tr>
<tr class="odd">
<td>Channel 4</td>
<td>PMU</td>
<td>7</td>
<td></td>
</tr>
<tr class="even">
<td>Channel 5</td>
<td>PMU</td>
<td>7</td>
<td></td>
</tr>
<tr class="odd">
<td>Channel 6</td>
<td>PMU</td>
<td>7</td>
<td></td>
</tr>
<tr class="even">
<td>Channel 7</td>
<td>PL 0</td>
<td>3</td>
<td><code>0xff99&#39;0600</code></td>
</tr>
<tr class="odd">
<td>Channel 8</td>
<td>PL 1</td>
<td>4</td>
<td><code>0xff99&#39;0800</code></td>
</tr>
<tr class="even">
<td>Channel 9</td>
<td>PL 2</td>
<td>5</td>
<td><code>0xff99&#39;0a00</code></td>
</tr>
<tr class="odd">
<td>Channel 10</td>
<td>PL 3</td>
<td>6</td>
<td><code>0xff99&#39;0c00</code></td>
</tr>
</tbody>
</table>
<p>0x200 byte の領域の区切られ方も buffer index 順です。ということで RPU 0 (ch 1, idx 0) -&gt; APU (ch 7, idx 3) の IPI では <code>0xff99&#39;00c0</code> と <code>0xff99&#39;00e0</code>、APU -&gt; RPU 0 の IPI では <code>0xff99&#39;0600</code> と <code>0xff99&#39;0620</code> を使えばいいことがわかります。Linux の場合は Devicetree にこんな感じの設定をし、IPI レジスタと同様 <code>mmap</code> した領域を介してアクセスできるようにしました。なお、実際に Message Buffer を使っているのは APU から RPU に IPI するときだけです。</p>
<div class="sourceCode" id="cb32"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb32-1"><a href="/entry/2022/09/19/earthly-zynqmp/#cb32-1" aria-hidden="true" tabindex="-1"></a><span class="op">/</span> <span class="op">{</span></span>
<span id="cb32-2"><a href="/entry/2022/09/19/earthly-zynqmp/#cb32-2" aria-hidden="true" tabindex="-1"></a>  ipi<span class="op">-</span>buffer@ff990000 <span class="op">{</span></span>
<span id="cb32-3"><a href="/entry/2022/09/19/earthly-zynqmp/#cb32-3" aria-hidden="true" tabindex="-1"></a>    compatible <span class="op">=</span> <span class="st">&quot;generic-uio&quot;</span><span class="op">;</span></span>
<span id="cb32-4"><a href="/entry/2022/09/19/earthly-zynqmp/#cb32-4" aria-hidden="true" tabindex="-1"></a>    reg <span class="op">=</span> <span class="op">&lt;</span><span class="bn">0x0</span> <span class="bn">0xff990600</span> <span class="bn">0x0</span> <span class="bn">0x20</span><span class="op">&gt;,</span> <span class="co">// APU -&gt; RPU0 request</span></span>
<span id="cb32-5"><a href="/entry/2022/09/19/earthly-zynqmp/#cb32-5" aria-hidden="true" tabindex="-1"></a>          <span class="op">&lt;</span><span class="bn">0x0</span> <span class="bn">0xff990620</span> <span class="bn">0x0</span> <span class="bn">0x20</span><span class="op">&gt;,</span> <span class="co">// RPU0 -&gt; APU response</span></span>
<span id="cb32-6"><a href="/entry/2022/09/19/earthly-zynqmp/#cb32-6" aria-hidden="true" tabindex="-1"></a>          <span class="op">&lt;</span><span class="bn">0x0</span> <span class="bn">0xff9900c0</span> <span class="bn">0x0</span> <span class="bn">0x20</span><span class="op">&gt;,</span> <span class="co">// RPU0 -&gt; APU request</span></span>
<span id="cb32-7"><a href="/entry/2022/09/19/earthly-zynqmp/#cb32-7" aria-hidden="true" tabindex="-1"></a>          <span class="op">&lt;</span><span class="bn">0x0</span> <span class="bn">0xff9900e0</span> <span class="bn">0x0</span> <span class="bn">0x20</span><span class="op">&gt;;</span> <span class="co">// APU -&gt; RPU0 response</span></span>
<span id="cb32-8"><a href="/entry/2022/09/19/earthly-zynqmp/#cb32-8" aria-hidden="true" tabindex="-1"></a>  <span class="op">};</span></span>
<span id="cb32-9"><a href="/entry/2022/09/19/earthly-zynqmp/#cb32-9" aria-hidden="true" tabindex="-1"></a><span class="op">};</span></span></code></pre></div>
<h3 id="l-チカを支える-ttc">L チカを支える TTC</h3>
<p>RPU から使えるタイマー・カウンターとして、LPD にある4つの Triple-timer counter (TTC) があります。今回はこのうちの1つを 10 Hz で割り込みが飛ぶようにして L チカのタイミング制御に使っています。</p>
<p>TTC は名前の通り、3つのカウンターを持つユニットです。それが4つあるので合計12個のカウンターがあることになります。<code>xparameters.h</code> では、1つ目の TTC が持つカウンターから順に <code>XPAR_PSU_TTC_0_*</code>, <code>XPAR_PSU_TTC_1_*</code>, …, <code>XPAR_PSU_TTC_12_*</code> と名前が付いています。ちょっとまぎらわしいので注意です。また XSCT で BSP を作ったときに出力されるメッセージや <code>xparameters.h</code> の記述にある通り、カウンターの1つは <code>sleep</code> などの実装に使われるようなので、実際に使えるカウンターは11個です。</p>
<pre><code>+generate-src | psu_ttc_3 will be used in sleep routines for delay generation</code></pre>
<p>今回は <code>xparameters.h</code> の <code>XPAR_PSU_TTC_0</code>、つまり TTC0 の1つ目のカウンターを使いました。10 Hz の Interval Mode で割り込みを設定するならこんな感じです。ちなみに、デバッグなどで実行中のアプリケーションを何度もロードし直すことも想定した場合、<code>XTtcPs_CfgInitialize()</code> の前にレジスタを直接操作するなどで TTC を無理やり無効化するなどの処理を入れるのがいいと思います。もしこのタイミングで TTC が動いていた場合、<a href="https://github.com/Xilinx/embeddedsw/blob/b3d8b420b421730ea505da55b42174dc90f885c1/XilinxProcessorIPLib/drivers/ttcps/src/xttcps.c#L121-L127" target="_blank" rel="nofollow noopener"><code>XTtcPs_CfgInitialize()</code> がエラーを返してしまう</a>ためです。</p>
<div class="sourceCode" id="cb34"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb34-1"><a href="/entry/2022/09/19/earthly-zynqmp/#cb34-1" aria-hidden="true" tabindex="-1"></a><span class="at">static</span> <span class="dt">void</span> ttc_irq_handler<span class="op">(</span><span class="dt">void</span><span class="op">*</span> data<span class="op">)</span> <span class="kw">noexcept</span> <span class="op">{</span></span>
<span id="cb34-2"><a href="/entry/2022/09/19/earthly-zynqmp/#cb34-2" aria-hidden="true" tabindex="-1"></a>  <span class="kw">auto</span> ttc <span class="op">=</span> <span class="kw">static_cast</span><span class="op">&lt;</span>XTtcPs<span class="op">*&gt;(</span>data<span class="op">);</span></span>
<span id="cb34-3"><a href="/entry/2022/09/19/earthly-zynqmp/#cb34-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">const</span> <span class="kw">auto</span> status <span class="op">=</span> XTtcPs_GetInterruptStatus<span class="op">(</span>ttc<span class="op">);</span></span>
<span id="cb34-4"><a href="/entry/2022/09/19/earthly-zynqmp/#cb34-4" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> <span class="op">(</span>status <span class="op">&amp;</span> XTTCPS_IXR_INTERVAL_MASK<span class="op">)</span> <span class="op">{</span></span>
<span id="cb34-5"><a href="/entry/2022/09/19/earthly-zynqmp/#cb34-5" aria-hidden="true" tabindex="-1"></a>    <span class="co">// ...</span></span>
<span id="cb34-6"><a href="/entry/2022/09/19/earthly-zynqmp/#cb34-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-7"><a href="/entry/2022/09/19/earthly-zynqmp/#cb34-7" aria-hidden="true" tabindex="-1"></a>    XTtcPs_ClearInterruptStatus<span class="op">(</span>ttc<span class="op">,</span> XTTCPS_IXR_INTERVAL_MASK<span class="op">);</span></span>
<span id="cb34-8"><a href="/entry/2022/09/19/earthly-zynqmp/#cb34-8" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb34-9"><a href="/entry/2022/09/19/earthly-zynqmp/#cb34-9" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb34-10"><a href="/entry/2022/09/19/earthly-zynqmp/#cb34-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-11"><a href="/entry/2022/09/19/earthly-zynqmp/#cb34-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-12"><a href="/entry/2022/09/19/earthly-zynqmp/#cb34-12" aria-hidden="true" tabindex="-1"></a>XTtcPs ttc<span class="op">{};</span></span>
<span id="cb34-13"><a href="/entry/2022/09/19/earthly-zynqmp/#cb34-13" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb34-14"><a href="/entry/2022/09/19/earthly-zynqmp/#cb34-14" aria-hidden="true" tabindex="-1"></a>  <span class="kw">auto</span> cfg <span class="op">=</span> XTtcPs_LookupConfig<span class="op">(</span>XPAR_PSU_TTC_0_DEVICE_ID<span class="op">);</span></span>
<span id="cb34-15"><a href="/entry/2022/09/19/earthly-zynqmp/#cb34-15" aria-hidden="true" tabindex="-1"></a>  XTtcPs_CfgInitialize<span class="op">(&amp;</span>ttc<span class="op">,</span> cfg<span class="op">,</span> cfg<span class="op">-&gt;</span>BaseAddress<span class="op">);</span></span>
<span id="cb34-16"><a href="/entry/2022/09/19/earthly-zynqmp/#cb34-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-17"><a href="/entry/2022/09/19/earthly-zynqmp/#cb34-17" aria-hidden="true" tabindex="-1"></a>  XTtcPs_SetOptions<span class="op">(&amp;</span>ttc<span class="op">,</span> XTTCPS_OPTION_INTERVAL_MODE <span class="op">|</span> XTTCPS_OPTION_WAVE_DISABLE<span class="op">);</span></span>
<span id="cb34-18"><a href="/entry/2022/09/19/earthly-zynqmp/#cb34-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-19"><a href="/entry/2022/09/19/earthly-zynqmp/#cb34-19" aria-hidden="true" tabindex="-1"></a>  XInterval interval<span class="op">;</span></span>
<span id="cb34-20"><a href="/entry/2022/09/19/earthly-zynqmp/#cb34-20" aria-hidden="true" tabindex="-1"></a>  <span class="bu">std::</span>uint8_t<span class="op"> </span>prescaler<span class="op">;</span></span>
<span id="cb34-21"><a href="/entry/2022/09/19/earthly-zynqmp/#cb34-21" aria-hidden="true" tabindex="-1"></a>  XTtcPs_CalcIntervalFromFreq<span class="op">(&amp;</span>ttc<span class="op">,</span> <span class="dv">10</span><span class="op">,</span> <span class="op">&amp;</span>interval<span class="op">,</span> <span class="op">&amp;</span>prescaler<span class="op">);</span> <span class="co">// 10 Hz</span></span>
<span id="cb34-22"><a href="/entry/2022/09/19/earthly-zynqmp/#cb34-22" aria-hidden="true" tabindex="-1"></a>  XTtcPs_SetInterval<span class="op">(&amp;</span>ttc<span class="op">,</span> interval<span class="op">);</span></span>
<span id="cb34-23"><a href="/entry/2022/09/19/earthly-zynqmp/#cb34-23" aria-hidden="true" tabindex="-1"></a>  XTtcPs_SetPrescaler<span class="op">(&amp;</span>ttc<span class="op">,</span> prescaler<span class="op">);</span></span>
<span id="cb34-24"><a href="/entry/2022/09/19/earthly-zynqmp/#cb34-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-25"><a href="/entry/2022/09/19/earthly-zynqmp/#cb34-25" aria-hidden="true" tabindex="-1"></a>  XTtcPs_EnableInterrupts<span class="op">(&amp;</span>ttc<span class="op">,</span> XTTCPS_IXR_INTERVAL_MASK<span class="op">);</span></span>
<span id="cb34-26"><a href="/entry/2022/09/19/earthly-zynqmp/#cb34-26" aria-hidden="true" tabindex="-1"></a>  XTtcPs_ClearInterruptStatus<span class="op">(&amp;</span>ttc<span class="op">,</span> XTTCPS_IXR_ALL_MASK<span class="op">);</span></span>
<span id="cb34-27"><a href="/entry/2022/09/19/earthly-zynqmp/#cb34-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-28"><a href="/entry/2022/09/19/earthly-zynqmp/#cb34-28" aria-hidden="true" tabindex="-1"></a>  XScuGic_Connect<span class="op">(&amp;</span>gic<span class="op">,</span> XPAR_PSU_TTC_0_INTR<span class="op">,</span> ttc_irq_handler<span class="op">,</span> <span class="op">&amp;</span>ttc<span class="op">);</span></span>
<span id="cb34-29"><a href="/entry/2022/09/19/earthly-zynqmp/#cb34-29" aria-hidden="true" tabindex="-1"></a>  XScuGic_Enable<span class="op">(&amp;</span>gic<span class="op">,</span> XPAR_PSU_TTC_0_INTR<span class="op">);</span></span>
<span id="cb34-30"><a href="/entry/2022/09/19/earthly-zynqmp/#cb34-30" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h3 id="ps-gpio-の任意の複数ピンを同時に扱う">PS GPIO の任意の複数ピンを同時に扱う</h3>
<p>ほかに RPU から使っているのは GPIO です。Ultra96 の LED は <code>PS_MIO{17, ..., 20}</code> につながっているので <code>XGpioPs</code> を使います。</p>
<p>GPIO の操作というと、ピン単位かポートやバンクなどと呼ばれるまとまった単位で操作するのが一般的だと思います。<code>XGpioPs</code> も、<code>XGpioPs_Read()</code>, <code>XGpioPs_Write()</code> などバンク単位での操作と、<code>XGpioPs_ReadPin()</code>, <code>XGpioPs_WritePin()</code> などピン単位の操作が C の関数として定義されています。LED 4つを一度に操作するなら、ちょうどそれらが同じバンクにあるので、例えばこんな感じにかけそうです。</p>
<div class="sourceCode" id="cb35"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb35-1"><a href="/entry/2022/09/19/earthly-zynqmp/#cb35-1" aria-hidden="true" tabindex="-1"></a><span class="kw">inline</span> <span class="kw">constexpr</span> <span class="bu">std::</span>uint32_t<span class="op"> </span>GPIO_BANK0_LED_MASK <span class="op">=</span> <span class="bu">std::</span>uint32_t<span class="op">{</span><span class="bn">0b1111</span><span class="op">}</span> <span class="op">&lt;&lt;</span> <span class="dv">17</span><span class="op">;</span></span>
<span id="cb35-2"><a href="/entry/2022/09/19/earthly-zynqmp/#cb35-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-3"><a href="/entry/2022/09/19/earthly-zynqmp/#cb35-3" aria-hidden="true" tabindex="-1"></a><span class="kw">inline</span> <span class="dt">void</span> set_ultra96_leds<span class="op">(</span>XGpioPs<span class="op">&amp;</span> gpio<span class="op">,</span> <span class="bu">std::</span>uint8_t<span class="op"> </span>value<span class="op">)</span> <span class="kw">noexcept</span> <span class="op">{</span></span>
<span id="cb35-4"><a href="/entry/2022/09/19/earthly-zynqmp/#cb35-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">const</span> <span class="kw">auto</span> r <span class="op">=</span> XGpioPs_Read<span class="op">(&amp;</span>gpio<span class="op">,</span> <span class="dv">0</span><span class="op">);</span></span>
<span id="cb35-5"><a href="/entry/2022/09/19/earthly-zynqmp/#cb35-5" aria-hidden="true" tabindex="-1"></a>  XGpioPs_Write<span class="op">(&amp;</span>gpio<span class="op">,</span> <span class="dv">0</span><span class="op">,</span> <span class="op">(</span>r <span class="op">&amp;</span> <span class="op">~</span>GPIO_BANK0_LED_MASK<span class="op">)</span> <span class="op">|</span> <span class="op">((</span>value <span class="op">*</span> <span class="bn">0b1111</span><span class="op">)</span> <span class="op">&lt;&lt;</span> <span class="dv">17</span><span class="op">));</span></span>
<span id="cb35-6"><a href="/entry/2022/09/19/earthly-zynqmp/#cb35-6" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>しかし、これだと一度 GPIO の値を読み出しているのがなんだかもにょっとします。また、<code>XGpioPs_Write()</code> がそのバンク全体に影響する操作なのもちょっとこわいです。特に APU で動いている Linux も GPIO を触れる状況にあるので、(実際に bank 0 を使うものはいないはずですが) 互いの処理の実行され方によっては整合性が取れなくなってしまうかもしれません。もちろん、そんな状況が想定される設計にしないに越したことはありませんが、いずれにせよ Zynq という同じメモリ空間を複数のプロセッサなどが共有している環境では注意しておくべきです<a href="/entry/2022/09/19/earthly-zynqmp/#fn8" class="footnote-ref" id="fnref8" role="doc-noteref"><sup>8</sup></a>。</p>
<p>どうしたものかと TRM などを眺めていると、<code>MASK_DATA_{LSW,MSW}</code> というレジスタがあるのに気づきます。これは各バンクに属する下 16 bit・上 10 bit に対し、一度にビットマスクとデータを渡すことで特定のピンだけの出力を指定できるようです。まさに探していたものですね。<code>PS_MIO{17, ..., 20}</code> は bank 0 の上位10 bit の枠になるので、<code>MASK_DATA_0_MSW</code> に対してこんな感じにしてやればいいですね。</p>
<div class="sourceCode" id="cb36"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb36-1"><a href="/entry/2022/09/19/earthly-zynqmp/#cb36-1" aria-hidden="true" tabindex="-1"></a><span class="kw">inline</span> <span class="kw">constexpr</span> <span class="bu">std::</span>uint32_t<span class="op"> </span>GPIO_BANK0_LED_MASK <span class="op">=</span> <span class="bu">std::</span>uint32_t<span class="op">{</span><span class="bn">0b1111</span><span class="op">}</span> <span class="op">&lt;&lt;</span> <span class="dv">17</span><span class="op">;</span></span>
<span id="cb36-2"><a href="/entry/2022/09/19/earthly-zynqmp/#cb36-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-3"><a href="/entry/2022/09/19/earthly-zynqmp/#cb36-3" aria-hidden="true" tabindex="-1"></a><span class="kw">inline</span> <span class="dt">void</span> set_ultra96_leds<span class="op">(</span>XGpioPs<span class="op">&amp;</span> gpio<span class="op">,</span> <span class="bu">std::</span>uint8_t<span class="op"> </span>value<span class="op">)</span> <span class="kw">noexcept</span> <span class="op">{</span></span>
<span id="cb36-4"><a href="/entry/2022/09/19/earthly-zynqmp/#cb36-4" aria-hidden="true" tabindex="-1"></a>  XGpioPs_WriteReg<span class="op">(</span></span>
<span id="cb36-5"><a href="/entry/2022/09/19/earthly-zynqmp/#cb36-5" aria-hidden="true" tabindex="-1"></a>    gpio<span class="op">.</span>GpioConfig<span class="op">.</span>BaseAddr<span class="op">,</span> XGPIOPS_DATA_MSW_OFFSET<span class="op">,</span></span>
<span id="cb36-6"><a href="/entry/2022/09/19/earthly-zynqmp/#cb36-6" aria-hidden="true" tabindex="-1"></a>    <span class="co">// MASK_DATA_0_MSW の上位 16 bit はマスク</span></span>
<span id="cb36-7"><a href="/entry/2022/09/19/earthly-zynqmp/#cb36-7" aria-hidden="true" tabindex="-1"></a>    <span class="co">// `PS_MIO{17, ..., 20}` 以外に対応するものを 1 にする</span></span>
<span id="cb36-8"><a href="/entry/2022/09/19/earthly-zynqmp/#cb36-8" aria-hidden="true" tabindex="-1"></a>    <span class="op">(~</span>GPIO_BANK0_LED_MASK <span class="op">&amp;</span> <span class="bn">0xffff0000</span><span class="op">)</span> <span class="op">|</span></span>
<span id="cb36-9"><a href="/entry/2022/09/19/earthly-zynqmp/#cb36-9" aria-hidden="true" tabindex="-1"></a>    <span class="co">// `PS_MIO{17, ..., 20}` に設定する値</span></span>
<span id="cb36-10"><a href="/entry/2022/09/19/earthly-zynqmp/#cb36-10" aria-hidden="true" tabindex="-1"></a>    <span class="op">((</span>value <span class="op">&amp;</span> <span class="bn">0b1111</span><span class="op">)</span> <span class="op">&lt;&lt;</span> <span class="dv">1</span><span class="op">)</span></span>
<span id="cb36-11"><a href="/entry/2022/09/19/earthly-zynqmp/#cb36-11" aria-hidden="true" tabindex="-1"></a>  <span class="op">);</span></span>
<span id="cb36-12"><a href="/entry/2022/09/19/earthly-zynqmp/#cb36-12" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h3 id="vitis-で作ったベアメタルアプリケーションを-cmake-でビルドする">Vitis で作ったベアメタルアプリケーションを CMake でビルドする</h3>
<p>上でちょろっと紹介したように、RPU 側アプリケーションの実装は Vitis で作った Appication Project からファイルを持ってきた上で CMake でビルドできるようにしたものです。<code>main.cc</code> 1つだけにわざわざ CMake を使わなくてよいですが、これをテンプレート的に別プロジェクトで使いまわすことを想定してのものです。</p>
<p>embeddedsw で提供されるいろいろを使うには、<code>libxil.a</code> などをリンクしなければいけません。<code>libxil.a</code> の検出とコンパイル・リンクのために、少々雑ではありますが <code>FindLibXil.cmake</code> を書きました。standalone 以外のライブラリも <code>find_package()</code> の <code>COMPONENTS</code> で指定できるようになっています。各ライブラリに対応するターゲットは、<code>add_library(LibXil::standalone INTERFACE IMPORTED)</code> のように <code>INTERFACE IMPORTED</code> で宣言しています。よくある <code>STATIC</code> や <code>UNKNOWN</code> でなく <code>INTERFACE</code> なのは、これらを単に <code>-l&lt;ほげほげ&gt;</code> でリンクできず、<code>--start-group,...,--end-group</code> でリンク順を明示してやらないといけないためです。続く <code>set_target_properties()</code> でそうしたリンクオプションを指定しています。</p>
<div class="sourceCode" id="cb37"><pre class="sourceCode cmake"><code class="sourceCode cmake"><span id="cb37-1"><a href="/entry/2022/09/19/earthly-zynqmp/#cb37-1" aria-hidden="true" tabindex="-1"></a><span class="kw">if</span>(<span class="dv">LibXil_standalone_FOUND</span> <span class="ot">AND</span> <span class="ot">NOT</span> <span class="ot">TARGET</span> <span class="bn">LibXil::standalone</span>)</span>
<span id="cb37-2"><a href="/entry/2022/09/19/earthly-zynqmp/#cb37-2" aria-hidden="true" tabindex="-1"></a>  <span class="kw">add_library</span>(<span class="bn">LibXil::standalone</span> <span class="ot">INTERFACE</span> <span class="ot">IMPORTED</span>)</span>
<span id="cb37-3"><a href="/entry/2022/09/19/earthly-zynqmp/#cb37-3" aria-hidden="true" tabindex="-1"></a>  <span class="kw">set_target_properties</span>(<span class="bn">LibXil::standalone</span> <span class="ot">PROPERTIES</span></span>
<span id="cb37-4"><a href="/entry/2022/09/19/earthly-zynqmp/#cb37-4" aria-hidden="true" tabindex="-1"></a>    <span class="ot">INTERFACE_LINK_LIBRARIES</span> <span class="st">&quot;-Wl,--start-group,</span><span class="dv">${standalone_lib}</span><span class="st">,-lgcc,-lc,-lstdc++,--end-group&quot;</span></span>
<span id="cb37-5"><a href="/entry/2022/09/19/earthly-zynqmp/#cb37-5" aria-hidden="true" tabindex="-1"></a>    <span class="ot">INTERFACE_INCLUDE_DIRECTORIES</span> <span class="st">&quot;</span><span class="dv">${standalone_include}</span><span class="st">&quot;</span>)</span>
<span id="cb37-6"><a href="/entry/2022/09/19/earthly-zynqmp/#cb37-6" aria-hidden="true" tabindex="-1"></a><span class="kw">endif</span>()</span></code></pre></div>
<p>ちなみに、各ライブラリをどの順でリンクすればいいのかは、embeddedsw の <code>.mld</code> ファイルで <code>OPTION APP_LINKER_FLAGS</code> を見ればよいです。例えば xilffs なら<a href="https://github.com/Xilinx/embeddedsw/blob/b3d8b420b421730ea505da55b42174dc90f885c1/lib/sw_services/xilffs/data/xilffs.mld#L22" target="_blank" rel="nofollow noopener">こんな行</a>があるのを見つけられると思います。</p>
<div class="sourceCode" id="cb38"><pre class="sourceCode tcl"><code class="sourceCode tcl"><span id="cb38-1"><a href="/entry/2022/09/19/earthly-zynqmp/#cb38-1" aria-hidden="true" tabindex="-1"></a>OPTION APP_LINKER_FLAGS = <span class="st">&quot;-Wl,--start-group,-lxilffs,-lxil,-lgcc,-lc,--end-group&quot;</span>;</span></code></pre></div>
<h3 id="isr-で-atomic-使うのって実際どうなの">ISR で atomic 使うのって実際どうなの</h3>
<p>割り込みハンドラーにたくさん実装を入れたくないので、「割り込みがあったかどうかのフラグ」を立てるなど最低限の処理だけにして、実際の処理はメインループの中でやる、という実装をしています。こうした「割り込みがあったかどうかのフラグ」などの割り込みハンドラーと共有する値は、コンパイラが意図しない最適化をしてしまわないように何かしらの対策をするのが一般的です。その値がコンパイラから見てどこか別のところから書き換えられることのない定数のように見えたとしても、実際には突発的に呼び出される割り込みハンドラーから書き換えられる可能性がるからコードの意味を変えないでね、と伝えてやるイメージです。</p>
<p>C/C++ の組み込みプログラミングでよく使われるのが <code>volatile</code> です。ただ <code>volatile</code> が何者なのか正直よくわからず、なんだか「とりあえず <code>volatile</code> 付けておけば安心！」に見えてしまうのでうーんです。その代替手段として <a href="https://en.cppreference.com/w/cpp/header/atomic" target="_blank" rel="nofollow noopener"><code>&lt;atomic&gt;</code></a> を試してみています。</p>
<p>一番単純な例が TTC 割り込みの部分です。<a href="https://en.cppreference.com/w/cpp/atomic/atomic_flag" target="_blank" rel="nofollow noopener"><code>std::atomic_flag</code></a> を使い、set を割り込み待ちの状態、clear を割り込みが起きた状態とします。メインループの中で <a href="https://en.cppreference.com/w/cpp/atomic/atomic_flag/test_and_set" target="_blank" rel="nofollow noopener"><code>test_and_set()</code></a> を呼び出し、その時点での値が clear された状態 (<code>false</code>) だったら割り込みに対する処理、という感じです。</p>
<div class="sourceCode" id="cb39"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb39-1"><a href="/entry/2022/09/19/earthly-zynqmp/#cb39-1" aria-hidden="true" tabindex="-1"></a><span class="at">static</span> <span class="bu">std::</span>atomic_flag<span class="op"> </span>ttc_irq_kicked_n <span class="op">=</span> ATOMIC_FLAG_INIT<span class="op">;</span></span>
<span id="cb39-2"><a href="/entry/2022/09/19/earthly-zynqmp/#cb39-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-3"><a href="/entry/2022/09/19/earthly-zynqmp/#cb39-3" aria-hidden="true" tabindex="-1"></a><span class="at">static</span> <span class="dt">void</span> ttc_irq_handler<span class="op">(</span><span class="dt">void</span><span class="op">*</span> data<span class="op">)</span> <span class="kw">noexcept</span> <span class="op">{</span></span>
<span id="cb39-4"><a href="/entry/2022/09/19/earthly-zynqmp/#cb39-4" aria-hidden="true" tabindex="-1"></a>  <span class="kw">auto</span> ttc <span class="op">=</span> <span class="kw">static_cast</span><span class="op">&lt;</span>XTtcPs<span class="op">*&gt;(</span>data<span class="op">);</span></span>
<span id="cb39-5"><a href="/entry/2022/09/19/earthly-zynqmp/#cb39-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">const</span> <span class="kw">auto</span> status <span class="op">=</span> XTtcPs_GetInterruptStatus<span class="op">(</span>ttc<span class="op">);</span></span>
<span id="cb39-6"><a href="/entry/2022/09/19/earthly-zynqmp/#cb39-6" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> <span class="op">(</span>status <span class="op">&amp;</span> XTTCPS_IXR_INTERVAL_MASK<span class="op">)</span> <span class="op">{</span></span>
<span id="cb39-7"><a href="/entry/2022/09/19/earthly-zynqmp/#cb39-7" aria-hidden="true" tabindex="-1"></a>    ttc_irq_kicked_n<span class="op">.</span>clear<span class="op">(</span><span class="bu">std::</span>memory_order_relaxed<span class="op">);</span></span>
<span id="cb39-8"><a href="/entry/2022/09/19/earthly-zynqmp/#cb39-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-9"><a href="/entry/2022/09/19/earthly-zynqmp/#cb39-9" aria-hidden="true" tabindex="-1"></a>    XTtcPs_ClearInterruptStatus<span class="op">(</span>ttc<span class="op">,</span> XTTCPS_IXR_INTERVAL_MASK<span class="op">);</span></span>
<span id="cb39-10"><a href="/entry/2022/09/19/earthly-zynqmp/#cb39-10" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb39-11"><a href="/entry/2022/09/19/earthly-zynqmp/#cb39-11" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb39-12"><a href="/entry/2022/09/19/earthly-zynqmp/#cb39-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-13"><a href="/entry/2022/09/19/earthly-zynqmp/#cb39-13" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> <span class="op">(;;)</span> <span class="op">{</span></span>
<span id="cb39-14"><a href="/entry/2022/09/19/earthly-zynqmp/#cb39-14" aria-hidden="true" tabindex="-1"></a>  <span class="kw">asm</span> <span class="at">volatile</span><span class="op">(</span><span class="st">&quot;wfi&quot;</span><span class="op">);</span></span>
<span id="cb39-15"><a href="/entry/2022/09/19/earthly-zynqmp/#cb39-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-16"><a href="/entry/2022/09/19/earthly-zynqmp/#cb39-16" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> <span class="op">(!</span>ttc_irq_kicked_n<span class="op">.</span>test_and_set<span class="op">(</span><span class="bu">std::</span>memory_order_relaxed<span class="op">))</span> <span class="op">{</span></span>
<span id="cb39-17"><a href="/entry/2022/09/19/earthly-zynqmp/#cb39-17" aria-hidden="true" tabindex="-1"></a>    <span class="co">// TTC 割り込みがあったときの処理</span></span>
<span id="cb39-18"><a href="/entry/2022/09/19/earthly-zynqmp/#cb39-18" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb39-19"><a href="/entry/2022/09/19/earthly-zynqmp/#cb39-19" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>IPI 割り込みでは <a href="https://en.cppreference.com/w/cpp/atomic/atomic" target="_blank" rel="nofollow noopener"><code>std::atomic&lt;std::uint32_t&gt;</code></a> を使って Message Buffer から読み込んだ値を渡す目的も兼ねています。最上位ビットを割り込みが起きた状態かどうかに、残りを Message Buffer から呼んだ値とします。メインループでは <a href="https://en.cppreference.com/w/cpp/atomic/atomic/exchange" target="_blank" rel="nofollow noopener"><code>exchange()</code></a> を呼び出して値を 0 に置き換えつつ、その時点での値の最上位ビットが立っていたら割り込みに対する処理、という感じです。</p>
<div class="sourceCode" id="cb40"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb40-1"><a href="/entry/2022/09/19/earthly-zynqmp/#cb40-1" aria-hidden="true" tabindex="-1"></a><span class="at">static</span> <span class="bu">std::</span>atomic<span class="op">&lt;</span><span class="bu">std::</span>uint32_t<span class="op">&gt;</span> ipi_req<span class="op">{</span><span class="dv">0</span><span class="op">};</span></span>
<span id="cb40-2"><a href="/entry/2022/09/19/earthly-zynqmp/#cb40-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-3"><a href="/entry/2022/09/19/earthly-zynqmp/#cb40-3" aria-hidden="true" tabindex="-1"></a><span class="at">static</span> <span class="dt">void</span> ipi_irq_handler<span class="op">(</span><span class="dt">void</span><span class="op">*</span> data<span class="op">)</span> <span class="kw">noexcept</span> <span class="op">{</span></span>
<span id="cb40-4"><a href="/entry/2022/09/19/earthly-zynqmp/#cb40-4" aria-hidden="true" tabindex="-1"></a>  <span class="kw">auto</span> ipi <span class="op">=</span> <span class="kw">static_cast</span><span class="op">&lt;</span>XIpiPsu<span class="op">*&gt;(</span>data<span class="op">);</span></span>
<span id="cb40-5"><a href="/entry/2022/09/19/earthly-zynqmp/#cb40-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">const</span> <span class="kw">auto</span> status <span class="op">=</span> XIpiPsu_GetInterruptStatus<span class="op">(</span>ipi<span class="op">);</span></span>
<span id="cb40-6"><a href="/entry/2022/09/19/earthly-zynqmp/#cb40-6" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> <span class="op">(</span>status <span class="op">&amp;</span> IPI_TRIG_CH7_MASK<span class="op">)</span> <span class="op">{</span></span>
<span id="cb40-7"><a href="/entry/2022/09/19/earthly-zynqmp/#cb40-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">const</span> <span class="bu">std::</span>uint32_t<span class="op"> </span>req <span class="op">=</span> Xil_In32<span class="op">(</span>XPAR_PSU_MESSAGE_BUFFERS_S_AXI_BASEADDR <span class="op">+</span> <span class="bn">0x600</span><span class="op">);</span></span>
<span id="cb40-8"><a href="/entry/2022/09/19/earthly-zynqmp/#cb40-8" aria-hidden="true" tabindex="-1"></a>    ipi_req<span class="op">.</span>store<span class="op">(</span>req <span class="op">|</span> <span class="bn">0x8000&#39;0000</span><span class="op">,</span> <span class="bu">std::</span>memory_order_relaxed<span class="op">);</span></span>
<span id="cb40-9"><a href="/entry/2022/09/19/earthly-zynqmp/#cb40-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-10"><a href="/entry/2022/09/19/earthly-zynqmp/#cb40-10" aria-hidden="true" tabindex="-1"></a>    XIpiPsu_ClearInterruptStatus<span class="op">(</span>ipi<span class="op">,</span> IPI_TRIG_CH7_MASK<span class="op">);</span></span>
<span id="cb40-11"><a href="/entry/2022/09/19/earthly-zynqmp/#cb40-11" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb40-12"><a href="/entry/2022/09/19/earthly-zynqmp/#cb40-12" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb40-13"><a href="/entry/2022/09/19/earthly-zynqmp/#cb40-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-14"><a href="/entry/2022/09/19/earthly-zynqmp/#cb40-14" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> <span class="op">(;;)</span> <span class="op">{</span></span>
<span id="cb40-15"><a href="/entry/2022/09/19/earthly-zynqmp/#cb40-15" aria-hidden="true" tabindex="-1"></a>  <span class="kw">asm</span> <span class="at">volatile</span><span class="op">(</span><span class="st">&quot;wfi&quot;</span><span class="op">);</span></span>
<span id="cb40-16"><a href="/entry/2022/09/19/earthly-zynqmp/#cb40-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-17"><a href="/entry/2022/09/19/earthly-zynqmp/#cb40-17" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> <span class="op">(</span><span class="at">const</span> <span class="kw">auto</span> req <span class="op">=</span> ipi_req<span class="op">.</span>exchange<span class="op">(</span><span class="dv">0</span><span class="op">,</span> <span class="bu">std::</span>memory_order_relaxed<span class="op">);</span> req <span class="op">&amp;</span> <span class="bn">0x8000&#39;0000</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb40-18"><a href="/entry/2022/09/19/earthly-zynqmp/#cb40-18" aria-hidden="true" tabindex="-1"></a>    <span class="co">// TTC 割り込みがあったときの処理</span></span>
<span id="cb40-19"><a href="/entry/2022/09/19/earthly-zynqmp/#cb40-19" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb40-20"><a href="/entry/2022/09/19/earthly-zynqmp/#cb40-20" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>これでどちらもそれっぽく動いているものの、正直 <code>volatile</code> と同様に <code>&lt;atomic&gt;</code> についても詳しいわけではないので、この使い方がアリなのかあまり自信がありません。Rust の<a href="https://docs.rust-embedded.org/book/concurrency/#atomic-access" target="_blank" rel="nofollow noopener">この資料</a>とかは一例として紹介されたりはしていますね。</p>
<h3 id="rpu-の-lock-step-mode-と-tcm">RPU の Lock-Step Mode と TCM</h3>
<p>RPU は Tightly Coupled Memory (TCM) とよばれる特別なメモリ領域にプログラムを配置できます。TCM はキャッシュを介さない予測可能時間でのアクセスや ECC が付いていたりする、RPU らしいメモリです。しかしこの TCM、容量がコア毎に 64 KB x 2 なので、ちょっと大きなものを載せようとすると厳しいことがあります。実際、開発中に <code>.text</code> が 64 KB を超えて収まらなくなったことがありました。</p>
<p>この対策 (?) になりそうな方法の1つとして、RPU を Lock-Step で動かすというのがあります。TRM によれば</p>
<blockquote>
<p>During the lock-step operation, the TCMs that are associated with the redundant processor become available to the lock-step processor. The size of ATCM and BTCM become 128 KB each with BTCM supporting interleaved accesses from processor and AXI slave interface.</p>
</blockquote>
<p>とあるためです。で、実際に linker script を変えてみたのですが…なんだかあやしいです。デバッガーでロードさせると問題ないのに、<code>boot.bin</code> に入れて FSBL で Linux と一緒にロードさせると途中で RPU 側のアプリケーションがお亡くなりになってしまうのです。デバッガーを使うと問題ないというのが厄介で、結局調査は諦めました。<code>.text</code> が 64 KB 超えた問題も、ちょっとコード変えただけで余裕で収まるようになりましたし。しかし謎…。</p>
<h3 id="systemd-unit-file-を追加して-ubuntu-のブート時にいろいろ動かす">Systemd Unit File を追加して Ubuntu のブート時にいろいろ動かす</h3>
<p>Linux 側で動かすアプリケーションは、電源を投入したら何もせず勝手に動いてほしいです。今回は Ubuntu が動いているので、そこに Systemd の unit file を追加して実現しました。こんな感じです。</p>
<div class="sourceCode" id="cb41"><pre class="sourceCode ini"><code class="sourceCode ini"><span id="cb41-1"><a href="/entry/2022/09/19/earthly-zynqmp/#cb41-1" aria-hidden="true" tabindex="-1"></a><span class="kw">[Unit]</span></span>
<span id="cb41-2"><a href="/entry/2022/09/19/earthly-zynqmp/#cb41-2" aria-hidden="true" tabindex="-1"></a><span class="dt">Description</span><span class="ot">=</span><span class="st">Trigger IPI to flash LEDs</span></span>
<span id="cb41-3"><a href="/entry/2022/09/19/earthly-zynqmp/#cb41-3" aria-hidden="true" tabindex="-1"></a><span class="dt">Wants</span><span class="ot">=</span><span class="st">modprobe@uio_pdrv_genirq.service</span></span>
<span id="cb41-4"><a href="/entry/2022/09/19/earthly-zynqmp/#cb41-4" aria-hidden="true" tabindex="-1"></a><span class="dt">After</span><span class="ot">=</span><span class="st">modprobe@uio_pdrv_genirq.service</span></span>
<span id="cb41-5"><a href="/entry/2022/09/19/earthly-zynqmp/#cb41-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-6"><a href="/entry/2022/09/19/earthly-zynqmp/#cb41-6" aria-hidden="true" tabindex="-1"></a><span class="kw">[Service]</span></span>
<span id="cb41-7"><a href="/entry/2022/09/19/earthly-zynqmp/#cb41-7" aria-hidden="true" tabindex="-1"></a><span class="dt">Type</span><span class="ot">=</span><span class="st">simple</span></span>
<span id="cb41-8"><a href="/entry/2022/09/19/earthly-zynqmp/#cb41-8" aria-hidden="true" tabindex="-1"></a><span class="dt">ExecStart</span><span class="ot">=</span><span class="st">/usr/bin/ipi-led</span></span>
<span id="cb41-9"><a href="/entry/2022/09/19/earthly-zynqmp/#cb41-9" aria-hidden="true" tabindex="-1"></a><span class="dt">DevicePolicy</span><span class="ot">=</span><span class="st">closed</span></span>
<span id="cb41-10"><a href="/entry/2022/09/19/earthly-zynqmp/#cb41-10" aria-hidden="true" tabindex="-1"></a><span class="dt">DeviceAllow</span><span class="ot">=</span><span class="st">char-uio</span></span>
<span id="cb41-11"><a href="/entry/2022/09/19/earthly-zynqmp/#cb41-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-12"><a href="/entry/2022/09/19/earthly-zynqmp/#cb41-12" aria-hidden="true" tabindex="-1"></a><span class="kw">[Install]</span></span>
<span id="cb41-13"><a href="/entry/2022/09/19/earthly-zynqmp/#cb41-13" aria-hidden="true" tabindex="-1"></a><span class="dt">WantedBy</span><span class="ot">=</span><span class="st">multi-user.target</span></span></code></pre></div>
<p>Systemd 世代なら見慣れた記述だと思います。カーネルモジュール <code>uio_pdrv_genirq</code> に依存しているので、それを <code>modprobe@uio_pdrv_genirq.service</code> と指定しています。<code>[Service]</code> で指定した処理は特に何もしなければ root で動いてしまうので、本格的に何かやろうとするなら別ユーザーで動かすなど権限を絞るべきです。今回は一発ネタなので手を抜いています。とはいえ何もしないのもおもしろくないので、お気持ち程度のリソース制限を付けました。<code>DevicePolicy=closed</code> と <code>DeviceAllow=char-uio</code> を設定して、<code>ipi-led</code> からは <code>/dev/null</code>, <code>/dev/zero</code> などの基本的なデバイスと <code>/dev/uio*</code> しか見えなくなっているはずです。</p>
<p><code>ipi-led</code> 以外にもいくつかの unit file を追加しています。まずは <a href="https://github.com/Tosainu/earthly-zynqmp-example/blob/27538797d4663eb2637bf9e8570dc23e7465f126/linux/rootfs/etc/systemd/system/maximize-root-partition.service" target="_blank" rel="nofollow noopener"><code>maximize-root-partition.service</code></a> です。<code>disk.img.zst</code> で作った Linux 側のパーティションは 256 MiB しかないので、最初にブートしたときに <code>parted</code> と <code>resize2fs</code> を呼び出してリサイズします。リサイズが済んだらもう役目はないので、unit file の中で <code>systemctl disable</code> しています。</p>
<p>もう1つが <a href="https://github.com/Tosainu/earthly-zynqmp-example/blob/27538797d4663eb2637bf9e8570dc23e7465f126/linux/rootfs/etc/systemd/system/setup-usb-ether.service" target="_blank" rel="nofollow noopener"><code>setup-usb-ether.service</code></a> で、USB Gadget を使ったネットワーク接続を設定します。USB Gadget 経由のネットワークは想像していたより快適でした。Ultra96 実機上で複雑な作業をするのであればぜひオススメしたいです。ちなみに、これに関連して <code>system-top-append.dts</code> に PS-GTR の refclock の設定や USB 関連の pinctrl の設定を追加しています。設定しないとないと相手 PC 側で突然 disconnect 扱いになってしまうなど不安定でした。PS-GTR の refclock 情報は <code>.xsa</code> に入っていた気がするので、それだけでも やってくれるといいのになと思いました。</p>
<blockquote class="twitter-tweet tw-align-center" data-dnt="true">
<p lang="cs" dir="ltr">
naruhodo <a href="https://t.co/iapfw9ABxP" target="_blank" rel="nofollow noopener">pic.twitter.com/iapfw9ABxP</a>
</p>
— ✧<em>。ヾ(｡ᐳ﹏ᐸ｡)ﾉﾞ。</em>✧ (@myon___) <a href="https://twitter.com/myon___/status/1518165469169332224?ref_src=twsrc%5Etfw" target="_blank" rel="nofollow noopener">April 24, 2022</a>
</blockquote>
<script async src="https://platform.twitter.com/widgets.js" charset="utf-8"></script>
<p>せっかくなので、USB で繋いだらすぐ SSH できるようにと Ubuntu 環境に <code>openssh-server</code> も入れようとしていました。ただ、Ubuntu の <code>openssh</code> パッケージはパッケージがインストールされるときに host key を生成しているようだったため見送りました<a href="/entry/2022/09/19/earthly-zynqmp/#fn9" class="footnote-ref" id="fnref9" role="doc-noteref"><sup>9</sup></a>。こうしたファイルを配布も想定したディスクイメージに含めたくないし、かと言って何かしらの workaround を設定するのも面倒だったので。</p>
<section class="footnotes footnotes-end-of-document" role="doc-endnotes">
<hr />
<ol>
<li id="fn1" role="doc-endnote"><p>もっと言えば、インターネットから拾ってきた実行ファイルをむやみに実行したくないのでソースコードからビルドしています。Earthly の最新機能を追うきっかけにもなりますしね。<a href="/entry/2022/09/19/earthly-zynqmp/#fnref1" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn2" role="doc-endnote"><p>BSP とかの <code>Makefile</code> を見ると <code>-j10</code> がハードコーディングされていたり、一方でどう見てもターゲットの依存関係や並列ビルドであやしくなりそうな箇所がありますよね…。Earthly が持つ、ある条件での処理をコンテナ内で1度だけ実行するという特徴は、こういったヤツらのトラブルを避けるのにも有効です。<a href="/entry/2022/09/19/earthly-zynqmp/#fnref2" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn3" role="doc-endnote"><p>何も意識せずに <code>tar.xz</code> を指定して、やけに時間かかるなーってなる出来事がありました…<a href="/entry/2022/09/19/earthly-zynqmp/#fnref3" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn4" role="doc-endnote"><p>FSBL の <code>psu_init()</code> 前に実行されてしまうから…？<a href="/entry/2022/09/19/earthly-zynqmp/#fnref4" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn5" role="doc-endnote"><p>あるいはキャッシュを意図的に消すか GC がかからない限り。<a href="/entry/2022/09/19/earthly-zynqmp/#fnref5" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn6" role="doc-endnote"><p>パッケージマネージャなど、何かをダウンロードする系とは相性がよさそうです。一方でビルドキャッシュに使うのは注意な気がします、特に C や C++ を使っている場合。<a href="/entry/2022/09/19/earthly-zynqmp/#fnref6" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn7" role="doc-endnote"><p>APU にデフォルトで割り当てられているのは channel 0 です。ただしこれは、XSCT が生成した Devicetree ノード <code>mailbox@ff990400</code> や OpenAMP 関連の資料にあるように PMU とやりとりするのに使っているようです。RPU 0 とやりとりで扱うビットに影響しない気もしますが、わざわざほかのプロセッサやソフトウェアが既に使っている領域を共有する必要もないです。channel 7 以降は未割り当てなのでこれを使います。<a href="/entry/2022/09/19/earthly-zynqmp/#fnref7" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn8" role="doc-endnote"><p>SoC 内のあらゆるリソースが同じメモリ空間にアクセスできるの、Zynq のおもしろく強力であり、同時にコワイところですよね。ちなみに XSCT が生成する <code>.dts</code> はデフォルトで何でも有効になっているので、RPU などからさわるリソースは <code>status</code> を <code>disabled</code> または <code>reserved</code> にしたり、PL 上のリソースは <code>/delete-node/</code> するのがよいです。デバイスドライバーによっては probe の段階でペリフェラルにリセットかけたりとかしちゃうので。<a href="/entry/2022/09/19/earthly-zynqmp/#fnref8" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn9" role="doc-endnote"><p>これに限らず、Ubuntu とかのパッケージはインストール時の hook でいろいろやり過ぎな気がします。特にパッケージに含まれるサービスをその場で start してくるやつが本当に好きじゃないです。ソフトウェアの設定を確認する前に勝手に動き出しちゃうってこわくないですか。<a href="/entry/2022/09/19/earthly-zynqmp/#fnref9" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
</ol>
</section></div><aside class="comments"><div id="disqus_thread"></div><script>(function() { var d = document, s = d.createElement('script');s.src = 'https://tosainu.disqus.com/embed.js';s.setAttribute('data-timestamp', +new Date());(d.head || d.body).appendChild(s); })();</script><noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" target="_blank" rel="nofollow noopener">comments powered by Disqus.</a></noscript></aside></div></article></main><footer class="site-footer"><div class="footer-widgets"><div class="container"><div class="col"><section class="about-me"><h4><svg class="svg-inline--fa fa-user fa-fw" focusable="false" aria-hidden="true" role="img" viewBox="0 0 448 512" data-icon="user" data-prefix="fas" xmlns="http://www.w3.org/2000/svg"><path d="M224 256c70.7 0 128-57.3 128-128S294.7 0 224 0S96 57.3 96 128s57.3 128 128 128zm-45.7 48C79.8 304 0 383.8 0 482.3C0 498.7 13.3 512 29.7 512H418.3c16.4 0 29.7-13.3 29.7-29.7C448 383.8 368.2 304 269.7 304H178.3z" fill="currentColor"></path></svg> About Me</h4><div class="about"><div class="avatar"><img src="/images/icon/cocoa.svg" class="icon" alt="avatar"></div><div class="info"><div class="name"><a href="https://myon.info" target="_blank" rel="nofollow noopener">Tosainu</a></div><div class="info">❤ Arch Linux, ごちうさ</div></div></div></section><section class="recent-posts"><h4><svg class="svg-inline--fa fa-file fa-fw" focusable="false" aria-hidden="true" role="img" viewBox="0 0 384 512" data-icon="file" data-prefix="fas" xmlns="http://www.w3.org/2000/svg"><path d="M0 64C0 28.7 28.7 0 64 0H224V128c0 17.7 14.3 32 32 32H384V448c0 35.3-28.7 64-64 64H64c-35.3 0-64-28.7-64-64V64zm384 64H256V0L384 128z" fill="currentColor"></path></svg> Recent Posts</h4><ul><li><a href="/entry/2022/09/19/earthly-zynqmp/">とにかく複雑な Zynq のソフトウェアを Earthly でビルドする</a></li><li><a href="/entry/2020/11/29/archlinux-arm-on-zu/">Ultra96 で Arch Linux ARM を動かす</a></li><li><a href="/entry/2020/09/01/thinkpad-x13/">ThinkPad X13 を買いました</a></li><li><a href="/entry/2020/07/05/bus-blaster/">Bus Blaster で Raspberry Pi Model B を JTAG デバッグしてみる</a></li><li><a href="/entry/2019/10/21/make-own-language-and-compiler/">Brainf**k からはじめる自作コンパイラ</a></li></ul></section></div><section class="tag-cloud"><h4><svg class="svg-inline--fa fa-tags fa-fw" focusable="false" aria-hidden="true" role="img" viewBox="0 0 512 512" data-icon="tags" data-prefix="fas" xmlns="http://www.w3.org/2000/svg"><path d="M345 39.1L472.8 168.4c52.4 53 52.4 138.2 0 191.2L360.8 472.9c-9.3 9.4-24.5 9.5-33.9 .2s-9.5-24.5-.2-33.9L438.6 325.9c33.9-34.3 33.9-89.4 0-123.7L310.9 72.9c-9.3-9.4-9.2-24.6 .2-33.9s24.6-9.2 33.9 .2zM0 229.5V80C0 53.5 21.5 32 48 32H197.5c17 0 33.3 6.7 45.3 18.7l168 168c25 25 25 65.5 0 90.5L277.3 442.7c-25 25-65.5 25-90.5 0l-168-168C6.7 262.7 0 246.5 0 229.5zM144 144c0-17.7-14.3-32-32-32s-32 14.3-32 32s14.3 32 32 32s32-14.3 32-32z" fill="currentColor"></path></svg> Tags</h4><ul class="tag-list"><li><a href="/entry/tags/android/"><span>Android</span></a></li><li><a href="/entry/tags/arch-linux/"><span>Arch Linux</span></a></li><li><a href="/entry/tags/arduino/"><span>Arduino</span></a></li><li><a href="/entry/tags/c/"><span>C++</span></a></li><li><a href="/entry/tags/ctf/"><span>CTF</span></a></li><li><a href="/entry/tags/diy-pc/"><span>DIY PC</span></a></li><li><a href="/entry/tags/docker/"><span>Docker</span></a></li><li><a href="/entry/tags/fpga/"><span>FPGA</span></a></li><li><a href="/entry/tags/game/"><span>Game</span></a></li><li><a href="/entry/tags/gochiusa/"><span>Gochiusa</span></a></li><li><a href="/entry/tags/hakyll/"><span>Hakyll</span></a></li><li><a href="/entry/tags/haskell/"><span>Haskell</span></a></li><li><a href="/entry/tags/linux/"><span>Linux</span></a></li><li><a href="/entry/tags/machine-learning/"><span>Machine learning</span></a></li><li><a href="/entry/tags/network/"><span>Network</span></a></li><li><a href="/entry/tags/raspberry-pi/"><span>Raspberry Pi</span></a></li><li><a href="/entry/tags/rust/"><span>Rust</span></a></li><li><a href="/entry/tags/slack/"><span>Slack</span></a></li><li><a href="/entry/tags/thinkpad-x13/"><span>ThinkPad X13</span></a></li><li><a href="/entry/tags/vaio-z2/"><span>VAIO Z2</span></a></li><li><a href="/entry/tags/vim/"><span>Vim</span></a></li><li><a href="/entry/tags/walkmanz/"><span>WalkmanZ</span></a></li><li><a href="/entry/tags/website/"><span>Website</span></a></li><li><a href="/entry/tags/xperia-nx/"><span>Xperia NX</span></a></li><li><a href="/entry/tags/xperia-arc/"><span>Xperia arc</span></a></li><li><a href="/entry/tags/xperia2011/"><span>Xperia2011</span></a></li><li><a href="/entry/tags/seccamp/"><span>seccamp</span></a></li></ul></section><section class="archives"><h4><svg class="svg-inline--fa fa-box-archive fa-fw" focusable="false" aria-hidden="true" role="img" viewBox="0 0 512 512" data-icon="box-archive" data-prefix="fas" xmlns="http://www.w3.org/2000/svg"><path d="M32 32H480c17.7 0 32 14.3 32 32V96c0 17.7-14.3 32-32 32H32C14.3 128 0 113.7 0 96V64C0 46.3 14.3 32 32 32zm0 128H480V416c0 35.3-28.7 64-64 64H96c-35.3 0-64-28.7-64-64V160zm128 80c0 8.8 7.2 16 16 16H336c8.8 0 16-7.2 16-16s-7.2-16-16-16H176c-8.8 0-16 7.2-16 16z" fill="currentColor"></path></svg> Archives</h4><ul class="archive-tree"><li><input class="tree-toggle" type="checkbox" id="tree-label-2022" checked><label class="tree-toggle-button" for="tree-label-2022"><svg class="svg-inline--fa fa-angle-right fa-fw" focusable="false" aria-hidden="true" role="img" viewBox="0 0 320 512" data-icon="angle-right" data-prefix="fas" xmlns="http://www.w3.org/2000/svg"><path d="M278.6 233.4c12.5 12.5 12.5 32.8 0 45.3l-160 160c-12.5 12.5-32.8 12.5-45.3 0s-12.5-32.8 0-45.3L210.7 256 73.4 118.6c-12.5-12.5-12.5-32.8 0-45.3s32.8-12.5 45.3 0l160 160z" fill="currentColor"></path></svg><svg class="svg-inline--fa fa-angle-down fa-fw" focusable="false" aria-hidden="true" role="img" viewBox="0 0 448 512" data-icon="angle-down" data-prefix="fas" xmlns="http://www.w3.org/2000/svg"><path d="M201.4 374.6c12.5 12.5 32.8 12.5 45.3 0l160-160c12.5-12.5 12.5-32.8 0-45.3s-32.8-12.5-45.3 0L224 306.7 86.6 169.4c-12.5-12.5-32.8-12.5-45.3 0s-12.5 32.8 0 45.3l160 160z" fill="currentColor"></path></svg><a href="/entry/2022/">2022 (1)</a></label><ul class="tree-child"><li><a href="/entry/2022/09/">2022/09 (1)</a></li></ul></li><li><input class="tree-toggle" type="checkbox" id="tree-label-2020"><label class="tree-toggle-button" for="tree-label-2020"><svg class="svg-inline--fa fa-angle-right fa-fw" focusable="false" aria-hidden="true" role="img" viewBox="0 0 320 512" data-icon="angle-right" data-prefix="fas" xmlns="http://www.w3.org/2000/svg"><path d="M278.6 233.4c12.5 12.5 12.5 32.8 0 45.3l-160 160c-12.5 12.5-32.8 12.5-45.3 0s-12.5-32.8 0-45.3L210.7 256 73.4 118.6c-12.5-12.5-12.5-32.8 0-45.3s32.8-12.5 45.3 0l160 160z" fill="currentColor"></path></svg><svg class="svg-inline--fa fa-angle-down fa-fw" focusable="false" aria-hidden="true" role="img" viewBox="0 0 448 512" data-icon="angle-down" data-prefix="fas" xmlns="http://www.w3.org/2000/svg"><path d="M201.4 374.6c12.5 12.5 32.8 12.5 45.3 0l160-160c12.5-12.5 12.5-32.8 0-45.3s-32.8-12.5-45.3 0L224 306.7 86.6 169.4c-12.5-12.5-32.8-12.5-45.3 0s-12.5 32.8 0 45.3l160 160z" fill="currentColor"></path></svg><a href="/entry/2020/">2020 (3)</a></label><ul class="tree-child"><li><a href="/entry/2020/11/">2020/11 (1)</a></li><li><a href="/entry/2020/09/">2020/09 (1)</a></li><li><a href="/entry/2020/07/">2020/07 (1)</a></li></ul></li><li><input class="tree-toggle" type="checkbox" id="tree-label-2019"><label class="tree-toggle-button" for="tree-label-2019"><svg class="svg-inline--fa fa-angle-right fa-fw" focusable="false" aria-hidden="true" role="img" viewBox="0 0 320 512" data-icon="angle-right" data-prefix="fas" xmlns="http://www.w3.org/2000/svg"><path d="M278.6 233.4c12.5 12.5 12.5 32.8 0 45.3l-160 160c-12.5 12.5-32.8 12.5-45.3 0s-12.5-32.8 0-45.3L210.7 256 73.4 118.6c-12.5-12.5-12.5-32.8 0-45.3s32.8-12.5 45.3 0l160 160z" fill="currentColor"></path></svg><svg class="svg-inline--fa fa-angle-down fa-fw" focusable="false" aria-hidden="true" role="img" viewBox="0 0 448 512" data-icon="angle-down" data-prefix="fas" xmlns="http://www.w3.org/2000/svg"><path d="M201.4 374.6c12.5 12.5 32.8 12.5 45.3 0l160-160c12.5-12.5 12.5-32.8 0-45.3s-32.8-12.5-45.3 0L224 306.7 86.6 169.4c-12.5-12.5-32.8-12.5-45.3 0s-12.5 32.8 0 45.3l160 160z" fill="currentColor"></path></svg><a href="/entry/2019/">2019 (4)</a></label><ul class="tree-child"><li><a href="/entry/2019/10/">2019/10 (1)</a></li><li><a href="/entry/2019/08/">2019/08 (2)</a></li><li><a href="/entry/2019/05/">2019/05 (1)</a></li></ul></li><li><input class="tree-toggle" type="checkbox" id="tree-label-2018"><label class="tree-toggle-button" for="tree-label-2018"><svg class="svg-inline--fa fa-angle-right fa-fw" focusable="false" aria-hidden="true" role="img" viewBox="0 0 320 512" data-icon="angle-right" data-prefix="fas" xmlns="http://www.w3.org/2000/svg"><path d="M278.6 233.4c12.5 12.5 12.5 32.8 0 45.3l-160 160c-12.5 12.5-32.8 12.5-45.3 0s-12.5-32.8 0-45.3L210.7 256 73.4 118.6c-12.5-12.5-12.5-32.8 0-45.3s32.8-12.5 45.3 0l160 160z" fill="currentColor"></path></svg><svg class="svg-inline--fa fa-angle-down fa-fw" focusable="false" aria-hidden="true" role="img" viewBox="0 0 448 512" data-icon="angle-down" data-prefix="fas" xmlns="http://www.w3.org/2000/svg"><path d="M201.4 374.6c12.5 12.5 32.8 12.5 45.3 0l160-160c12.5-12.5 12.5-32.8 0-45.3s-32.8-12.5-45.3 0L224 306.7 86.6 169.4c-12.5-12.5-32.8-12.5-45.3 0s-12.5 32.8 0 45.3l160 160z" fill="currentColor"></path></svg><a href="/entry/2018/">2018 (5)</a></label><ul class="tree-child"><li><a href="/entry/2018/10/">2018/10 (1)</a></li><li><a href="/entry/2018/09/">2018/09 (1)</a></li><li><a href="/entry/2018/08/">2018/08 (1)</a></li><li><a href="/entry/2018/03/">2018/03 (1)</a></li><li><a href="/entry/2018/01/">2018/01 (1)</a></li></ul></li><li><input class="tree-toggle" type="checkbox" id="tree-label-2017"><label class="tree-toggle-button" for="tree-label-2017"><svg class="svg-inline--fa fa-angle-right fa-fw" focusable="false" aria-hidden="true" role="img" viewBox="0 0 320 512" data-icon="angle-right" data-prefix="fas" xmlns="http://www.w3.org/2000/svg"><path d="M278.6 233.4c12.5 12.5 12.5 32.8 0 45.3l-160 160c-12.5 12.5-32.8 12.5-45.3 0s-12.5-32.8 0-45.3L210.7 256 73.4 118.6c-12.5-12.5-12.5-32.8 0-45.3s32.8-12.5 45.3 0l160 160z" fill="currentColor"></path></svg><svg class="svg-inline--fa fa-angle-down fa-fw" focusable="false" aria-hidden="true" role="img" viewBox="0 0 448 512" data-icon="angle-down" data-prefix="fas" xmlns="http://www.w3.org/2000/svg"><path d="M201.4 374.6c12.5 12.5 32.8 12.5 45.3 0l160-160c12.5-12.5 12.5-32.8 0-45.3s-32.8-12.5-45.3 0L224 306.7 86.6 169.4c-12.5-12.5-32.8-12.5-45.3 0s-12.5 32.8 0 45.3l160 160z" fill="currentColor"></path></svg><a href="/entry/2017/">2017 (5)</a></label><ul class="tree-child"><li><a href="/entry/2017/09/">2017/09 (1)</a></li><li><a href="/entry/2017/05/">2017/05 (1)</a></li><li><a href="/entry/2017/02/">2017/02 (3)</a></li></ul></li><li><input class="tree-toggle" type="checkbox" id="tree-label-2016"><label class="tree-toggle-button" for="tree-label-2016"><svg class="svg-inline--fa fa-angle-right fa-fw" focusable="false" aria-hidden="true" role="img" viewBox="0 0 320 512" data-icon="angle-right" data-prefix="fas" xmlns="http://www.w3.org/2000/svg"><path d="M278.6 233.4c12.5 12.5 12.5 32.8 0 45.3l-160 160c-12.5 12.5-32.8 12.5-45.3 0s-12.5-32.8 0-45.3L210.7 256 73.4 118.6c-12.5-12.5-12.5-32.8 0-45.3s32.8-12.5 45.3 0l160 160z" fill="currentColor"></path></svg><svg class="svg-inline--fa fa-angle-down fa-fw" focusable="false" aria-hidden="true" role="img" viewBox="0 0 448 512" data-icon="angle-down" data-prefix="fas" xmlns="http://www.w3.org/2000/svg"><path d="M201.4 374.6c12.5 12.5 32.8 12.5 45.3 0l160-160c12.5-12.5 12.5-32.8 0-45.3s-32.8-12.5-45.3 0L224 306.7 86.6 169.4c-12.5-12.5-32.8-12.5-45.3 0s-12.5 32.8 0 45.3l160 160z" fill="currentColor"></path></svg><a href="/entry/2016/">2016 (8)</a></label><ul class="tree-child"><li><a href="/entry/2016/08/">2016/08 (2)</a></li><li><a href="/entry/2016/07/">2016/07 (1)</a></li><li><a href="/entry/2016/06/">2016/06 (1)</a></li><li><a href="/entry/2016/05/">2016/05 (1)</a></li><li><a href="/entry/2016/03/">2016/03 (1)</a></li><li><a href="/entry/2016/01/">2016/01 (2)</a></li></ul></li><li><input class="tree-toggle" type="checkbox" id="tree-label-2015"><label class="tree-toggle-button" for="tree-label-2015"><svg class="svg-inline--fa fa-angle-right fa-fw" focusable="false" aria-hidden="true" role="img" viewBox="0 0 320 512" data-icon="angle-right" data-prefix="fas" xmlns="http://www.w3.org/2000/svg"><path d="M278.6 233.4c12.5 12.5 12.5 32.8 0 45.3l-160 160c-12.5 12.5-32.8 12.5-45.3 0s-12.5-32.8 0-45.3L210.7 256 73.4 118.6c-12.5-12.5-12.5-32.8 0-45.3s32.8-12.5 45.3 0l160 160z" fill="currentColor"></path></svg><svg class="svg-inline--fa fa-angle-down fa-fw" focusable="false" aria-hidden="true" role="img" viewBox="0 0 448 512" data-icon="angle-down" data-prefix="fas" xmlns="http://www.w3.org/2000/svg"><path d="M201.4 374.6c12.5 12.5 32.8 12.5 45.3 0l160-160c12.5-12.5 12.5-32.8 0-45.3s-32.8-12.5-45.3 0L224 306.7 86.6 169.4c-12.5-12.5-32.8-12.5-45.3 0s-12.5 32.8 0 45.3l160 160z" fill="currentColor"></path></svg><a href="/entry/2015/">2015 (12)</a></label><ul class="tree-child"><li><a href="/entry/2015/12/">2015/12 (1)</a></li><li><a href="/entry/2015/08/">2015/08 (1)</a></li><li><a href="/entry/2015/06/">2015/06 (2)</a></li><li><a href="/entry/2015/05/">2015/05 (2)</a></li><li><a href="/entry/2015/04/">2015/04 (1)</a></li><li><a href="/entry/2015/03/">2015/03 (2)</a></li><li><a href="/entry/2015/02/">2015/02 (1)</a></li><li><a href="/entry/2015/01/">2015/01 (2)</a></li></ul></li><li><input class="tree-toggle" type="checkbox" id="tree-label-2014"><label class="tree-toggle-button" for="tree-label-2014"><svg class="svg-inline--fa fa-angle-right fa-fw" focusable="false" aria-hidden="true" role="img" viewBox="0 0 320 512" data-icon="angle-right" data-prefix="fas" xmlns="http://www.w3.org/2000/svg"><path d="M278.6 233.4c12.5 12.5 12.5 32.8 0 45.3l-160 160c-12.5 12.5-32.8 12.5-45.3 0s-12.5-32.8 0-45.3L210.7 256 73.4 118.6c-12.5-12.5-12.5-32.8 0-45.3s32.8-12.5 45.3 0l160 160z" fill="currentColor"></path></svg><svg class="svg-inline--fa fa-angle-down fa-fw" focusable="false" aria-hidden="true" role="img" viewBox="0 0 448 512" data-icon="angle-down" data-prefix="fas" xmlns="http://www.w3.org/2000/svg"><path d="M201.4 374.6c12.5 12.5 32.8 12.5 45.3 0l160-160c12.5-12.5 12.5-32.8 0-45.3s-32.8-12.5-45.3 0L224 306.7 86.6 169.4c-12.5-12.5-32.8-12.5-45.3 0s-12.5 32.8 0 45.3l160 160z" fill="currentColor"></path></svg><a href="/entry/2014/">2014 (62)</a></label><ul class="tree-child"><li><a href="/entry/2014/12/">2014/12 (7)</a></li><li><a href="/entry/2014/11/">2014/11 (4)</a></li><li><a href="/entry/2014/10/">2014/10 (3)</a></li><li><a href="/entry/2014/09/">2014/09 (3)</a></li><li><a href="/entry/2014/08/">2014/08 (5)</a></li><li><a href="/entry/2014/07/">2014/07 (6)</a></li><li><a href="/entry/2014/06/">2014/06 (6)</a></li><li><a href="/entry/2014/05/">2014/05 (4)</a></li><li><a href="/entry/2014/04/">2014/04 (6)</a></li><li><a href="/entry/2014/03/">2014/03 (7)</a></li><li><a href="/entry/2014/02/">2014/02 (5)</a></li><li><a href="/entry/2014/01/">2014/01 (6)</a></li></ul></li><li><input class="tree-toggle" type="checkbox" id="tree-label-2013"><label class="tree-toggle-button" for="tree-label-2013"><svg class="svg-inline--fa fa-angle-right fa-fw" focusable="false" aria-hidden="true" role="img" viewBox="0 0 320 512" data-icon="angle-right" data-prefix="fas" xmlns="http://www.w3.org/2000/svg"><path d="M278.6 233.4c12.5 12.5 12.5 32.8 0 45.3l-160 160c-12.5 12.5-32.8 12.5-45.3 0s-12.5-32.8 0-45.3L210.7 256 73.4 118.6c-12.5-12.5-12.5-32.8 0-45.3s32.8-12.5 45.3 0l160 160z" fill="currentColor"></path></svg><svg class="svg-inline--fa fa-angle-down fa-fw" focusable="false" aria-hidden="true" role="img" viewBox="0 0 448 512" data-icon="angle-down" data-prefix="fas" xmlns="http://www.w3.org/2000/svg"><path d="M201.4 374.6c12.5 12.5 32.8 12.5 45.3 0l160-160c12.5-12.5 12.5-32.8 0-45.3s-32.8-12.5-45.3 0L224 306.7 86.6 169.4c-12.5-12.5-32.8-12.5-45.3 0s-12.5 32.8 0 45.3l160 160z" fill="currentColor"></path></svg><a href="/entry/2013/">2013 (116)</a></label><ul class="tree-child"><li><a href="/entry/2013/12/">2013/12 (8)</a></li><li><a href="/entry/2013/11/">2013/11 (6)</a></li><li><a href="/entry/2013/10/">2013/10 (5)</a></li><li><a href="/entry/2013/09/">2013/09 (5)</a></li><li><a href="/entry/2013/08/">2013/08 (4)</a></li><li><a href="/entry/2013/07/">2013/07 (3)</a></li><li><a href="/entry/2013/06/">2013/06 (12)</a></li><li><a href="/entry/2013/05/">2013/05 (16)</a></li><li><a href="/entry/2013/04/">2013/04 (16)</a></li><li><a href="/entry/2013/03/">2013/03 (27)</a></li><li><a href="/entry/2013/02/">2013/02 (7)</a></li><li><a href="/entry/2013/01/">2013/01 (7)</a></li></ul></li><li><input class="tree-toggle" type="checkbox" id="tree-label-2012"><label class="tree-toggle-button" for="tree-label-2012"><svg class="svg-inline--fa fa-angle-right fa-fw" focusable="false" aria-hidden="true" role="img" viewBox="0 0 320 512" data-icon="angle-right" data-prefix="fas" xmlns="http://www.w3.org/2000/svg"><path d="M278.6 233.4c12.5 12.5 12.5 32.8 0 45.3l-160 160c-12.5 12.5-32.8 12.5-45.3 0s-12.5-32.8 0-45.3L210.7 256 73.4 118.6c-12.5-12.5-12.5-32.8 0-45.3s32.8-12.5 45.3 0l160 160z" fill="currentColor"></path></svg><svg class="svg-inline--fa fa-angle-down fa-fw" focusable="false" aria-hidden="true" role="img" viewBox="0 0 448 512" data-icon="angle-down" data-prefix="fas" xmlns="http://www.w3.org/2000/svg"><path d="M201.4 374.6c12.5 12.5 32.8 12.5 45.3 0l160-160c12.5-12.5 12.5-32.8 0-45.3s-32.8-12.5-45.3 0L224 306.7 86.6 169.4c-12.5-12.5-32.8-12.5-45.3 0s-12.5 32.8 0 45.3l160 160z" fill="currentColor"></path></svg><a href="/entry/2012/">2012 (11)</a></label><ul class="tree-child"><li><a href="/entry/2012/12/">2012/12 (3)</a></li><li><a href="/entry/2012/09/">2012/09 (1)</a></li><li><a href="/entry/2012/07/">2012/07 (4)</a></li><li><a href="/entry/2012/04/">2012/04 (1)</a></li><li><a href="/entry/2012/03/">2012/03 (1)</a></li><li><a href="/entry/2012/01/">2012/01 (1)</a></li></ul></li><li><input class="tree-toggle" type="checkbox" id="tree-label-2011"><label class="tree-toggle-button" for="tree-label-2011"><svg class="svg-inline--fa fa-angle-right fa-fw" focusable="false" aria-hidden="true" role="img" viewBox="0 0 320 512" data-icon="angle-right" data-prefix="fas" xmlns="http://www.w3.org/2000/svg"><path d="M278.6 233.4c12.5 12.5 12.5 32.8 0 45.3l-160 160c-12.5 12.5-32.8 12.5-45.3 0s-12.5-32.8 0-45.3L210.7 256 73.4 118.6c-12.5-12.5-12.5-32.8 0-45.3s32.8-12.5 45.3 0l160 160z" fill="currentColor"></path></svg><svg class="svg-inline--fa fa-angle-down fa-fw" focusable="false" aria-hidden="true" role="img" viewBox="0 0 448 512" data-icon="angle-down" data-prefix="fas" xmlns="http://www.w3.org/2000/svg"><path d="M201.4 374.6c12.5 12.5 32.8 12.5 45.3 0l160-160c12.5-12.5 12.5-32.8 0-45.3s-32.8-12.5-45.3 0L224 306.7 86.6 169.4c-12.5-12.5-32.8-12.5-45.3 0s-12.5 32.8 0 45.3l160 160z" fill="currentColor"></path></svg><a href="/entry/2011/">2011 (12)</a></label><ul class="tree-child"><li><a href="/entry/2011/09/">2011/09 (1)</a></li><li><a href="/entry/2011/06/">2011/06 (1)</a></li><li><a href="/entry/2011/05/">2011/05 (1)</a></li><li><a href="/entry/2011/03/">2011/03 (6)</a></li><li><a href="/entry/2011/02/">2011/02 (1)</a></li><li><a href="/entry/2011/01/">2011/01 (2)</a></li></ul></li></ul></section></div></div><div class="footer-bottom"><div class="container"><div class="copyright">© 2011-2022 Tosainu. Site generated by <a href="https://jaspervdj.be/hakyll/" target="_blank" rel="nofollow noopener">Hakyll</a>.</div></div></div></footer></body></html>
