<!DOCTYPE HTML><html lang="ja"><head><meta charset="utf-8"><meta content="Tosainu" name="author"><meta content="[Ultra96](https://www.96boards.org/product/ultra96/) というデバイスがあります。Ultra96 は Xilinx 社の [Zynq UltraScale+ MPSoC](https://www.xilinx.com/products/silicon" name="description"><meta content="Hakyll" name="generator"><meta content="width=device-width, initial-scale=1" name="viewport"><meta property="twitter:card" content="summary"><meta property="twitter:site" content="myon___"><meta property="twitter:creator" content="myon___"><meta property="og:type" content="article"><meta property="og:url" content="https://blog.myon.info/entry/2019/05/15/ultra96-julia-set-explorer/index.html"><meta property="og:title" content="Ultra96 で Julia set をぐりぐり動かせるやつを作った | Tosainu Lab"><meta property="og:description" content="[Ultra96](https://www.96boards.org/product/ultra96/) というデバイスがあります。Ultra96 は Xilinx 社の [Zynq UltraScale+ MPSoC](https://www.xilinx.com/products/silicon"><meta property="og:site_name" content="Tosainu Lab"><meta property="og:image" content="https://blog.myon.info/entry/2019/05/15/ultra96-julia-set-explorer/fractal_example.png"><title>Ultra96 で Julia set をぐりぐり動かせるやつを作った | Tosainu Lab</title><link href="/vendor/normalize.css/normalize.css" rel="stylesheet"><link href="/stylesheets/style.css" rel="stylesheet"><link href="/stylesheets/highlight.css" rel="stylesheet"><link href="/vendor/fontawesome/style.css" rel="stylesheet"><link href="/vendor/katex/katex.min.css" rel="stylesheet"><link href="/feed.xml" title="Atom Feed" type="application/atom+xml" rel="alternate"><script async src="https://www.googletagmanager.com/gtag/js?id=G-X1CGBSMEQW"></script><script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments);}gtag('js',new Date());gtag('config','G-X1CGBSMEQW');</script></head><body><header class="site-header"><div class="container"><h1><a href="/" title="home">Tosainu Lab</a></h1></div></header><main class="post"><article><header class="post-header"><div class="container"><h1><a href="/entry/2019/05/15/ultra96-julia-set-explorer/">Ultra96 で Julia set をぐりぐり動かせるやつを作った</a></h1><ul class="post-meta"><li><svg class="svg-inline--fa fa-calendar" focusable="false" aria-hidden="true" role="img" viewBox="0 0 448 512" data-icon="calendar" data-prefix="fas" xmlns="http://www.w3.org/2000/svg"><path d="M96 32V64H48C21.5 64 0 85.5 0 112v48H448V112c0-26.5-21.5-48-48-48H352V32c0-17.7-14.3-32-32-32s-32 14.3-32 32V64H160V32c0-17.7-14.3-32-32-32S96 14.3 96 32zM448 192H0V464c0 26.5 21.5 48 48 48H400c26.5 0 48-21.5 48-48V192z" fill="currentColor"></path></svg></li><li class="date">2019/05/15 12:52</li><li><svg class="svg-inline--fa fa-tags" focusable="false" aria-hidden="true" role="img" viewBox="0 0 512 512" data-icon="tags" data-prefix="fas" xmlns="http://www.w3.org/2000/svg"><path d="M345 39.1L472.8 168.4c52.4 53 52.4 138.2 0 191.2L360.8 472.9c-9.3 9.4-24.5 9.5-33.9 .2s-9.5-24.5-.2-33.9L438.6 325.9c33.9-34.3 33.9-89.4 0-123.7L310.9 72.9c-9.3-9.4-9.2-24.6 .2-33.9s24.6-9.2 33.9 .2zM0 229.5V80C0 53.5 21.5 32 48 32H197.5c17 0 33.3 6.7 45.3 18.7l168 168c25 25 25 65.5 0 90.5L277.3 442.7c-25 25-65.5 25-90.5 0l-168-168C6.7 262.7 0 246.5 0 229.5zM144 144c0-17.7-14.3-32-32-32s-32 14.3-32 32s14.3 32 32 32s32-14.3 32-32z" fill="currentColor"></path></svg></li><li><ul class="tag-list"><li><a href="/entry/tags/fpga/"><span>FPGA</span></a></li><li><a href="/entry/tags/c/"><span>C++</span></a></li></ul></li></ul></div></header><div class="container"><div class="post-contents"><p><a href="https://www.96boards.org/product/ultra96/" target="_blank" rel="nofollow noopener">Ultra96</a> というデバイスがあります。Ultra96 は Xilinx 社の <a href="https://www.xilinx.com/products/silicon-devices/soc/zynq-ultrascale-mpsoc.html" target="_blank" rel="nofollow noopener">Zynq UltraScale+ MPSoC</a> が載っている開発ボードで、<a href="https://en.wikipedia.org/wiki/Field-programmable_gate_array" target="_blank" rel="nofollow noopener">FPGA</a> 開発から最新の ARM 開発、Linux カーネルやそのデバイスドライバ開発なんかも学べて、しかも$249で入手できるというコスパの高い<a href="/entry/2019/05/15/ultra96-julia-set-explorer/#fn1" class="footnote-ref" id="fnref1" role="doc-noteref"><sup>1</sup></a>デバイスです。</p>
<p>今回いろいろあって Ultra96 で遊べる環境ができたので、Julia set を表示してぐりぐり動かせるやつを作ってみました。こんな感じです。</p>
<blockquote class="twitter-tweet tw-align-center" data-lang="en">
<p lang="ja" dir="ltr">
当初の目標だった「Ultra96 に直接接続したゲームパッドでぐりぐり動かす」ができた ヾ(๑&gt;◡&lt;)ﾉ&quot; <a href="https://t.co/AMDp3hPPnz" target="_blank" rel="nofollow noopener">pic.twitter.com/AMDp3hPPnz</a>
</p>
— +。:.ﾟ٩(๑＞◡＜๑)۶:.｡+ﾟ (@myon___) <a href="https://twitter.com/myon___/status/1112762085799157763?ref_src=twsrc%5Etfw" target="_blank" rel="nofollow noopener">April 1, 2019</a>
</blockquote>
<script async src="https://platform.twitter.com/widgets.js" charset="utf-8"></script>
<p>関連するソースコードはほぼ全て <a href="https://github.com/Tosainu/ultra96-fractal" target="_blank" rel="nofollow noopener">GitHub のリポジトリ</a> に公開してあります。</p>
<p>まだ当初予定していた機能を実装しきれていなかったりしますが、とりあえずシステム全体とその開発方法などを紹介していきたいと思います。</p>
<!--more-->
<h2 id="julia-set">Julia set</h2>
<p><a href="https://en.wikipedia.org/wiki/Julia_set" target="_blank" rel="nofollow noopener">Julia set</a> は<a href="https://en.wikipedia.org/wiki/Fractal" target="_blank" rel="nofollow noopener">フラクタル</a>として知られる図形の1つです。同様の図形だと <a href="https://en.wikipedia.org/wiki/Mandelbrot_set" target="_blank" rel="nofollow noopener">Mandelbrot set</a> のほうが有名かもしれませんが、個人的にはこっちのほうが好きです。</p>
<p>Julia set は、ある複素数の多項式関数 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>f</mi><mi>c</mi></msub><mo stretchy="false">(</mo><mi>z</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">f_c(z)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:-0.1076em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">c</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.04398em;">z</span><span class="mclose">)</span></span></span></span> に初期値 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>z</mi><mn>0</mn></msub></mrow><annotation encoding="application/x-tex">z_0</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.5806em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.04398em;">z</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.044em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">0</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> を与えて繰り返し適用したときに、収束する領域と発散する領域の境界になるような <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>z</mi><mn>0</mn></msub></mrow><annotation encoding="application/x-tex">z_0</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.5806em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.04398em;">z</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.044em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">0</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> の集合のことらしいです。そして Julia set の描画は、画像の各ピクセルの座標値から <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>z</mi><mn>0</mn></msub></mrow><annotation encoding="application/x-tex">z_0</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.5806em;vertical-align:-0.15em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.04398em;">z</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3011em;"><span style="top:-2.55em;margin-left:-0.044em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">0</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span></span></span></span> を決めて、その値を <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>f</mi><mi>c</mi></msub><mo stretchy="false">(</mo><mi>z</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">f_c(z)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:-0.1076em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">c</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.04398em;">z</span><span class="mclose">)</span></span></span></span> に与えて繰り返し適用したときの動きをもとに色を割り当てることで行います。</p>
<p>…といってもイメージしにくいので、有名な <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>f</mi><mi>c</mi></msub><mo stretchy="false">(</mo><mi>z</mi><mo stretchy="false">)</mo></mrow><annotation encoding="application/x-tex">f_c(z)</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:-0.1076em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">c</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.04398em;">z</span><span class="mclose">)</span></span></span></span> である
<span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><msub><mi>f</mi><mi>c</mi></msub><mo stretchy="false">(</mo><mi>z</mi><mo stretchy="false">)</mo><mo>=</mo><msup><mi>z</mi><mn>2</mn></msup><mo>+</mo><mi>c</mi></mrow><annotation encoding="application/x-tex">
f_c(z) = z^2 + c
</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:1em;vertical-align:-0.25em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.10764em;">f</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em;"><span style="top:-2.55em;margin-left:-0.1076em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">c</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em;"><span></span></span></span></span></span></span><span class="mopen">(</span><span class="mord mathnormal" style="margin-right:0.04398em;">z</span><span class="mclose">)</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span></span><span class="base"><span class="strut" style="height:0.9474em;vertical-align:-0.0833em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.04398em;">z</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8641em;"><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">+</span><span class="mspace" style="margin-right:0.2222em;"></span></span><span class="base"><span class="strut" style="height:0.4306em;"></span><span class="mord mathnormal">c</span></span></span></span></span>
を Rust で描いてみます。コードは <a href="https://github.com/image-rs/image#62-generating-fractals" target="_blank" rel="nofollow noopener">image crate の Example</a> で紹介されているものをベースにしました。</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode rust"><code class="sourceCode rust"><span id="cb1-1"><a href="/entry/2019/05/15/ultra96-julia-set-explorer/#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="kw">fn</span> main() <span class="op">{</span></span>
<span id="cb1-2"><a href="/entry/2019/05/15/ultra96-julia-set-explorer/#cb1-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">// 画像のサイズ</span></span>
<span id="cb1-3"><a href="/entry/2019/05/15/ultra96-julia-set-explorer/#cb1-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">let</span> (imgx<span class="op">,</span> imgy) <span class="op">=</span> (<span class="dv">960</span><span class="op">,</span> <span class="dv">600</span>)<span class="op">;</span></span>
<span id="cb1-4"><a href="/entry/2019/05/15/ultra96-julia-set-explorer/#cb1-4" aria-hidden="true" tabindex="-1"></a>    <span class="co">// 最大反復回数</span></span>
<span id="cb1-5"><a href="/entry/2019/05/15/ultra96-julia-set-explorer/#cb1-5" aria-hidden="true" tabindex="-1"></a>    <span class="kw">let</span> max_iter <span class="op">=</span> <span class="dv">255</span><span class="op">;</span></span>
<span id="cb1-6"><a href="/entry/2019/05/15/ultra96-julia-set-explorer/#cb1-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-7"><a href="/entry/2019/05/15/ultra96-julia-set-explorer/#cb1-7" aria-hidden="true" tabindex="-1"></a>    <span class="kw">let</span> x0 <span class="op">=</span> <span class="dv">1.0</span><span class="op">;</span></span>
<span id="cb1-8"><a href="/entry/2019/05/15/ultra96-julia-set-explorer/#cb1-8" aria-hidden="true" tabindex="-1"></a>    <span class="kw">let</span> y0 <span class="op">=</span> imgy <span class="kw">as</span> <span class="dt">f32</span> <span class="op">/</span> imgx <span class="kw">as</span> <span class="dt">f32</span><span class="op">;</span></span>
<span id="cb1-9"><a href="/entry/2019/05/15/ultra96-julia-set-explorer/#cb1-9" aria-hidden="true" tabindex="-1"></a>    <span class="kw">let</span> dx <span class="op">=</span> <span class="dv">2.0</span> <span class="op">*</span> x0 <span class="op">/</span> imgx <span class="kw">as</span> <span class="dt">f32</span><span class="op">;</span></span>
<span id="cb1-10"><a href="/entry/2019/05/15/ultra96-julia-set-explorer/#cb1-10" aria-hidden="true" tabindex="-1"></a>    <span class="kw">let</span> dy <span class="op">=</span> <span class="dv">2.0</span> <span class="op">*</span> y0 <span class="op">/</span> imgy <span class="kw">as</span> <span class="dt">f32</span><span class="op">;</span></span>
<span id="cb1-11"><a href="/entry/2019/05/15/ultra96-julia-set-explorer/#cb1-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-12"><a href="/entry/2019/05/15/ultra96-julia-set-explorer/#cb1-12" aria-hidden="true" tabindex="-1"></a>    <span class="kw">let</span> <span class="kw">mut</span> imgbuf <span class="op">=</span> <span class="pp">image::ImageBuffer::</span>new(imgx<span class="op">,</span> imgy)<span class="op">;</span></span>
<span id="cb1-13"><a href="/entry/2019/05/15/ultra96-julia-set-explorer/#cb1-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-14"><a href="/entry/2019/05/15/ultra96-julia-set-explorer/#cb1-14" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> (x<span class="op">,</span> y<span class="op">,</span> pixel) <span class="kw">in</span> imgbuf<span class="op">.</span>enumerate_pixels_mut() <span class="op">{</span></span>
<span id="cb1-15"><a href="/entry/2019/05/15/ultra96-julia-set-explorer/#cb1-15" aria-hidden="true" tabindex="-1"></a>        <span class="co">// 定数 c</span></span>
<span id="cb1-16"><a href="/entry/2019/05/15/ultra96-julia-set-explorer/#cb1-16" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> c <span class="op">=</span> <span class="pp">num_complex::Complex::</span>new(<span class="op">-</span><span class="dv">0.4</span><span class="op">,</span> <span class="dv">0.6</span>)<span class="op">;</span></span>
<span id="cb1-17"><a href="/entry/2019/05/15/ultra96-julia-set-explorer/#cb1-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-18"><a href="/entry/2019/05/15/ultra96-julia-set-explorer/#cb1-18" aria-hidden="true" tabindex="-1"></a>        <span class="co">// 初期値 z_0</span></span>
<span id="cb1-19"><a href="/entry/2019/05/15/ultra96-julia-set-explorer/#cb1-19" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> cx <span class="op">=</span> <span class="op">-</span>x0 <span class="op">+</span> dx <span class="op">*</span> x <span class="kw">as</span> <span class="dt">f32</span><span class="op">;</span></span>
<span id="cb1-20"><a href="/entry/2019/05/15/ultra96-julia-set-explorer/#cb1-20" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> cy <span class="op">=</span> <span class="op">-</span>y0 <span class="op">+</span> dy <span class="op">*</span> y <span class="kw">as</span> <span class="dt">f32</span><span class="op">;</span></span>
<span id="cb1-21"><a href="/entry/2019/05/15/ultra96-julia-set-explorer/#cb1-21" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> z_0 <span class="op">=</span> <span class="pp">num_complex::Complex::</span>new(cx<span class="op">,</span> cy)<span class="op">;</span></span>
<span id="cb1-22"><a href="/entry/2019/05/15/ultra96-julia-set-explorer/#cb1-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-23"><a href="/entry/2019/05/15/ultra96-julia-set-explorer/#cb1-23" aria-hidden="true" tabindex="-1"></a>        <span class="co">// z_{i + 1} = z^2 + c を計算</span></span>
<span id="cb1-24"><a href="/entry/2019/05/15/ultra96-julia-set-explorer/#cb1-24" aria-hidden="true" tabindex="-1"></a>        <span class="co">// |z| &gt; 2.0 になったら &quot;発散した&quot; とする</span></span>
<span id="cb1-25"><a href="/entry/2019/05/15/ultra96-julia-set-explorer/#cb1-25" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> <span class="kw">mut</span> z <span class="op">=</span> z_0<span class="op">;</span></span>
<span id="cb1-26"><a href="/entry/2019/05/15/ultra96-julia-set-explorer/#cb1-26" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> <span class="kw">mut</span> i <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb1-27"><a href="/entry/2019/05/15/ultra96-julia-set-explorer/#cb1-27" aria-hidden="true" tabindex="-1"></a>        <span class="cf">while</span> i <span class="op">&lt;</span> max_iter <span class="op">&amp;&amp;</span> z<span class="op">.</span>norm() <span class="op">&lt;=</span> <span class="dv">2.0</span> <span class="op">{</span></span>
<span id="cb1-28"><a href="/entry/2019/05/15/ultra96-julia-set-explorer/#cb1-28" aria-hidden="true" tabindex="-1"></a>            z <span class="op">=</span> z <span class="op">*</span> z <span class="op">+</span> c<span class="op">;</span></span>
<span id="cb1-29"><a href="/entry/2019/05/15/ultra96-julia-set-explorer/#cb1-29" aria-hidden="true" tabindex="-1"></a>            i <span class="op">+=</span> <span class="dv">1</span><span class="op">;</span></span>
<span id="cb1-30"><a href="/entry/2019/05/15/ultra96-julia-set-explorer/#cb1-30" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb1-31"><a href="/entry/2019/05/15/ultra96-julia-set-explorer/#cb1-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-32"><a href="/entry/2019/05/15/ultra96-julia-set-explorer/#cb1-32" aria-hidden="true" tabindex="-1"></a>        <span class="co">// 反復回数 i をベースに色つけ</span></span>
<span id="cb1-33"><a href="/entry/2019/05/15/ultra96-julia-set-explorer/#cb1-33" aria-hidden="true" tabindex="-1"></a>        <span class="op">*</span>pixel <span class="op">=</span> colorize(i <span class="kw">as</span> <span class="dt">f32</span> <span class="op">/</span> max_iter <span class="kw">as</span> <span class="dt">f32</span>)<span class="op">;</span></span>
<span id="cb1-34"><a href="/entry/2019/05/15/ultra96-julia-set-explorer/#cb1-34" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb1-35"><a href="/entry/2019/05/15/ultra96-julia-set-explorer/#cb1-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-36"><a href="/entry/2019/05/15/ultra96-julia-set-explorer/#cb1-36" aria-hidden="true" tabindex="-1"></a>    imgbuf<span class="op">.</span>save(<span class="st">&quot;fractal.png&quot;</span>)<span class="op">.</span>unwrap()<span class="op">;</span></span>
<span id="cb1-37"><a href="/entry/2019/05/15/ultra96-julia-set-explorer/#cb1-37" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb1-38"><a href="/entry/2019/05/15/ultra96-julia-set-explorer/#cb1-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-39"><a href="/entry/2019/05/15/ultra96-julia-set-explorer/#cb1-39" aria-hidden="true" tabindex="-1"></a><span class="kw">fn</span> colorize(t<span class="op">:</span> <span class="dt">f32</span>) <span class="op">-&gt;</span> <span class="pp">image::</span>Rgb<span class="op">&lt;</span><span class="dt">u8</span><span class="op">&gt;</span> <span class="op">{</span></span>
<span id="cb1-40"><a href="/entry/2019/05/15/ultra96-julia-set-explorer/#cb1-40" aria-hidden="true" tabindex="-1"></a>    <span class="kw">let</span> m <span class="op">=</span> <span class="pp">std::</span><span class="dt">u8</span><span class="pp">::</span><span class="cn">MAX</span> <span class="kw">as</span> <span class="dt">f32</span><span class="op">;</span></span>
<span id="cb1-41"><a href="/entry/2019/05/15/ultra96-julia-set-explorer/#cb1-41" aria-hidden="true" tabindex="-1"></a>    <span class="kw">let</span> r <span class="op">=</span> m <span class="op">*</span> <span class="dv">9.0</span> <span class="op">*</span> (<span class="dv">1.0</span> <span class="op">-</span> t) <span class="op">*</span> t <span class="op">*</span> t <span class="op">*</span> t<span class="op">;</span></span>
<span id="cb1-42"><a href="/entry/2019/05/15/ultra96-julia-set-explorer/#cb1-42" aria-hidden="true" tabindex="-1"></a>    <span class="kw">let</span> g <span class="op">=</span> m <span class="op">*</span> <span class="dv">15.0</span> <span class="op">*</span> (<span class="dv">1.0</span> <span class="op">-</span> t) <span class="op">*</span> (<span class="dv">1.0</span> <span class="op">-</span> t) <span class="op">*</span> t <span class="op">*</span> t<span class="op">;</span></span>
<span id="cb1-43"><a href="/entry/2019/05/15/ultra96-julia-set-explorer/#cb1-43" aria-hidden="true" tabindex="-1"></a>    <span class="kw">let</span> b <span class="op">=</span> m <span class="op">*</span> <span class="dv">8.5</span> <span class="op">*</span> (<span class="dv">1.0</span> <span class="op">-</span> t) <span class="op">*</span> (<span class="dv">1.0</span> <span class="op">-</span> t) <span class="op">*</span> (<span class="dv">1.0</span> <span class="op">-</span> t) <span class="op">*</span> t<span class="op">;</span></span>
<span id="cb1-44"><a href="/entry/2019/05/15/ultra96-julia-set-explorer/#cb1-44" aria-hidden="true" tabindex="-1"></a>    <span class="pp">image::</span>Rgb([r <span class="kw">as</span> <span class="dt">u8</span><span class="op">,</span> g <span class="kw">as</span> <span class="dt">u8</span><span class="op">,</span> b <span class="kw">as</span> <span class="dt">u8</span>])</span>
<span id="cb1-45"><a href="/entry/2019/05/15/ultra96-julia-set-explorer/#cb1-45" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>これを実行するとこんな感じの画像が出力されます。</p>
<p><img src="/entry/2019/05/15/ultra96-julia-set-explorer/fractal_example.png" /></p>
<h2 id="fpga-で-julia-set-を描画する">FPGA で Julia set を描画する</h2>
<p>前述したコードからもわかるように、Julia set の描画はそこそこの計算量があります。これをいかに速く計算するかは長く研究されているようで、いろいろなアプローチが見つかります。今回は Zynq UltraScale+ MPSoC のプログラマブルな回路側 (Programmable Logic, PL) に <strong>Julia set の描画専用の回路を構築</strong>することで高速に描画することを試みてみました。</p>
<h3 id="高位合成-high-level-synthesis-hls">高位合成 (High-level synthesis, HLS)</h3>
<p>FPGA 開発というと、VHDL や Verilog HDL といった <a href="https://en.wikipedia.org/wiki/Hardware_description_language" target="_blank" rel="nofollow noopener">Hardware description language (HDL)</a> によって <a href="https://en.wikipedia.org/wiki/Register-transfer_level" target="_blank" rel="nofollow noopener">Register-transfer level (RTL)</a> の記述をするイメージが強いかもしれません。FPGA 開発全体でみればそのような言語を使った開発が一般的なのでしょうが、近年<a href="https://en.wikipedia.org/wiki/High-level_synthesis" target="_blank" rel="nofollow noopener">高位合成 (High-level synthesis, HLS)</a> と呼ばれる技術がある程度の実用レベルになりつつあり、これを利用した開発手法が話題になっています。</p>
<p>HLS は RTL より抽象度の高い言語によってハードウェアの設計を可能にする技術です。HLS にも様々な種類があるので一概にはいえませんが、この抽象度の高い言語とは C や Java のようなソフトウェア開発のためのプログラミング言語を指します。プログラミング言語で記述したアルゴリズムがどのようにハードウェア化されるかは<a href="https://www.xilinx.com/support/documentation/sw_manuals/xilinx2018_3/ug902-vivado-high-level-synthesis.pdf#page=6" target="_blank" rel="nofollow noopener">このへん</a>が参考になると思います。ソフトウェア向けのプログラミング言語を用いた記述を入力とする HLS はソフトウェアで実装されたアルゴリズムのハードウェア化をある程度容易にしたことから、特にハードウェアアクセラレータ実装をしている界隈などで注目されているなかなかホットな技術といってよいでしょう。</p>
<p>今回 Julia set を描画する回路を設計するにあたり、Xilinx 社が提供している HLS の開発環境である <a href="https://www.xilinx.com/products/design-tools/vivado/integration/esl-design.html" target="_blank" rel="nofollow noopener">Vivado HLS</a> を利用することにしました。理由としては、とりあえず動作するものを短期間で実装したかったのと、個人的に別の HLS 開発環境に触れていた経験があることから Xilinx の HLS についても調査したいという思いがあったためです。</p>
<h3 id="vivado-hls-で-julia-set-描画回路を実装する">Vivado HLS で Julia set 描画回路を実装する</h3>
<p>Vivado HLS は入力言語に C、C++、SystemC をサポートしています。今回は C++ で実装しました。最終的なソースコードは<a href="https://github.com/Tosainu/ultra96-fractal/tree/1ed4e5e409d6445a85741149c112322cc6fc251c/hls_ip/fractal" target="_blank" rel="nofollow noopener">これ</a>です。</p>
<p>Vivado HLS は思っていた以上に強かったようで、とりあえず適当に実装してみた Julia set のコードも普通に合成できてしまい驚きました。このため「アルゴリズムを FPGA に持っていく」点に関してはほとんど苦労することなく行うことができたと言って良いです。Vivado HLS すごい。ちなみにコミットログをたどったところ、開発初期のコードは<a href="https://github.com/Tosainu/ultra96-fractal/blob/9aeb006057254d9e9d859b307b64db8e86adc5ef/hls_ip/fractal/fractal.cc" target="_blank" rel="nofollow noopener">こんな感じ</a>だったようです。</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb2-1"><a href="/entry/2019/05/15/ultra96-julia-set-explorer/#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;cmath&gt;</span></span>
<span id="cb2-2"><a href="/entry/2019/05/15/ultra96-julia-set-explorer/#cb2-2" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;complex&gt;</span></span>
<span id="cb2-3"><a href="/entry/2019/05/15/ultra96-julia-set-explorer/#cb2-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-4"><a href="/entry/2019/05/15/ultra96-julia-set-explorer/#cb2-4" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&quot;fractal.h&quot;</span></span>
<span id="cb2-5"><a href="/entry/2019/05/15/ultra96-julia-set-explorer/#cb2-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-6"><a href="/entry/2019/05/15/ultra96-julia-set-explorer/#cb2-6" aria-hidden="true" tabindex="-1"></a><span class="dt">uint24_type</span> colorize<span class="op">(</span><span class="dt">fix64_type</span> t<span class="op">)</span> <span class="op">{</span></span>
<span id="cb2-7"><a href="/entry/2019/05/15/ultra96-julia-set-explorer/#cb2-7" aria-hidden="true" tabindex="-1"></a>  <span class="co">// https://solarianprogrammer.com/2013/02/28/mandelbrot-set-cpp-11/</span></span>
<span id="cb2-8"><a href="/entry/2019/05/15/ultra96-julia-set-explorer/#cb2-8" aria-hidden="true" tabindex="-1"></a>  <span class="at">const</span> <span class="dt">fix64_type</span> one<span class="op">{</span><span class="fl">1.0</span><span class="op">};</span></span>
<span id="cb2-9"><a href="/entry/2019/05/15/ultra96-julia-set-explorer/#cb2-9" aria-hidden="true" tabindex="-1"></a>  <span class="at">const</span> <span class="dt">fix64_type</span> r <span class="op">=</span> <span class="dt">fix64_type</span><span class="op">{</span><span class="fl">8.5</span><span class="op">}</span> <span class="op">*</span> <span class="op">(</span>one <span class="op">-</span> t<span class="op">)</span> <span class="op">*</span> <span class="op">(</span>one <span class="op">-</span> t<span class="op">)</span> <span class="op">*</span> <span class="op">(</span>one <span class="op">-</span> t<span class="op">)</span> <span class="op">*</span> t<span class="op">;</span></span>
<span id="cb2-10"><a href="/entry/2019/05/15/ultra96-julia-set-explorer/#cb2-10" aria-hidden="true" tabindex="-1"></a>  <span class="at">const</span> <span class="dt">fix64_type</span> g <span class="op">=</span> <span class="dt">fix64_type</span><span class="op">{</span><span class="fl">15.0</span><span class="op">}</span> <span class="op">*</span> <span class="op">(</span>one <span class="op">-</span> t<span class="op">)</span> <span class="op">*</span> <span class="op">(</span>one <span class="op">-</span> t<span class="op">)</span> <span class="op">*</span> t <span class="op">*</span> t<span class="op">;</span></span>
<span id="cb2-11"><a href="/entry/2019/05/15/ultra96-julia-set-explorer/#cb2-11" aria-hidden="true" tabindex="-1"></a>  <span class="at">const</span> <span class="dt">fix64_type</span> b <span class="op">=</span> <span class="dt">fix64_type</span><span class="op">{</span><span class="fl">9.0</span><span class="op">}</span> <span class="op">*</span> <span class="op">(</span>one <span class="op">-</span> t<span class="op">)</span> <span class="op">*</span> t <span class="op">*</span> t <span class="op">*</span> t<span class="op">;</span></span>
<span id="cb2-12"><a href="/entry/2019/05/15/ultra96-julia-set-explorer/#cb2-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-13"><a href="/entry/2019/05/15/ultra96-julia-set-explorer/#cb2-13" aria-hidden="true" tabindex="-1"></a>  <span class="dt">uint24_type</span> rgb <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb2-14"><a href="/entry/2019/05/15/ultra96-julia-set-explorer/#cb2-14" aria-hidden="true" tabindex="-1"></a>  rgb <span class="op">|=</span> <span class="kw">static_cast</span><span class="op">&lt;</span><span class="dt">uint24_type</span><span class="op">&gt;(</span><span class="bu">std::</span>min<span class="op">(</span>r<span class="op">,</span> one<span class="op">)</span> <span class="op">*</span> <span class="dt">fix64_type</span><span class="op">{</span><span class="fl">255.0</span><span class="op">});</span></span>
<span id="cb2-15"><a href="/entry/2019/05/15/ultra96-julia-set-explorer/#cb2-15" aria-hidden="true" tabindex="-1"></a>  rgb <span class="op">|=</span> <span class="kw">static_cast</span><span class="op">&lt;</span><span class="dt">uint24_type</span><span class="op">&gt;(</span><span class="bu">std::</span>min<span class="op">(</span>g<span class="op">,</span> one<span class="op">)</span> <span class="op">*</span> <span class="dt">fix64_type</span><span class="op">{</span><span class="fl">255.0</span><span class="op">})</span> <span class="op">&lt;&lt;</span> <span class="dv">8</span><span class="op">;</span></span>
<span id="cb2-16"><a href="/entry/2019/05/15/ultra96-julia-set-explorer/#cb2-16" aria-hidden="true" tabindex="-1"></a>  rgb <span class="op">|=</span> <span class="kw">static_cast</span><span class="op">&lt;</span><span class="dt">uint24_type</span><span class="op">&gt;(</span><span class="bu">std::</span>min<span class="op">(</span>b<span class="op">,</span> one<span class="op">)</span> <span class="op">*</span> <span class="dt">fix64_type</span><span class="op">{</span><span class="fl">255.0</span><span class="op">})</span> <span class="op">&lt;&lt;</span> <span class="dv">16</span><span class="op">;</span></span>
<span id="cb2-17"><a href="/entry/2019/05/15/ultra96-julia-set-explorer/#cb2-17" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> rgb<span class="op">;</span></span>
<span id="cb2-18"><a href="/entry/2019/05/15/ultra96-julia-set-explorer/#cb2-18" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb2-19"><a href="/entry/2019/05/15/ultra96-julia-set-explorer/#cb2-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-20"><a href="/entry/2019/05/15/ultra96-julia-set-explorer/#cb2-20" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span> fractal<span class="op">(</span><span class="dt">stream_type</span><span class="op">&amp;</span> <span class="va">m_axis</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb2-21"><a href="/entry/2019/05/15/ultra96-julia-set-explorer/#cb2-21" aria-hidden="true" tabindex="-1"></a><span class="pp">#pragma HLS INTERFACE axis register both port=m_axis</span></span>
<span id="cb2-22"><a href="/entry/2019/05/15/ultra96-julia-set-explorer/#cb2-22" aria-hidden="true" tabindex="-1"></a><span class="pp">#pragma HLS INTERFACE s_axilite port=return</span></span>
<span id="cb2-23"><a href="/entry/2019/05/15/ultra96-julia-set-explorer/#cb2-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-24"><a href="/entry/2019/05/15/ultra96-julia-set-explorer/#cb2-24" aria-hidden="true" tabindex="-1"></a>  <span class="at">const</span> <span class="kw">auto</span> x1 <span class="op">=</span> <span class="dt">fix64_type</span><span class="op">{</span><span class="fl">1.0</span><span class="op">};</span></span>
<span id="cb2-25"><a href="/entry/2019/05/15/ultra96-julia-set-explorer/#cb2-25" aria-hidden="true" tabindex="-1"></a>  <span class="at">const</span> <span class="kw">auto</span> y1 <span class="op">=</span> <span class="dt">fix64_type</span><span class="op">{</span>MAX_HEIGHT<span class="op">}</span> <span class="op">/</span> <span class="dt">fix64_type</span><span class="op">{</span>MAX_WIDTH<span class="op">};</span></span>
<span id="cb2-26"><a href="/entry/2019/05/15/ultra96-julia-set-explorer/#cb2-26" aria-hidden="true" tabindex="-1"></a>  <span class="at">const</span> <span class="kw">auto</span> dx <span class="op">=</span> <span class="dt">fix64_type</span><span class="op">{</span><span class="fl">2.0</span><span class="op">}</span> <span class="op">*</span> x1 <span class="op">/</span> <span class="dt">fix64_type</span><span class="op">{</span>MAX_WIDTH<span class="op">};</span></span>
<span id="cb2-27"><a href="/entry/2019/05/15/ultra96-julia-set-explorer/#cb2-27" aria-hidden="true" tabindex="-1"></a>  <span class="at">const</span> <span class="kw">auto</span> dy <span class="op">=</span> <span class="dt">fix64_type</span><span class="op">{</span><span class="fl">2.0</span><span class="op">}</span> <span class="op">*</span> y1 <span class="op">/</span> <span class="dt">fix64_type</span><span class="op">{</span>MAX_HEIGHT<span class="op">};</span></span>
<span id="cb2-28"><a href="/entry/2019/05/15/ultra96-julia-set-explorer/#cb2-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-29"><a href="/entry/2019/05/15/ultra96-julia-set-explorer/#cb2-29" aria-hidden="true" tabindex="-1"></a>  <span class="at">const</span> <span class="kw">auto</span> offset_x <span class="op">=</span> <span class="dt">fix64_type</span><span class="op">{</span><span class="dv">0</span><span class="op">};</span></span>
<span id="cb2-30"><a href="/entry/2019/05/15/ultra96-julia-set-explorer/#cb2-30" aria-hidden="true" tabindex="-1"></a>  <span class="at">const</span> <span class="kw">auto</span> offset_y <span class="op">=</span> <span class="dt">fix64_type</span><span class="op">{</span><span class="dv">0</span><span class="op">};</span></span>
<span id="cb2-31"><a href="/entry/2019/05/15/ultra96-julia-set-explorer/#cb2-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-32"><a href="/entry/2019/05/15/ultra96-julia-set-explorer/#cb2-32" aria-hidden="true" tabindex="-1"></a>  <span class="dt">video_type</span> video<span class="op">;</span></span>
<span id="cb2-33"><a href="/entry/2019/05/15/ultra96-julia-set-explorer/#cb2-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-34"><a href="/entry/2019/05/15/ultra96-julia-set-explorer/#cb2-34" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> <span class="op">(</span><span class="bu">std::</span>uint32_t<span class="op"> </span>y <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> y <span class="op">&lt;</span> MAX_HEIGHT<span class="op">;</span> y<span class="op">++)</span> <span class="op">{</span></span>
<span id="cb2-35"><a href="/entry/2019/05/15/ultra96-julia-set-explorer/#cb2-35" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> <span class="op">(</span><span class="bu">std::</span>uint32_t<span class="op"> </span>x <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> x <span class="op">&lt;</span> MAX_WIDTH<span class="op">;</span> x<span class="op">++)</span> <span class="op">{</span></span>
<span id="cb2-36"><a href="/entry/2019/05/15/ultra96-julia-set-explorer/#cb2-36" aria-hidden="true" tabindex="-1"></a>      <span class="co">// Set Start-of-Frame (tuser) and End-of-Line (tlast) singale</span></span>
<span id="cb2-37"><a href="/entry/2019/05/15/ultra96-julia-set-explorer/#cb2-37" aria-hidden="true" tabindex="-1"></a>      <span class="co">// https://forums.xilinx.com/t5/Video/Video-Beginner-Series-14-Creating-a-Pattern-Generator-using-HLS/m-p/895489/highlight/true#M21986</span></span>
<span id="cb2-38"><a href="/entry/2019/05/15/ultra96-julia-set-explorer/#cb2-38" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> <span class="op">(</span>x <span class="op">==</span> <span class="dv">0</span> <span class="op">&amp;&amp;</span> y <span class="op">==</span> <span class="dv">0</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb2-39"><a href="/entry/2019/05/15/ultra96-julia-set-explorer/#cb2-39" aria-hidden="true" tabindex="-1"></a>        video<span class="op">.</span>user <span class="op">=</span> <span class="dv">1</span><span class="op">;</span></span>
<span id="cb2-40"><a href="/entry/2019/05/15/ultra96-julia-set-explorer/#cb2-40" aria-hidden="true" tabindex="-1"></a>      <span class="op">}</span> <span class="cf">else</span> <span class="op">{</span></span>
<span id="cb2-41"><a href="/entry/2019/05/15/ultra96-julia-set-explorer/#cb2-41" aria-hidden="true" tabindex="-1"></a>        video<span class="op">.</span>user <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb2-42"><a href="/entry/2019/05/15/ultra96-julia-set-explorer/#cb2-42" aria-hidden="true" tabindex="-1"></a>      <span class="op">}</span></span>
<span id="cb2-43"><a href="/entry/2019/05/15/ultra96-julia-set-explorer/#cb2-43" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> <span class="op">(</span>x <span class="op">==</span> MAX_WIDTH <span class="op">-</span> <span class="dv">1</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb2-44"><a href="/entry/2019/05/15/ultra96-julia-set-explorer/#cb2-44" aria-hidden="true" tabindex="-1"></a>        video<span class="op">.</span>last <span class="op">=</span> <span class="dv">1</span><span class="op">;</span></span>
<span id="cb2-45"><a href="/entry/2019/05/15/ultra96-julia-set-explorer/#cb2-45" aria-hidden="true" tabindex="-1"></a>      <span class="op">}</span> <span class="cf">else</span> <span class="op">{</span></span>
<span id="cb2-46"><a href="/entry/2019/05/15/ultra96-julia-set-explorer/#cb2-46" aria-hidden="true" tabindex="-1"></a>        video<span class="op">.</span>last <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb2-47"><a href="/entry/2019/05/15/ultra96-julia-set-explorer/#cb2-47" aria-hidden="true" tabindex="-1"></a>      <span class="op">}</span></span>
<span id="cb2-48"><a href="/entry/2019/05/15/ultra96-julia-set-explorer/#cb2-48" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-49"><a href="/entry/2019/05/15/ultra96-julia-set-explorer/#cb2-49" aria-hidden="true" tabindex="-1"></a>      <span class="at">const</span> <span class="kw">auto</span> cx <span class="op">=</span> <span class="op">-</span>x1 <span class="op">+</span> dx <span class="op">*</span> x <span class="op">+</span> offset_x<span class="op">;</span></span>
<span id="cb2-50"><a href="/entry/2019/05/15/ultra96-julia-set-explorer/#cb2-50" aria-hidden="true" tabindex="-1"></a>      <span class="at">const</span> <span class="kw">auto</span> cy <span class="op">=</span> <span class="op">-</span>y1 <span class="op">+</span> dy <span class="op">*</span> y <span class="op">+</span> offset_y<span class="op">;</span></span>
<span id="cb2-51"><a href="/entry/2019/05/15/ultra96-julia-set-explorer/#cb2-51" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-52"><a href="/entry/2019/05/15/ultra96-julia-set-explorer/#cb2-52" aria-hidden="true" tabindex="-1"></a>      <span class="kw">auto</span> z       <span class="op">=</span> <span class="bu">std::</span>complex<span class="op">&lt;</span><span class="dt">fix64_type</span><span class="op">&gt;{</span>cx<span class="op">,</span> cy<span class="op">};</span></span>
<span id="cb2-53"><a href="/entry/2019/05/15/ultra96-julia-set-explorer/#cb2-53" aria-hidden="true" tabindex="-1"></a>      <span class="at">const</span> <span class="kw">auto</span> c <span class="op">=</span> <span class="bu">std::</span>complex<span class="op">&lt;</span><span class="dt">fix64_type</span><span class="op">&gt;{-</span><span class="fl">0.4</span><span class="op">,</span> <span class="fl">0.6</span><span class="op">};</span></span>
<span id="cb2-54"><a href="/entry/2019/05/15/ultra96-julia-set-explorer/#cb2-54" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-55"><a href="/entry/2019/05/15/ultra96-julia-set-explorer/#cb2-55" aria-hidden="true" tabindex="-1"></a>      <span class="bu">std::</span>uint32_t<span class="op"> </span>i <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb2-56"><a href="/entry/2019/05/15/ultra96-julia-set-explorer/#cb2-56" aria-hidden="true" tabindex="-1"></a>      <span class="cf">while</span> <span class="op">(</span>i <span class="op">&lt;</span> MAX_ITERATIONS <span class="op">&amp;&amp;</span> z<span class="op">.</span>real<span class="op">()</span> <span class="op">*</span> z<span class="op">.</span>real<span class="op">()</span> <span class="op">+</span> z<span class="op">.</span>imag<span class="op">()</span> <span class="op">*</span> z<span class="op">.</span>imag<span class="op">()</span> <span class="op">&lt;=</span> <span class="fl">4.0</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb2-57"><a href="/entry/2019/05/15/ultra96-julia-set-explorer/#cb2-57" aria-hidden="true" tabindex="-1"></a>        z <span class="op">=</span> z <span class="op">*</span> z <span class="op">+</span> c<span class="op">;</span></span>
<span id="cb2-58"><a href="/entry/2019/05/15/ultra96-julia-set-explorer/#cb2-58" aria-hidden="true" tabindex="-1"></a>        i<span class="op">++;</span></span>
<span id="cb2-59"><a href="/entry/2019/05/15/ultra96-julia-set-explorer/#cb2-59" aria-hidden="true" tabindex="-1"></a>      <span class="op">}</span></span>
<span id="cb2-60"><a href="/entry/2019/05/15/ultra96-julia-set-explorer/#cb2-60" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-61"><a href="/entry/2019/05/15/ultra96-julia-set-explorer/#cb2-61" aria-hidden="true" tabindex="-1"></a>      video<span class="op">.</span>data <span class="op">=</span> colorize<span class="op">(</span><span class="kw">static_cast</span><span class="op">&lt;</span><span class="dt">fix64_type</span><span class="op">&gt;(</span>i<span class="op">)</span> <span class="op">/</span> <span class="dt">fix64_type</span><span class="op">{</span><span class="fl">255.0</span><span class="op">});</span></span>
<span id="cb2-62"><a href="/entry/2019/05/15/ultra96-julia-set-explorer/#cb2-62" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-63"><a href="/entry/2019/05/15/ultra96-julia-set-explorer/#cb2-63" aria-hidden="true" tabindex="-1"></a>      <span class="va">m_axis</span> <span class="op">&lt;&lt;</span> video<span class="op">;</span></span>
<span id="cb2-64"><a href="/entry/2019/05/15/ultra96-julia-set-explorer/#cb2-64" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb2-65"><a href="/entry/2019/05/15/ultra96-julia-set-explorer/#cb2-65" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb2-66"><a href="/entry/2019/05/15/ultra96-julia-set-explorer/#cb2-66" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>もちろんこのままでは実用にならないほど性能が出ないためチューニングをする必要があります。今回はパイプライン化や並列化、固定小数点数の採用やループの反復回数の固定化など様々なチューニングを行いました。そのなかでも少し変わった例として、色つけ処理部分 (前述した Rust や C++ コード中の <code>colorize</code> 関数) に適用した手法を紹介しようと思います。</p>
<p>色つけ処理は反復回数 [0, 255] に RGB の色を割り当てるものです。RGB の各チャンネルの値は、反復回数 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>i</mi></mrow><annotation encoding="application/x-tex">i</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6595em;"></span><span class="mord mathnormal">i</span></span></span></span> を最大反復回数 255 で割った [0, 1.0] の値 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>t</mi></mrow><annotation encoding="application/x-tex">t</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.6151em;"></span><span class="mord mathnormal">t</span></span></span></span> を次の3つの関数に渡すことで求めています。
<span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mtable rowspacing="0.25em" columnalign="right left" columnspacing="0em"><mtr><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><mi>r</mi><mo stretchy="false">(</mo><mi>t</mi><mo stretchy="false">)</mo></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><mrow></mrow><mo>=</mo><mn>9</mn><mo stretchy="false">(</mo><mn>1</mn><mo>−</mo><mi>t</mi><mo stretchy="false">)</mo><msup><mi>t</mi><mn>3</mn></msup></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><mi>g</mi><mo stretchy="false">(</mo><mi>t</mi><mo stretchy="false">)</mo></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><mrow></mrow><mo>=</mo><mn>15</mn><mo stretchy="false">(</mo><mn>1</mn><mo>−</mo><mi>t</mi><msup><mo stretchy="false">)</mo><mn>2</mn></msup><msup><mi>t</mi><mn>2</mn></msup></mrow></mstyle></mtd></mtr><mtr><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><mi>b</mi><mo stretchy="false">(</mo><mi>t</mi><mo stretchy="false">)</mo></mrow></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><mrow></mrow><mo>=</mo><mn>8.5</mn><mo stretchy="false">(</mo><mn>1</mn><mo>−</mo><mi>t</mi><msup><mo stretchy="false">)</mo><mn>3</mn></msup><mi>t</mi></mrow></mstyle></mtd></mtr></mtable><annotation encoding="application/x-tex">
\begin{aligned}
    r(t) &amp;= 9 (1 - t) t^3 \\
    g(t) &amp;= 15 (1 - t)^2 t^2 \\
    b(t) &amp;= 8.5 (1 - t)^3 t
\end{aligned}
</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:4.5723em;vertical-align:-2.0362em;"></span><span class="mord"><span class="mtable"><span class="col-align-r"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.5362em;"><span style="top:-4.6721em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.02778em;">r</span><span class="mopen">(</span><span class="mord mathnormal">t</span><span class="mclose">)</span></span></span><span style="top:-3.1479em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathnormal" style="margin-right:0.03588em;">g</span><span class="mopen">(</span><span class="mord mathnormal">t</span><span class="mclose">)</span></span></span><span style="top:-1.6238em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord mathnormal">b</span><span class="mopen">(</span><span class="mord mathnormal">t</span><span class="mclose">)</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:2.0362em;"><span></span></span></span></span></span><span class="col-align-l"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:2.5362em;"><span style="top:-4.6721em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord"></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mord">9</span><span class="mopen">(</span><span class="mord">1</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mord mathnormal">t</span><span class="mclose">)</span><span class="mord"><span class="mord mathnormal">t</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8641em;"><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">3</span></span></span></span></span></span></span></span></span></span><span style="top:-3.1479em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord"></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mord">15</span><span class="mopen">(</span><span class="mord">1</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mord mathnormal">t</span><span class="mclose"><span class="mclose">)</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8641em;"><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span><span class="mord"><span class="mord mathnormal">t</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8641em;"><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">2</span></span></span></span></span></span></span></span></span></span><span style="top:-1.6238em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord"></span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em;"></span><span class="mord">8.5</span><span class="mopen">(</span><span class="mord">1</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em;"></span><span class="mord mathnormal">t</span><span class="mclose"><span class="mclose">)</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8641em;"><span style="top:-3.113em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight">3</span></span></span></span></span></span></span></span><span class="mord mathnormal">t</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:2.0362em;"><span></span></span></span></span></span></span></span></span></span></span></span>
<img src="/entry/2019/05/15/ultra96-julia-set-explorer/color.svg" /></p>
<p>この関数は見ての通り乗算が多く、そのまま FPGA に落とせば計算に必要なクロックサイクル数は増えるし貴重な FPGA のリソースを大量に消費するしでなにもいいことがありません。今回これらの関数に与えられうる値は <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mstyle displaystyle="true" scriptlevel="0"><mfrac><mn>0</mn><mn>255</mn></mfrac></mstyle><mo separator="true">,</mo><mstyle displaystyle="true" scriptlevel="0"><mfrac><mn>1</mn><mn>255</mn></mfrac></mstyle><mo separator="true">,</mo><mstyle displaystyle="true" scriptlevel="0"><mfrac><mn>2</mn><mn>255</mn></mfrac></mstyle><mo separator="true">,</mo><mo>…</mo><mo separator="true">,</mo><mstyle displaystyle="true" scriptlevel="0"><mfrac><mn>255</mn><mn>255</mn></mfrac></mstyle></mrow><annotation encoding="application/x-tex">\cfrac{0}{255}, \cfrac{1}{255}, \cfrac{2}{255}, \dots, \cfrac{255}{255}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:2.276em;vertical-align:-0.686em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.59em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">255</span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.74em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">0</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.686em;"><span></span></span></span></span></span><span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.59em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">255</span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.74em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.686em;"><span></span></span></span></span></span><span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.59em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">255</span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.74em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">2</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.686em;"><span></span></span></span></span></span><span></span></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="minner">…</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mpunct">,</span><span class="mspace" style="margin-right:0.1667em;"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.59em;"><span style="top:-2.314em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">255</span></span></span><span style="top:-3.23em;"><span class="pstrut" style="height:3em;"></span><span class="frac-line" style="border-bottom-width:0.04em;"></span></span><span style="top:-3.74em;"><span class="pstrut" style="height:3em;"></span><span class="mord"><span class="mord">255</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.686em;"><span></span></span></span></span></span><span></span></span></span></span></span> と決まっているので定数化が可能ですが、流石に手作業で 256 個の値を計算しハードコーディングするのは面倒だしメンテナンス性も下がって最悪です。</p>
<p>そこで、Vivado HLS で C++11 の機能がある程度利用可能<a href="/entry/2019/05/15/ultra96-julia-set-explorer/#fn2" class="footnote-ref" id="fnref2" role="doc-noteref"><sup>2</sup></a>なことを活用 (悪用？) し、<strong><code>constexpr</code> を使った色変換テーブルのコンパイル時計算</strong>をやってみました。</p>
<p>まず <code>colorize</code> 関数を <code>constexpr</code> 化します。C++11 なので <code>constexpr</code> な関数の中身が <code>return</code> 文1つしか書けない点や <code>constexpr</code> な <a href="https://en.cppreference.com/w/cpp/algorithm/min" target="_blank" rel="nofollow noopener"><code>std::min</code></a> などがないことに注意します。</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb3-1"><a href="/entry/2019/05/15/ultra96-julia-set-explorer/#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="kw">namespace</span> detail <span class="op">{</span></span>
<span id="cb3-2"><a href="/entry/2019/05/15/ultra96-julia-set-explorer/#cb3-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-3"><a href="/entry/2019/05/15/ultra96-julia-set-explorer/#cb3-3" aria-hidden="true" tabindex="-1"></a><span class="kw">template</span> <span class="op">&lt;</span><span class="kw">class</span> T<span class="op">&gt;</span></span>
<span id="cb3-4"><a href="/entry/2019/05/15/ultra96-julia-set-explorer/#cb3-4" aria-hidden="true" tabindex="-1"></a><span class="kw">constexpr</span> T constexpr_min<span class="op">(</span>T a<span class="op">,</span> T b<span class="op">)</span> <span class="op">{</span></span>
<span id="cb3-5"><a href="/entry/2019/05/15/ultra96-julia-set-explorer/#cb3-5" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> a <span class="op">&lt;</span> b <span class="op">?</span> a <span class="op">:</span> b<span class="op">;</span></span>
<span id="cb3-6"><a href="/entry/2019/05/15/ultra96-julia-set-explorer/#cb3-6" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb3-7"><a href="/entry/2019/05/15/ultra96-julia-set-explorer/#cb3-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-8"><a href="/entry/2019/05/15/ultra96-julia-set-explorer/#cb3-8" aria-hidden="true" tabindex="-1"></a><span class="kw">constexpr</span> <span class="bu">std::</span>uint32_t<span class="op"> </span>f2i<span class="op">(</span><span class="dt">double</span> d<span class="op">)</span> <span class="op">{</span></span>
<span id="cb3-9"><a href="/entry/2019/05/15/ultra96-julia-set-explorer/#cb3-9" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> <span class="kw">static_cast</span><span class="op">&lt;</span><span class="bu">std::</span>uint32_t<span class="op">&gt;(</span>constexpr_min<span class="op">(</span>d<span class="op">,</span> <span class="fl">1.0</span><span class="op">)</span> <span class="op">*</span> <span class="fl">255.0</span><span class="op">);</span></span>
<span id="cb3-10"><a href="/entry/2019/05/15/ultra96-julia-set-explorer/#cb3-10" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb3-11"><a href="/entry/2019/05/15/ultra96-julia-set-explorer/#cb3-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-12"><a href="/entry/2019/05/15/ultra96-julia-set-explorer/#cb3-12" aria-hidden="true" tabindex="-1"></a><span class="kw">constexpr</span> <span class="bu">std::</span>uint32_t<span class="op"> </span>colorize<span class="op">(</span><span class="dt">double</span> t<span class="op">)</span> <span class="op">{</span></span>
<span id="cb3-13"><a href="/entry/2019/05/15/ultra96-julia-set-explorer/#cb3-13" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> <span class="op">(</span>f2i<span class="op">(</span><span class="fl">9.0</span> <span class="op">*</span> <span class="op">(</span><span class="fl">1.0</span> <span class="op">-</span> t<span class="op">)</span> <span class="op">*</span> t <span class="op">*</span> t <span class="op">*</span> t<span class="op">)</span> <span class="op">&lt;&lt;</span> <span class="dv">16</span><span class="op">)</span> <span class="op">|</span>                <span class="co">// red</span></span>
<span id="cb3-14"><a href="/entry/2019/05/15/ultra96-julia-set-explorer/#cb3-14" aria-hidden="true" tabindex="-1"></a>         <span class="op">(</span>f2i<span class="op">(</span><span class="fl">8.5</span> <span class="op">*</span> <span class="op">(</span><span class="fl">1.0</span> <span class="op">-</span> t<span class="op">)</span> <span class="op">*</span> <span class="op">(</span><span class="fl">1.0</span> <span class="op">-</span> t<span class="op">)</span> <span class="op">*</span> <span class="op">(</span><span class="fl">1.0</span> <span class="op">-</span> t<span class="op">)</span> <span class="op">*</span> t<span class="op">)</span> <span class="op">&lt;&lt;</span> <span class="dv">8</span><span class="op">)</span> <span class="op">|</span> <span class="co">// blue</span></span>
<span id="cb3-15"><a href="/entry/2019/05/15/ultra96-julia-set-explorer/#cb3-15" aria-hidden="true" tabindex="-1"></a>         <span class="op">(</span>f2i<span class="op">(</span><span class="fl">15.0</span> <span class="op">*</span> <span class="op">(</span><span class="fl">1.0</span> <span class="op">-</span> t<span class="op">)</span> <span class="op">*</span> <span class="op">(</span><span class="fl">1.0</span> <span class="op">-</span> t<span class="op">)</span> <span class="op">*</span> t <span class="op">*</span> t<span class="op">));</span>              <span class="co">// green</span></span>
<span id="cb3-16"><a href="/entry/2019/05/15/ultra96-julia-set-explorer/#cb3-16" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb3-17"><a href="/entry/2019/05/15/ultra96-julia-set-explorer/#cb3-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-18"><a href="/entry/2019/05/15/ultra96-julia-set-explorer/#cb3-18" aria-hidden="true" tabindex="-1"></a><span class="kw">constexpr</span> <span class="bu">std::</span>uint32_t<span class="op"> </span>index2color<span class="op">(</span><span class="bu">std::</span>size_t<span class="op"> </span>i<span class="op">)</span> <span class="op">{</span></span>
<span id="cb3-19"><a href="/entry/2019/05/15/ultra96-julia-set-explorer/#cb3-19" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> colorize<span class="op">(</span><span class="kw">static_cast</span><span class="op">&lt;</span><span class="dt">double</span><span class="op">&gt;(</span>i<span class="op">)</span> <span class="op">/</span> <span class="fl">255.0</span><span class="op">);</span></span>
<span id="cb3-20"><a href="/entry/2019/05/15/ultra96-julia-set-explorer/#cb3-20" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb3-21"><a href="/entry/2019/05/15/ultra96-julia-set-explorer/#cb3-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-22"><a href="/entry/2019/05/15/ultra96-julia-set-explorer/#cb3-22" aria-hidden="true" tabindex="-1"></a><span class="op">}</span> <span class="co">// namespace detail</span></span></code></pre></div>
<p>続いて反復回数から RGB 値を求める色変換テーブルを構築する部分を書いていきます。こんな感じのコードで各要素が <code>index2color(index)</code> となる配列 <code>color_table</code> をコンパイル時に構築できるようにするのが目標です。</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb4-1"><a href="/entry/2019/05/15/ultra96-julia-set-explorer/#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="kw">constexpr</span> <span class="bu">std::</span>array<span class="op">&lt;</span><span class="bu">std::</span>uint32_t<span class="op">,</span> <span class="dv">256</span><span class="op">&gt;</span> make_color_table<span class="op">()</span> <span class="op">{</span></span>
<span id="cb4-2"><a href="/entry/2019/05/15/ultra96-julia-set-explorer/#cb4-2" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> detail::make_array<span class="op">&lt;</span><span class="dv">256</span><span class="op">&gt;(</span>detail::index2color<span class="op">);</span></span>
<span id="cb4-3"><a href="/entry/2019/05/15/ultra96-julia-set-explorer/#cb4-3" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb4-4"><a href="/entry/2019/05/15/ultra96-julia-set-explorer/#cb4-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-5"><a href="/entry/2019/05/15/ultra96-julia-set-explorer/#cb4-5" aria-hidden="true" tabindex="-1"></a><span class="at">static</span> <span class="kw">constexpr</span> <span class="kw">auto</span> color_table <span class="op">=</span> make_color_table<span class="op">();</span></span></code></pre></div>
<p><code>detail::make_array&lt;N&gt;</code> を実装するのに <a href="https://en.cppreference.com/w/cpp/utility/integer_sequence" target="_blank" rel="nofollow noopener">std::make_integer_sequence</a> があると便利なのですが、C++11 の標準ライブラリには入っていないので、まずそれ相当のものを自分で実装します。</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb5-1"><a href="/entry/2019/05/15/ultra96-julia-set-explorer/#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="kw">namespace</span> detail <span class="op">{</span></span>
<span id="cb5-2"><a href="/entry/2019/05/15/ultra96-julia-set-explorer/#cb5-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-3"><a href="/entry/2019/05/15/ultra96-julia-set-explorer/#cb5-3" aria-hidden="true" tabindex="-1"></a><span class="kw">template</span> <span class="op">&lt;</span><span class="bu">std::</span>size_t<span class="op">...</span> Values<span class="op">&gt;</span></span>
<span id="cb5-4"><a href="/entry/2019/05/15/ultra96-julia-set-explorer/#cb5-4" aria-hidden="true" tabindex="-1"></a><span class="kw">struct</span> index_sequence <span class="op">{};</span></span>
<span id="cb5-5"><a href="/entry/2019/05/15/ultra96-julia-set-explorer/#cb5-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-6"><a href="/entry/2019/05/15/ultra96-julia-set-explorer/#cb5-6" aria-hidden="true" tabindex="-1"></a><span class="kw">template</span> <span class="op">&lt;</span><span class="bu">std::</span>size_t<span class="op"> </span>N<span class="op">,</span> <span class="bu">std::</span>size_t<span class="op">...</span> Values<span class="op">&gt;</span></span>
<span id="cb5-7"><a href="/entry/2019/05/15/ultra96-julia-set-explorer/#cb5-7" aria-hidden="true" tabindex="-1"></a><span class="kw">struct</span> index_sequence_impl <span class="op">:</span> index_sequence_impl<span class="op">&lt;</span>N <span class="op">-</span> <span class="dv">1</span><span class="op">,</span> N <span class="op">-</span> <span class="dv">1</span><span class="op">,</span> Values<span class="op">...&gt;</span> <span class="op">{};</span></span>
<span id="cb5-8"><a href="/entry/2019/05/15/ultra96-julia-set-explorer/#cb5-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-9"><a href="/entry/2019/05/15/ultra96-julia-set-explorer/#cb5-9" aria-hidden="true" tabindex="-1"></a><span class="kw">template</span> <span class="op">&lt;</span><span class="bu">std::</span>size_t<span class="op">...</span> Values<span class="op">&gt;</span></span>
<span id="cb5-10"><a href="/entry/2019/05/15/ultra96-julia-set-explorer/#cb5-10" aria-hidden="true" tabindex="-1"></a><span class="kw">struct</span> index_sequence_impl<span class="op">&lt;</span><span class="dv">0</span><span class="op">,</span> Values<span class="op">...&gt;</span> <span class="op">{</span></span>
<span id="cb5-11"><a href="/entry/2019/05/15/ultra96-julia-set-explorer/#cb5-11" aria-hidden="true" tabindex="-1"></a>  <span class="kw">using</span> type <span class="op">=</span> index_sequence<span class="op">&lt;</span>Values<span class="op">...&gt;;</span></span>
<span id="cb5-12"><a href="/entry/2019/05/15/ultra96-julia-set-explorer/#cb5-12" aria-hidden="true" tabindex="-1"></a><span class="op">};</span></span>
<span id="cb5-13"><a href="/entry/2019/05/15/ultra96-julia-set-explorer/#cb5-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-14"><a href="/entry/2019/05/15/ultra96-julia-set-explorer/#cb5-14" aria-hidden="true" tabindex="-1"></a><span class="kw">template</span> <span class="op">&lt;</span><span class="bu">std::</span>size_t<span class="op"> </span>N<span class="op">&gt;</span></span>
<span id="cb5-15"><a href="/entry/2019/05/15/ultra96-julia-set-explorer/#cb5-15" aria-hidden="true" tabindex="-1"></a><span class="kw">using</span> make_index_sequence <span class="op">=</span> <span class="kw">typename</span> index_sequence_impl<span class="op">&lt;</span>N<span class="op">&gt;::</span>type<span class="op">;</span></span>
<span id="cb5-16"><a href="/entry/2019/05/15/ultra96-julia-set-explorer/#cb5-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-17"><a href="/entry/2019/05/15/ultra96-julia-set-explorer/#cb5-17" aria-hidden="true" tabindex="-1"></a><span class="op">}</span> <span class="co">// namespace detail</span></span></code></pre></div>
<p>この <code>make_index_sequence&lt;N&gt;</code> は <code>index_sequence&lt;0, 1, 2, ..., N - 1&gt;</code> を作るためのもので、コンパイル時に <code>0</code> ~ <code>N - 1</code> の数値が欲しいときに使います。</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb6-1"><a href="/entry/2019/05/15/ultra96-julia-set-explorer/#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="kw">template</span> <span class="op">&lt;</span><span class="bu">std::</span>size_t<span class="op">...</span> Indeces<span class="op">&gt;</span></span>
<span id="cb6-2"><a href="/entry/2019/05/15/ultra96-julia-set-explorer/#cb6-2" aria-hidden="true" tabindex="-1"></a><span class="kw">constexpr</span> <span class="kw">auto</span> foo_impl<span class="op">(</span>index_sequence<span class="op">&lt;</span>Indeces<span class="op">...&gt;)</span> <span class="op">{</span></span>
<span id="cb6-3"><a href="/entry/2019/05/15/ultra96-julia-set-explorer/#cb6-3" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Indeces... が 0, 1, 2, ..., N - 1 になる</span></span>
<span id="cb6-4"><a href="/entry/2019/05/15/ultra96-julia-set-explorer/#cb6-4" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> <span class="bu">std::</span>make_tuple<span class="op">(</span>Indeces<span class="op">...);</span></span>
<span id="cb6-5"><a href="/entry/2019/05/15/ultra96-julia-set-explorer/#cb6-5" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb6-6"><a href="/entry/2019/05/15/ultra96-julia-set-explorer/#cb6-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-7"><a href="/entry/2019/05/15/ultra96-julia-set-explorer/#cb6-7" aria-hidden="true" tabindex="-1"></a><span class="kw">template</span> <span class="op">&lt;</span><span class="bu">std::</span>size_t<span class="op"> </span>N<span class="op">&gt;</span></span>
<span id="cb6-8"><a href="/entry/2019/05/15/ultra96-julia-set-explorer/#cb6-8" aria-hidden="true" tabindex="-1"></a><span class="kw">constexpr</span> <span class="kw">auto</span> foo<span class="op">()</span> <span class="op">{</span></span>
<span id="cb6-9"><a href="/entry/2019/05/15/ultra96-julia-set-explorer/#cb6-9" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> foo_impl<span class="op">(</span>make_index_sequence<span class="op">&lt;</span>N<span class="op">&gt;{});</span></span>
<span id="cb6-10"><a href="/entry/2019/05/15/ultra96-julia-set-explorer/#cb6-10" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb6-11"><a href="/entry/2019/05/15/ultra96-julia-set-explorer/#cb6-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-12"><a href="/entry/2019/05/15/ultra96-julia-set-explorer/#cb6-12" aria-hidden="true" tabindex="-1"></a>foo<span class="op">&lt;</span><span class="dv">4</span><span class="op">&gt;();</span> <span class="co">// =&gt; std::tuple&lt;std::size_t&gt;{0, 1, 2, 3};</span></span></code></pre></div>
<p>これを使うと <code>detail::make_array</code> をこんな感じに実装できます。C++11 には<a href="https://en.cppreference.com/w/cpp/language/function#Return_type_deduction" target="_blank" rel="nofollow noopener">関数の返り値の型推論</a>もないのでそれっぽい返り値の型も書いてやる必要があります。</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb7-1"><a href="/entry/2019/05/15/ultra96-julia-set-explorer/#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="kw">namespace</span> detail <span class="op">{</span></span>
<span id="cb7-2"><a href="/entry/2019/05/15/ultra96-julia-set-explorer/#cb7-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-3"><a href="/entry/2019/05/15/ultra96-julia-set-explorer/#cb7-3" aria-hidden="true" tabindex="-1"></a><span class="kw">template</span> <span class="op">&lt;</span><span class="kw">class</span> Function<span class="op">,</span> <span class="bu">std::</span>size_t<span class="op">...</span> Indeces<span class="op">&gt;</span></span>
<span id="cb7-4"><a href="/entry/2019/05/15/ultra96-julia-set-explorer/#cb7-4" aria-hidden="true" tabindex="-1"></a><span class="kw">constexpr</span> <span class="kw">auto</span> make_array_impl<span class="op">(</span>Function f<span class="op">,</span> index_sequence<span class="op">&lt;</span>Indeces<span class="op">...&gt;)</span></span>
<span id="cb7-5"><a href="/entry/2019/05/15/ultra96-julia-set-explorer/#cb7-5" aria-hidden="true" tabindex="-1"></a>    <span class="op">-&gt;</span> <span class="bu">std::</span>array<span class="op">&lt;</span><span class="kw">typename</span> <span class="bu">std::</span>result_of<span class="op">&lt;</span>Function<span class="op">(</span><span class="bu">std::</span>size_t<span class="op">)&gt;::</span>type<span class="op">,</span> <span class="kw">sizeof</span><span class="op">...(</span>Indeces<span class="op">)&gt;</span> <span class="op">{</span></span>
<span id="cb7-6"><a href="/entry/2019/05/15/ultra96-julia-set-explorer/#cb7-6" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> <span class="op">{{</span>f<span class="op">(</span>Indeces<span class="op">)...}};</span></span>
<span id="cb7-7"><a href="/entry/2019/05/15/ultra96-julia-set-explorer/#cb7-7" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb7-8"><a href="/entry/2019/05/15/ultra96-julia-set-explorer/#cb7-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-9"><a href="/entry/2019/05/15/ultra96-julia-set-explorer/#cb7-9" aria-hidden="true" tabindex="-1"></a><span class="kw">template</span> <span class="op">&lt;</span><span class="bu">std::</span>size_t<span class="op"> </span>N<span class="op">,</span> <span class="kw">class</span> Function<span class="op">&gt;</span></span>
<span id="cb7-10"><a href="/entry/2019/05/15/ultra96-julia-set-explorer/#cb7-10" aria-hidden="true" tabindex="-1"></a><span class="kw">constexpr</span> <span class="kw">auto</span> make_array<span class="op">(</span>Function f<span class="op">)</span></span>
<span id="cb7-11"><a href="/entry/2019/05/15/ultra96-julia-set-explorer/#cb7-11" aria-hidden="true" tabindex="-1"></a>    <span class="op">-&gt;</span> <span class="bu">std::</span>array<span class="op">&lt;</span><span class="kw">typename</span> <span class="bu">std::</span>result_of<span class="op">&lt;</span>Function<span class="op">(</span><span class="bu">std::</span>size_t<span class="op">)&gt;::</span>type<span class="op">,</span> N<span class="op">&gt;</span> <span class="op">{</span></span>
<span id="cb7-12"><a href="/entry/2019/05/15/ultra96-julia-set-explorer/#cb7-12" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> make_array_impl<span class="op">(</span>f<span class="op">,</span> make_index_sequence<span class="op">&lt;</span>N<span class="op">&gt;{});</span></span>
<span id="cb7-13"><a href="/entry/2019/05/15/ultra96-julia-set-explorer/#cb7-13" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb7-14"><a href="/entry/2019/05/15/ultra96-julia-set-explorer/#cb7-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-15"><a href="/entry/2019/05/15/ultra96-julia-set-explorer/#cb7-15" aria-hidden="true" tabindex="-1"></a><span class="op">}</span> <span class="co">// namespace detail</span></span></code></pre></div>
<p>これらをまとめたソースコードが<a href="https://github.com/Tosainu/ultra96-fractal/blob/1ed4e5e409d6445a85741149c112322cc6fc251c/hls_ip/fractal/color_table.h" target="_blank" rel="nofollow noopener">こちら</a>です。C++11 のためコードは長くなったものの、カラーパレットの変更は <code>constexpr</code> 化された <code>colorize</code> 関数を変更するだけでテーブル構築はコンパイラが勝手にやってくれるようになりましたし、構築された色変換テーブルはただの配列なので、その要素を参照する処理は FPGA デザイン上で ROM から値を1つ読むだけの軽い処理に展開されたりと、とても効果のあったチューニングでした。<strong>C++ メタプロは FPGA 開発にも役立ちます！</strong><a href="/entry/2019/05/15/ultra96-julia-set-explorer/#fn3" class="footnote-ref" id="fnref3" role="doc-noteref"><sup>3</sup></a></p>
<p>チューニングの結果、実装した回路は 1920px x 1080px の Julia set を 約 6 fps で描画できるようになりました。ただ僕の Vivado HLS 力が足りず、当初計画していた「ぼくの考えたさいきょうの Julia set レンダリングパイプライン」になっていないので、また時間があればより高速な実装に挑戦してみたいと思っています。</p>
<h3 id="ブロックデザイン">ブロックデザイン</h3>
<p>ここまでで Julia set を描画するための回路の設計ができました。しかし、実際に動作させるためには様々な周辺回路が必要です。特に今回は Zynq UltraScale+ MPSoC のプロセッサ側 (Processing System, PS) も利用したいので、実装した Julia set 描画回路を PS から制御できるようにしたり、描画した Julia set の画像を PS から取得できるようにする必要があります。今回は Xilinx 社が提供する設計ツールである <a href="https://www.xilinx.com/products/design-tools/vivado.html" target="_blank" rel="nofollow noopener">Vivado</a> の IP Integrator を使ってシステム全体 (Julia set 描画回路とその周辺回路) の設計を行いました。</p>
<p>IP は Intellectual Property の略で、再利用可能な回路デザインのことを指します。ソフトウェア開発で例えるならライブラリのようなものでしょうか。そして最近の FPGA 開発ツールは様々な IP を GUI 上で配置・接続することで目的のシステムを開発する機能を搭載しているものがあり、Vivado では IP Integrator がそれに当たります。IP Integrator で作成したデザインはブロックデザインと呼ばれています。</p>
<p>今回作成した Julia set explorer のブロックデザインは次のようになっています。表示されているものは簡略化されたもので、クリックすると Vivado から直接出力した詳細なものが表示されます。
<a href="/entry/2019/05/15/ultra96-julia-set-explorer/bd.pdf"><img src="/entry/2019/05/15/ultra96-julia-set-explorer/bd_simple.png" /></a></p>
<p><code>fractal_0</code> が Vivado HLS で出力した Julia set 描画回路の IP で、<code>m_axis</code> がその出力ポートです。出力された画像の信号は、周波数の調整やデータの簡単な下処理を行うための IP を通したうえで、<a href="https://www.xilinx.com/products/intellectual-property/axi_video_dma.html" target="_blank" rel="nofollow noopener">AXI Video DMA (AXI VDMA)</a> という IP に接続されています。この IP は Vivado にバンドルされているもので、ストリーム形式の映像データをメモリへ転送したり、逆にメモリから映像を読み出してストリーム形式で出力するものです。今回は描画した Julia set の画像をメモリに書き込み、PS からその画像を読み出せるようにする役割があります。</p>
上のデモでは使っていませんが、今回のブロックデザインには PL から直接 <a href="https://www.xilinx.com/support/documentation/user_guides/ug1085-zynq-ultrascale-trm.pdf#page=919" target="_blank" rel="nofollow noopener">Zynq UltraScale+ MPSoC の DisplayPort Controller</a> に映像を送り込むための回路も組み込まれています。ブロックデザインの右下あたりの IP がそれにあたります。下の tweet をしていた時期の実装では、この部分の回路を使った映像の出力をしていました。
<blockquote class="twitter-tweet tw-align-center" data-lang="en">
<p lang="ja" dir="ltr">
Ultra96 で Julia set 描くやつ、6fps くらい出るようになったり、いろんなの描けるようになった <a href="https://t.co/iTE2lkyyVs" target="_blank" rel="nofollow noopener">pic.twitter.com/iTE2lkyyVs</a>
</p>
— +。:.ﾟ٩(๑＞◡＜๑)۶:.｡+ﾟ (@myon___) <a href="https://twitter.com/myon___/status/1099649604088254464?ref_src=twsrc%5Etfw" target="_blank" rel="nofollow noopener">February 24, 2019</a>
</blockquote>
<script async src="https://platform.twitter.com/widgets.js" charset="utf-8"></script>
<h2 id="ultra96-向け-linux-のブートイメージを作る">Ultra96 向け Linux のブートイメージを作る</h2>
<p>PL の実装ができたので、今度は PS で動かすソフトウェアの実装をしていきます。</p>
<p>Xilinx の開発環境では、ベアメタル、FreeRTOS、Linux の開発を公式でサポートしているようです。当初はベアメタルでやっていこうと思っていたのですが、</p>
<ul>
<li>USB 接続のゲームパッドでぐりぐり動かしたい</li>
<li>現在の状況をカッコイイ感じでオーバーレイ表示したい</li>
<li>ベアメタル開発時に提供されるライブラリが好きになれず規模の大きなコードを書く気になれなかった</li>
</ul>
<p>という気持ちになってきたので Linux を利用することにしました。実装に必要な知識は多くなるけれども、ゲームパッドや GPU など各種デバイスドライバが提供されることや、普段から慣れた環境が利用できるメリットのほうが大きいと考えたためです。個人的に低レイヤ Linux に関する知識を付けていきたいなと思っていたのもあります。</p>
<h3 id="petalinux-tools-で-ultra96-向けプロジェクトを作る">PetaLinux Tools で Ultra96 向けプロジェクトを作る</h3>
<p><a href="https://www.xilinx.com/products/design-tools/embedded-software/petalinux-sdk.html" target="_blank" rel="nofollow noopener">PetaLinux Tools</a> は Xilinx デバイスの PS 向け組み込み Linux 開発ツール群です。ブートローダ、カーネル、ライブラリ、アプリケーションの設定・ビルドおよびブートイメージの生成などを全てやってくれます。</p>
<p>Ultra96 向け PetaLinux プロジェクトの作成は、<a href="http://zedboard.org/support/design/24166/156" target="_blank" rel="nofollow noopener">ここ</a> で公開されている Board Support Packages (BSP) を利用するのが簡単そうです。しかし表示されているバージョンが v2018.2 と古かったりして心配だったので、展開した BSP の中身を参考にしながら自分で設定することにしました。</p>
<p>といっても必要な手順はそんなに多くありません。まず以下のコマンドでプロジェクトを作成します。</p>
<pre><code>$ petalinux-create --type project --template zynqMP --name &lt;project-name&gt;
$ cd &lt;project-name&gt;
$ petalinux-config --get-hw-description=&lt;path-to-hdf-dir&gt;</code></pre>
<p>最後の <code>petalinux-config</code> を実行すると、Linux カーネルで <code>make menuconfig</code> したときのような画面が出てくるので以下の値を設定します。</p>
<pre><code>DTG Settings  ---&gt;
    (zcu100-revc) MACHINE_NAME
u-boot Configuration  ---&gt;
    (xilinx_zynqmp_zcu100_revC_defconfig) u-boot config target</code></pre>
<p>これらの値を設定することで、Ultra96 向けの Devicetree などが読み込まれるようになります。この変化のわかりやすい例としては、無線 LAN やオンボード LED がちゃんと認識されるなどがあります。</p>
<h2 id="linux-からいい感じに画像を取得できるようにする">Linux からいい感じに画像を取得できるようにする</h2>
<p>Ultra96 の Linux 開発環境ができたので、次は Linux からいい感じに Julia set 描画回路を制御するためのデバイスドライバを実装していきます。方針としては Julia set 描画回路をカメラのような映像入力デバイスとして扱えるようにし、V4L2 の API でデバイスの制御と生成された画像の取得ができるようにする、という感じです。</p>
<h3 id="xilinx-video-ip-driver">Xilinx Video IP driver</h3>
<p>さてデバイスドライバを実装するといっても、僕はデバイスドライバどころか Linux のカーネルモジュールすらまともに書いたことがなく、何もわかりません。それなのに Xilinx 特有のたくさんの PDF なドキュメントの中に Linux のデバイスドライバ実装に関するものは全くと言っていいほどなく、とても困ってしまいました。</p>
<p>それからいろいろ調べていって参考になったのが Xilinx の Linux カーネルのリポジトリ <a href="https://github.com/Xilinx/linux-xlnx" target="_blank" rel="nofollow noopener">Xilinx/linux-xlnx</a> です。追加されている Xilinx プラットフォーム特有のデバイスドライバの実装やそれらについてのドキュメントがとても参考になりました。特に今回のデバイスドライバ実装には</p>
<ul>
<li><a href="https://github.com/Xilinx/linux-xlnx/blob/xilinx-v2018.3/drivers/media/platform/xilinx/xilinx-tpg.c" target="_blank" rel="nofollow noopener">drivers/media/platform/xilinx/xilinx-tpg.c</a>
<ul>
<li>Test Pattern Generator (TPG) のデバイスドライバ</li>
<li>ほぼ同じ動作をするデバイスであったため</li>
<li>実装したコードもだいたい同じ感じになっている</li>
</ul></li>
<li><a href="https://github.com/Xilinx/linux-xlnx/tree/xilinx-v2018.3/Documentation/devicetree/bindings/media/xilinx" target="_blank" rel="nofollow noopener">Documentation/devicetree/bindings/media/xilinx/</a>
<ul>
<li>Xilinx Video IP 関連の Devicetree の記述に関するドキュメント</li>
</ul></li>
</ul>
<p>あたりをよく参照していた記憶があります。</p>
<h3 id="デバイスドライバを実装する">デバイスドライバを実装する</h3>
<p>ということでデバイスドライバを実装しました。最終的なコードは<a href="https://github.com/Tosainu/ultra96-fractal/blob/1ed4e5e409d6445a85741149c112322cc6fc251c/petalinux_project/project-spec/meta-user/recipes-modules/kernel-module-fractal/files/fractal.c" target="_blank" rel="nofollow noopener">ここ</a>です。</p>
<p>今回は <a href="https://lwn.net/Articles/448499/" target="_blank" rel="nofollow noopener">Platform device API</a> と呼ばれるものを使って実装していきます。Platform device のドライバ実装でまず必要となるのがデバイスの初期化のための処理 (<code>probe</code>) と取り外された (？) ときの処理 (<code>remove</code>) です。これらの処理の登録は、必要な関数を実装し、その関数ポインタなどを対応するメンバに指定した <a href="https://elixir.bootlin.com/linux/v4.14/source/include/linux/platform_device.h#L180" target="_blank" rel="nofollow noopener"><code>struct platform_driver</code></a> 型の変数を <a href="https://elixir.bootlin.com/linux/v4.14/source/include/linux/platform_device.h#L227" target="_blank" rel="nofollow noopener"><code>module_platform_driver()</code></a> マクロに渡せばいいようです。</p>
<div class="sourceCode" id="cb10"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb10-1"><a href="/entry/2019/05/15/ultra96-julia-set-explorer/#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="dt">static</span> <span class="dt">int</span> fractal_probe<span class="op">(</span><span class="kw">struct</span> platform_device <span class="op">*</span>dev<span class="op">)</span></span>
<span id="cb10-2"><a href="/entry/2019/05/15/ultra96-julia-set-explorer/#cb10-2" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb10-3"><a href="/entry/2019/05/15/ultra96-julia-set-explorer/#cb10-3" aria-hidden="true" tabindex="-1"></a>	<span class="co">// なんか実装</span></span>
<span id="cb10-4"><a href="/entry/2019/05/15/ultra96-julia-set-explorer/#cb10-4" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb10-5"><a href="/entry/2019/05/15/ultra96-julia-set-explorer/#cb10-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-6"><a href="/entry/2019/05/15/ultra96-julia-set-explorer/#cb10-6" aria-hidden="true" tabindex="-1"></a><span class="dt">static</span> <span class="dt">int</span> fractal_remove<span class="op">(</span><span class="kw">struct</span> platform_device <span class="op">*</span>dev<span class="op">)</span></span>
<span id="cb10-7"><a href="/entry/2019/05/15/ultra96-julia-set-explorer/#cb10-7" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb10-8"><a href="/entry/2019/05/15/ultra96-julia-set-explorer/#cb10-8" aria-hidden="true" tabindex="-1"></a>	<span class="co">// なんか実装</span></span>
<span id="cb10-9"><a href="/entry/2019/05/15/ultra96-julia-set-explorer/#cb10-9" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb10-10"><a href="/entry/2019/05/15/ultra96-julia-set-explorer/#cb10-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-11"><a href="/entry/2019/05/15/ultra96-julia-set-explorer/#cb10-11" aria-hidden="true" tabindex="-1"></a><span class="dt">static</span> <span class="dt">const</span> <span class="kw">struct</span> of_device_id fractal_of_id_table<span class="op">[]</span> <span class="op">=</span> <span class="op">{</span></span>
<span id="cb10-12"><a href="/entry/2019/05/15/ultra96-julia-set-explorer/#cb10-12" aria-hidden="true" tabindex="-1"></a>	<span class="op">{</span> <span class="op">.</span>compatible <span class="op">=</span> <span class="st">&quot;xlnx,fractal-1.0&quot;</span> <span class="op">},</span></span>
<span id="cb10-13"><a href="/entry/2019/05/15/ultra96-julia-set-explorer/#cb10-13" aria-hidden="true" tabindex="-1"></a>	<span class="op">{</span> <span class="op">}</span></span>
<span id="cb10-14"><a href="/entry/2019/05/15/ultra96-julia-set-explorer/#cb10-14" aria-hidden="true" tabindex="-1"></a><span class="op">};</span></span>
<span id="cb10-15"><a href="/entry/2019/05/15/ultra96-julia-set-explorer/#cb10-15" aria-hidden="true" tabindex="-1"></a>MODULE_DEVICE_TABLE<span class="op">(</span>of<span class="op">,</span> fractal_of_id_table<span class="op">);</span></span>
<span id="cb10-16"><a href="/entry/2019/05/15/ultra96-julia-set-explorer/#cb10-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-17"><a href="/entry/2019/05/15/ultra96-julia-set-explorer/#cb10-17" aria-hidden="true" tabindex="-1"></a><span class="dt">static</span> <span class="kw">struct</span> platform_driver fractal_driver <span class="op">=</span> <span class="op">{</span></span>
<span id="cb10-18"><a href="/entry/2019/05/15/ultra96-julia-set-explorer/#cb10-18" aria-hidden="true" tabindex="-1"></a>	<span class="op">.</span>driver <span class="op">=</span> <span class="op">{</span></span>
<span id="cb10-19"><a href="/entry/2019/05/15/ultra96-julia-set-explorer/#cb10-19" aria-hidden="true" tabindex="-1"></a>		<span class="op">.</span>name <span class="op">=</span> <span class="st">&quot;fractal&quot;</span><span class="op">,</span></span>
<span id="cb10-20"><a href="/entry/2019/05/15/ultra96-julia-set-explorer/#cb10-20" aria-hidden="true" tabindex="-1"></a>		<span class="op">.</span>of_match_table <span class="op">=</span> fractal_of_id_table<span class="op">,</span></span>
<span id="cb10-21"><a href="/entry/2019/05/15/ultra96-julia-set-explorer/#cb10-21" aria-hidden="true" tabindex="-1"></a>	<span class="op">},</span></span>
<span id="cb10-22"><a href="/entry/2019/05/15/ultra96-julia-set-explorer/#cb10-22" aria-hidden="true" tabindex="-1"></a>	<span class="op">.</span>probe <span class="op">=</span> fractal_probe<span class="op">,</span></span>
<span id="cb10-23"><a href="/entry/2019/05/15/ultra96-julia-set-explorer/#cb10-23" aria-hidden="true" tabindex="-1"></a>	<span class="op">.</span>remove <span class="op">=</span> fractal_remove<span class="op">,</span></span>
<span id="cb10-24"><a href="/entry/2019/05/15/ultra96-julia-set-explorer/#cb10-24" aria-hidden="true" tabindex="-1"></a><span class="op">};</span></span>
<span id="cb10-25"><a href="/entry/2019/05/15/ultra96-julia-set-explorer/#cb10-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-26"><a href="/entry/2019/05/15/ultra96-julia-set-explorer/#cb10-26" aria-hidden="true" tabindex="-1"></a>module_platform_driver<span class="op">(</span>fractal_driver<span class="op">);</span></span></code></pre></div>
<p><code>probe</code> に登録した関数 <code>fractal_probe</code> では、大きく分けて3つの処理を行っています。</p>
<ol type="1">
<li>ドライバ内で利用するメモリ領域の確保</li>
<li>デバイスのレジスタにアクセスするための準備</li>
<li>V4L2 デバイスのための初期化</li>
</ol>
<p>まずメモリ領域の確保です。今回実装したデバイスドライバ内で扱うデータとしてこんな感じの構造体を定義したので、</p>
<div class="sourceCode" id="cb11"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb11-1"><a href="/entry/2019/05/15/ultra96-julia-set-explorer/#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="kw">struct</span> fractal_device <span class="op">{</span></span>
<span id="cb11-2"><a href="/entry/2019/05/15/ultra96-julia-set-explorer/#cb11-2" aria-hidden="true" tabindex="-1"></a>	<span class="kw">struct</span> device <span class="op">*</span>dev<span class="op">;</span></span>
<span id="cb11-3"><a href="/entry/2019/05/15/ultra96-julia-set-explorer/#cb11-3" aria-hidden="true" tabindex="-1"></a>	<span class="dt">void</span> __iomem <span class="op">*</span>iomem<span class="op">;</span></span>
<span id="cb11-4"><a href="/entry/2019/05/15/ultra96-julia-set-explorer/#cb11-4" aria-hidden="true" tabindex="-1"></a>	<span class="kw">struct</span> clk <span class="op">*</span>clk<span class="op">;</span></span>
<span id="cb11-5"><a href="/entry/2019/05/15/ultra96-julia-set-explorer/#cb11-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-6"><a href="/entry/2019/05/15/ultra96-julia-set-explorer/#cb11-6" aria-hidden="true" tabindex="-1"></a>	<span class="kw">struct</span> v4l2_subdev subdev<span class="op">;</span></span>
<span id="cb11-7"><a href="/entry/2019/05/15/ultra96-julia-set-explorer/#cb11-7" aria-hidden="true" tabindex="-1"></a>	<span class="kw">struct</span> v4l2_mbus_framefmt format<span class="op">;</span></span>
<span id="cb11-8"><a href="/entry/2019/05/15/ultra96-julia-set-explorer/#cb11-8" aria-hidden="true" tabindex="-1"></a>	<span class="kw">struct</span> media_pad pads<span class="op">[</span><span class="dv">1</span><span class="op">];</span></span>
<span id="cb11-9"><a href="/entry/2019/05/15/ultra96-julia-set-explorer/#cb11-9" aria-hidden="true" tabindex="-1"></a><span class="op">};</span></span></code></pre></div>
<p>こんな感じのコードでメモリ領域を確保することにしました。</p>
<div class="sourceCode" id="cb12"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb12-1"><a href="/entry/2019/05/15/ultra96-julia-set-explorer/#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="dt">static</span> <span class="dt">int</span> fractal_probe<span class="op">(</span><span class="kw">struct</span> platform_device <span class="op">*</span>dev<span class="op">)</span></span>
<span id="cb12-2"><a href="/entry/2019/05/15/ultra96-julia-set-explorer/#cb12-2" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb12-3"><a href="/entry/2019/05/15/ultra96-julia-set-explorer/#cb12-3" aria-hidden="true" tabindex="-1"></a>	<span class="kw">struct</span> fractal_device <span class="op">*</span>fractal<span class="op">;</span></span>
<span id="cb12-4"><a href="/entry/2019/05/15/ultra96-julia-set-explorer/#cb12-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-5"><a href="/entry/2019/05/15/ultra96-julia-set-explorer/#cb12-5" aria-hidden="true" tabindex="-1"></a>	fractal <span class="op">=</span> devm_kzalloc<span class="op">(&amp;</span>dev<span class="op">-&gt;</span>dev<span class="op">,</span> <span class="kw">sizeof</span> <span class="op">*</span>fractal<span class="op">,</span> GFP_KERNEL<span class="op">);</span></span>
<span id="cb12-6"><a href="/entry/2019/05/15/ultra96-julia-set-explorer/#cb12-6" aria-hidden="true" tabindex="-1"></a>	<span class="cf">if</span> <span class="op">(!</span>fractal<span class="op">)</span></span>
<span id="cb12-7"><a href="/entry/2019/05/15/ultra96-julia-set-explorer/#cb12-7" aria-hidden="true" tabindex="-1"></a>		<span class="cf">return</span> <span class="op">-</span>ENOMEM<span class="op">;</span></span></code></pre></div>
<p>続いて、<code>fractal-&gt;iomem</code> からデバイスのレジスタ (<a href="https://en.wikipedia.org/wiki/Memory-mapped_I/O" target="_blank" rel="nofollow noopener">MMIO</a> なデバイスになっている) にアクセスできるようにします。こんな感じにすればいいようです。</p>
<div class="sourceCode" id="cb13"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb13-1"><a href="/entry/2019/05/15/ultra96-julia-set-explorer/#cb13-1" aria-hidden="true" tabindex="-1"></a>	<span class="kw">struct</span> resource <span class="op">*</span>res<span class="op">;</span></span>
<span id="cb13-2"><a href="/entry/2019/05/15/ultra96-julia-set-explorer/#cb13-2" aria-hidden="true" tabindex="-1"></a>	<span class="dt">int</span> ret<span class="op">;</span></span>
<span id="cb13-3"><a href="/entry/2019/05/15/ultra96-julia-set-explorer/#cb13-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-4"><a href="/entry/2019/05/15/ultra96-julia-set-explorer/#cb13-4" aria-hidden="true" tabindex="-1"></a>	res <span class="op">=</span> platform_get_resource<span class="op">(</span>dev<span class="op">,</span> IORESOURCE_MEM<span class="op">,</span> <span class="dv">0</span><span class="op">);</span></span>
<span id="cb13-5"><a href="/entry/2019/05/15/ultra96-julia-set-explorer/#cb13-5" aria-hidden="true" tabindex="-1"></a>	fractal<span class="op">-&gt;</span>iomem <span class="op">=</span> devm_ioremap_resource<span class="op">(</span>fractal<span class="op">-&gt;</span>dev<span class="op">,</span> res<span class="op">);</span></span>
<span id="cb13-6"><a href="/entry/2019/05/15/ultra96-julia-set-explorer/#cb13-6" aria-hidden="true" tabindex="-1"></a>	<span class="cf">if</span> <span class="op">(</span>IS_ERR<span class="op">(</span>fractal<span class="op">-&gt;</span>iomem<span class="op">))</span></span>
<span id="cb13-7"><a href="/entry/2019/05/15/ultra96-julia-set-explorer/#cb13-7" aria-hidden="true" tabindex="-1"></a>		<span class="cf">return</span> PTR_ERR<span class="op">(</span>fractal<span class="op">-&gt;</span>iomem<span class="op">);</span></span></code></pre></div>
<p>これで <code>fractal-&gt;iomem</code> 経由でデバイスのレジスタにアクセスできるようになったので、例えば <code>ctrl</code> レジスタの <code>START</code> ビットと <code>AUTO_RESTART</code> ビットをセットするならこんな感じでできるようになります。</p>
<div class="sourceCode" id="cb14"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb14-1"><a href="/entry/2019/05/15/ultra96-julia-set-explorer/#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="pp">#define FRACTAL_REG_CTRL		0x0</span></span>
<span id="cb14-2"><a href="/entry/2019/05/15/ultra96-julia-set-explorer/#cb14-2" aria-hidden="true" tabindex="-1"></a><span class="pp">#define FRACTAL_REG_CTRL_START		BIT(0)</span></span>
<span id="cb14-3"><a href="/entry/2019/05/15/ultra96-julia-set-explorer/#cb14-3" aria-hidden="true" tabindex="-1"></a><span class="pp">#define FRACTAL_REG_CTRL_DONE		BIT(1)</span></span>
<span id="cb14-4"><a href="/entry/2019/05/15/ultra96-julia-set-explorer/#cb14-4" aria-hidden="true" tabindex="-1"></a><span class="pp">#define FRACTAL_REG_CTRL_IDLE		BIT(2)</span></span>
<span id="cb14-5"><a href="/entry/2019/05/15/ultra96-julia-set-explorer/#cb14-5" aria-hidden="true" tabindex="-1"></a><span class="pp">#define FRACTAL_REG_CTRL_READY		BIT(3)</span></span>
<span id="cb14-6"><a href="/entry/2019/05/15/ultra96-julia-set-explorer/#cb14-6" aria-hidden="true" tabindex="-1"></a><span class="pp">#define FRACTAL_REG_CTRL_AUTO_RESTART	BIT(7)</span></span>
<span id="cb14-7"><a href="/entry/2019/05/15/ultra96-julia-set-explorer/#cb14-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-8"><a href="/entry/2019/05/15/ultra96-julia-set-explorer/#cb14-8" aria-hidden="true" tabindex="-1"></a><span class="dt">static</span> <span class="kw">inline</span> <span class="dt">void</span> fractal_write<span class="op">(</span><span class="kw">struct</span> fractal_device <span class="op">*</span>dev<span class="op">,</span> u32 addr<span class="op">,</span> u32 value<span class="op">)</span></span>
<span id="cb14-9"><a href="/entry/2019/05/15/ultra96-julia-set-explorer/#cb14-9" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb14-10"><a href="/entry/2019/05/15/ultra96-julia-set-explorer/#cb14-10" aria-hidden="true" tabindex="-1"></a>	iowrite32<span class="op">(</span>value<span class="op">,</span> dev<span class="op">-&gt;</span>iomem <span class="op">+</span> addr<span class="op">);</span></span>
<span id="cb14-11"><a href="/entry/2019/05/15/ultra96-julia-set-explorer/#cb14-11" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb14-12"><a href="/entry/2019/05/15/ultra96-julia-set-explorer/#cb14-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-13"><a href="/entry/2019/05/15/ultra96-julia-set-explorer/#cb14-13" aria-hidden="true" tabindex="-1"></a><span class="dt">static</span> <span class="kw">inline</span> <span class="dt">void</span> fractal_set<span class="op">(</span><span class="kw">struct</span> fractal_device <span class="op">*</span>dev<span class="op">,</span> u32 addr<span class="op">,</span> u32 value<span class="op">)</span></span>
<span id="cb14-14"><a href="/entry/2019/05/15/ultra96-julia-set-explorer/#cb14-14" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb14-15"><a href="/entry/2019/05/15/ultra96-julia-set-explorer/#cb14-15" aria-hidden="true" tabindex="-1"></a>	fractal_write<span class="op">(</span>dev<span class="op">,</span> addr<span class="op">,</span> fractal_read<span class="op">(</span>dev<span class="op">,</span> addr<span class="op">)</span> <span class="op">|</span> value<span class="op">);</span></span>
<span id="cb14-16"><a href="/entry/2019/05/15/ultra96-julia-set-explorer/#cb14-16" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb14-17"><a href="/entry/2019/05/15/ultra96-julia-set-explorer/#cb14-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-18"><a href="/entry/2019/05/15/ultra96-julia-set-explorer/#cb14-18" aria-hidden="true" tabindex="-1"></a>fractal_set<span class="op">(</span>fractal<span class="op">,</span> FRACTAL_REG_CTRL<span class="op">,</span></span>
<span id="cb14-19"><a href="/entry/2019/05/15/ultra96-julia-set-explorer/#cb14-19" aria-hidden="true" tabindex="-1"></a>	    FRACTAL_REG_CTRL_AUTO_RESTART <span class="op">|</span></span>
<span id="cb14-20"><a href="/entry/2019/05/15/ultra96-julia-set-explorer/#cb14-20" aria-hidden="true" tabindex="-1"></a>	    FRACTAL_REG_CTRL_START<span class="op">);</span></span></code></pre></div>
<p>ちなみに、ここまでで登場した <a href="https://elixir.bootlin.com/linux/v4.14/source/include/linux/device.h#L660" target="_blank" rel="nofollow noopener"><code>devm_kzalloc</code></a> や <a href="https://elixir.bootlin.com/linux/v4.4/source/lib/devres.c#L134" target="_blank" rel="nofollow noopener"><code>devm_ioremap_resource</code></a> などの <code>devm_xxx</code> 系の関数は <a href="https://lwn.net/Articles/222860/" target="_blank" rel="nofollow noopener">Managed resource API</a> と呼ばれるもので、この関数を使って確保した各種リソースはデバイスドライバがアンロードされたときに自動で解放してくれるそうです。便利。</p>
<p>最後に V4L2 関連の初期化です。これも流れとしては必要な値を設定したり、各種必要な処理を実装してその関数ポインタを渡すというもので、だいたいこんな感じになりました。</p>
<div class="sourceCode" id="cb15"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb15-1"><a href="/entry/2019/05/15/ultra96-julia-set-explorer/#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="dt">static</span> <span class="dt">int</span> fractal_s_stream<span class="op">(</span><span class="kw">struct</span> v4l2_subdev <span class="op">*</span>subdev<span class="op">,</span> <span class="dt">int</span> enable<span class="op">)</span></span>
<span id="cb15-2"><a href="/entry/2019/05/15/ultra96-julia-set-explorer/#cb15-2" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb15-3"><a href="/entry/2019/05/15/ultra96-julia-set-explorer/#cb15-3" aria-hidden="true" tabindex="-1"></a>	<span class="co">// なんか実装</span></span>
<span id="cb15-4"><a href="/entry/2019/05/15/ultra96-julia-set-explorer/#cb15-4" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb15-5"><a href="/entry/2019/05/15/ultra96-julia-set-explorer/#cb15-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-6"><a href="/entry/2019/05/15/ultra96-julia-set-explorer/#cb15-6" aria-hidden="true" tabindex="-1"></a><span class="dt">static</span> <span class="dt">const</span> <span class="kw">struct</span> v4l2_subdev_core_ops fractal_core_ops <span class="op">=</span> <span class="op">{</span></span>
<span id="cb15-7"><a href="/entry/2019/05/15/ultra96-julia-set-explorer/#cb15-7" aria-hidden="true" tabindex="-1"></a>	<span class="co">// ...</span></span>
<span id="cb15-8"><a href="/entry/2019/05/15/ultra96-julia-set-explorer/#cb15-8" aria-hidden="true" tabindex="-1"></a><span class="op">};</span></span>
<span id="cb15-9"><a href="/entry/2019/05/15/ultra96-julia-set-explorer/#cb15-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-10"><a href="/entry/2019/05/15/ultra96-julia-set-explorer/#cb15-10" aria-hidden="true" tabindex="-1"></a><span class="dt">static</span> <span class="dt">const</span> <span class="kw">struct</span> v4l2_subdev_video_ops fractal_video_ops <span class="op">=</span> <span class="op">{</span></span>
<span id="cb15-11"><a href="/entry/2019/05/15/ultra96-julia-set-explorer/#cb15-11" aria-hidden="true" tabindex="-1"></a>	<span class="op">.</span>s_stream <span class="op">=</span> fractal_s_stream<span class="op">,</span></span>
<span id="cb15-12"><a href="/entry/2019/05/15/ultra96-julia-set-explorer/#cb15-12" aria-hidden="true" tabindex="-1"></a><span class="op">};</span></span>
<span id="cb15-13"><a href="/entry/2019/05/15/ultra96-julia-set-explorer/#cb15-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-14"><a href="/entry/2019/05/15/ultra96-julia-set-explorer/#cb15-14" aria-hidden="true" tabindex="-1"></a><span class="dt">static</span> <span class="dt">const</span> <span class="kw">struct</span> v4l2_subdev_pad_ops fractal_pad_ops <span class="op">=</span> <span class="op">{</span></span>
<span id="cb15-15"><a href="/entry/2019/05/15/ultra96-julia-set-explorer/#cb15-15" aria-hidden="true" tabindex="-1"></a>	<span class="co">// ...</span></span>
<span id="cb15-16"><a href="/entry/2019/05/15/ultra96-julia-set-explorer/#cb15-16" aria-hidden="true" tabindex="-1"></a><span class="op">};</span></span>
<span id="cb15-17"><a href="/entry/2019/05/15/ultra96-julia-set-explorer/#cb15-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-18"><a href="/entry/2019/05/15/ultra96-julia-set-explorer/#cb15-18" aria-hidden="true" tabindex="-1"></a><span class="dt">static</span> <span class="dt">const</span> <span class="kw">struct</span> v4l2_subdev_ops fractal_ops <span class="op">=</span> <span class="op">{</span></span>
<span id="cb15-19"><a href="/entry/2019/05/15/ultra96-julia-set-explorer/#cb15-19" aria-hidden="true" tabindex="-1"></a>	<span class="op">.</span>core   <span class="op">=</span> <span class="op">&amp;</span>fractal_core_ops<span class="op">,</span></span>
<span id="cb15-20"><a href="/entry/2019/05/15/ultra96-julia-set-explorer/#cb15-20" aria-hidden="true" tabindex="-1"></a>	<span class="op">.</span>video  <span class="op">=</span> <span class="op">&amp;</span>fractal_video_ops<span class="op">,</span></span>
<span id="cb15-21"><a href="/entry/2019/05/15/ultra96-julia-set-explorer/#cb15-21" aria-hidden="true" tabindex="-1"></a>	<span class="op">.</span>pad    <span class="op">=</span> <span class="op">&amp;</span>fractal_pad_ops<span class="op">,</span></span>
<span id="cb15-22"><a href="/entry/2019/05/15/ultra96-julia-set-explorer/#cb15-22" aria-hidden="true" tabindex="-1"></a><span class="op">};</span></span>
<span id="cb15-23"><a href="/entry/2019/05/15/ultra96-julia-set-explorer/#cb15-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-24"><a href="/entry/2019/05/15/ultra96-julia-set-explorer/#cb15-24" aria-hidden="true" tabindex="-1"></a><span class="dt">static</span> <span class="dt">int</span> fractal_probe<span class="op">(</span><span class="kw">struct</span> platform_device <span class="op">*</span>dev<span class="op">)</span></span>
<span id="cb15-25"><a href="/entry/2019/05/15/ultra96-julia-set-explorer/#cb15-25" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb15-26"><a href="/entry/2019/05/15/ultra96-julia-set-explorer/#cb15-26" aria-hidden="true" tabindex="-1"></a>	<span class="kw">struct</span> v4l2_subdev <span class="op">*</span>subdev<span class="op">;</span></span>
<span id="cb15-27"><a href="/entry/2019/05/15/ultra96-julia-set-explorer/#cb15-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-28"><a href="/entry/2019/05/15/ultra96-julia-set-explorer/#cb15-28" aria-hidden="true" tabindex="-1"></a>	<span class="co">// その他の設定 ...</span></span>
<span id="cb15-29"><a href="/entry/2019/05/15/ultra96-julia-set-explorer/#cb15-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-30"><a href="/entry/2019/05/15/ultra96-julia-set-explorer/#cb15-30" aria-hidden="true" tabindex="-1"></a>	subdev <span class="op">=</span> <span class="op">&amp;</span>fractal<span class="op">-&gt;</span>subdev<span class="op">;</span></span>
<span id="cb15-31"><a href="/entry/2019/05/15/ultra96-julia-set-explorer/#cb15-31" aria-hidden="true" tabindex="-1"></a>	v4l2_subdev_init<span class="op">(</span>subdev<span class="op">,</span> <span class="op">&amp;</span>fractal_ops<span class="op">);</span></span>
<span id="cb15-32"><a href="/entry/2019/05/15/ultra96-julia-set-explorer/#cb15-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-33"><a href="/entry/2019/05/15/ultra96-julia-set-explorer/#cb15-33" aria-hidden="true" tabindex="-1"></a>	<span class="co">// その他の設定 ...</span></span>
<span id="cb15-34"><a href="/entry/2019/05/15/ultra96-julia-set-explorer/#cb15-34" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p><code>s_stream</code> はストリーミングの開始・終了時 (<a href="https://www.kernel.org/doc/html/v4.14/media/uapi/v4l/vidioc-streamon.html" target="_blank" rel="nofollow noopener"><code>ioctl VIDIOC_STREAMON</code>, <code>ioctl VIDIOC_STREAMOFF</code></a>) に呼ばれる関数です。今回実装した Julia set 描画回路は描画の開始と終了を制御してやる必要があるので、このように実装しました。ストリーミングの開始時には、適用な初期値の設定も行っています。</p>
<div class="sourceCode" id="cb16"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb16-1"><a href="/entry/2019/05/15/ultra96-julia-set-explorer/#cb16-1" aria-hidden="true" tabindex="-1"></a><span class="dt">static</span> <span class="kw">inline</span> <span class="kw">struct</span> fractal_device</span>
<span id="cb16-2"><a href="/entry/2019/05/15/ultra96-julia-set-explorer/#cb16-2" aria-hidden="true" tabindex="-1"></a><span class="op">*</span>get_fractal_device<span class="op">(</span><span class="kw">struct</span> v4l2_subdev <span class="op">*</span>subdev<span class="op">)</span></span>
<span id="cb16-3"><a href="/entry/2019/05/15/ultra96-julia-set-explorer/#cb16-3" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb16-4"><a href="/entry/2019/05/15/ultra96-julia-set-explorer/#cb16-4" aria-hidden="true" tabindex="-1"></a>	<span class="cf">return</span> container_of<span class="op">(</span>subdev<span class="op">,</span> <span class="kw">struct</span> fractal_device<span class="op">,</span> subdev<span class="op">);</span></span>
<span id="cb16-5"><a href="/entry/2019/05/15/ultra96-julia-set-explorer/#cb16-5" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb16-6"><a href="/entry/2019/05/15/ultra96-julia-set-explorer/#cb16-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-7"><a href="/entry/2019/05/15/ultra96-julia-set-explorer/#cb16-7" aria-hidden="true" tabindex="-1"></a><span class="dt">static</span> <span class="dt">int</span> fractal_s_stream<span class="op">(</span><span class="kw">struct</span> v4l2_subdev <span class="op">*</span>subdev<span class="op">,</span> <span class="dt">int</span> enable<span class="op">)</span></span>
<span id="cb16-8"><a href="/entry/2019/05/15/ultra96-julia-set-explorer/#cb16-8" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb16-9"><a href="/entry/2019/05/15/ultra96-julia-set-explorer/#cb16-9" aria-hidden="true" tabindex="-1"></a>	<span class="kw">struct</span> fractal_device <span class="op">*</span>fractal <span class="op">=</span> get_fractal_device<span class="op">(</span>subdev<span class="op">);</span></span>
<span id="cb16-10"><a href="/entry/2019/05/15/ultra96-julia-set-explorer/#cb16-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-11"><a href="/entry/2019/05/15/ultra96-julia-set-explorer/#cb16-11" aria-hidden="true" tabindex="-1"></a>	<span class="cf">if</span> <span class="op">(</span>enable<span class="op">)</span> <span class="op">{</span></span>
<span id="cb16-12"><a href="/entry/2019/05/15/ultra96-julia-set-explorer/#cb16-12" aria-hidden="true" tabindex="-1"></a>		fractal_write<span class="op">(</span>fractal<span class="op">,</span> FRACTAL_REG_X0<span class="op">,</span> <span class="bn">0x10000000</span><span class="bu">u</span><span class="op">);</span></span>
<span id="cb16-13"><a href="/entry/2019/05/15/ultra96-julia-set-explorer/#cb16-13" aria-hidden="true" tabindex="-1"></a>		fractal_write<span class="op">(</span>fractal<span class="op">,</span> FRACTAL_REG_Y0<span class="op">,</span> <span class="bn">0x09000000</span><span class="bu">u</span><span class="op">);</span></span>
<span id="cb16-14"><a href="/entry/2019/05/15/ultra96-julia-set-explorer/#cb16-14" aria-hidden="true" tabindex="-1"></a>		fractal_write<span class="op">(</span>fractal<span class="op">,</span> FRACTAL_REG_DX<span class="op">,</span> <span class="bn">0x00044444</span><span class="bu">u</span><span class="op">);</span></span>
<span id="cb16-15"><a href="/entry/2019/05/15/ultra96-julia-set-explorer/#cb16-15" aria-hidden="true" tabindex="-1"></a>		fractal_write<span class="op">(</span>fractal<span class="op">,</span> FRACTAL_REG_DY<span class="op">,</span> <span class="bn">0x00044444</span><span class="bu">u</span><span class="op">);</span></span>
<span id="cb16-16"><a href="/entry/2019/05/15/ultra96-julia-set-explorer/#cb16-16" aria-hidden="true" tabindex="-1"></a>		fractal_write<span class="op">(</span>fractal<span class="op">,</span> FRACTAL_REG_CR<span class="op">,</span> <span class="bn">0xf9999999</span><span class="bu">u</span><span class="op">);</span></span>
<span id="cb16-17"><a href="/entry/2019/05/15/ultra96-julia-set-explorer/#cb16-17" aria-hidden="true" tabindex="-1"></a>		fractal_write<span class="op">(</span>fractal<span class="op">,</span> FRACTAL_REG_CI<span class="op">,</span> <span class="bn">0x09999999</span><span class="bu">u</span><span class="op">);</span></span>
<span id="cb16-18"><a href="/entry/2019/05/15/ultra96-julia-set-explorer/#cb16-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-19"><a href="/entry/2019/05/15/ultra96-julia-set-explorer/#cb16-19" aria-hidden="true" tabindex="-1"></a>		fractal_set<span class="op">(</span>fractal<span class="op">,</span> FRACTAL_REG_CTRL<span class="op">,</span></span>
<span id="cb16-20"><a href="/entry/2019/05/15/ultra96-julia-set-explorer/#cb16-20" aria-hidden="true" tabindex="-1"></a>			    FRACTAL_REG_CTRL_AUTO_RESTART <span class="op">|</span></span>
<span id="cb16-21"><a href="/entry/2019/05/15/ultra96-julia-set-explorer/#cb16-21" aria-hidden="true" tabindex="-1"></a>			    FRACTAL_REG_CTRL_START<span class="op">);</span></span>
<span id="cb16-22"><a href="/entry/2019/05/15/ultra96-julia-set-explorer/#cb16-22" aria-hidden="true" tabindex="-1"></a>	<span class="op">}</span> <span class="cf">else</span> <span class="op">{</span></span>
<span id="cb16-23"><a href="/entry/2019/05/15/ultra96-julia-set-explorer/#cb16-23" aria-hidden="true" tabindex="-1"></a>		fractal_clr<span class="op">(</span>fractal<span class="op">,</span> FRACTAL_REG_CTRL<span class="op">,</span></span>
<span id="cb16-24"><a href="/entry/2019/05/15/ultra96-julia-set-explorer/#cb16-24" aria-hidden="true" tabindex="-1"></a>			    FRACTAL_REG_CTRL_AUTO_RESTART <span class="op">|</span></span>
<span id="cb16-25"><a href="/entry/2019/05/15/ultra96-julia-set-explorer/#cb16-25" aria-hidden="true" tabindex="-1"></a>			    FRACTAL_REG_CTRL_START<span class="op">);</span></span>
<span id="cb16-26"><a href="/entry/2019/05/15/ultra96-julia-set-explorer/#cb16-26" aria-hidden="true" tabindex="-1"></a>	<span class="op">}</span></span>
<span id="cb16-27"><a href="/entry/2019/05/15/ultra96-julia-set-explorer/#cb16-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-28"><a href="/entry/2019/05/15/ultra96-julia-set-explorer/#cb16-28" aria-hidden="true" tabindex="-1"></a>	<span class="cf">return</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb16-29"><a href="/entry/2019/05/15/ultra96-julia-set-explorer/#cb16-29" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>このほか、<code>fractal_pad_ops</code> の <code>enum_mbus_code</code>、<code>enum_frame_size</code>、<code>get_fmt</code>、<code>set_fmt</code> が実装されています。実装といっても、今回は画像フォーマットは固定であるなどの理由からなにか特別な処理を実装したわけではないので、ここでは省略します。</p>
<h3 id="devicetree-の設定">Devicetree の設定</h3>
<p><a href="https://www.devicetree.org/" target="_blank" rel="nofollow noopener">Devicetree</a> は、(ソフトウェアから直接探索できない) デバイスのプロパティや接続関係の詳細を記述するためのものだそうです。従来 OS の実装にハードコーディングしていたデバイス固有のパラメータを Devicetree に切り離すことで、OS をより汎用的なコードで実装できるようにするのが狙いだそうです。デバイスドライバの実装の際に MMIO なレジスタをマッピングするなどを行いましたが、ここで必要になる MMIO のアドレスなんかも Devicetree に記述される情報だったりします。ARM の Linux は Devicetree を活用しているものの1つで、今回 Linux に実装したデバイスを認識させるにあたって Devicetree の設定がいくつか必要になります。</p>
<p>PetaLinux Tools を使った開発では、Devicetree の設定を PetaLinux Tools が自動生成した Devicetree に必要に応じてノードの追加・上書きなどをすることによって行うようです。PetaLinux Tools が生成した Devicetree は <code>components/plnx_workspace/device-tree/device-tree/</code> にあります。例えば PL 上の回路に関連するものは <code>pl.dtsi</code> に記述されていて、今回実装した Julia set 描画回路に対応するものはこんな感じになっていました。</p>
<pre class="dts"><code>fractal_0: fractal@a0000000 {
	clock-names = &quot;ap_clk&quot;;
	clocks = &lt;&amp;misc_clk_1&gt;;
	compatible = &quot;xlnx,fractal-1.0&quot;;
	interrupt-names = &quot;interrupt&quot;;
	interrupt-parent = &lt;&amp;gic&gt;;
	interrupts = &lt;0 89 4&gt;;
	reg = &lt;0x0 0xa0000000 0x0 0x10000&gt;;
	xlnx,s-axi-ctrl-addr-width = &lt;0x6&gt;;
	xlnx,s-axi-ctrl-data-width = &lt;0x20&gt;;
};</code></pre>
<p>この生成された Devicetree へのノードの追加・上書きは <code>project-spec/meta-user/recipes-bsp/device-tree/files/system-user.dtsi</code> によって行います。例えば前述した <code>fractal_0</code> に <code>hello = &quot;world&quot;;</code> というプロパティを追加したいときはこのような記述を追加します。</p>
<pre class="dts"><code>&amp;fractal_0 {
	hello = &quot;world&quot;;
}</code></pre>
<p>さて、今回 Devicetree に追加しなければいけないのが</p>
<ul>
<li><a href="https://github.com/Xilinx/linux-xlnx/blob/xilinx-v2018.3/Documentation/devicetree/bindings/media/xilinx/xlnx,video.txt" target="_blank" rel="nofollow noopener">Xilinx Video IP Pipeline (VIPP)</a> ノード</li>
<li>映像処理関連 IP が持つ入出力ポート</li>
<li>各種 IP と VIPP の入出力ポートの接続関係</li>
</ul>
<p>です。とりあえず今回記述した <code>system-user.dtsi</code> が<a href="https://github.com/Tosainu/ultra96-fractal/blob/1ed4e5e409d6445a85741149c112322cc6fc251c/petalinux_project/project-spec/meta-user/recipes-bsp/device-tree/files/system-user.dtsi" target="_blank" rel="nofollow noopener">こんな感じ</a>になりました。</p>
<pre class="dts"><code>&amp;fractal_0 {
	ports {
		#address-cells = &lt;1&gt;;
		#size-cells = &lt;0&gt;;

		port@0 {
			reg = &lt;0&gt;;
			fractal_0_out_0: endpoint {
				remote-endpoint = &lt;&amp;vcap_0_in_0&gt;;
			};
		};
	};
};

&amp;amba_pl {
	vcap_0: video_cap {
		compatible = &quot;xlnx,video&quot;;
		dmas = &lt;&amp;axi_vdma_0 1&gt;;
		dma-names = &quot;port0&quot;;

		ports {
			#address-cells = &lt;1&gt;;
			#size-cells = &lt;0&gt;;

			port@0 {
				reg = &lt;0&gt;;
				direction = &quot;input&quot;;
				vcap_0_in_0: endpoint {
					remote-endpoint = &lt;&amp;fractal_0_out_0&gt;;
				};
			};
		};
	};
};</code></pre>
<p><code>vcap_0</code> が VIPP ノードです。このノードの <code>compatible</code> には <code>xlnx,video</code> を指定します。また <code>dmas</code> に利用する DMA とその Channel ID を指定します。Stream ID は、<a href="https://github.com/Xilinx/linux-xlnx/blob/xilinx-v2018.3/Documentation/devicetree/bindings/dma/xilinx/xilinx_dma.txt#L105-L112" target="_blank" rel="nofollow noopener">AXI VDMA の場合</a> 0 が Read channel、1 が Write channel に対応します<a href="/entry/2019/05/15/ultra96-julia-set-explorer/#fn4" class="footnote-ref" id="fnref4" role="doc-noteref"><sup>4</sup></a>。</p>
<p>デバイスの入出力ポートは <code>ports</code> ノード下に記述します。この辺の設定に関しては<a href="https://github.com/Xilinx/linux-xlnx/blob/xilinx-v2018.3/Documentation/devicetree/bindings/media/video-interfaces.txt" target="_blank" rel="nofollow noopener">ここ</a>を参考にすればよいでしょう。今回は <code>fractal_0</code>、<code>vcap_0</code> ともに入力または出力のポートの1つしかないなので <code>port@0</code> のみを記述し、それぞれ <code>remote-endpoint</code> にポートの接続先を指定してやりました。</p>
<h3 id="ブート時にドライバが読み込まれるようにする">ブート時にドライバが読み込まれるようにする</h3>
<p>デバイスドライバは PetaLinux プロジェクトのディレクトリで <code>petalinux-create --type modules</code> コマンドを実行することでプロジェクトに追加したカーネルモジュールとして実装しました。しかしこの追加したカーネルモジュールなのですが、<code>petalinux-config -c rootfs</code> で開いたメニューから有効にするだけでは、ビルドはされるもののブート時に自動で読み込まれるようになってくれませんでした。</p>
<p>追加したカーネルモジュールをブート時に自動的に読み込まれるようにするには、プロジェクトの <code>project-spec/meta-user/conf/petalinuxbsp.conf</code> に以下の行を追加する必要があるようです。</p>
<pre class="conf"><code>KERNEL_MODULE_AUTOLOAD_append = &quot; &lt;module-name&gt;&quot;</code></pre>
<p>ちなみに、この <code>KERNEL_MODULE_AUTOLOAD</code> に関するドキュメントは<a href="https://www.yoctoproject.org/docs/2.4/ref-manual/ref-manual.html#migration-1.7-kernel-module-autoloading" target="_blank" rel="nofollow noopener">ここ</a>にあります。PetaLinux が Yocto Project をベースにしている (？) ためかこのあたりの設定項目のドキュメントは Yocto Project 側にあることも多く、調べるのが少し大変でした。</p>
<h2 id="描画した-julia-set-をカッコよく表示できるようにする">描画した Julia set をカッコよく表示できるようにする</h2>
<p>最後に PL で描画した Julia set を表示したりゲームパッドで操作するためのアプリケーションを実装しました。実装したコードが<a href="https://github.com/Tosainu/ultra96-fractal/blob/1ed4e5e409d6445a85741149c112322cc6fc251c/petalinux_project/project-spec/meta-user/recipes-apps/fractal-explorer/files/main.cc" target="_blank" rel="nofollow noopener">これ</a><a href="/entry/2019/05/15/ultra96-julia-set-explorer/#fn5" class="footnote-ref" id="fnref5" role="doc-noteref"><sup>5</sup></a>で、動作している様子がこんな感じです。ウィンドウ全体に描画した Julia set を表示しつつ、左上に Julia set のパラメータを表示しています<a href="/entry/2019/05/15/ultra96-julia-set-explorer/#fn6" class="footnote-ref" id="fnref6" role="doc-noteref"><sup>6</sup></a>。
<img src="/entry/2019/05/15/ultra96-julia-set-explorer/screenshot.png" /></p>
<h3 id="ディスプレイドライバと-x11-の相性が悪い問題">ディスプレイドライバと X11 の相性が悪い問題</h3>
<p>上のスクリーンショットで気づいた方もいるかもしれませんが、今回 <a href="https://wayland.freedesktop.org/" target="_blank" rel="nofollow noopener">Wayland</a> な Window Manager (WM) である <a href="https://gitlab.freedesktop.org/wayland/weston/" target="_blank" rel="nofollow noopener">Weston</a> を使っています。Wayland な WM を利用しているのは、X11 な WM ではなぜか性能が全く出てくれなかったためです。画面のチラつき・カクつきといった現象がみられたり、OpenGL ES 2.0 版の glmark2 を試すと良くても十数 fps 程度しか出なかったりと、とても許容できるものではありませんでした。この問題に悩んでいるときたまたま <a href="https://xilinx-wiki.atlassian.net/wiki/spaces/A/pages/18841928/Xilinx+MALI+driver" target="_blank" rel="nofollow noopener">Zynq UltraScale+MPSoC で Wayland が利用できるという情報</a><a href="/entry/2019/05/15/ultra96-julia-set-explorer/#fn7" class="footnote-ref" id="fnref7" role="doc-noteref"><sup>7</sup></a>を見つけ試してみたら X11 よりはかなりマシに動作してくれることがわかり、じゃあ Wayland にするかーとなった感じです。</p>
<p>紹介したリンク先にあるように、PetaLinux で Weston を組み込んだイメージを作るには <code>project-spec/meta-user/conf/petalinuxbsp.conf</code> に次の行を追加すればいいようです。</p>
<pre class="conf"><code>DISTRO_FEATURES_append = &quot; wayland&quot;
IMAGE_INSTALL_append = &quot; packagegroup-petalinux-weston&quot;</code></pre>
<p>さらに X11 関連のパッケージが完全に不要であれば、同ファイルに</p>
<pre class="conf"><code>DISTRO_FEATURES_remove = &quot; x11&quot;</code></pre>
<p>も追加すると、作成されるイメージがより小さくなって良さそうです。</p>
<p>WM に Wayland なものを採用したため、実装するアプリケーションも Wayland に対応したものでなければいけません。今回は複雑な UI を持ったものを作る予定がなかったことや、起動イメージをできる限り小さくしたかったことから、<code>wayland-client.h</code> の関数を直接利用し Wayland client を実装しました。</p>
<h3 id="v4l2-でキャプチャした画像を低遅延で表示したい">V4L2 でキャプチャした画像を低遅延で表示したい</h3>
<p>単に PL で生成した画像を表示したいだけであれば、前述した Zynq UltraScale+ MPSoC の DisplayPort Controller に直接映像を流し込む方法などが良さそうです。しかし今回は描画した Juia set の上からステータス表示などを合成したかったため、OpenGL ES 2.0 を使った画像の表示とステータス表示の合成を行うことにしました<a href="/entry/2019/05/15/ultra96-julia-set-explorer/#fn8" class="footnote-ref" id="fnref8" role="doc-noteref"><sup>8</sup></a>。</p>
<p>この方針で実装するにあたり、特にソフトウェア側で発生する遅延を最小限にするためにいくつかの工夫が必要でした。</p>
<p>OpenGL を使って画像を表示したい場合、まず GPU 側に画像を転送する必要があります。例えば以下のような画像データ <code>image</code> がある場合、</p>
<div class="sourceCode" id="cb23"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb23-1"><a href="/entry/2019/05/15/ultra96-julia-set-explorer/#cb23-1" aria-hidden="true" tabindex="-1"></a>GLubyte image<span class="op">[</span>width <span class="op">*</span> height <span class="op">*</span> <span class="dv">4</span><span class="op">];</span></span></code></pre></div>
<p>これを GPU に転送するコードは <a href="https://www.khronos.org/registry/OpenGL-Refpages/es2.0/xhtml/glTexImage2D.xml" target="_blank" rel="nofollow noopener"><code>glTexImage2D</code></a> や <a href="https://www.khronos.org/registry/OpenGL-Refpages/es2.0/xhtml/glTexSubImage2D.xml" target="_blank" rel="nofollow noopener"><code>glTexSubImage2D</code></a> などを使えばよく、だいたいこんな感じになります<a href="/entry/2019/05/15/ultra96-julia-set-explorer/#fn9" class="footnote-ref" id="fnref9" role="doc-noteref"><sup>9</sup></a>。</p>
<div class="sourceCode" id="cb24"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb24-1"><a href="/entry/2019/05/15/ultra96-julia-set-explorer/#cb24-1" aria-hidden="true" tabindex="-1"></a>GLuint texture<span class="op">;</span></span>
<span id="cb24-2"><a href="/entry/2019/05/15/ultra96-julia-set-explorer/#cb24-2" aria-hidden="true" tabindex="-1"></a>glGenTextures<span class="op">(</span>num_buffers<span class="op">,</span> <span class="op">&amp;</span>texture<span class="op">);</span></span>
<span id="cb24-3"><a href="/entry/2019/05/15/ultra96-julia-set-explorer/#cb24-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-4"><a href="/entry/2019/05/15/ultra96-julia-set-explorer/#cb24-4" aria-hidden="true" tabindex="-1"></a>glBindTexture<span class="op">(</span>GL_TEXTURE_2D<span class="op">,</span> texture<span class="op">);</span></span>
<span id="cb24-5"><a href="/entry/2019/05/15/ultra96-julia-set-explorer/#cb24-5" aria-hidden="true" tabindex="-1"></a>glTexImage2D<span class="op">(</span>GL_TEXTURE_2D<span class="op">,</span></span>
<span id="cb24-6"><a href="/entry/2019/05/15/ultra96-julia-set-explorer/#cb24-6" aria-hidden="true" tabindex="-1"></a>    <span class="dv">0</span><span class="op">,</span> GL_RGBA<span class="op">,</span> width<span class="op">,</span> height<span class="op">,</span> <span class="dv">0</span><span class="op">,</span> GL_RGBA<span class="op">,</span> GL_UNSIGNED_BYTE<span class="op">,</span> image<span class="op">);</span></span>
<span id="cb24-7"><a href="/entry/2019/05/15/ultra96-julia-set-explorer/#cb24-7" aria-hidden="true" tabindex="-1"></a>glBindTexture<span class="op">(</span>GL_TEXTURE_2D<span class="op">,</span> <span class="dv">0</span><span class="op">);</span></span></code></pre></div>
<p>「なら V4L2 でキャプチャした画像を表示するのも簡単じゃん！」とこんな感じの実装<a href="/entry/2019/05/15/ultra96-julia-set-explorer/#fn10" class="footnote-ref" id="fnref10" role="doc-noteref"><sup>10</sup></a>をすると…</p>
<div class="sourceCode" id="cb25"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb25-1"><a href="/entry/2019/05/15/ultra96-julia-set-explorer/#cb25-1" aria-hidden="true" tabindex="-1"></a><span class="co">// テクスチャの初期化</span></span>
<span id="cb25-2"><a href="/entry/2019/05/15/ultra96-julia-set-explorer/#cb25-2" aria-hidden="true" tabindex="-1"></a>GLuint texture<span class="op">;</span></span>
<span id="cb25-3"><a href="/entry/2019/05/15/ultra96-julia-set-explorer/#cb25-3" aria-hidden="true" tabindex="-1"></a>glGenTextures<span class="op">(</span>num_buffers<span class="op">,</span> <span class="op">&amp;</span>texture<span class="op">);</span></span>
<span id="cb25-4"><a href="/entry/2019/05/15/ultra96-julia-set-explorer/#cb25-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-5"><a href="/entry/2019/05/15/ultra96-julia-set-explorer/#cb25-5" aria-hidden="true" tabindex="-1"></a><span class="dt">int</span> fd <span class="op">=</span> open<span class="op">(</span><span class="st">&quot;/dev/video0&quot;</span><span class="op">,</span> O_RDWR<span class="op">);</span></span>
<span id="cb25-6"><a href="/entry/2019/05/15/ultra96-julia-set-explorer/#cb25-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-7"><a href="/entry/2019/05/15/ultra96-julia-set-explorer/#cb25-7" aria-hidden="true" tabindex="-1"></a><span class="co">// キャプチャ用バッファの初期設定</span></span>
<span id="cb25-8"><a href="/entry/2019/05/15/ultra96-julia-set-explorer/#cb25-8" aria-hidden="true" tabindex="-1"></a><span class="kw">struct</span> v4l2_requestbuffers req<span class="op">;</span></span>
<span id="cb25-9"><a href="/entry/2019/05/15/ultra96-julia-set-explorer/#cb25-9" aria-hidden="true" tabindex="-1"></a>req<span class="op">.</span>count <span class="op">=</span> MAX_BUFFERS<span class="op">;</span></span>
<span id="cb25-10"><a href="/entry/2019/05/15/ultra96-julia-set-explorer/#cb25-10" aria-hidden="true" tabindex="-1"></a>req<span class="op">.</span>type <span class="op">=</span> V4L2_BUF_TYPE_VIDEO_CAPTURE<span class="op">;</span></span>
<span id="cb25-11"><a href="/entry/2019/05/15/ultra96-julia-set-explorer/#cb25-11" aria-hidden="true" tabindex="-1"></a>req<span class="op">.</span>memory <span class="op">=</span> V4L2_MEMORY_MMAP<span class="op">;</span></span>
<span id="cb25-12"><a href="/entry/2019/05/15/ultra96-julia-set-explorer/#cb25-12" aria-hidden="true" tabindex="-1"></a>ioctl<span class="op">(</span>fd<span class="op">,</span> VIDIOC_REQBUFS<span class="op">,</span> <span class="op">&amp;</span>req<span class="op">);</span></span>
<span id="cb25-13"><a href="/entry/2019/05/15/ultra96-julia-set-explorer/#cb25-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-14"><a href="/entry/2019/05/15/ultra96-julia-set-explorer/#cb25-14" aria-hidden="true" tabindex="-1"></a><span class="dt">unsigned</span> <span class="dt">int</span> num_buffers <span class="op">=</span> req<span class="op">.</span>count<span class="op">;</span></span>
<span id="cb25-15"><a href="/entry/2019/05/15/ultra96-julia-set-explorer/#cb25-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-16"><a href="/entry/2019/05/15/ultra96-julia-set-explorer/#cb25-16" aria-hidden="true" tabindex="-1"></a><span class="co">// バッファの確保・ストリーミングキューへの追加</span></span>
<span id="cb25-17"><a href="/entry/2019/05/15/ultra96-julia-set-explorer/#cb25-17" aria-hidden="true" tabindex="-1"></a><span class="dt">void</span><span class="op">*</span> buffers<span class="op">[</span>MAX_BUFFERS<span class="op">];</span></span>
<span id="cb25-18"><a href="/entry/2019/05/15/ultra96-julia-set-explorer/#cb25-18" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> <span class="op">(</span><span class="dt">unsigned</span> <span class="dt">int</span> i <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> i <span class="op">&lt;</span> num_buffers<span class="op">;</span> <span class="op">++</span>i<span class="op">)</span> <span class="op">{</span></span>
<span id="cb25-19"><a href="/entry/2019/05/15/ultra96-julia-set-explorer/#cb25-19" aria-hidden="true" tabindex="-1"></a>  <span class="kw">struct</span> v4l2_buffer buf<span class="op">;</span></span>
<span id="cb25-20"><a href="/entry/2019/05/15/ultra96-julia-set-explorer/#cb25-20" aria-hidden="true" tabindex="-1"></a>  buf<span class="op">.</span>index <span class="op">=</span> i<span class="op">;</span></span>
<span id="cb25-21"><a href="/entry/2019/05/15/ultra96-julia-set-explorer/#cb25-21" aria-hidden="true" tabindex="-1"></a>  buf<span class="op">.</span>type <span class="op">=</span> V4L2_BUF_TYPE_VIDEO_CAPTURE<span class="op">;</span></span>
<span id="cb25-22"><a href="/entry/2019/05/15/ultra96-julia-set-explorer/#cb25-22" aria-hidden="true" tabindex="-1"></a>  buf<span class="op">.</span>memory <span class="op">=</span> V4L2_MEMORY_MMAP<span class="op">;</span></span>
<span id="cb25-23"><a href="/entry/2019/05/15/ultra96-julia-set-explorer/#cb25-23" aria-hidden="true" tabindex="-1"></a>  ioctl<span class="op">(</span>fd<span class="op">,</span> VIDIOC_QUERYBUF<span class="op">,</span> <span class="op">&amp;</span>buf<span class="op">);</span></span>
<span id="cb25-24"><a href="/entry/2019/05/15/ultra96-julia-set-explorer/#cb25-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-25"><a href="/entry/2019/05/15/ultra96-julia-set-explorer/#cb25-25" aria-hidden="true" tabindex="-1"></a>  buffers<span class="op">[</span>i<span class="op">]</span> <span class="op">=</span> mmap<span class="op">(</span>NULL<span class="op">,</span> buf<span class="op">.</span>length<span class="op">,</span> PROT_READ <span class="op">|</span> PROT_WRITE<span class="op">,</span> MAP_SHARED<span class="op">,</span> fd<span class="op">,</span> buf<span class="op">.</span>m<span class="op">.</span>offset<span class="op">);</span></span>
<span id="cb25-26"><a href="/entry/2019/05/15/ultra96-julia-set-explorer/#cb25-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-27"><a href="/entry/2019/05/15/ultra96-julia-set-explorer/#cb25-27" aria-hidden="true" tabindex="-1"></a>  ioctl<span class="op">(</span>fd<span class="op">,</span> VIDIOC_QBUF<span class="op">,</span> <span class="op">&amp;</span>buf<span class="op">);</span></span>
<span id="cb25-28"><a href="/entry/2019/05/15/ultra96-julia-set-explorer/#cb25-28" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb25-29"><a href="/entry/2019/05/15/ultra96-julia-set-explorer/#cb25-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-30"><a href="/entry/2019/05/15/ultra96-julia-set-explorer/#cb25-30" aria-hidden="true" tabindex="-1"></a><span class="co">// キャプチャの開始</span></span>
<span id="cb25-31"><a href="/entry/2019/05/15/ultra96-julia-set-explorer/#cb25-31" aria-hidden="true" tabindex="-1"></a><span class="kw">enum</span> v4l2_buf_type type <span class="op">=</span> V4L2_BUF_TYPE_VIDEO_CAPTURE<span class="op">;</span></span>
<span id="cb25-32"><a href="/entry/2019/05/15/ultra96-julia-set-explorer/#cb25-32" aria-hidden="true" tabindex="-1"></a>ioctl<span class="op">(</span>fd<span class="op">,</span> VIDIOC_STREAMON<span class="op">,</span> <span class="op">&amp;</span>type<span class="op">);</span></span>
<span id="cb25-33"><a href="/entry/2019/05/15/ultra96-julia-set-explorer/#cb25-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-34"><a href="/entry/2019/05/15/ultra96-julia-set-explorer/#cb25-34" aria-hidden="true" tabindex="-1"></a><span class="cf">while</span> <span class="op">(</span><span class="dv">1</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb25-35"><a href="/entry/2019/05/15/ultra96-julia-set-explorer/#cb25-35" aria-hidden="true" tabindex="-1"></a>  <span class="co">// ストリーミングキューからバッファを取り出す</span></span>
<span id="cb25-36"><a href="/entry/2019/05/15/ultra96-julia-set-explorer/#cb25-36" aria-hidden="true" tabindex="-1"></a>  <span class="kw">struct</span> v4l2_buffer buf<span class="op">;</span></span>
<span id="cb25-37"><a href="/entry/2019/05/15/ultra96-julia-set-explorer/#cb25-37" aria-hidden="true" tabindex="-1"></a>  buf<span class="op">.</span>type <span class="op">=</span> V4L2_BUF_TYPE_VIDEO_CAPTURE<span class="op">;</span></span>
<span id="cb25-38"><a href="/entry/2019/05/15/ultra96-julia-set-explorer/#cb25-38" aria-hidden="true" tabindex="-1"></a>  buf<span class="op">.</span>memory <span class="op">=</span> V4L2_MEMORY_MMAP<span class="op">;</span></span>
<span id="cb25-39"><a href="/entry/2019/05/15/ultra96-julia-set-explorer/#cb25-39" aria-hidden="true" tabindex="-1"></a>  ioctl<span class="op">(</span>fd<span class="op">,</span> VIDIOC_DQBUF<span class="op">,</span> <span class="op">&amp;</span>buf<span class="op">);</span></span>
<span id="cb25-40"><a href="/entry/2019/05/15/ultra96-julia-set-explorer/#cb25-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-41"><a href="/entry/2019/05/15/ultra96-julia-set-explorer/#cb25-41" aria-hidden="true" tabindex="-1"></a>  <span class="co">// 新しく取得した画像を GPU に転送</span></span>
<span id="cb25-42"><a href="/entry/2019/05/15/ultra96-julia-set-explorer/#cb25-42" aria-hidden="true" tabindex="-1"></a>  glBindTexture<span class="op">(</span>GL_TEXTURE_2D<span class="op">,</span> texture<span class="op">);</span></span>
<span id="cb25-43"><a href="/entry/2019/05/15/ultra96-julia-set-explorer/#cb25-43" aria-hidden="true" tabindex="-1"></a>  glTexSubImage2D<span class="op">(</span>GL_TEXTURE_2D<span class="op">,</span></span>
<span id="cb25-44"><a href="/entry/2019/05/15/ultra96-julia-set-explorer/#cb25-44" aria-hidden="true" tabindex="-1"></a>      <span class="dv">0</span><span class="op">,</span> GL_RGBA<span class="op">,</span> width<span class="op">,</span> height<span class="op">,</span> <span class="dv">0</span><span class="op">,</span> GL_RGBA<span class="op">,</span> GL_UNSIGNED_BYTE<span class="op">,</span> buffers<span class="op">[</span>buf<span class="op">.</span>index<span class="op">]);</span></span>
<span id="cb25-45"><a href="/entry/2019/05/15/ultra96-julia-set-explorer/#cb25-45" aria-hidden="true" tabindex="-1"></a>  glBindTexture<span class="op">(</span>GL_TEXTURE_2D<span class="op">,</span> <span class="dv">0</span><span class="op">);</span></span>
<span id="cb25-46"><a href="/entry/2019/05/15/ultra96-julia-set-explorer/#cb25-46" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-47"><a href="/entry/2019/05/15/ultra96-julia-set-explorer/#cb25-47" aria-hidden="true" tabindex="-1"></a>  <span class="co">// 表示</span></span>
<span id="cb25-48"><a href="/entry/2019/05/15/ultra96-julia-set-explorer/#cb25-48" aria-hidden="true" tabindex="-1"></a>  <span class="co">// ...</span></span>
<span id="cb25-49"><a href="/entry/2019/05/15/ultra96-julia-set-explorer/#cb25-49" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-50"><a href="/entry/2019/05/15/ultra96-julia-set-explorer/#cb25-50" aria-hidden="true" tabindex="-1"></a>  <span class="co">// バッファをストリーミングキューへのへ戻す</span></span>
<span id="cb25-51"><a href="/entry/2019/05/15/ultra96-julia-set-explorer/#cb25-51" aria-hidden="true" tabindex="-1"></a>  ioctl<span class="op">(</span>fd<span class="op">,</span> VIDIOC_QBUF<span class="op">,</span> <span class="op">&amp;</span>buf<span class="op">);</span></span>
<span id="cb25-52"><a href="/entry/2019/05/15/ultra96-julia-set-explorer/#cb25-52" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p><code>glTexSubImage2D</code> の部分で<strong>全然速度が出てくれません。</strong> ちょっと時間計測をしたときの記憶があいまいなので正確な値は書けないのですが、今回の 1920px x 1080px の RGBA な画像 (約 7.9MB) を転送するケースで 50ms ~ 90ms 程度のオーダの時間が掛かっていました。この原因としては、単純に画像のコピーがあまり軽い処理でないということに加え、V4L2 のバッファとして割り当てられた領域のメモリキャッシュが (おそらく) 無効化されていることによるものだと推測しています。</p>
<p><img src="/entry/2019/05/15/ultra96-julia-set-explorer/nodmabuf.svg" style="width:70.0%" /></p>
<p>この問題は、<a href="https://elinux.org/images/5/53/Zero-copy_video_streaming.pdf" target="_blank" rel="nofollow noopener">たまたま見つけたスライド</a>を参考に、<a href="https://www.kernel.org/doc/html/v4.14/driver-api/dma-buf.html" target="_blank" rel="nofollow noopener"><strong>dma-buf</strong></a> という Linux カーネルが持つの複数のデバイス間でバッファを共有する仕組みを利用することで解決しました。</p>
<p>dma-buf の動作を簡単な図にするとこんな感じです。まず、共有したいメモリ領域を持つデバイスからそのメモリ領域に関する情報へアクセスするためのファイルディスクリプタを export します。そのファイルディスクリプタを共有先のデバイスに import することで、共有先のデバイスから共有元のメモリ領域に直接アクセスすることが可能となる、というものだそうです。dma-buf 利用前と比較し、データのコピーは必要なくなり、またユーザ空間でやり取りするデータもファイルディスクリプタだけと非常に簡単なものになっています。</p>
<p><img src="/entry/2019/05/15/ultra96-julia-set-explorer/dmabuf.svg" style="width:70.0%" /></p>
<p>ということで、dma-buf を使った実装をしていきます。V4L2 のバッファを export するには <a href="https://www.kernel.org/doc/html/v4.14/media/uapi/v4l/vidioc-expbuf.html" target="_blank" rel="nofollow noopener"><code>ioctl VIDIOC_EXPBUF</code></a> を使います。</p>
<div class="sourceCode" id="cb26"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb26-1"><a href="/entry/2019/05/15/ultra96-julia-set-explorer/#cb26-1" aria-hidden="true" tabindex="-1"></a><span class="dt">int</span> fds<span class="op">[</span>MAX_BUFFERS<span class="op">];</span></span>
<span id="cb26-2"><a href="/entry/2019/05/15/ultra96-julia-set-explorer/#cb26-2" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> <span class="op">(</span><span class="dt">unsigned</span> <span class="dt">int</span> i <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> i <span class="op">&lt;</span> num_buffers<span class="op">;</span> <span class="op">++</span>i<span class="op">)</span> <span class="op">{</span></span>
<span id="cb26-3"><a href="/entry/2019/05/15/ultra96-julia-set-explorer/#cb26-3" aria-hidden="true" tabindex="-1"></a>  <span class="kw">struct</span> v4l2_exportbuffer exbuf<span class="op">;</span></span>
<span id="cb26-4"><a href="/entry/2019/05/15/ultra96-julia-set-explorer/#cb26-4" aria-hidden="true" tabindex="-1"></a>  exbuf<span class="op">.</span>index <span class="op">=</span> i<span class="op">;</span></span>
<span id="cb26-5"><a href="/entry/2019/05/15/ultra96-julia-set-explorer/#cb26-5" aria-hidden="true" tabindex="-1"></a>  exbuf<span class="op">.</span>type <span class="op">=</span> V4L2_BUF_TYPE_VIDEO_CAPTURE<span class="op">;</span></span>
<span id="cb26-6"><a href="/entry/2019/05/15/ultra96-julia-set-explorer/#cb26-6" aria-hidden="true" tabindex="-1"></a>  ioctl<span class="op">(</span>fd<span class="op">,</span> VIDIOC_EXPBUF<span class="op">,</span> <span class="op">&amp;</span>exbuf<span class="op">);</span></span>
<span id="cb26-7"><a href="/entry/2019/05/15/ultra96-julia-set-explorer/#cb26-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-8"><a href="/entry/2019/05/15/ultra96-julia-set-explorer/#cb26-8" aria-hidden="true" tabindex="-1"></a>  <span class="co">// exbuf.fd にファイルディスクリプタがセットされている</span></span>
<span id="cb26-9"><a href="/entry/2019/05/15/ultra96-julia-set-explorer/#cb26-9" aria-hidden="true" tabindex="-1"></a>  fds<span class="op">[</span>i<span class="op">]</span> <span class="op">=</span> exbuf<span class="op">.</span>fd<span class="op">;</span></span>
<span id="cb26-10"><a href="/entry/2019/05/15/ultra96-julia-set-explorer/#cb26-10" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>続いて OpenGL/EGL でこのファイルディスクリプタを import する部分です。まず必要となる関数を呼び出せるようにします。</p>
<div class="sourceCode" id="cb27"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb27-1"><a href="/entry/2019/05/15/ultra96-julia-set-explorer/#cb27-1" aria-hidden="true" tabindex="-1"></a><span class="dt">static</span> PFNEGLCREATEIMAGEKHRPROC eglCreateImageKHR<span class="op">;</span></span>
<span id="cb27-2"><a href="/entry/2019/05/15/ultra96-julia-set-explorer/#cb27-2" aria-hidden="true" tabindex="-1"></a><span class="dt">static</span> PFNEGLDESTROYIMAGEKHRPROC eglDestroyImageKHR<span class="op">;</span></span>
<span id="cb27-3"><a href="/entry/2019/05/15/ultra96-julia-set-explorer/#cb27-3" aria-hidden="true" tabindex="-1"></a><span class="dt">static</span> PFNGLEGLIMAGETARGETTEXTURE2DOESPROC glEGLImageTargetTexture2DOES<span class="op">;</span></span>
<span id="cb27-4"><a href="/entry/2019/05/15/ultra96-julia-set-explorer/#cb27-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-5"><a href="/entry/2019/05/15/ultra96-julia-set-explorer/#cb27-5" aria-hidden="true" tabindex="-1"></a>eglCreateImageKHR <span class="op">=</span></span>
<span id="cb27-6"><a href="/entry/2019/05/15/ultra96-julia-set-explorer/#cb27-6" aria-hidden="true" tabindex="-1"></a>    <span class="op">(</span>PFNEGLCREATEIMAGEKHRPROC<span class="op">)</span>eglGetProcAddress<span class="op">(</span><span class="st">&quot;eglCreateImageKHR&quot;</span><span class="op">);</span></span>
<span id="cb27-7"><a href="/entry/2019/05/15/ultra96-julia-set-explorer/#cb27-7" aria-hidden="true" tabindex="-1"></a>eglDestroyImageKHR <span class="op">=</span></span>
<span id="cb27-8"><a href="/entry/2019/05/15/ultra96-julia-set-explorer/#cb27-8" aria-hidden="true" tabindex="-1"></a>    <span class="op">(</span>PFNEGLDESTROYIMAGEKHRPROC<span class="op">)</span>eglGetProcAddress<span class="op">(</span><span class="st">&quot;eglDestroyImageKHR&quot;</span><span class="op">);</span></span>
<span id="cb27-9"><a href="/entry/2019/05/15/ultra96-julia-set-explorer/#cb27-9" aria-hidden="true" tabindex="-1"></a>glEGLImageTargetTexture2DOES <span class="op">=</span></span>
<span id="cb27-10"><a href="/entry/2019/05/15/ultra96-julia-set-explorer/#cb27-10" aria-hidden="true" tabindex="-1"></a>    <span class="op">(</span>PFNGLEGLIMAGETARGETTEXTURE2DOESPROC<span class="op">)</span>eglGetProcAddress<span class="op">(</span><span class="st">&quot;glEGLImageTargetTexture2DOES&quot;</span><span class="op">);</span></span></code></pre></div>
<p>これらの関数を使ってこんな実装をすれば準備は完了です。V4L2 の各バッファの画像が、対応する OpenGL のテクスチャに勝手に転送されるようになります。</p>
<div class="sourceCode" id="cb28"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb28-1"><a href="/entry/2019/05/15/ultra96-julia-set-explorer/#cb28-1" aria-hidden="true" tabindex="-1"></a>GLuint textures<span class="op">[</span>MAX_BUFFERS<span class="op">];</span></span>
<span id="cb28-2"><a href="/entry/2019/05/15/ultra96-julia-set-explorer/#cb28-2" aria-hidden="true" tabindex="-1"></a><span class="op">::</span>glGenTextures<span class="op">(</span>num_buffers<span class="op">,</span> textures<span class="op">);</span></span>
<span id="cb28-3"><a href="/entry/2019/05/15/ultra96-julia-set-explorer/#cb28-3" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> <span class="op">(</span><span class="dt">auto</span> i <span class="op">=</span> <span class="dv">0</span><span class="bu">u</span><span class="op">;</span> i <span class="op">&lt;</span> num_buffers<span class="op">;</span> <span class="op">++</span>i<span class="op">)</span> <span class="op">{</span></span>
<span id="cb28-4"><a href="/entry/2019/05/15/ultra96-julia-set-explorer/#cb28-4" aria-hidden="true" tabindex="-1"></a>  EGLint attrs<span class="op">[]</span> <span class="op">=</span> <span class="op">{</span></span>
<span id="cb28-5"><a href="/entry/2019/05/15/ultra96-julia-set-explorer/#cb28-5" aria-hidden="true" tabindex="-1"></a>    EGL_IMAGE_PRESERVED_KHR<span class="op">,</span>       EGL_TRUE<span class="op">,</span></span>
<span id="cb28-6"><a href="/entry/2019/05/15/ultra96-julia-set-explorer/#cb28-6" aria-hidden="true" tabindex="-1"></a>    EGL_WIDTH<span class="op">,</span>                     width<span class="op">,</span></span>
<span id="cb28-7"><a href="/entry/2019/05/15/ultra96-julia-set-explorer/#cb28-7" aria-hidden="true" tabindex="-1"></a>    EGL_HEIGHT<span class="op">,</span>                    height<span class="op">,</span></span>
<span id="cb28-8"><a href="/entry/2019/05/15/ultra96-julia-set-explorer/#cb28-8" aria-hidden="true" tabindex="-1"></a>    EGL_LINUX_DRM_FOURCC_EXT<span class="op">,</span>      DRM_FORMAT_ABGR8888<span class="op">,</span></span>
<span id="cb28-9"><a href="/entry/2019/05/15/ultra96-julia-set-explorer/#cb28-9" aria-hidden="true" tabindex="-1"></a>    EGL_DMA_BUF_PLANE0_FD_EXT<span class="op">,</span>     fds<span class="op">[</span>i<span class="op">],</span></span>
<span id="cb28-10"><a href="/entry/2019/05/15/ultra96-julia-set-explorer/#cb28-10" aria-hidden="true" tabindex="-1"></a>    EGL_DMA_BUF_PLANE0_OFFSET_EXT<span class="op">,</span> <span class="dv">0</span><span class="op">,</span></span>
<span id="cb28-11"><a href="/entry/2019/05/15/ultra96-julia-set-explorer/#cb28-11" aria-hidden="true" tabindex="-1"></a>    EGL_DMA_BUF_PLANE0_PITCH_EXT<span class="op">,</span>  width <span class="op">*</span> <span class="dv">4</span><span class="op">,</span></span>
<span id="cb28-12"><a href="/entry/2019/05/15/ultra96-julia-set-explorer/#cb28-12" aria-hidden="true" tabindex="-1"></a>    EGL_NONE</span>
<span id="cb28-13"><a href="/entry/2019/05/15/ultra96-julia-set-explorer/#cb28-13" aria-hidden="true" tabindex="-1"></a>  <span class="op">};</span></span>
<span id="cb28-14"><a href="/entry/2019/05/15/ultra96-julia-set-explorer/#cb28-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-15"><a href="/entry/2019/05/15/ultra96-julia-set-explorer/#cb28-15" aria-hidden="true" tabindex="-1"></a>  EGLImageKHR image <span class="op">=</span></span>
<span id="cb28-16"><a href="/entry/2019/05/15/ultra96-julia-set-explorer/#cb28-16" aria-hidden="true" tabindex="-1"></a>      eglCreateImageKHR<span class="op">(</span>egl_dpy<span class="op">,</span> EGL_NO_CONTEXT<span class="op">,</span> EGL_LINUX_DMA_BUF_EXT<span class="op">,</span> NULL<span class="op">,</span> attrs<span class="op">);</span></span>
<span id="cb28-17"><a href="/entry/2019/05/15/ultra96-julia-set-explorer/#cb28-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-18"><a href="/entry/2019/05/15/ultra96-julia-set-explorer/#cb28-18" aria-hidden="true" tabindex="-1"></a>  glBindTexture<span class="op">(</span>GL_TEXTURE_EXTERNAL_OES<span class="op">,</span> textures<span class="op">[</span>i<span class="op">]);</span></span>
<span id="cb28-19"><a href="/entry/2019/05/15/ultra96-julia-set-explorer/#cb28-19" aria-hidden="true" tabindex="-1"></a>  glEGLImageTargetTexture2DOES<span class="op">(</span>GL_TEXTURE_EXTERNAL_OES<span class="op">,</span> image<span class="op">);</span></span>
<span id="cb28-20"><a href="/entry/2019/05/15/ultra96-julia-set-explorer/#cb28-20" aria-hidden="true" tabindex="-1"></a>  glBindTexture<span class="op">(</span>GL_TEXTURE_EXTERNAL_OES<span class="op">,</span> <span class="dv">0</span><span class="op">);</span></span>
<span id="cb28-21"><a href="/entry/2019/05/15/ultra96-julia-set-explorer/#cb28-21" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h2 id="まとめ">まとめ</h2>
<p>Zynq UltraScale+ MPSoC の開発ボードである Ultra96 を用いて、FPGA、デバイスドライバ、デスクトップアプリケーションと、ハードウェアからソフトウェアまでを一通り実装して何かを作ってみた事例を紹介しました。なんか面白そうなデバイスがあるなーとか、最近の FPGA ってこんな開発方法があるのかーというのが伝わればいいなと思っています。</p>
<p>最後に、今回実装した Julia set explorer の元ネタというか、とても影響を受けている作品を紹介しようと思います。Chiaki Nakajima さんの <a href="http://www.chiaki.cc/Pyxis2010/index.htm" target="_blank" rel="nofollow noopener">Pyxis 2010</a> です。記事を見つけた当時 (6 ~ 7年前くらい？)、なんか FPGA っていうすごい素子があるんだなーというのと、なによりゲーム機を改造した作品ということでとても興味をひかれたのを覚えています。</p>
<h2 id="追記-20190830">追記 (2019/08/30)</h2>
<p>もう少し強くなりました: <a href="/entry/2019/08/29/ultra96-julia-set-explorer-2/">Ultra96 で Julia set をぐりぐり動かせるやつをもう少し強くした</a></p>
<section class="footnotes footnotes-end-of-document" role="doc-endnotes">
<hr />
<ol>
<li id="fn1" role="doc-endnote"><p>学生が一度にポンと出すにはちょっと大変な価格かな… ラボのボスに頼んでみよう ヾ(๑╹◡╹)ﾉ”<a href="/entry/2019/05/15/ultra96-julia-set-explorer/#fnref1" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn2" role="doc-endnote"><p>プロジェクト設定で <code>CFLAGS</code> に <code>-std=c++11</code> を設定する。ベースとなっているコンパイラもあまり新しいものではないようなので、<code>-std=c++17</code>、<code>-std=c++14</code>、<code>-std=c++1y</code> とかはもちろんダメだったし、C++11 の機能にも未対応なものがいくつかあったりする。C/RTL co-simulation が動作しなくなる副作用もある<a href="/entry/2019/05/15/ultra96-julia-set-explorer/#fnref2" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn3" role="doc-endnote"><p>ネタ性が高いだけで実際あんまり嬉しくない<a href="/entry/2019/05/15/ultra96-julia-set-explorer/#fnref3" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn4" role="doc-endnote"><p>リンク先のドキュメントは微妙に違っていて、たぶん write/tx → read/tx、read/rx → write/rx が正しい。<a href="/entry/2019/05/15/ultra96-julia-set-explorer/#fnref4" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn5" role="doc-endnote"><p>いきあたりばったりな実装をしていてアレなことになっているのでなんとかしたい…<a href="/entry/2019/05/15/ultra96-julia-set-explorer/#fnref5" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn6" role="doc-endnote"><p>現時点では未実装で、表示されているのは適当な値<a href="/entry/2019/05/15/ultra96-julia-set-explorer/#fnref6" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn7" role="doc-endnote"><p>Xilinx Wiki ってしょっちゅう403になってこまる…<a href="/entry/2019/05/15/ultra96-julia-set-explorer/#fnref7" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn8" role="doc-endnote"><p>Zynq UltraScale+ MPSoC の DisplayPort Controller 自体に映像の合成機能があるのでこれが使えないかなーと思ったのですが、Linux からやろうとするとちょっと難しそうだったのと、ベアメタル実装でいろいろ検証していたときに<a href="https://twitter.com/myon___/status/1080115506093338627" target="_blank" rel="nofollow noopener">検討していたパターンで上手く行かなかったりした</a>のでやめました<a href="/entry/2019/05/15/ultra96-julia-set-explorer/#fnref8" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn9" role="doc-endnote"><p>細かな処理を省いているのでこのコードはコピペではたぶん動きません<a href="/entry/2019/05/15/ultra96-julia-set-explorer/#fnref9" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn10" role="doc-endnote"><p>これも細かな処理を省いているのでこのコードはコピペではたぶん動きません<a href="/entry/2019/05/15/ultra96-julia-set-explorer/#fnref10" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
</ol>
</section></div><aside class="comments"><div id="disqus_thread"></div><script>(function() { var d = document, s = d.createElement('script');s.src = 'https://tosainu.disqus.com/embed.js';s.setAttribute('data-timestamp', +new Date());(d.head || d.body).appendChild(s); })();</script><noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" target="_blank" rel="nofollow noopener">comments powered by Disqus.</a></noscript></aside></div></article></main><footer class="site-footer"><div class="footer-widgets"><div class="container"><div class="col"><section class="about-me"><h4><svg class="svg-inline--fa fa-user fa-fw" focusable="false" aria-hidden="true" role="img" viewBox="0 0 448 512" data-icon="user" data-prefix="fas" xmlns="http://www.w3.org/2000/svg"><path d="M224 256c70.7 0 128-57.3 128-128S294.7 0 224 0S96 57.3 96 128s57.3 128 128 128zm-45.7 48C79.8 304 0 383.8 0 482.3C0 498.7 13.3 512 29.7 512H418.3c16.4 0 29.7-13.3 29.7-29.7C448 383.8 368.2 304 269.7 304H178.3z" fill="currentColor"></path></svg> About Me</h4><div class="about"><div class="avatar"><img src="/images/icon/cocoa.svg" class="icon" alt="avatar"></div><div class="info"><div class="name"><a href="https://myon.info" target="_blank" rel="nofollow noopener">Tosainu</a></div><div class="info">❤ Arch Linux, ごちうさ</div></div></div></section><section class="recent-posts"><h4><svg class="svg-inline--fa fa-file fa-fw" focusable="false" aria-hidden="true" role="img" viewBox="0 0 384 512" data-icon="file" data-prefix="fas" xmlns="http://www.w3.org/2000/svg"><path d="M0 64C0 28.7 28.7 0 64 0H224V128c0 17.7 14.3 32 32 32H384V448c0 35.3-28.7 64-64 64H64c-35.3 0-64-28.7-64-64V64zm384 64H256V0L384 128z" fill="currentColor"></path></svg> Recent Posts</h4><ul><li><a href="/entry/2022/09/19/earthly-zynqmp/">とにかく複雑な Zynq のソフトウェアを Earthly でビルドする</a></li><li><a href="/entry/2020/11/29/archlinux-arm-on-zu/">Ultra96 で Arch Linux ARM を動かす</a></li><li><a href="/entry/2020/09/01/thinkpad-x13/">ThinkPad X13 を買いました</a></li><li><a href="/entry/2020/07/05/bus-blaster/">Bus Blaster で Raspberry Pi Model B を JTAG デバッグしてみる</a></li><li><a href="/entry/2019/10/21/make-own-language-and-compiler/">Brainf**k からはじめる自作コンパイラ</a></li></ul></section></div><section class="tag-cloud"><h4><svg class="svg-inline--fa fa-tags fa-fw" focusable="false" aria-hidden="true" role="img" viewBox="0 0 512 512" data-icon="tags" data-prefix="fas" xmlns="http://www.w3.org/2000/svg"><path d="M345 39.1L472.8 168.4c52.4 53 52.4 138.2 0 191.2L360.8 472.9c-9.3 9.4-24.5 9.5-33.9 .2s-9.5-24.5-.2-33.9L438.6 325.9c33.9-34.3 33.9-89.4 0-123.7L310.9 72.9c-9.3-9.4-9.2-24.6 .2-33.9s24.6-9.2 33.9 .2zM0 229.5V80C0 53.5 21.5 32 48 32H197.5c17 0 33.3 6.7 45.3 18.7l168 168c25 25 25 65.5 0 90.5L277.3 442.7c-25 25-65.5 25-90.5 0l-168-168C6.7 262.7 0 246.5 0 229.5zM144 144c0-17.7-14.3-32-32-32s-32 14.3-32 32s14.3 32 32 32s32-14.3 32-32z" fill="currentColor"></path></svg> Tags</h4><ul class="tag-list"><li><a href="/entry/tags/android/"><span>Android</span></a></li><li><a href="/entry/tags/arch-linux/"><span>Arch Linux</span></a></li><li><a href="/entry/tags/arduino/"><span>Arduino</span></a></li><li><a href="/entry/tags/c/"><span>C++</span></a></li><li><a href="/entry/tags/ctf/"><span>CTF</span></a></li><li><a href="/entry/tags/diy-pc/"><span>DIY PC</span></a></li><li><a href="/entry/tags/docker/"><span>Docker</span></a></li><li><a href="/entry/tags/fpga/"><span>FPGA</span></a></li><li><a href="/entry/tags/game/"><span>Game</span></a></li><li><a href="/entry/tags/gochiusa/"><span>Gochiusa</span></a></li><li><a href="/entry/tags/hakyll/"><span>Hakyll</span></a></li><li><a href="/entry/tags/haskell/"><span>Haskell</span></a></li><li><a href="/entry/tags/linux/"><span>Linux</span></a></li><li><a href="/entry/tags/machine-learning/"><span>Machine learning</span></a></li><li><a href="/entry/tags/network/"><span>Network</span></a></li><li><a href="/entry/tags/raspberry-pi/"><span>Raspberry Pi</span></a></li><li><a href="/entry/tags/rust/"><span>Rust</span></a></li><li><a href="/entry/tags/slack/"><span>Slack</span></a></li><li><a href="/entry/tags/thinkpad-x13/"><span>ThinkPad X13</span></a></li><li><a href="/entry/tags/vaio-z2/"><span>VAIO Z2</span></a></li><li><a href="/entry/tags/vim/"><span>Vim</span></a></li><li><a href="/entry/tags/walkmanz/"><span>WalkmanZ</span></a></li><li><a href="/entry/tags/website/"><span>Website</span></a></li><li><a href="/entry/tags/xperia-nx/"><span>Xperia NX</span></a></li><li><a href="/entry/tags/xperia-arc/"><span>Xperia arc</span></a></li><li><a href="/entry/tags/xperia2011/"><span>Xperia2011</span></a></li><li><a href="/entry/tags/seccamp/"><span>seccamp</span></a></li></ul></section><section class="archives"><h4><svg class="svg-inline--fa fa-box-archive fa-fw" focusable="false" aria-hidden="true" role="img" viewBox="0 0 512 512" data-icon="box-archive" data-prefix="fas" xmlns="http://www.w3.org/2000/svg"><path d="M32 32H480c17.7 0 32 14.3 32 32V96c0 17.7-14.3 32-32 32H32C14.3 128 0 113.7 0 96V64C0 46.3 14.3 32 32 32zm0 128H480V416c0 35.3-28.7 64-64 64H96c-35.3 0-64-28.7-64-64V160zm128 80c0 8.8 7.2 16 16 16H336c8.8 0 16-7.2 16-16s-7.2-16-16-16H176c-8.8 0-16 7.2-16 16z" fill="currentColor"></path></svg> Archives</h4><ul class="archive-tree"><li><input class="tree-toggle" type="checkbox" id="tree-label-2022"><label class="tree-toggle-button" for="tree-label-2022"><svg class="svg-inline--fa fa-angle-right fa-fw" focusable="false" aria-hidden="true" role="img" viewBox="0 0 320 512" data-icon="angle-right" data-prefix="fas" xmlns="http://www.w3.org/2000/svg"><path d="M278.6 233.4c12.5 12.5 12.5 32.8 0 45.3l-160 160c-12.5 12.5-32.8 12.5-45.3 0s-12.5-32.8 0-45.3L210.7 256 73.4 118.6c-12.5-12.5-12.5-32.8 0-45.3s32.8-12.5 45.3 0l160 160z" fill="currentColor"></path></svg><svg class="svg-inline--fa fa-angle-down fa-fw" focusable="false" aria-hidden="true" role="img" viewBox="0 0 448 512" data-icon="angle-down" data-prefix="fas" xmlns="http://www.w3.org/2000/svg"><path d="M201.4 374.6c12.5 12.5 32.8 12.5 45.3 0l160-160c12.5-12.5 12.5-32.8 0-45.3s-32.8-12.5-45.3 0L224 306.7 86.6 169.4c-12.5-12.5-32.8-12.5-45.3 0s-12.5 32.8 0 45.3l160 160z" fill="currentColor"></path></svg><a href="/entry/2022/">2022 (1)</a></label><ul class="tree-child"><li><a href="/entry/2022/09/">2022/09 (1)</a></li></ul></li><li><input class="tree-toggle" type="checkbox" id="tree-label-2020"><label class="tree-toggle-button" for="tree-label-2020"><svg class="svg-inline--fa fa-angle-right fa-fw" focusable="false" aria-hidden="true" role="img" viewBox="0 0 320 512" data-icon="angle-right" data-prefix="fas" xmlns="http://www.w3.org/2000/svg"><path d="M278.6 233.4c12.5 12.5 12.5 32.8 0 45.3l-160 160c-12.5 12.5-32.8 12.5-45.3 0s-12.5-32.8 0-45.3L210.7 256 73.4 118.6c-12.5-12.5-12.5-32.8 0-45.3s32.8-12.5 45.3 0l160 160z" fill="currentColor"></path></svg><svg class="svg-inline--fa fa-angle-down fa-fw" focusable="false" aria-hidden="true" role="img" viewBox="0 0 448 512" data-icon="angle-down" data-prefix="fas" xmlns="http://www.w3.org/2000/svg"><path d="M201.4 374.6c12.5 12.5 32.8 12.5 45.3 0l160-160c12.5-12.5 12.5-32.8 0-45.3s-32.8-12.5-45.3 0L224 306.7 86.6 169.4c-12.5-12.5-32.8-12.5-45.3 0s-12.5 32.8 0 45.3l160 160z" fill="currentColor"></path></svg><a href="/entry/2020/">2020 (3)</a></label><ul class="tree-child"><li><a href="/entry/2020/11/">2020/11 (1)</a></li><li><a href="/entry/2020/09/">2020/09 (1)</a></li><li><a href="/entry/2020/07/">2020/07 (1)</a></li></ul></li><li><input class="tree-toggle" type="checkbox" id="tree-label-2019" checked><label class="tree-toggle-button" for="tree-label-2019"><svg class="svg-inline--fa fa-angle-right fa-fw" focusable="false" aria-hidden="true" role="img" viewBox="0 0 320 512" data-icon="angle-right" data-prefix="fas" xmlns="http://www.w3.org/2000/svg"><path d="M278.6 233.4c12.5 12.5 12.5 32.8 0 45.3l-160 160c-12.5 12.5-32.8 12.5-45.3 0s-12.5-32.8 0-45.3L210.7 256 73.4 118.6c-12.5-12.5-12.5-32.8 0-45.3s32.8-12.5 45.3 0l160 160z" fill="currentColor"></path></svg><svg class="svg-inline--fa fa-angle-down fa-fw" focusable="false" aria-hidden="true" role="img" viewBox="0 0 448 512" data-icon="angle-down" data-prefix="fas" xmlns="http://www.w3.org/2000/svg"><path d="M201.4 374.6c12.5 12.5 32.8 12.5 45.3 0l160-160c12.5-12.5 12.5-32.8 0-45.3s-32.8-12.5-45.3 0L224 306.7 86.6 169.4c-12.5-12.5-32.8-12.5-45.3 0s-12.5 32.8 0 45.3l160 160z" fill="currentColor"></path></svg><a href="/entry/2019/">2019 (4)</a></label><ul class="tree-child"><li><a href="/entry/2019/10/">2019/10 (1)</a></li><li><a href="/entry/2019/08/">2019/08 (2)</a></li><li><a href="/entry/2019/05/">2019/05 (1)</a></li></ul></li><li><input class="tree-toggle" type="checkbox" id="tree-label-2018"><label class="tree-toggle-button" for="tree-label-2018"><svg class="svg-inline--fa fa-angle-right fa-fw" focusable="false" aria-hidden="true" role="img" viewBox="0 0 320 512" data-icon="angle-right" data-prefix="fas" xmlns="http://www.w3.org/2000/svg"><path d="M278.6 233.4c12.5 12.5 12.5 32.8 0 45.3l-160 160c-12.5 12.5-32.8 12.5-45.3 0s-12.5-32.8 0-45.3L210.7 256 73.4 118.6c-12.5-12.5-12.5-32.8 0-45.3s32.8-12.5 45.3 0l160 160z" fill="currentColor"></path></svg><svg class="svg-inline--fa fa-angle-down fa-fw" focusable="false" aria-hidden="true" role="img" viewBox="0 0 448 512" data-icon="angle-down" data-prefix="fas" xmlns="http://www.w3.org/2000/svg"><path d="M201.4 374.6c12.5 12.5 32.8 12.5 45.3 0l160-160c12.5-12.5 12.5-32.8 0-45.3s-32.8-12.5-45.3 0L224 306.7 86.6 169.4c-12.5-12.5-32.8-12.5-45.3 0s-12.5 32.8 0 45.3l160 160z" fill="currentColor"></path></svg><a href="/entry/2018/">2018 (5)</a></label><ul class="tree-child"><li><a href="/entry/2018/10/">2018/10 (1)</a></li><li><a href="/entry/2018/09/">2018/09 (1)</a></li><li><a href="/entry/2018/08/">2018/08 (1)</a></li><li><a href="/entry/2018/03/">2018/03 (1)</a></li><li><a href="/entry/2018/01/">2018/01 (1)</a></li></ul></li><li><input class="tree-toggle" type="checkbox" id="tree-label-2017"><label class="tree-toggle-button" for="tree-label-2017"><svg class="svg-inline--fa fa-angle-right fa-fw" focusable="false" aria-hidden="true" role="img" viewBox="0 0 320 512" data-icon="angle-right" data-prefix="fas" xmlns="http://www.w3.org/2000/svg"><path d="M278.6 233.4c12.5 12.5 12.5 32.8 0 45.3l-160 160c-12.5 12.5-32.8 12.5-45.3 0s-12.5-32.8 0-45.3L210.7 256 73.4 118.6c-12.5-12.5-12.5-32.8 0-45.3s32.8-12.5 45.3 0l160 160z" fill="currentColor"></path></svg><svg class="svg-inline--fa fa-angle-down fa-fw" focusable="false" aria-hidden="true" role="img" viewBox="0 0 448 512" data-icon="angle-down" data-prefix="fas" xmlns="http://www.w3.org/2000/svg"><path d="M201.4 374.6c12.5 12.5 32.8 12.5 45.3 0l160-160c12.5-12.5 12.5-32.8 0-45.3s-32.8-12.5-45.3 0L224 306.7 86.6 169.4c-12.5-12.5-32.8-12.5-45.3 0s-12.5 32.8 0 45.3l160 160z" fill="currentColor"></path></svg><a href="/entry/2017/">2017 (5)</a></label><ul class="tree-child"><li><a href="/entry/2017/09/">2017/09 (1)</a></li><li><a href="/entry/2017/05/">2017/05 (1)</a></li><li><a href="/entry/2017/02/">2017/02 (3)</a></li></ul></li><li><input class="tree-toggle" type="checkbox" id="tree-label-2016"><label class="tree-toggle-button" for="tree-label-2016"><svg class="svg-inline--fa fa-angle-right fa-fw" focusable="false" aria-hidden="true" role="img" viewBox="0 0 320 512" data-icon="angle-right" data-prefix="fas" xmlns="http://www.w3.org/2000/svg"><path d="M278.6 233.4c12.5 12.5 12.5 32.8 0 45.3l-160 160c-12.5 12.5-32.8 12.5-45.3 0s-12.5-32.8 0-45.3L210.7 256 73.4 118.6c-12.5-12.5-12.5-32.8 0-45.3s32.8-12.5 45.3 0l160 160z" fill="currentColor"></path></svg><svg class="svg-inline--fa fa-angle-down fa-fw" focusable="false" aria-hidden="true" role="img" viewBox="0 0 448 512" data-icon="angle-down" data-prefix="fas" xmlns="http://www.w3.org/2000/svg"><path d="M201.4 374.6c12.5 12.5 32.8 12.5 45.3 0l160-160c12.5-12.5 12.5-32.8 0-45.3s-32.8-12.5-45.3 0L224 306.7 86.6 169.4c-12.5-12.5-32.8-12.5-45.3 0s-12.5 32.8 0 45.3l160 160z" fill="currentColor"></path></svg><a href="/entry/2016/">2016 (8)</a></label><ul class="tree-child"><li><a href="/entry/2016/08/">2016/08 (2)</a></li><li><a href="/entry/2016/07/">2016/07 (1)</a></li><li><a href="/entry/2016/06/">2016/06 (1)</a></li><li><a href="/entry/2016/05/">2016/05 (1)</a></li><li><a href="/entry/2016/03/">2016/03 (1)</a></li><li><a href="/entry/2016/01/">2016/01 (2)</a></li></ul></li><li><input class="tree-toggle" type="checkbox" id="tree-label-2015"><label class="tree-toggle-button" for="tree-label-2015"><svg class="svg-inline--fa fa-angle-right fa-fw" focusable="false" aria-hidden="true" role="img" viewBox="0 0 320 512" data-icon="angle-right" data-prefix="fas" xmlns="http://www.w3.org/2000/svg"><path d="M278.6 233.4c12.5 12.5 12.5 32.8 0 45.3l-160 160c-12.5 12.5-32.8 12.5-45.3 0s-12.5-32.8 0-45.3L210.7 256 73.4 118.6c-12.5-12.5-12.5-32.8 0-45.3s32.8-12.5 45.3 0l160 160z" fill="currentColor"></path></svg><svg class="svg-inline--fa fa-angle-down fa-fw" focusable="false" aria-hidden="true" role="img" viewBox="0 0 448 512" data-icon="angle-down" data-prefix="fas" xmlns="http://www.w3.org/2000/svg"><path d="M201.4 374.6c12.5 12.5 32.8 12.5 45.3 0l160-160c12.5-12.5 12.5-32.8 0-45.3s-32.8-12.5-45.3 0L224 306.7 86.6 169.4c-12.5-12.5-32.8-12.5-45.3 0s-12.5 32.8 0 45.3l160 160z" fill="currentColor"></path></svg><a href="/entry/2015/">2015 (12)</a></label><ul class="tree-child"><li><a href="/entry/2015/12/">2015/12 (1)</a></li><li><a href="/entry/2015/08/">2015/08 (1)</a></li><li><a href="/entry/2015/06/">2015/06 (2)</a></li><li><a href="/entry/2015/05/">2015/05 (2)</a></li><li><a href="/entry/2015/04/">2015/04 (1)</a></li><li><a href="/entry/2015/03/">2015/03 (2)</a></li><li><a href="/entry/2015/02/">2015/02 (1)</a></li><li><a href="/entry/2015/01/">2015/01 (2)</a></li></ul></li><li><input class="tree-toggle" type="checkbox" id="tree-label-2014"><label class="tree-toggle-button" for="tree-label-2014"><svg class="svg-inline--fa fa-angle-right fa-fw" focusable="false" aria-hidden="true" role="img" viewBox="0 0 320 512" data-icon="angle-right" data-prefix="fas" xmlns="http://www.w3.org/2000/svg"><path d="M278.6 233.4c12.5 12.5 12.5 32.8 0 45.3l-160 160c-12.5 12.5-32.8 12.5-45.3 0s-12.5-32.8 0-45.3L210.7 256 73.4 118.6c-12.5-12.5-12.5-32.8 0-45.3s32.8-12.5 45.3 0l160 160z" fill="currentColor"></path></svg><svg class="svg-inline--fa fa-angle-down fa-fw" focusable="false" aria-hidden="true" role="img" viewBox="0 0 448 512" data-icon="angle-down" data-prefix="fas" xmlns="http://www.w3.org/2000/svg"><path d="M201.4 374.6c12.5 12.5 32.8 12.5 45.3 0l160-160c12.5-12.5 12.5-32.8 0-45.3s-32.8-12.5-45.3 0L224 306.7 86.6 169.4c-12.5-12.5-32.8-12.5-45.3 0s-12.5 32.8 0 45.3l160 160z" fill="currentColor"></path></svg><a href="/entry/2014/">2014 (62)</a></label><ul class="tree-child"><li><a href="/entry/2014/12/">2014/12 (7)</a></li><li><a href="/entry/2014/11/">2014/11 (4)</a></li><li><a href="/entry/2014/10/">2014/10 (3)</a></li><li><a href="/entry/2014/09/">2014/09 (3)</a></li><li><a href="/entry/2014/08/">2014/08 (5)</a></li><li><a href="/entry/2014/07/">2014/07 (6)</a></li><li><a href="/entry/2014/06/">2014/06 (6)</a></li><li><a href="/entry/2014/05/">2014/05 (4)</a></li><li><a href="/entry/2014/04/">2014/04 (6)</a></li><li><a href="/entry/2014/03/">2014/03 (7)</a></li><li><a href="/entry/2014/02/">2014/02 (5)</a></li><li><a href="/entry/2014/01/">2014/01 (6)</a></li></ul></li><li><input class="tree-toggle" type="checkbox" id="tree-label-2013"><label class="tree-toggle-button" for="tree-label-2013"><svg class="svg-inline--fa fa-angle-right fa-fw" focusable="false" aria-hidden="true" role="img" viewBox="0 0 320 512" data-icon="angle-right" data-prefix="fas" xmlns="http://www.w3.org/2000/svg"><path d="M278.6 233.4c12.5 12.5 12.5 32.8 0 45.3l-160 160c-12.5 12.5-32.8 12.5-45.3 0s-12.5-32.8 0-45.3L210.7 256 73.4 118.6c-12.5-12.5-12.5-32.8 0-45.3s32.8-12.5 45.3 0l160 160z" fill="currentColor"></path></svg><svg class="svg-inline--fa fa-angle-down fa-fw" focusable="false" aria-hidden="true" role="img" viewBox="0 0 448 512" data-icon="angle-down" data-prefix="fas" xmlns="http://www.w3.org/2000/svg"><path d="M201.4 374.6c12.5 12.5 32.8 12.5 45.3 0l160-160c12.5-12.5 12.5-32.8 0-45.3s-32.8-12.5-45.3 0L224 306.7 86.6 169.4c-12.5-12.5-32.8-12.5-45.3 0s-12.5 32.8 0 45.3l160 160z" fill="currentColor"></path></svg><a href="/entry/2013/">2013 (116)</a></label><ul class="tree-child"><li><a href="/entry/2013/12/">2013/12 (8)</a></li><li><a href="/entry/2013/11/">2013/11 (6)</a></li><li><a href="/entry/2013/10/">2013/10 (5)</a></li><li><a href="/entry/2013/09/">2013/09 (5)</a></li><li><a href="/entry/2013/08/">2013/08 (4)</a></li><li><a href="/entry/2013/07/">2013/07 (3)</a></li><li><a href="/entry/2013/06/">2013/06 (12)</a></li><li><a href="/entry/2013/05/">2013/05 (16)</a></li><li><a href="/entry/2013/04/">2013/04 (16)</a></li><li><a href="/entry/2013/03/">2013/03 (27)</a></li><li><a href="/entry/2013/02/">2013/02 (7)</a></li><li><a href="/entry/2013/01/">2013/01 (7)</a></li></ul></li><li><input class="tree-toggle" type="checkbox" id="tree-label-2012"><label class="tree-toggle-button" for="tree-label-2012"><svg class="svg-inline--fa fa-angle-right fa-fw" focusable="false" aria-hidden="true" role="img" viewBox="0 0 320 512" data-icon="angle-right" data-prefix="fas" xmlns="http://www.w3.org/2000/svg"><path d="M278.6 233.4c12.5 12.5 12.5 32.8 0 45.3l-160 160c-12.5 12.5-32.8 12.5-45.3 0s-12.5-32.8 0-45.3L210.7 256 73.4 118.6c-12.5-12.5-12.5-32.8 0-45.3s32.8-12.5 45.3 0l160 160z" fill="currentColor"></path></svg><svg class="svg-inline--fa fa-angle-down fa-fw" focusable="false" aria-hidden="true" role="img" viewBox="0 0 448 512" data-icon="angle-down" data-prefix="fas" xmlns="http://www.w3.org/2000/svg"><path d="M201.4 374.6c12.5 12.5 32.8 12.5 45.3 0l160-160c12.5-12.5 12.5-32.8 0-45.3s-32.8-12.5-45.3 0L224 306.7 86.6 169.4c-12.5-12.5-32.8-12.5-45.3 0s-12.5 32.8 0 45.3l160 160z" fill="currentColor"></path></svg><a href="/entry/2012/">2012 (11)</a></label><ul class="tree-child"><li><a href="/entry/2012/12/">2012/12 (3)</a></li><li><a href="/entry/2012/09/">2012/09 (1)</a></li><li><a href="/entry/2012/07/">2012/07 (4)</a></li><li><a href="/entry/2012/04/">2012/04 (1)</a></li><li><a href="/entry/2012/03/">2012/03 (1)</a></li><li><a href="/entry/2012/01/">2012/01 (1)</a></li></ul></li><li><input class="tree-toggle" type="checkbox" id="tree-label-2011"><label class="tree-toggle-button" for="tree-label-2011"><svg class="svg-inline--fa fa-angle-right fa-fw" focusable="false" aria-hidden="true" role="img" viewBox="0 0 320 512" data-icon="angle-right" data-prefix="fas" xmlns="http://www.w3.org/2000/svg"><path d="M278.6 233.4c12.5 12.5 12.5 32.8 0 45.3l-160 160c-12.5 12.5-32.8 12.5-45.3 0s-12.5-32.8 0-45.3L210.7 256 73.4 118.6c-12.5-12.5-12.5-32.8 0-45.3s32.8-12.5 45.3 0l160 160z" fill="currentColor"></path></svg><svg class="svg-inline--fa fa-angle-down fa-fw" focusable="false" aria-hidden="true" role="img" viewBox="0 0 448 512" data-icon="angle-down" data-prefix="fas" xmlns="http://www.w3.org/2000/svg"><path d="M201.4 374.6c12.5 12.5 32.8 12.5 45.3 0l160-160c12.5-12.5 12.5-32.8 0-45.3s-32.8-12.5-45.3 0L224 306.7 86.6 169.4c-12.5-12.5-32.8-12.5-45.3 0s-12.5 32.8 0 45.3l160 160z" fill="currentColor"></path></svg><a href="/entry/2011/">2011 (12)</a></label><ul class="tree-child"><li><a href="/entry/2011/09/">2011/09 (1)</a></li><li><a href="/entry/2011/06/">2011/06 (1)</a></li><li><a href="/entry/2011/05/">2011/05 (1)</a></li><li><a href="/entry/2011/03/">2011/03 (6)</a></li><li><a href="/entry/2011/02/">2011/02 (1)</a></li><li><a href="/entry/2011/01/">2011/01 (2)</a></li></ul></li></ul></section></div></div><div class="footer-bottom"><div class="container"><div class="copyright">© 2011-2022 Tosainu. Site generated by <a href="https://jaspervdj.be/hakyll/" target="_blank" rel="nofollow noopener">Hakyll</a>.</div></div></div></footer></body></html>
