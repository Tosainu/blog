<!DOCTYPE HTML><html lang="ja"><head><meta charset="utf-8"><meta content="Tosainu" name="author"><meta content="コンパイラやインタプリタは、プログラミングをするときほぼ必ず使うことになる重要なソフトウェアです。その原理ついては大学の講義で学んだことのある人も多いのではないでしょうか。とはいえ、原理を学んだところでそれがシュッと実装できるかはコンパイラに限らずそうではない場合が多いと思います。僕もその1人でした" name="description"><meta content="Hakyll" name="generator"><meta content="width=device-width, initial-scale=1" name="viewport"><meta property="twitter:card" content="summary"><meta property="twitter:site" content="myon___"><meta property="twitter:creator" content="myon___"><meta property="og:type" content="article"><meta property="og:url" content="https://blog.myon.info/entry/2019/10/21/make-own-language-and-compiler/index.html"><meta property="og:title" content="Brainf**k からはじめる自作コンパイラ | Tosainu Lab"><meta property="og:description" content="コンパイラやインタプリタは、プログラミングをするときほぼ必ず使うことになる重要なソフトウェアです。その原理ついては大学の講義で学んだことのある人も多いのではないでしょうか。とはいえ、原理を学んだところでそれがシュッと実装できるかはコンパイラに限らずそうではない場合が多いと思います。僕もその1人でした"><meta property="og:site_name" content="Tosainu Lab"><meta property="og:image" content="https://blog.myon.info/images/icon/cocoa-512.jpg"><title>Brainf**k からはじめる自作コンパイラ | Tosainu Lab</title><link href="/vendor/normalize.css/normalize.css" rel="stylesheet"><link href="/stylesheets/style.css" rel="stylesheet"><link href="/stylesheets/highlight.css" rel="stylesheet"><link href="/vendor/fontawesome/style.css" rel="stylesheet"><link href="/vendor/katex/katex.min.css" rel="stylesheet"><link href="/feed.xml" title="Atom Feed" type="application/atom+xml" rel="alternate"><script async src="https://www.googletagmanager.com/gtag/js?id=G-X1CGBSMEQW"></script><script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments);}gtag('js',new Date());gtag('config','G-X1CGBSMEQW');</script></head><body><header class="site-header"><div class="container"><h1><a href="/" title="home">Tosainu Lab</a></h1></div></header><main class="post"><article><header class="post-header"><div class="container"><h1><a href="/entry/2019/10/21/make-own-language-and-compiler/">Brainf**k からはじめる自作コンパイラ</a></h1><ul class="post-meta"><li><svg class="svg-inline--fa fa-calendar" focusable="false" aria-hidden="true" role="img" viewBox="0 0 448 512" data-icon="calendar" data-prefix="fas" xmlns="http://www.w3.org/2000/svg"><path d="M96 32V64H48C21.5 64 0 85.5 0 112v48H448V112c0-26.5-21.5-48-48-48H352V32c0-17.7-14.3-32-32-32s-32 14.3-32 32V64H160V32c0-17.7-14.3-32-32-32S96 14.3 96 32zM448 192H0V464c0 26.5 21.5 48 48 48H400c26.5 0 48-21.5 48-48V192z" fill="currentColor"></path></svg></li><li class="date">2019/10/21 23:54</li><li><svg class="svg-inline--fa fa-tags" focusable="false" aria-hidden="true" role="img" viewBox="0 0 512 512" data-icon="tags" data-prefix="fas" xmlns="http://www.w3.org/2000/svg"><path d="M345 39.1L472.8 168.4c52.4 53 52.4 138.2 0 191.2L360.8 472.9c-9.3 9.4-24.5 9.5-33.9 .2s-9.5-24.5-.2-33.9L438.6 325.9c33.9-34.3 33.9-89.4 0-123.7L310.9 72.9c-9.3-9.4-9.2-24.6 .2-33.9s24.6-9.2 33.9 .2zM0 229.5V80C0 53.5 21.5 32 48 32H197.5c17 0 33.3 6.7 45.3 18.7l168 168c25 25 25 65.5 0 90.5L277.3 442.7c-25 25-65.5 25-90.5 0l-168-168C6.7 262.7 0 246.5 0 229.5zM144 144c0-17.7-14.3-32-32-32s-32 14.3-32 32s14.3 32 32 32s32-14.3 32-32z" fill="currentColor"></path></svg></li><li><ul class="tag-list"><li><a href="/entry/tags/rust/"><span>Rust</span></a></li></ul></li></ul></div></header><div class="container"><div class="post-contents"><p>コンパイラやインタプリタは、プログラミングをするときほぼ必ず使うことになる重要なソフトウェアです。その原理ついては大学の講義で学んだことのある人も多いのではないでしょうか。</p>
<p>とはいえ、原理を学んだところでそれがシュッと実装できるかはコンパイラに限らずそうではない場合が多いと思います。僕もその1人でした。コンパイラの講義や Haskell でパーサコンビネータを実装した流れからコンパイラの実装に興味を持ったものの、どの程度の機能をどう実装するかに悩んでなかなか進まず、結局ほかにもやりたいことがあるからと有耶無耶になってしまった経験があったりします。</p>
<p>最近ふと「そういえば <a href="https://en.wikipedia.org/wiki/Brainfuck" target="_blank" rel="nofollow noopener">Brainf**k</a> の処理系って書いたことなかったな」と思い、以前読んで気になっていた <a href="https://itchyny.hatenablog.com/entry/2017/02/27/100000" target="_blank" rel="nofollow noopener">itchyny さんのブログ記事</a>を参考にしながら Brainf**k を LLVM IR にするコンパイラのようなものを実装してみたことがありました。</p>
<blockquote class="twitter-tweet tw-align-center">
<p lang="ja" dir="ltr">
Brainf**k の処理系って未だに書いたことないなーってことで、インタプリタと LLVM IR を出力するコンパイラみたいなの書いてた <a href="https://t.co/FlSdpxU3yX" target="_blank" rel="nofollow noopener">https://t.co/FlSdpxU3yX</a>
</p>
— +。:.ﾟ٩(๑＞◡＜๑)۶:.｡+ﾟ (@myon___) <a href="https://twitter.com/myon___/status/1167413225211625472?ref_src=twsrc%5Etfw" target="_blank" rel="nofollow noopener">August 30, 2019</a>
</blockquote>
<script async src="https://platform.twitter.com/widgets.js" charset="utf-8"></script>
<p>これが数時間もしないうちに実装できてしまったことにまず驚きます。そして Brainf**k コンパイラの実装を眺めていると、コンパイラを構成する要素でいうところのコード生成に相当するものではないかということに気づき更に衝撃を受けます。ただ Brainf**k の処理系を書いていたつもりが、いつの間にかコンパイラの一部を、しかも比較的短時間で実装していたのです。</p>
<p>僕はプログラミングを完全に理解しているわけではないので、何かしらの処理をプログラムするときに、まずどのような感じになるかをイメージしやすくするための最小限の実装から始めることがよくあります<a href="/entry/2019/10/21/make-own-language-and-compiler/#fn1" class="footnote-ref" id="fnref1" role="doc-noteref"><sup>1</sup></a>。コンパイラもそうすればよかったのです。小さなプログラミング言語？ Brainf**k だ！Brainf**k レベルに機能を制限しつつも見慣れた構文を持つプログラミング言語 (<a href="https://github.com/masarakki/nyaruko_lang" target="_blank" rel="nofollow noopener">これ</a> みたいな Brainf**k の命令を別の文字列に置換しただけの言語ではない) を設計し、それを認識する字句解析や構文解析などを実装していけば、とりあえずコンパイラを構成する要素を一通り実装できるのではないか。そんなモチベーションで始めた自作コンパイラ <a href="https://github.com/Tosainu/chiya" target="_blank" rel="nofollow noopener">chiya</a> をどのように実装したかの紹介をしていきます。</p>
<!--more-->
<h2 id="準備">準備</h2>
<p>chiya は <a href="https://www.rust-lang.org/" target="_blank" rel="nofollow noopener">Rust</a> で実装しました。記事執筆時点でのツールチェインのバージョンは次のとおりです。</p>
<pre><code>$ rustup --version
rustup 1.20.2 (2019-10-16)

$ rustup show active-toolchain
stable-x86_64-unknown-linux-gnu (default)

$ rustc --version
rustc 1.38.0 (625451e37 2019-09-23)

$ clang --version
clang version 9.0.0 (tags/RELEASE_900/final)
Target: x86_64-pc-linux-gnu
Thread model: posix
InstalledDir: /usr/bin</code></pre>
<p>プロジェクト<a href="/entry/2019/10/21/make-own-language-and-compiler/#fn2" class="footnote-ref" id="fnref2" role="doc-noteref"><sup>2</sup></a>は以下のように作成し、ライブラリと実行ファイルを含むようにしてみました。</p>
<pre><code>$ cargo new --lib chiya

$ mkdir -p src/bin
$ cat &gt; src/bin/chiya.rs &lt;&lt;EOS
fn main() {
    println!(&quot;Hello, World!&quot;);
}
EOS

$ cargo run
   Compiling chiya v0.1.0 (/path/to/work/dir/chiya)
    Finished dev [unoptimized + debuginfo] target(s) in 1.45s
     Running `target/debug/chiya`
Hello, World!</code></pre>
<h2 id="brainfk-レベルのコード生成を実装する">Brainf**k レベルのコード生成を実装する</h2>
<p>まずは本記事のきっかけともいえる、 Brainf**k の各命令に対応する LLVM assembly language (LLVM IR<a href="/entry/2019/10/21/make-own-language-and-compiler/#fn3" class="footnote-ref" id="fnref3" role="doc-noteref"><sup>3</sup></a>) を生成する処理から実装します。最初にこんな感じの <code>trait</code> を <a href="https://github.com/Tosainu/chiya/blob/c8a26f5cebf89fa41edde83e23873a4837a55d3f/src/codegen/emitter.rs" target="_blank" rel="nofollow noopener"><code>src/codegen/emitter.rs</code></a> に実装しました。</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode rust"><code class="sourceCode rust"><span id="cb3-1"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="kw">pub</span> <span class="kw">trait</span> Emitter <span class="op">{</span></span>
<span id="cb3-2"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb3-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">// ptr を offset 進める</span></span>
<span id="cb3-3"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb3-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">fn</span> emit_move_ptr(<span class="op">&amp;</span><span class="kw">mut</span> <span class="kw">self</span><span class="op">,</span> offset<span class="op">:</span> <span class="dt">i32</span>) <span class="op">-&gt;</span> <span class="dt">String</span><span class="op">;</span></span>
<span id="cb3-4"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb3-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-5"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb3-5" aria-hidden="true" tabindex="-1"></a>    <span class="co">// *ptr に n 加算する</span></span>
<span id="cb3-6"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb3-6" aria-hidden="true" tabindex="-1"></a>    <span class="kw">fn</span> emit_add(<span class="op">&amp;</span><span class="kw">mut</span> <span class="kw">self</span><span class="op">,</span> n<span class="op">:</span> <span class="dt">i32</span>) <span class="op">-&gt;</span> <span class="dt">String</span><span class="op">;</span></span>
<span id="cb3-7"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb3-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-8"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb3-8" aria-hidden="true" tabindex="-1"></a>    <span class="co">// putchar() を呼ぶ</span></span>
<span id="cb3-9"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb3-9" aria-hidden="true" tabindex="-1"></a>    <span class="kw">fn</span> emit_call_putchar(<span class="op">&amp;</span><span class="kw">mut</span> <span class="kw">self</span>) <span class="op">-&gt;</span> <span class="dt">String</span><span class="op">;</span></span>
<span id="cb3-10"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb3-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-11"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb3-11" aria-hidden="true" tabindex="-1"></a>    <span class="co">// getchar() を呼ぶ</span></span>
<span id="cb3-12"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb3-12" aria-hidden="true" tabindex="-1"></a>    <span class="kw">fn</span> emit_call_getchar(<span class="op">&amp;</span><span class="kw">mut</span> <span class="kw">self</span>) <span class="op">-&gt;</span> <span class="dt">String</span><span class="op">;</span></span>
<span id="cb3-13"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb3-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-14"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb3-14" aria-hidden="true" tabindex="-1"></a>    <span class="co">// ループのはじまり</span></span>
<span id="cb3-15"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb3-15" aria-hidden="true" tabindex="-1"></a>    <span class="kw">fn</span> emit_loop_begin(<span class="op">&amp;</span><span class="kw">mut</span> <span class="kw">self</span>) <span class="op">-&gt;</span> <span class="dt">String</span><span class="op">;</span></span>
<span id="cb3-16"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb3-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-17"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb3-17" aria-hidden="true" tabindex="-1"></a>    <span class="co">// ループのおわり</span></span>
<span id="cb3-18"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb3-18" aria-hidden="true" tabindex="-1"></a>    <span class="kw">fn</span> emit_loop_end(<span class="op">&amp;</span><span class="kw">mut</span> <span class="kw">self</span>) <span class="op">-&gt;</span> <span class="dt">String</span><span class="op">;</span></span>
<span id="cb3-19"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb3-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-20"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb3-20" aria-hidden="true" tabindex="-1"></a>    <span class="co">// 生成するコードのヘッダ</span></span>
<span id="cb3-21"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb3-21" aria-hidden="true" tabindex="-1"></a>    <span class="kw">fn</span> emit_header(<span class="op">&amp;</span><span class="kw">self</span>) <span class="op">-&gt;</span> <span class="dt">String</span><span class="op">;</span></span>
<span id="cb3-22"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb3-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb3-23"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb3-23" aria-hidden="true" tabindex="-1"></a>    <span class="co">// 生成するコードのフッタ</span></span>
<span id="cb3-24"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb3-24" aria-hidden="true" tabindex="-1"></a>    <span class="kw">fn</span> emit_footer(<span class="op">&amp;</span><span class="kw">self</span>) <span class="op">-&gt;</span> <span class="dt">String</span><span class="op">;</span></span>
<span id="cb3-25"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb3-25" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>続いて <a href="https://github.com/Tosainu/chiya/blob/0142dec5700759efb7b50ee1284fe42e81add906/src/codegen/llvm.rs" target="_blank" rel="nofollow noopener"><code>src/codegen/llvm.rs</code></a> にこんな感じのデータ型 <code>LLVM</code> を定義しました。各フィールドは与えたソースコード全体のコードを生成するにあたって必要となる情報で、<code>variable_idx</code> は次に登場する無名変数のインデックス (LLVM IR で計算の途中結果などを格納する変数 (<a href="http://releases.llvm.org/9.0.0/docs/LangRef.html#identifiers" target="_blank" rel="nofollow noopener">Unnamed values</a>) は <code>%1</code>, <code>%2</code> … と<a href="http://releases.llvm.org/9.0.0/docs/LangRef.html#functions" target="_blank" rel="nofollow noopener">登場する順に1からカウントしていく必要がある</a>)、<code>label_idx</code> はループで使われるラベルのインデックス、<code>loop_stack</code> は今どのループの中にいるかを管理するためのものです。このデータ型に先程定義した <code>Emitter</code> のメソッドを生やしていきます。</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode rust"><code class="sourceCode rust"><span id="cb4-1"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="kw">use</span> <span class="pp">std::collections::</span>VecDeque<span class="op">;</span></span>
<span id="cb4-2"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb4-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-3"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb4-3" aria-hidden="true" tabindex="-1"></a><span class="kw">pub</span> <span class="kw">struct</span> LLVM <span class="op">{</span></span>
<span id="cb4-4"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb4-4" aria-hidden="true" tabindex="-1"></a>    variable_idx<span class="op">:</span> <span class="dt">u32</span><span class="op">,</span></span>
<span id="cb4-5"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb4-5" aria-hidden="true" tabindex="-1"></a>    label_idx<span class="op">:</span> <span class="dt">u32</span><span class="op">,</span></span>
<span id="cb4-6"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb4-6" aria-hidden="true" tabindex="-1"></a>    loop_stack<span class="op">:</span> VecDeque<span class="op">&lt;</span><span class="dt">u32</span><span class="op">&gt;,</span></span>
<span id="cb4-7"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb4-7" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb4-8"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb4-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-9"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb4-9" aria-hidden="true" tabindex="-1"></a><span class="kw">impl</span> LLVM <span class="op">{</span></span>
<span id="cb4-10"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb4-10" aria-hidden="true" tabindex="-1"></a>    <span class="kw">pub</span> <span class="kw">fn</span> new() <span class="op">-&gt;</span> LLVM <span class="op">{</span></span>
<span id="cb4-11"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb4-11" aria-hidden="true" tabindex="-1"></a>        <span class="bu">Default</span><span class="pp">::</span><span class="kw">default</span>()</span>
<span id="cb4-12"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb4-12" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb4-13"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb4-13" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb4-14"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb4-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-15"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb4-15" aria-hidden="true" tabindex="-1"></a><span class="kw">impl</span> <span class="bu">Default</span> <span class="cf">for</span> LLVM <span class="op">{</span></span>
<span id="cb4-16"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb4-16" aria-hidden="true" tabindex="-1"></a>    <span class="kw">fn</span> default() <span class="op">-&gt;</span> <span class="dt">Self</span> <span class="op">{</span></span>
<span id="cb4-17"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb4-17" aria-hidden="true" tabindex="-1"></a>        LLVM <span class="op">{</span></span>
<span id="cb4-18"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb4-18" aria-hidden="true" tabindex="-1"></a>            variable_idx<span class="op">:</span> <span class="dv">1</span><span class="op">,</span></span>
<span id="cb4-19"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb4-19" aria-hidden="true" tabindex="-1"></a>            label_idx<span class="op">:</span> <span class="dv">1</span><span class="op">,</span></span>
<span id="cb4-20"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb4-20" aria-hidden="true" tabindex="-1"></a>            loop_stack<span class="op">:</span> <span class="pp">VecDeque::</span>new()<span class="op">,</span></span>
<span id="cb4-21"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb4-21" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb4-22"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb4-22" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb4-23"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb4-23" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>上で紹介した itchyny さんのブログ記事などと同様に、目的の動作を C で書いて、それがどのような LLVM IR になるかを <code>clang</code> で確認しながら実装していく方針で進めました。例えば次のポインタ <code>ptr</code> の加算と <code>ptr</code> が指す値への加算をする処理は</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb5-1"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="dt">int</span> main<span class="op">()</span> <span class="op">{</span></span>
<span id="cb5-2"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb5-2" aria-hidden="true" tabindex="-1"></a>  <span class="dt">int</span><span class="op">*</span> ptr<span class="op">;</span></span>
<span id="cb5-3"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb5-3" aria-hidden="true" tabindex="-1"></a>  <span class="op">++</span>ptr<span class="op">;</span></span>
<span id="cb5-4"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb5-4" aria-hidden="true" tabindex="-1"></a>  <span class="op">++*</span>ptr<span class="op">;</span></span>
<span id="cb5-5"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb5-5" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p><code>clang -O0 -S --emit-llvm</code> の出力によればこんな感じの LLVM IR になるようなので</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode llvm"><code class="sourceCode llvm"><span id="cb6-1"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="co">; ModuleID = &#39;test.c&#39;</span></span>
<span id="cb6-2"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb6-2" aria-hidden="true" tabindex="-1"></a>source_filename = <span class="st">&quot;test.c&quot;</span></span>
<span id="cb6-3"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb6-3" aria-hidden="true" tabindex="-1"></a><span class="kw">target</span> <span class="kw">datalayout</span> = <span class="st">&quot;e-m:e-i64:64-f80:128-n8:16:32:64-S128&quot;</span></span>
<span id="cb6-4"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb6-4" aria-hidden="true" tabindex="-1"></a><span class="kw">target</span> <span class="kw">triple</span> = <span class="st">&quot;x86_64-pc-linux-gnu&quot;</span></span>
<span id="cb6-5"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb6-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-6"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb6-6" aria-hidden="true" tabindex="-1"></a><span class="co">; Function Attrs: noinline nounwind optnone sspstrong uwtable</span></span>
<span id="cb6-7"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb6-7" aria-hidden="true" tabindex="-1"></a><span class="kw">define</span> dso_local <span class="dt">i32</span> <span class="fu">@main</span>() #<span class="dv">0</span> {</span>
<span id="cb6-8"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb6-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">%1</span> = <span class="kw">alloca</span> <span class="dt">i32</span>*, <span class="kw">align</span> <span class="dv">8</span></span>
<span id="cb6-9"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb6-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">%2</span> = <span class="kw">load</span> <span class="dt">i32</span>*, <span class="dt">i32</span>** <span class="fu">%1</span>, <span class="kw">align</span> <span class="dv">8</span></span>
<span id="cb6-10"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb6-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">%3</span> = <span class="kw">getelementptr</span> <span class="kw">inbounds</span> <span class="dt">i32</span>, <span class="dt">i32</span>* <span class="fu">%2</span>, <span class="dt">i32</span> <span class="dv">1</span></span>
<span id="cb6-11"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb6-11" aria-hidden="true" tabindex="-1"></a>  <span class="kw">store</span> <span class="dt">i32</span>* <span class="fu">%3</span>, <span class="dt">i32</span>** <span class="fu">%1</span>, <span class="kw">align</span> <span class="dv">8</span></span>
<span id="cb6-12"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb6-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">%4</span> = <span class="kw">load</span> <span class="dt">i32</span>*, <span class="dt">i32</span>** <span class="fu">%1</span>, <span class="kw">align</span> <span class="dv">8</span></span>
<span id="cb6-13"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb6-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">%5</span> = <span class="kw">load</span> <span class="dt">i32</span>, <span class="dt">i32</span>* <span class="fu">%4</span>, <span class="kw">align</span> <span class="dv">4</span></span>
<span id="cb6-14"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb6-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">%6</span> = <span class="kw">add</span> <span class="kw">nsw</span> <span class="dt">i32</span> <span class="fu">%5</span>, <span class="dv">1</span></span>
<span id="cb6-15"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb6-15" aria-hidden="true" tabindex="-1"></a>  <span class="kw">store</span> <span class="dt">i32</span> <span class="fu">%6</span>, <span class="dt">i32</span>* <span class="fu">%4</span>, <span class="kw">align</span> <span class="dv">4</span></span>
<span id="cb6-16"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb6-16" aria-hidden="true" tabindex="-1"></a>  <span class="kw">ret</span> <span class="dt">i32</span> <span class="dv">0</span></span>
<span id="cb6-17"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb6-17" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb6-18"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb6-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-19"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb6-19" aria-hidden="true" tabindex="-1"></a>attributes #<span class="dv">0</span> = { <span class="kw">noinline</span> <span class="kw">nounwind</span> <span class="kw">optnone</span> <span class="kw">sspstrong</span> uwtable <span class="st">&quot;correctly-rounded-divide-sqrt-fp-math&quot;</span>=<span class="st">&quot;false&quot;</span> <span class="st">&quot;disable-tail-calls&quot;</span>=<span class="st">&quot;false&quot;</span> <span class="st">&quot;less-precise-fpmad&quot;</span>=<span class="st">&quot;false&quot;</span> <span class="st">&quot;min-legal-vector-width&quot;</span>=<span class="st">&quot;0&quot;</span> <span class="st">&quot;no-frame-pointer-elim&quot;</span>=<span class="st">&quot;true&quot;</span> <span class="st">&quot;no-frame-pointer-elim-non-leaf&quot;</span> <span class="st">&quot;no-infs-fp-math&quot;</span>=<span class="st">&quot;false&quot;</span> <span class="st">&quot;no-jump-tables&quot;</span>=<span class="st">&quot;false&quot;</span> <span class="st">&quot;no-nans-fp-math&quot;</span>=<span class="st">&quot;false&quot;</span> <span class="st">&quot;no-signed-zeros-fp-math&quot;</span>=<span class="st">&quot;false&quot;</span> <span class="st">&quot;no-trapping-math&quot;</span>=<span class="st">&quot;false&quot;</span> <span class="st">&quot;stack-protector-buffer-size&quot;</span>=<span class="st">&quot;8&quot;</span> <span class="st">&quot;target-cpu&quot;</span>=<span class="st">&quot;x86-64&quot;</span> <span class="st">&quot;target-features&quot;</span>=<span class="st">&quot;+cx8,+fxsr,+mmx,+sse,+sse2,+x87&quot;</span> <span class="st">&quot;unsafe-fp-math&quot;</span>=<span class="st">&quot;false&quot;</span> <span class="st">&quot;use-soft-float&quot;</span>=<span class="st">&quot;false&quot;</span> }</span>
<span id="cb6-20"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb6-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-21"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb6-21" aria-hidden="true" tabindex="-1"></a>!llvm.module.flags = !{!<span class="dv">0</span>, !<span class="dv">1</span>, !<span class="dv">2</span>}</span>
<span id="cb6-22"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb6-22" aria-hidden="true" tabindex="-1"></a>!llvm.ident = !{!<span class="dv">3</span>}</span>
<span id="cb6-23"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb6-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-24"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb6-24" aria-hidden="true" tabindex="-1"></a>!<span class="dv">0</span> = !{<span class="dt">i32</span> <span class="dv">1</span>, !<span class="st">&quot;wchar_size&quot;</span>, <span class="dt">i32</span> <span class="dv">4</span>}</span>
<span id="cb6-25"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb6-25" aria-hidden="true" tabindex="-1"></a>!<span class="dv">1</span> = !{<span class="dt">i32</span> <span class="dv">7</span>, !<span class="st">&quot;PIC Level&quot;</span>, <span class="dt">i32</span> <span class="dv">2</span>}</span>
<span id="cb6-26"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb6-26" aria-hidden="true" tabindex="-1"></a>!<span class="dv">2</span> = !{<span class="dt">i32</span> <span class="dv">7</span>, !<span class="st">&quot;PIE Level&quot;</span>, <span class="dt">i32</span> <span class="dv">2</span>}</span>
<span id="cb6-27"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb6-27" aria-hidden="true" tabindex="-1"></a>!<span class="dv">3</span> = !{!<span class="st">&quot;clang version 9.0.0 (tags/RELEASE_900/final)&quot;</span>}</span></code></pre></div>
<p><code>emit_move_ptr()</code> と <code>emit_add()</code> の実装はこうなる、という感じです。</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode rust"><code class="sourceCode rust"><span id="cb7-1"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="kw">use</span> <span class="kw">crate</span><span class="pp">::codegen::</span>emitter<span class="op">;</span></span>
<span id="cb7-2"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb7-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-3"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb7-3" aria-hidden="true" tabindex="-1"></a><span class="kw">impl</span> <span class="pp">emitter::</span>Emitter <span class="cf">for</span> LLVM <span class="op">{</span></span>
<span id="cb7-4"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb7-4" aria-hidden="true" tabindex="-1"></a>    <span class="kw">fn</span> emit_move_ptr(<span class="op">&amp;</span><span class="kw">mut</span> <span class="kw">self</span><span class="op">,</span> offset<span class="op">:</span> <span class="dt">i32</span>) <span class="op">-&gt;</span> <span class="dt">String</span> <span class="op">{</span></span>
<span id="cb7-5"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb7-5" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> s <span class="op">=</span> <span class="pp">format!</span>(</span>
<span id="cb7-6"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb7-6" aria-hidden="true" tabindex="-1"></a>            <span class="st">r#&quot;</span></span>
<span id="cb7-7"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb7-7" aria-hidden="true" tabindex="-1"></a><span class="st">  ; emit_move_ptr({2})</span></span>
<span id="cb7-8"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb7-8" aria-hidden="true" tabindex="-1"></a><span class="st">  %{0} = load i32*, i32** %ptr, align 8</span></span>
<span id="cb7-9"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb7-9" aria-hidden="true" tabindex="-1"></a><span class="st">  %{1} = getelementptr inbounds i32, i32* %{0}, i32 {2}</span></span>
<span id="cb7-10"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb7-10" aria-hidden="true" tabindex="-1"></a><span class="st">  store i32* %{1}, i32** %ptr, align 8&quot;#</span><span class="op">,</span></span>
<span id="cb7-11"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb7-11" aria-hidden="true" tabindex="-1"></a>            <span class="kw">self</span><span class="op">.</span>variable_idx<span class="op">,</span></span>
<span id="cb7-12"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb7-12" aria-hidden="true" tabindex="-1"></a>            <span class="kw">self</span><span class="op">.</span>variable_idx <span class="op">+</span> <span class="dv">1</span><span class="op">,</span></span>
<span id="cb7-13"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb7-13" aria-hidden="true" tabindex="-1"></a>            offset</span>
<span id="cb7-14"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb7-14" aria-hidden="true" tabindex="-1"></a>        )<span class="op">;</span></span>
<span id="cb7-15"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb7-15" aria-hidden="true" tabindex="-1"></a>        <span class="kw">self</span><span class="op">.</span>variable_idx <span class="op">+=</span> <span class="dv">2</span><span class="op">;</span></span>
<span id="cb7-16"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb7-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-17"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb7-17" aria-hidden="true" tabindex="-1"></a>        s</span>
<span id="cb7-18"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb7-18" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb7-19"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb7-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-20"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb7-20" aria-hidden="true" tabindex="-1"></a>    <span class="kw">fn</span> emit_add(<span class="op">&amp;</span><span class="kw">mut</span> <span class="kw">self</span><span class="op">,</span> n<span class="op">:</span> <span class="dt">i32</span>) <span class="op">-&gt;</span> <span class="dt">String</span> <span class="op">{</span></span>
<span id="cb7-21"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb7-21" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> s <span class="op">=</span> <span class="pp">format!</span>(</span>
<span id="cb7-22"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb7-22" aria-hidden="true" tabindex="-1"></a>            <span class="st">r#&quot;</span></span>
<span id="cb7-23"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb7-23" aria-hidden="true" tabindex="-1"></a><span class="st">  ; emit_add({3})</span></span>
<span id="cb7-24"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb7-24" aria-hidden="true" tabindex="-1"></a><span class="st">  %{0} = load i32*, i32** %ptr, align 8</span></span>
<span id="cb7-25"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb7-25" aria-hidden="true" tabindex="-1"></a><span class="st">  %{1} = load i32, i32* %{0}, align 4</span></span>
<span id="cb7-26"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb7-26" aria-hidden="true" tabindex="-1"></a><span class="st">  %{2} = add nsw i32 %{1}, {3}</span></span>
<span id="cb7-27"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb7-27" aria-hidden="true" tabindex="-1"></a><span class="st">  store i32 %{2}, i32* %{0}, align 4&quot;#</span><span class="op">,</span></span>
<span id="cb7-28"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb7-28" aria-hidden="true" tabindex="-1"></a>            <span class="kw">self</span><span class="op">.</span>variable_idx<span class="op">,</span></span>
<span id="cb7-29"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb7-29" aria-hidden="true" tabindex="-1"></a>            <span class="kw">self</span><span class="op">.</span>variable_idx <span class="op">+</span> <span class="dv">1</span><span class="op">,</span></span>
<span id="cb7-30"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb7-30" aria-hidden="true" tabindex="-1"></a>            <span class="kw">self</span><span class="op">.</span>variable_idx <span class="op">+</span> <span class="dv">2</span><span class="op">,</span></span>
<span id="cb7-31"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb7-31" aria-hidden="true" tabindex="-1"></a>            n</span>
<span id="cb7-32"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb7-32" aria-hidden="true" tabindex="-1"></a>        )<span class="op">;</span></span>
<span id="cb7-33"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb7-33" aria-hidden="true" tabindex="-1"></a>        <span class="kw">self</span><span class="op">.</span>variable_idx <span class="op">+=</span> <span class="dv">3</span><span class="op">;</span></span>
<span id="cb7-34"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb7-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-35"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb7-35" aria-hidden="true" tabindex="-1"></a>        s</span>
<span id="cb7-36"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb7-36" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb7-37"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb7-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-38"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb7-38" aria-hidden="true" tabindex="-1"></a>    <span class="co">// ...</span></span>
<span id="cb7-39"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb7-39" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>そのほかの実装は長くなるので、ここでは割愛します。</p>
<h3 id="とりあえず動かしてみる">とりあえず動かしてみる</h3>
<p>ここまでで Brainf**k の各命令に対応する LLVM IR を出力できるようになったはずです。最初のコンパイラっぽい動作確認に、Brainf**k のソースコードを読み込み、LLVM IR に変換して出力する Brainf**k コンパイラを書いてみます。</p>
<p><a href="https://github.com/Tosainu/chiya/blob/777b7b8b9243604aa6d1ea6a72d038b73a413a7d/src/bin/chiya.rs" target="_blank" rel="nofollow noopener"><code>src/bin/chiya.rs</code></a> にこんな感じのコードを書きました。標準入力を <code>src</code> に全部読み込み、その文字列を 1 文字ずつ見て対応するコードを出力する、というものです。</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode rust"><code class="sourceCode rust"><span id="cb8-1"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="kw">use</span> <span class="pp">std::io::</span><span class="bu">Read</span><span class="op">;</span></span>
<span id="cb8-2"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb8-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-3"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb8-3" aria-hidden="true" tabindex="-1"></a><span class="kw">use</span> <span class="pp">chiya::codegen::emitter::</span>Emitter<span class="op">;</span></span>
<span id="cb8-4"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb8-4" aria-hidden="true" tabindex="-1"></a><span class="kw">use</span> <span class="pp">chiya::codegen::llvm::</span>LLVM<span class="op">;</span></span>
<span id="cb8-5"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb8-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-6"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb8-6" aria-hidden="true" tabindex="-1"></a><span class="kw">fn</span> main() <span class="op">-&gt;</span> <span class="pp">std::io::</span><span class="dt">Result</span><span class="op">&lt;</span>()<span class="op">&gt;</span> <span class="op">{</span></span>
<span id="cb8-7"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb8-7" aria-hidden="true" tabindex="-1"></a>    <span class="kw">let</span> <span class="kw">mut</span> src <span class="op">=</span> <span class="dt">String</span><span class="pp">::</span>new()<span class="op">;</span></span>
<span id="cb8-8"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb8-8" aria-hidden="true" tabindex="-1"></a>    <span class="pp">std::io::</span>stdin()<span class="op">.</span>read_to_string(<span class="op">&amp;</span><span class="kw">mut</span> src)<span class="op">?;</span></span>
<span id="cb8-9"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb8-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-10"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb8-10" aria-hidden="true" tabindex="-1"></a>    <span class="kw">let</span> <span class="kw">mut</span> e <span class="op">=</span> <span class="pp">LLVM::</span>new()<span class="op">;</span></span>
<span id="cb8-11"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb8-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-12"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb8-12" aria-hidden="true" tabindex="-1"></a>    <span class="pp">println!</span>(<span class="st">&quot;{}&quot;</span><span class="op">,</span> e<span class="op">.</span>emit_header())<span class="op">;</span></span>
<span id="cb8-13"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb8-13" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> c <span class="kw">in</span> src<span class="op">.</span>chars() <span class="op">{</span></span>
<span id="cb8-14"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb8-14" aria-hidden="true" tabindex="-1"></a>        <span class="kw">let</span> l <span class="op">=</span> <span class="cf">match</span> c <span class="op">{</span></span>
<span id="cb8-15"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb8-15" aria-hidden="true" tabindex="-1"></a>            <span class="ch">&#39;&gt;&#39;</span> <span class="op">=&gt;</span> e<span class="op">.</span>emit_move_ptr(<span class="dv">1</span>)<span class="op">,</span></span>
<span id="cb8-16"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb8-16" aria-hidden="true" tabindex="-1"></a>            <span class="ch">&#39;&lt;&#39;</span> <span class="op">=&gt;</span> e<span class="op">.</span>emit_move_ptr(<span class="op">-</span><span class="dv">1</span>)<span class="op">,</span></span>
<span id="cb8-17"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb8-17" aria-hidden="true" tabindex="-1"></a>            <span class="ch">&#39;+&#39;</span> <span class="op">=&gt;</span> e<span class="op">.</span>emit_add(<span class="dv">1</span>)<span class="op">,</span></span>
<span id="cb8-18"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb8-18" aria-hidden="true" tabindex="-1"></a>            <span class="ch">&#39;-&#39;</span> <span class="op">=&gt;</span> e<span class="op">.</span>emit_add(<span class="op">-</span><span class="dv">1</span>)<span class="op">,</span></span>
<span id="cb8-19"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb8-19" aria-hidden="true" tabindex="-1"></a>            <span class="ch">&#39;.&#39;</span> <span class="op">=&gt;</span> e<span class="op">.</span>emit_call_putchar()<span class="op">,</span></span>
<span id="cb8-20"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb8-20" aria-hidden="true" tabindex="-1"></a>            <span class="ch">&#39;,&#39;</span> <span class="op">=&gt;</span> e<span class="op">.</span>emit_call_getchar()<span class="op">,</span></span>
<span id="cb8-21"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb8-21" aria-hidden="true" tabindex="-1"></a>            <span class="ch">&#39;[&#39;</span> <span class="op">=&gt;</span> e<span class="op">.</span>emit_loop_begin()<span class="op">,</span></span>
<span id="cb8-22"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb8-22" aria-hidden="true" tabindex="-1"></a>            <span class="ch">&#39;]&#39;</span> <span class="op">=&gt;</span> e<span class="op">.</span>emit_loop_end()<span class="op">,</span></span>
<span id="cb8-23"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb8-23" aria-hidden="true" tabindex="-1"></a>            _ <span class="op">=&gt;</span> <span class="cf">continue</span><span class="op">,</span></span>
<span id="cb8-24"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb8-24" aria-hidden="true" tabindex="-1"></a>        <span class="op">};</span></span>
<span id="cb8-25"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb8-25" aria-hidden="true" tabindex="-1"></a>        <span class="pp">println!</span>(<span class="st">&quot;{}&quot;</span><span class="op">,</span> l)<span class="op">;</span></span>
<span id="cb8-26"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb8-26" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb8-27"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb8-27" aria-hidden="true" tabindex="-1"></a>    <span class="pp">println!</span>(<span class="st">&quot;{}&quot;</span><span class="op">,</span> e<span class="op">.</span>emit_footer())<span class="op">;</span></span>
<span id="cb8-28"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb8-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-29"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb8-29" aria-hidden="true" tabindex="-1"></a>    <span class="cn">Ok</span>(())</span>
<span id="cb8-30"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb8-30" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>まずはとても簡単な <code>A</code> を出力するだけのコードを入力し、出力された LLVM IR を LLVM インタプリタの <a href="http://releases.llvm.org/9.0.0/docs/CommandGuide/lli.html" target="_blank" rel="nofollow noopener"><code>lli</code></a> で実行してみます。</p>
<pre><code>$ echo &#39;+++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++.&#39; | cargo run -q | lli
A</code></pre>
<p><a href="https://en.wikipedia.org/wiki/Brainfuck#Hello_World!" target="_blank" rel="nofollow noopener">Wikipedia に載っている Hello World!</a> でもチェック。</p>
<pre><code>$ cargo run -q &lt; hello_with_comments.bf | lli
Hello World!</code></pre>
<p><a href="https://rosettacode.org/wiki/Mandelbrot_set#Brainf.2A.2A.2A" target="_blank" rel="nofollow noopener">Erik Bosman さんの Mandelbrot set プログラム</a> だと…</p>
<pre><code>$ cargo run -q &lt; mandelbrot.bf | lli
AAAAAAAAAAAAAAAABBBBBBBBBBBBBBBCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCDDDDDDDDDEGFFEEEEDDDDDDCCCCCCCCCBBBBBBBBBBBBBBBBBBBBBBBBBBBBBB
AAAAAAAAAAAAAAABBBBBBBBBBBBBCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCDDDDDDDDDDEEEFGIIGFFEEEDDDDDDDDCCCCCCCCCBBBBBBBBBBBBBBBBBBBBBBBBBB
AAAAAAAAAAAAABBBBBBBBBBBBCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCDDDDDDDDDDDDEEEEFFFI KHGGGHGEDDDDDDDDDCCCCCCCCCBBBBBBBBBBBBBBBBBBBBBBB
AAAAAAAAAAAABBBBBBBBBBCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCDDDDDDDDDDDDDDEEEEEFFGHIMTKLZOGFEEDDDDDDDDDCCCCCCCCCBBBBBBBBBBBBBBBBBBBBB
AAAAAAAAAAABBBBBBBBBCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCDDDDDDDDDDDDDDEEEEEEFGGHHIKPPKIHGFFEEEDDDDDDDDDCCCCCCCCCCBBBBBBBBBBBBBBBBBB
AAAAAAAAAABBBBBBBBCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCDDDDDDDDDDDDDDDEEEEEEFFGHIJKS  X KHHGFEEEEEDDDDDDDDDCCCCCCCCCCBBBBBBBBBBBBBBBB
AAAAAAAAABBBBBBBCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCDDDDDDDDDDDDDDDEEEEEEFFGQPUVOTY   ZQL[MHFEEEEEEEDDDDDDDCCCCCCCCCCCBBBBBBBBBBBBBB
AAAAAAAABBBBBBCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCDDDDDDDDDDDDDDDEEEEEFFFFFGGHJLZ         UKHGFFEEEEEEEEDDDDDCCCCCCCCCCCCBBBBBBBBBBBB
AAAAAAABBBBBCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCDDDDDDDDDDDDDDEEEEFFFFFFGGGGHIKP           KHHGGFFFFEEEEEEDDDDDCCCCCCCCCCCBBBBBBBBBBB
AAAAAAABBBBCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCDDDDDDDDDDDDEEEEEFGGHIIHHHHHIIIJKMR        VMKJIHHHGFFFFFFGSGEDDDDCCCCCCCCCCCCBBBBBBBBB
AAAAAABBBCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCDDDDDDDDDDDEEEEEEFFGHK   MKJIJO  N R  X      YUSR PLV LHHHGGHIOJGFEDDDCCCCCCCCCCCCBBBBBBBB
AAAAABBBCCCCCCCCCCCCCCCCCCCCCCCCCCCCCDDDDDDDDEEEEEEEEEFFFFGH O    TN S                       NKJKR LLQMNHEEDDDCCCCCCCCCCCCBBBBBBB
AAAAABBCCCCCCCCCCCCCCCCCCCCCCCCCCCDDDDDDEEEEEEEEEEEEFFFFFGHHIN                                 Q     UMWGEEEDDDCCCCCCCCCCCCBBBBBB
AAAABBCCCCCCCCCCCCCCCCCCCCCCCCCDDDDEEEEEEEEEEEEEEEFFFFFFGHIJKLOT                                     [JGFFEEEDDCCCCCCCCCCCCCBBBBB
AAAABCCCCCCCCCCCCCCCCCCCCCCDDDDEEEEEEEEEEEEEEEEFFFFFFGGHYV RQU                                     QMJHGGFEEEDDDCCCCCCCCCCCCCBBBB
AAABCCCCCCCCCCCCCCCCCDDDDDDDEEFJIHFFFFFFFFFFFFFFGGGGGGHIJN                                            JHHGFEEDDDDCCCCCCCCCCCCCBBB
AAABCCCCCCCCCCCDDDDDDDDDDEEEEFFHLKHHGGGGHHMJHGGGGGGHHHIKRR                                           UQ L HFEDDDDCCCCCCCCCCCCCCBB
AABCCCCCCCCDDDDDDDDDDDEEEEEEFFFHKQMRKNJIJLVS JJKIIIIIIJLR                                               YNHFEDDDDDCCCCCCCCCCCCCBB
AABCCCCCDDDDDDDDDDDDEEEEEEEFFGGHIJKOU  O O   PR LLJJJKL                                                OIHFFEDDDDDCCCCCCCCCCCCCCB
AACCCDDDDDDDDDDDDDEEEEEEEEEFGGGHIJMR              RMLMN                                                 NTFEEDDDDDDCCCCCCCCCCCCCB
AACCDDDDDDDDDDDDEEEEEEEEEFGGGHHKONSZ                QPR                                                NJGFEEDDDDDDCCCCCCCCCCCCCC
ABCDDDDDDDDDDDEEEEEFFFFFGIPJIIJKMQ                   VX                                                 HFFEEDDDDDDCCCCCCCCCCCCCC
ACDDDDDDDDDDEFFFFFFFGGGGHIKZOOPPS                                                                      HGFEEEDDDDDDCCCCCCCCCCCCCC
ADEEEEFFFGHIGGGGGGHHHHIJJLNY                                                                        TJHGFFEEEDDDDDDDCCCCCCCCCCCCC
A                                                                                                 PLJHGGFFEEEDDDDDDDCCCCCCCCCCCCC
ADEEEEFFFGHIGGGGGGHHHHIJJLNY                                                                        TJHGFFEEEDDDDDDDCCCCCCCCCCCCC
ACDDDDDDDDDDEFFFFFFFGGGGHIKZOOPPS                                                                      HGFEEEDDDDDDCCCCCCCCCCCCCC
ABCDDDDDDDDDDDEEEEEFFFFFGIPJIIJKMQ                   VX                                                 HFFEEDDDDDDCCCCCCCCCCCCCC
AACCDDDDDDDDDDDDEEEEEEEEEFGGGHHKONSZ                QPR                                                NJGFEEDDDDDDCCCCCCCCCCCCCC
AACCCDDDDDDDDDDDDDEEEEEEEEEFGGGHIJMR              RMLMN                                                 NTFEEDDDDDDCCCCCCCCCCCCCB
AABCCCCCDDDDDDDDDDDDEEEEEEEFFGGHIJKOU  O O   PR LLJJJKL                                                OIHFFEDDDDDCCCCCCCCCCCCCCB
AABCCCCCCCCDDDDDDDDDDDEEEEEEFFFHKQMRKNJIJLVS JJKIIIIIIJLR                                               YNHFEDDDDDCCCCCCCCCCCCCBB
AAABCCCCCCCCCCCDDDDDDDDDDEEEEFFHLKHHGGGGHHMJHGGGGGGHHHIKRR                                           UQ L HFEDDDDCCCCCCCCCCCCCCBB
AAABCCCCCCCCCCCCCCCCCDDDDDDDEEFJIHFFFFFFFFFFFFFFGGGGGGHIJN                                            JHHGFEEDDDDCCCCCCCCCCCCCBBB
AAAABCCCCCCCCCCCCCCCCCCCCCCDDDDEEEEEEEEEEEEEEEEFFFFFFGGHYV RQU                                     QMJHGGFEEEDDDCCCCCCCCCCCCCBBBB
AAAABBCCCCCCCCCCCCCCCCCCCCCCCCCDDDDEEEEEEEEEEEEEEEFFFFFFGHIJKLOT                                     [JGFFEEEDDCCCCCCCCCCCCCBBBBB
AAAAABBCCCCCCCCCCCCCCCCCCCCCCCCCCCDDDDDDEEEEEEEEEEEEFFFFFGHHIN                                 Q     UMWGEEEDDDCCCCCCCCCCCCBBBBBB
AAAAABBBCCCCCCCCCCCCCCCCCCCCCCCCCCCCCDDDDDDDDEEEEEEEEEFFFFGH O    TN S                       NKJKR LLQMNHEEDDDCCCCCCCCCCCCBBBBBBB
AAAAAABBBCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCDDDDDDDDDDDEEEEEEFFGHK   MKJIJO  N R  X      YUSR PLV LHHHGGHIOJGFEDDDCCCCCCCCCCCCBBBBBBBB
AAAAAAABBBBCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCDDDDDDDDDDDDEEEEEFGGHIIHHHHHIIIJKMR        VMKJIHHHGFFFFFFGSGEDDDDCCCCCCCCCCCCBBBBBBBBB
AAAAAAABBBBBCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCDDDDDDDDDDDDDDEEEEFFFFFFGGGGHIKP           KHHGGFFFFEEEEEEDDDDDCCCCCCCCCCCBBBBBBBBBBB
AAAAAAAABBBBBBCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCDDDDDDDDDDDDDDDEEEEEFFFFFGGHJLZ         UKHGFFEEEEEEEEDDDDDCCCCCCCCCCCCBBBBBBBBBBBB
AAAAAAAAABBBBBBBCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCDDDDDDDDDDDDDDDEEEEEEFFGQPUVOTY   ZQL[MHFEEEEEEEDDDDDDDCCCCCCCCCCCBBBBBBBBBBBBBB
AAAAAAAAAABBBBBBBBCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCDDDDDDDDDDDDDDDEEEEEEFFGHIJKS  X KHHGFEEEEEDDDDDDDDDCCCCCCCCCCBBBBBBBBBBBBBBBB
AAAAAAAAAAABBBBBBBBBCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCDDDDDDDDDDDDDDEEEEEEFGGHHIKPPKIHGFFEEEDDDDDDDDDCCCCCCCCCCBBBBBBBBBBBBBBBBBB
AAAAAAAAAAAABBBBBBBBBBCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCDDDDDDDDDDDDDDEEEEEFFGHIMTKLZOGFEEDDDDDDDDDCCCCCCCCCBBBBBBBBBBBBBBBBBBBBB
AAAAAAAAAAAAABBBBBBBBBBBBCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCDDDDDDDDDDDDEEEEFFFI KHGGGHGEDDDDDDDDDCCCCCCCCCBBBBBBBBBBBBBBBBBBBBBBB
AAAAAAAAAAAAAAABBBBBBBBBBBBBCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCCDDDDDDDDDDEEEFGIIGFFEEEDDDDDDDDCCCCCCCCCBBBBBBBBBBBBBBBBBBBBBBBBBB</code></pre>
<p>(⋈◍＞◡＜◍)。✧♡</p>
<h2 id="brainfk-レベルのプログラミング言語を設計する">Brainf**k レベルのプログラミング言語を設計する</h2>
<p>次は「Brainf**k レベルに機能を絞った言語」を定義します。今回はこんな感じにしてみました。<code>ptr</code> は組み込みの変数のようなものです。この <code>ptr</code> を Brainf**k 上で操作するポインタとし、それをよくある感じの構文で操作できるようにしたイメージです。本当に Brainf**k に皮をかぶせた程度の機能しかないし、見た目もいろいろと残念なのには目をつぶることにします。</p>
<div class="sourceCode" id="cb12"><pre class="sourceCode rust"><code class="sourceCode rust"><span id="cb12-1"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="co">// 行末までコメント</span></span>
<span id="cb12-2"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb12-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-3"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb12-3" aria-hidden="true" tabindex="-1"></a>ptr <span class="op">+=</span> <span class="dv">123</span><span class="op">;</span>  <span class="co">// 数値だけポインタを進める</span></span>
<span id="cb12-4"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb12-4" aria-hidden="true" tabindex="-1"></a>ptr <span class="op">-=</span> <span class="dv">123</span><span class="op">;</span>  <span class="co">// 数値だけポインタを戻す</span></span>
<span id="cb12-5"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb12-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-6"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb12-6" aria-hidden="true" tabindex="-1"></a><span class="op">*</span>ptr <span class="op">+=</span> <span class="dv">123</span><span class="op">;</span>  <span class="co">// 数値だけポインタが指す値を加算する</span></span>
<span id="cb12-7"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb12-7" aria-hidden="true" tabindex="-1"></a><span class="op">*</span>ptr <span class="op">-=</span> <span class="dv">123</span><span class="op">;</span>  <span class="co">// 数値だけポインタが指す値を減算する</span></span>
<span id="cb12-8"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb12-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-9"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb12-9" aria-hidden="true" tabindex="-1"></a>putchar()<span class="op">;</span>  <span class="co">// 標準入力から1文字読んで *ptr に格納する</span></span>
<span id="cb12-10"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb12-10" aria-hidden="true" tabindex="-1"></a>getchar()<span class="op">;</span>  <span class="co">// *ptr の値を標準出力に書き込む</span></span>
<span id="cb12-11"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb12-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-12"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb12-12" aria-hidden="true" tabindex="-1"></a><span class="co">// ループ (条件式は現状 *ptr のみ)</span></span>
<span id="cb12-13"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb12-13" aria-hidden="true" tabindex="-1"></a><span class="cf">while</span> <span class="op">*</span>ptr <span class="op">{</span></span>
<span id="cb12-14"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb12-14" aria-hidden="true" tabindex="-1"></a>    <span class="co">// do something</span></span>
<span id="cb12-15"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb12-15" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h2 id="字句解析を実装する">字句解析を実装する</h2>
<p>今度はソースコードをプログラミング言語で意味のある字句・記号 (トークン) で分割し、内部で扱いやすい形式に変換する字句解析を実装していきます。</p>
<p><a href="https://github.com/Tosainu/chiya/blob/e6f96026af0323fad54c3754b0e4c14322a6bd25/src/token.rs" target="_blank" rel="nofollow noopener"><code>src/token.rs</code></a> を作成し、まずはトークンを表現するデータ型をこんな感じに定義しました。トークンの分類や名称などは <a href="https://doc.rust-lang.org/stable/reference/tokens.html" target="_blank" rel="nofollow noopener">Tokens - The Rust Reference</a> などを参考にしました。</p>
<div class="sourceCode" id="cb13"><pre class="sourceCode rust"><code class="sourceCode rust"><span id="cb13-1"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="at">#[</span>derive<span class="at">(</span><span class="bu">Debug</span><span class="op">,</span> <span class="bu">PartialEq</span><span class="at">)]</span></span>
<span id="cb13-2"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb13-2" aria-hidden="true" tabindex="-1"></a><span class="kw">pub</span> <span class="kw">enum</span> Token <span class="op">{</span></span>
<span id="cb13-3"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb13-3" aria-hidden="true" tabindex="-1"></a>    Integer(<span class="dt">i32</span>)<span class="op">,</span></span>
<span id="cb13-4"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb13-4" aria-hidden="true" tabindex="-1"></a>    Identifier(<span class="dt">String</span>)<span class="op">,</span></span>
<span id="cb13-5"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb13-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-6"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb13-6" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Keywords</span></span>
<span id="cb13-7"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb13-7" aria-hidden="true" tabindex="-1"></a>    While<span class="op">,</span> <span class="co">// &#39;while&#39;</span></span>
<span id="cb13-8"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb13-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-9"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb13-9" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Punctuation symbols</span></span>
<span id="cb13-10"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb13-10" aria-hidden="true" tabindex="-1"></a>    Star<span class="op">,</span>       <span class="co">// &#39;*&#39;</span></span>
<span id="cb13-11"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb13-11" aria-hidden="true" tabindex="-1"></a>    PlusEq<span class="op">,</span>     <span class="co">// &#39;+=&#39;</span></span>
<span id="cb13-12"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb13-12" aria-hidden="true" tabindex="-1"></a>    MinusEq<span class="op">,</span>    <span class="co">// &#39;-=&#39;</span></span>
<span id="cb13-13"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb13-13" aria-hidden="true" tabindex="-1"></a>    Semi<span class="op">,</span>       <span class="co">// &#39;;&#39;</span></span>
<span id="cb13-14"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb13-14" aria-hidden="true" tabindex="-1"></a>    ParenOpen<span class="op">,</span>  <span class="co">// &#39;(&#39;</span></span>
<span id="cb13-15"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb13-15" aria-hidden="true" tabindex="-1"></a>    ParenClose<span class="op">,</span> <span class="co">// &#39;)&#39;</span></span>
<span id="cb13-16"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb13-16" aria-hidden="true" tabindex="-1"></a>    CurlyOpen<span class="op">,</span>  <span class="co">// &#39;{&#39;</span></span>
<span id="cb13-17"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb13-17" aria-hidden="true" tabindex="-1"></a>    CurlyClose<span class="op">,</span> <span class="co">// &#39;}&#39;</span></span>
<span id="cb13-18"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb13-18" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>続いて文字列をトークン列に分割する関数 <code>tokenize()</code> を実装していきます。処理は失敗する可能性があるので、<a href="https://docs.rs/failure/0.1.6/failure/" target="_blank" rel="nofollow noopener"><code>failure</code> crate</a> を使ったエラー処理を使ってみました。Rust の文字列 (<a href="https://doc.rust-lang.org/std/string/struct.String.html" target="_blank" rel="nofollow noopener"><code>String</code></a> や <a href="https://doc.rust-lang.org/std/primitive.str.html" target="_blank" rel="nofollow noopener"><code>str</code></a>) を複数文字ずつチェックしていくいい感じの方法がよくわからず、とりあえず <code>str</code> のメソッド <a href="https://doc.rust-lang.org/std/primitive.str.html#method.get" target="_blank" rel="nofollow noopener"><code>get()</code></a> を使ってみました。何か Best practice があれば教えてもらえるとうれしいです。</p>
<div class="sourceCode" id="cb14"><pre class="sourceCode rust"><code class="sourceCode rust"><span id="cb14-1"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="at">#[</span>derive<span class="at">(</span><span class="bu">Debug</span><span class="op">,</span> <span class="bu">PartialEq</span><span class="op">,</span> <span class="pp">failure::</span>Fail<span class="at">)]</span></span>
<span id="cb14-2"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb14-2" aria-hidden="true" tabindex="-1"></a><span class="kw">pub</span> <span class="kw">enum</span> TokenizerError <span class="op">{</span></span>
<span id="cb14-3"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb14-3" aria-hidden="true" tabindex="-1"></a>    <span class="at">#[</span>fail<span class="at">(</span>display <span class="op">=</span> <span class="st">&quot;unexpected character: &#39;{}&#39;&quot;</span><span class="op">,</span> character<span class="at">)]</span></span>
<span id="cb14-4"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb14-4" aria-hidden="true" tabindex="-1"></a>    UnexpectedCharacter <span class="op">{</span> character<span class="op">:</span> <span class="dt">char</span> <span class="op">},</span></span>
<span id="cb14-5"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb14-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-6"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb14-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">#[</span>fail<span class="at">(</span>display <span class="op">=</span> <span class="st">&quot;input error&quot;</span><span class="at">)]</span></span>
<span id="cb14-7"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb14-7" aria-hidden="true" tabindex="-1"></a>    InputError<span class="op">,</span></span>
<span id="cb14-8"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb14-8" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb14-9"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb14-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-10"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb14-10" aria-hidden="true" tabindex="-1"></a><span class="kw">pub</span> <span class="kw">fn</span> tokenize(src<span class="op">:</span> <span class="op">&amp;</span><span class="dt">str</span>) <span class="op">-&gt;</span> <span class="dt">Result</span><span class="op">&lt;</span><span class="dt">Vec</span><span class="op">&lt;</span>Token<span class="op">&gt;,</span> TokenizerError<span class="op">&gt;</span> <span class="op">{</span></span>
<span id="cb14-11"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb14-11" aria-hidden="true" tabindex="-1"></a>    <span class="kw">let</span> <span class="kw">mut</span> tokens <span class="op">=</span> <span class="dt">Vec</span><span class="pp">::</span>new()<span class="op">;</span></span>
<span id="cb14-12"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb14-12" aria-hidden="true" tabindex="-1"></a>    <span class="kw">let</span> <span class="kw">mut</span> cur <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb14-13"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb14-13" aria-hidden="true" tabindex="-1"></a>    <span class="cf">while</span> cur <span class="op">&lt;</span> src<span class="op">.</span>len() <span class="op">{</span></span>
<span id="cb14-14"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb14-14" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="kw">let</span> <span class="cn">Some</span>(s) <span class="op">=</span> src<span class="op">.</span>get(cur<span class="op">..</span>) <span class="op">{</span></span>
<span id="cb14-15"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb14-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-16"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb14-16" aria-hidden="true" tabindex="-1"></a>            <span class="co">// ~~~ トークンへの分割処理 ~~~</span></span>
<span id="cb14-17"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb14-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-18"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb14-18" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> <span class="cn">Err</span>(<span class="pp">TokenizerError::</span>UnexpectedCharacter <span class="op">{</span></span>
<span id="cb14-19"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb14-19" aria-hidden="true" tabindex="-1"></a>                character<span class="op">:</span> s<span class="op">.</span>chars()<span class="op">.</span>next()<span class="op">.</span>unwrap()<span class="op">,</span></span>
<span id="cb14-20"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb14-20" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span>)<span class="op">;</span></span>
<span id="cb14-21"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb14-21" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span> <span class="cf">else</span> <span class="op">{</span></span>
<span id="cb14-22"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb14-22" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> <span class="cn">Err</span>(<span class="pp">TokenizerError::</span>InputError)<span class="op">;</span></span>
<span id="cb14-23"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb14-23" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb14-24"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb14-24" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb14-25"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb14-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-26"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb14-26" aria-hidden="true" tabindex="-1"></a>    <span class="cn">Ok</span>(tokens)</span>
<span id="cb14-27"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb14-27" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>コンパイラの教科書や字句解析系を生成するソフトウェアとして有名な <a href="https://en.wikipedia.org/wiki/Lex_(software)" target="_blank" rel="nofollow noopener">Lex</a> では正規表現が出てくるので、ここでもルールの記述に正規表現を使うことにします。正規表現のライブラリには <a href="https://docs.rs/crate/regex/1.3.1" target="_blank" rel="nofollow noopener"><code>regex</code> crate</a> を使うことにしました。</p>
<p>簡単なルールから書いていきます。空白文字のスキップと数値のルールをとりあえずこんな感じに書いてみました。</p>
<div class="sourceCode" id="cb15"><pre class="sourceCode rust"><code class="sourceCode rust"><span id="cb15-1"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="kw">use</span> <span class="pp">lazy_static::</span>lazy_static<span class="op">;</span></span>
<span id="cb15-2"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb15-2" aria-hidden="true" tabindex="-1"></a><span class="kw">use</span> <span class="pp">regex::</span>Regex<span class="op">;</span></span>
<span id="cb15-3"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb15-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-4"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb15-4" aria-hidden="true" tabindex="-1"></a><span class="pp">lazy_static!</span> <span class="op">{</span></span>
<span id="cb15-5"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb15-5" aria-hidden="true" tabindex="-1"></a>    <span class="kw">static</span> <span class="kw">ref</span> WHITESPACES<span class="op">:</span> Regex <span class="op">=</span> <span class="pp">Regex::</span>new(<span class="st">r&quot;^\s+&quot;</span>)<span class="op">.</span>unwrap()<span class="op">;</span></span>
<span id="cb15-6"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb15-6" aria-hidden="true" tabindex="-1"></a>    <span class="kw">static</span> <span class="kw">ref</span> INTEGER<span class="op">:</span> Regex <span class="op">=</span> <span class="pp">Regex::</span>new(<span class="st">r&quot;^-?\d+\b&quot;</span>)<span class="op">.</span>unwrap()<span class="op">;</span></span>
<span id="cb15-7"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb15-7" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb15-8"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb15-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-9"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb15-9" aria-hidden="true" tabindex="-1"></a><span class="co">// 注目している文字列が正規表現 WHITESPACES にマッチしたら</span></span>
<span id="cb15-10"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb15-10" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> <span class="kw">let</span> <span class="cn">Some</span>(m) <span class="op">=</span> WHITESPACES<span class="op">.</span>find(s) <span class="op">{</span></span>
<span id="cb15-11"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb15-11" aria-hidden="true" tabindex="-1"></a>    <span class="co">// 何もせずマッチしたバイト数だけカーソルを進める</span></span>
<span id="cb15-12"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb15-12" aria-hidden="true" tabindex="-1"></a>    cur <span class="op">+=</span> m<span class="op">.</span>end()<span class="op">;</span></span>
<span id="cb15-13"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb15-13" aria-hidden="true" tabindex="-1"></a>    <span class="cf">continue</span><span class="op">;</span></span>
<span id="cb15-14"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb15-14" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb15-15"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb15-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-16"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb15-16" aria-hidden="true" tabindex="-1"></a><span class="co">// 注目している文字列が正規表現 INTEGER にマッチしたら</span></span>
<span id="cb15-17"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb15-17" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> <span class="kw">let</span> <span class="cn">Some</span>(m) <span class="op">=</span> INTEGER<span class="op">.</span>find(s) <span class="op">{</span></span>
<span id="cb15-18"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb15-18" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Token::Integer を追加して</span></span>
<span id="cb15-19"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb15-19" aria-hidden="true" tabindex="-1"></a>    tokens<span class="op">.</span>push(<span class="pp">Token::</span>Integer(m<span class="op">.</span>as_str()<span class="op">.</span>parse()<span class="op">.</span>unwrap()))<span class="op">;</span></span>
<span id="cb15-20"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb15-20" aria-hidden="true" tabindex="-1"></a>    <span class="co">// マッチしたバイト数だけカーソルを進める</span></span>
<span id="cb15-21"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb15-21" aria-hidden="true" tabindex="-1"></a>    cur <span class="op">+=</span> m<span class="op">.</span>end()<span class="op">;</span></span>
<span id="cb15-22"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb15-22" aria-hidden="true" tabindex="-1"></a>    <span class="cf">continue</span><span class="op">;</span></span>
<span id="cb15-23"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb15-23" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>単体テストを書くことで実装の動作確認を行うことにします。Rust では関数に <a href="https://doc.rust-lang.org/reference/attributes/testing.html#the-test-attribute" target="_blank" rel="nofollow noopener"><code>#[test]</code></a> と付けるだけでテスト用の関数になるのはとてもお手軽で良いですね。</p>
<div class="sourceCode" id="cb16"><pre class="sourceCode rust"><code class="sourceCode rust"><span id="cb16-1"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb16-1" aria-hidden="true" tabindex="-1"></a><span class="at">#[</span>test<span class="at">]</span></span>
<span id="cb16-2"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb16-2" aria-hidden="true" tabindex="-1"></a><span class="kw">fn</span> test_tokenize() <span class="op">{</span></span>
<span id="cb16-3"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb16-3" aria-hidden="true" tabindex="-1"></a>    <span class="pp">assert_eq!</span>(tokenize(<span class="st">&quot;     &quot;</span>)<span class="op">,</span> <span class="cn">Ok</span>(<span class="pp">vec!</span>[]))<span class="op">;</span></span>
<span id="cb16-4"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb16-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-5"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb16-5" aria-hidden="true" tabindex="-1"></a>    <span class="pp">assert_eq!</span>(tokenize(<span class="st">&quot;123&quot;</span>)<span class="op">,</span> <span class="cn">Ok</span>(<span class="pp">vec!</span>[<span class="pp">Token::</span>Integer(<span class="dv">123</span>)]))<span class="op">;</span></span>
<span id="cb16-6"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb16-6" aria-hidden="true" tabindex="-1"></a>    <span class="pp">assert_eq!</span>(tokenize(<span class="st">&quot;-123&quot;</span>)<span class="op">,</span> <span class="cn">Ok</span>(<span class="pp">vec!</span>[<span class="pp">Token::</span>Integer(<span class="op">-</span><span class="dv">123</span>)]))<span class="op">;</span></span>
<span id="cb16-7"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb16-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-8"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb16-8" aria-hidden="true" tabindex="-1"></a>    <span class="pp">assert_eq!</span>(</span>
<span id="cb16-9"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb16-9" aria-hidden="true" tabindex="-1"></a>        tokenize(<span class="st">&quot;123 123&quot;</span>)<span class="op">,</span></span>
<span id="cb16-10"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb16-10" aria-hidden="true" tabindex="-1"></a>        <span class="cn">Ok</span>(<span class="pp">vec!</span>[<span class="pp">Token::</span>Integer(<span class="dv">123</span>)<span class="op">,</span> <span class="pp">Token::</span>Integer(<span class="dv">123</span>)])</span>
<span id="cb16-11"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb16-11" aria-hidden="true" tabindex="-1"></a>    )<span class="op">;</span></span>
<span id="cb16-12"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb16-12" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p><code>cargo test --lib</code> で書いたテストを実行してみると、とりあえずそれっぽく動いてそうです。</p>
<pre><code>$ cargo test --lib
   Compiling chiya v0.1.0 (/path/to/work/dir/chiya)
    Finished dev [unoptimized + debuginfo] target(s) in 1.10s
     Running target/debug/deps/chiya-193f94de4648cab5

running 1 test
test token::test_tokenize ... ok

test result: ok. 1 passed; 0 failed; 0 ignored; 0 measured; 0 filtered out</code></pre>
<p>単純な文字列の一致で済みそうなケースでも正規表現を利用するのはちょっとアレです。Rust の Linter である <a href="https://github.com/rust-lang/rust-clippy" target="_blank" rel="nofollow noopener">Clippy</a> も<a href="https://rust-lang.github.io/rust-clippy/master/#trivial_regex" target="_blank" rel="nofollow noopener">非常に単純な正規表現に警告を出してきたり</a>します。ということで、記号など簡単なルールは文字列の先頭が引数に与えた文字列と一致しているかを判定する <a href="https://doc.rust-lang.org/std/primitive.str.html#method.starts_with" target="_blank" rel="nofollow noopener"><code>starts_with()</code></a> メソッドを使うことにしました。</p>
<div class="sourceCode" id="cb18"><pre class="sourceCode rust"><code class="sourceCode rust"><span id="cb18-1"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb18-1" aria-hidden="true" tabindex="-1"></a><span class="co">// 注目している文字列が &#39;+=&#39; で始まっていたら</span></span>
<span id="cb18-2"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb18-2" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> s<span class="op">.</span>starts_with(<span class="st">&quot;+=&quot;</span>) <span class="op">{</span></span>
<span id="cb18-3"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb18-3" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Token::PlusEq を追加して</span></span>
<span id="cb18-4"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb18-4" aria-hidden="true" tabindex="-1"></a>    tokens<span class="op">.</span>push(<span class="pp">Token::</span>PlusEq)<span class="op">;</span></span>
<span id="cb18-5"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb18-5" aria-hidden="true" tabindex="-1"></a>    <span class="co">// そのバイト数だけカーソルを進める</span></span>
<span id="cb18-6"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb18-6" aria-hidden="true" tabindex="-1"></a>    cur <span class="op">+=</span> <span class="st">&quot;+=&quot;</span><span class="op">.</span>len()<span class="op">;</span></span>
<span id="cb18-7"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb18-7" aria-hidden="true" tabindex="-1"></a>    <span class="cf">continue</span><span class="op">;</span></span>
<span id="cb18-8"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb18-8" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>こんな感じでほかのトークンも認識できるようにしていきます。頻出する「ルールにマッチしたら何かして <code>continue</code>」へ展開されるマクロ <code>match_re!</code> や <code>match_str!</code> なども実装し、<code>tokenize()</code> は最終的にこんな感じになりました。</p>
<div class="sourceCode" id="cb19"><pre class="sourceCode rust"><code class="sourceCode rust"><span id="cb19-1"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb19-1" aria-hidden="true" tabindex="-1"></a><span class="kw">pub</span> <span class="kw">fn</span> tokenize(src<span class="op">:</span> <span class="op">&amp;</span><span class="dt">str</span>) <span class="op">-&gt;</span> <span class="dt">Result</span><span class="op">&lt;</span><span class="dt">Vec</span><span class="op">&lt;</span>Token<span class="op">&gt;,</span> TokenizerError<span class="op">&gt;</span> <span class="op">{</span></span>
<span id="cb19-2"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb19-2" aria-hidden="true" tabindex="-1"></a>    <span class="kw">let</span> <span class="kw">mut</span> tokens <span class="op">=</span> <span class="dt">Vec</span><span class="pp">::</span>new()<span class="op">;</span></span>
<span id="cb19-3"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb19-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">let</span> <span class="kw">mut</span> cur <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb19-4"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb19-4" aria-hidden="true" tabindex="-1"></a>    <span class="cf">while</span> cur <span class="op">&lt;</span> src<span class="op">.</span>len() <span class="op">{</span></span>
<span id="cb19-5"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb19-5" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="kw">let</span> <span class="cn">Some</span>(s) <span class="op">=</span> src<span class="op">.</span>get(cur<span class="op">..</span>) <span class="op">{</span></span>
<span id="cb19-6"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb19-6" aria-hidden="true" tabindex="-1"></a>            <span class="pp">macro_rules!</span> match_re <span class="op">{</span></span>
<span id="cb19-7"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb19-7" aria-hidden="true" tabindex="-1"></a>                (<span class="op">$</span>re<span class="op">:</span>expr<span class="op">,</span> <span class="op">$</span>closure<span class="op">:</span>expr) <span class="op">=&gt;</span> <span class="op">{</span></span>
<span id="cb19-8"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb19-8" aria-hidden="true" tabindex="-1"></a>                    <span class="cf">if</span> <span class="kw">let</span> <span class="cn">Some</span>(m) <span class="op">=</span> <span class="op">$</span>re<span class="op">.</span>find(s) <span class="op">{</span></span>
<span id="cb19-9"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb19-9" aria-hidden="true" tabindex="-1"></a>                        <span class="op">$</span>closure(m)<span class="op">;</span></span>
<span id="cb19-10"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb19-10" aria-hidden="true" tabindex="-1"></a>                        cur <span class="op">+=</span> m<span class="op">.</span>end()<span class="op">;</span></span>
<span id="cb19-11"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb19-11" aria-hidden="true" tabindex="-1"></a>                        <span class="cf">continue</span><span class="op">;</span></span>
<span id="cb19-12"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb19-12" aria-hidden="true" tabindex="-1"></a>                    <span class="op">}</span></span>
<span id="cb19-13"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb19-13" aria-hidden="true" tabindex="-1"></a>                <span class="op">};</span></span>
<span id="cb19-14"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb19-14" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span></span>
<span id="cb19-15"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb19-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-16"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb19-16" aria-hidden="true" tabindex="-1"></a>            <span class="pp">macro_rules!</span> match_str <span class="op">{</span></span>
<span id="cb19-17"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb19-17" aria-hidden="true" tabindex="-1"></a>                (<span class="op">$</span>pat<span class="op">:</span>expr<span class="op">,</span> <span class="op">$</span>e<span class="op">:</span>expr) <span class="op">=&gt;</span> <span class="op">{</span></span>
<span id="cb19-18"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb19-18" aria-hidden="true" tabindex="-1"></a>                    <span class="cf">if</span> s<span class="op">.</span>starts_with(<span class="op">$</span>pat) <span class="op">{</span></span>
<span id="cb19-19"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb19-19" aria-hidden="true" tabindex="-1"></a>                        <span class="op">$</span>e<span class="op">;</span></span>
<span id="cb19-20"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb19-20" aria-hidden="true" tabindex="-1"></a>                        cur <span class="op">+=</span> <span class="op">$</span>pat<span class="op">.</span>len()<span class="op">;</span></span>
<span id="cb19-21"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb19-21" aria-hidden="true" tabindex="-1"></a>                        <span class="cf">continue</span><span class="op">;</span></span>
<span id="cb19-22"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb19-22" aria-hidden="true" tabindex="-1"></a>                    <span class="op">}</span></span>
<span id="cb19-23"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb19-23" aria-hidden="true" tabindex="-1"></a>                <span class="op">};</span></span>
<span id="cb19-24"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb19-24" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span></span>
<span id="cb19-25"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb19-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-26"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb19-26" aria-hidden="true" tabindex="-1"></a>            <span class="pp">lazy_static!</span> <span class="op">{</span></span>
<span id="cb19-27"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb19-27" aria-hidden="true" tabindex="-1"></a>                <span class="kw">static</span> <span class="kw">ref</span> WHITESPACES<span class="op">:</span> Regex <span class="op">=</span> <span class="pp">Regex::</span>new(<span class="st">r&quot;^\s+&quot;</span>)<span class="op">.</span>unwrap()<span class="op">;</span></span>
<span id="cb19-28"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb19-28" aria-hidden="true" tabindex="-1"></a>                <span class="kw">static</span> <span class="kw">ref</span> COMMENT<span class="op">:</span> Regex <span class="op">=</span> <span class="pp">Regex::</span>new(<span class="st">r&quot;^(?m://.+$)&quot;</span>)<span class="op">.</span>unwrap()<span class="op">;</span></span>
<span id="cb19-29"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb19-29" aria-hidden="true" tabindex="-1"></a>                <span class="kw">static</span> <span class="kw">ref</span> INTEGER<span class="op">:</span> Regex <span class="op">=</span> <span class="pp">Regex::</span>new(<span class="st">r&quot;^-?\d+\b&quot;</span>)<span class="op">.</span>unwrap()<span class="op">;</span></span>
<span id="cb19-30"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb19-30" aria-hidden="true" tabindex="-1"></a>                <span class="kw">static</span> <span class="kw">ref</span> ID_OR_KEY<span class="op">:</span> Regex <span class="op">=</span></span>
<span id="cb19-31"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb19-31" aria-hidden="true" tabindex="-1"></a>                    <span class="pp">Regex::</span>new(<span class="st">r&quot;^[a-zA-Z][a-zA-Z0-9_]*|_[a-zA-Z0-9_]+\b&quot;</span>)<span class="op">.</span>unwrap()<span class="op">;</span></span>
<span id="cb19-32"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb19-32" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span></span>
<span id="cb19-33"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb19-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-34"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb19-34" aria-hidden="true" tabindex="-1"></a>            <span class="pp">match_re!</span>(WHITESPACES<span class="op">,</span> <span class="op">|</span>_<span class="op">|</span> <span class="op">{}</span>)<span class="op">;</span></span>
<span id="cb19-35"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb19-35" aria-hidden="true" tabindex="-1"></a>            <span class="pp">match_re!</span>(COMMENT<span class="op">,</span> <span class="op">|</span>_<span class="op">|</span> <span class="op">{}</span>)<span class="op">;</span></span>
<span id="cb19-36"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb19-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-37"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb19-37" aria-hidden="true" tabindex="-1"></a>            <span class="pp">match_re!</span>(INTEGER<span class="op">,</span> <span class="op">|</span>m<span class="op">:</span> <span class="pp">regex::</span>Match<span class="op">|</span> <span class="op">{</span></span>
<span id="cb19-38"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb19-38" aria-hidden="true" tabindex="-1"></a>                tokens<span class="op">.</span>push(<span class="pp">Token::</span>Integer(m<span class="op">.</span>as_str()<span class="op">.</span>parse()<span class="op">.</span>unwrap()))<span class="op">;</span></span>
<span id="cb19-39"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb19-39" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span>)<span class="op">;</span></span>
<span id="cb19-40"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb19-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-41"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb19-41" aria-hidden="true" tabindex="-1"></a>            <span class="pp">match_str!</span>(<span class="st">&quot;+=&quot;</span><span class="op">,</span> tokens<span class="op">.</span>push(<span class="pp">Token::</span>PlusEq))<span class="op">;</span></span>
<span id="cb19-42"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb19-42" aria-hidden="true" tabindex="-1"></a>            <span class="pp">match_str!</span>(<span class="st">&quot;-=&quot;</span><span class="op">,</span> tokens<span class="op">.</span>push(<span class="pp">Token::</span>MinusEq))<span class="op">;</span></span>
<span id="cb19-43"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb19-43" aria-hidden="true" tabindex="-1"></a>            <span class="pp">match_str!</span>(<span class="st">&quot;*&quot;</span><span class="op">,</span> tokens<span class="op">.</span>push(<span class="pp">Token::</span>Star))<span class="op">;</span></span>
<span id="cb19-44"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb19-44" aria-hidden="true" tabindex="-1"></a>            <span class="pp">match_str!</span>(<span class="st">&quot;;&quot;</span><span class="op">,</span> tokens<span class="op">.</span>push(<span class="pp">Token::</span>Semi))<span class="op">;</span></span>
<span id="cb19-45"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb19-45" aria-hidden="true" tabindex="-1"></a>            <span class="pp">match_str!</span>(<span class="st">&quot;(&quot;</span><span class="op">,</span> tokens<span class="op">.</span>push(<span class="pp">Token::</span>ParenOpen))<span class="op">;</span></span>
<span id="cb19-46"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb19-46" aria-hidden="true" tabindex="-1"></a>            <span class="pp">match_str!</span>(<span class="st">&quot;)&quot;</span><span class="op">,</span> tokens<span class="op">.</span>push(<span class="pp">Token::</span>ParenClose))<span class="op">;</span></span>
<span id="cb19-47"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb19-47" aria-hidden="true" tabindex="-1"></a>            <span class="pp">match_str!</span>(<span class="st">&quot;{&quot;</span><span class="op">,</span> tokens<span class="op">.</span>push(<span class="pp">Token::</span>CurlyOpen))<span class="op">;</span></span>
<span id="cb19-48"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb19-48" aria-hidden="true" tabindex="-1"></a>            <span class="pp">match_str!</span>(<span class="st">&quot;}&quot;</span><span class="op">,</span> tokens<span class="op">.</span>push(<span class="pp">Token::</span>CurlyClose))<span class="op">;</span></span>
<span id="cb19-49"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb19-49" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-50"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb19-50" aria-hidden="true" tabindex="-1"></a>            <span class="pp">match_re!</span>(ID_OR_KEY<span class="op">,</span> <span class="op">|</span>m<span class="op">:</span> <span class="pp">regex::</span>Match<span class="op">|</span> <span class="op">{</span></span>
<span id="cb19-51"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb19-51" aria-hidden="true" tabindex="-1"></a>                <span class="kw">let</span> t <span class="op">=</span> <span class="cf">match</span> m<span class="op">.</span>as_str() <span class="op">{</span></span>
<span id="cb19-52"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb19-52" aria-hidden="true" tabindex="-1"></a>                    <span class="st">&quot;while&quot;</span> <span class="op">=&gt;</span> <span class="pp">Token::</span>While<span class="op">,</span></span>
<span id="cb19-53"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb19-53" aria-hidden="true" tabindex="-1"></a>                    s <span class="op">=&gt;</span> <span class="pp">Token::</span>Identifier(s<span class="op">.</span>to_string())<span class="op">,</span></span>
<span id="cb19-54"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb19-54" aria-hidden="true" tabindex="-1"></a>                <span class="op">};</span></span>
<span id="cb19-55"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb19-55" aria-hidden="true" tabindex="-1"></a>                tokens<span class="op">.</span>push(t)<span class="op">;</span></span>
<span id="cb19-56"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb19-56" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span>)<span class="op">;</span></span>
<span id="cb19-57"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb19-57" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-58"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb19-58" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> <span class="cn">Err</span>(<span class="pp">TokenizerError::</span>UnexpectedCharacter <span class="op">{</span></span>
<span id="cb19-59"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb19-59" aria-hidden="true" tabindex="-1"></a>                character<span class="op">:</span> s<span class="op">.</span>chars()<span class="op">.</span>next()<span class="op">.</span>unwrap()<span class="op">,</span></span>
<span id="cb19-60"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb19-60" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span>)<span class="op">;</span></span>
<span id="cb19-61"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb19-61" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span> <span class="cf">else</span> <span class="op">{</span></span>
<span id="cb19-62"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb19-62" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> <span class="cn">Err</span>(<span class="pp">TokenizerError::</span>InputError)<span class="op">;</span></span>
<span id="cb19-63"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb19-63" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb19-64"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb19-64" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb19-65"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb19-65" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-66"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb19-66" aria-hidden="true" tabindex="-1"></a>    <span class="cn">Ok</span>(tokens)</span>
<span id="cb19-67"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb19-67" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h2 id="構文解析を実装する">構文解析を実装する</h2>
<p>次は、入力がプログラミング言語の文法に従っているかを確認し、その構造を表現する構文木を組み立てる構文解析を実装していきます。</p>
<h3 id="文法を定義する">文法を定義する</h3>
<p>まずは定義したプログラミング言語のもう少し厳密な文法を決めていきます。とりあえず簡単なところからいきましょう。今回定めたプログラミング言語における、<code>ptr += 123;</code> や、<code>while *ptr { ... }</code> などを <code>statement</code> (文) という要素とします。プログラムは複数の文で成り立っているので、このプログラミング言語には「<code>program</code> (プログラム全体) は <code>statements</code> (1つ以上の文) で構成される」というルールがあることになります。これを <a href="https://en.wikipedia.org/wiki/Backus–Naur_form" target="_blank" rel="nofollow noopener">BNF (Backus–Naur form)</a> 風に記述するとこうなります。</p>
<pre><code>&lt;program&gt; ::= &lt;statements&gt;
&lt;statements&gt; ::= &lt;statements&gt; &lt;statement&gt; | &lt;statement&gt;</code></pre>
<p>こんな感じにプログラムを構成する要素がどのような構文になっているかのルールを列挙していくことで、文法を定義していきます。</p>
<p>ではどんどんいきましょう。<code>statement</code> は <code>ptr += 123</code> などの <code>expression</code> (式) の末尾にセミコロンをつけたもの、<code>{ ... }</code>、<code>while *ptr { ... }</code> のいずれかで構成されるとすれば</p>
<pre><code>&lt;statement&gt; ::= &lt;expression&gt; &#39;;&#39;
              | &lt;block&gt;
              | &#39;while&#39; &lt;expression&gt; &lt;block&gt;
&lt;block&gt; ::= &#39;{&#39; &lt;statements&gt; &#39;}&#39;</code></pre>
<p><code>rhs</code> (右辺値) を数値、<code>lhs</code> (左辺値) を <code>ptr</code> や <code>*ptr</code> として、<code>expression</code> は</p>
<pre><code>&lt;expression&gt; ::= &lt;lhs&gt; &#39;+=&#39; &lt;rhs&gt;
               | &lt;lhs&gt; &#39;-=&#39; &lt;rhs&gt;
               | &lt;lhs&gt; &#39;(&#39; &#39;)&#39;
               | &lt;lhs&gt;
&lt;lhs&gt; ::= identifier | &#39;*&#39; identifier
&lt;rhs&gt; ::= number</code></pre>
<p>という感じにしました。</p>
<h3 id="構文木のデータ型を定義する">構文木のデータ型を定義する</h3>
<p>続いて、先程定義したプログラミング言語の各要素を表現するデータ型を <a href="https://github.com/Tosainu/chiya/blob/af4d8799e2b61a717d360238be47af56a501c520/src/parser.rs" target="_blank" rel="nofollow noopener"><code>src/parser.rs</code></a> に定義していきます。例えば <code>&lt;rhs&gt; ::= number</code> なら</p>
<div class="sourceCode" id="cb23"><pre class="sourceCode rust"><code class="sourceCode rust"><span id="cb23-1"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb23-1" aria-hidden="true" tabindex="-1"></a><span class="at">#[</span>derive<span class="at">(</span><span class="bu">Debug</span><span class="op">,</span> <span class="bu">PartialEq</span><span class="at">)]</span></span>
<span id="cb23-2"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb23-2" aria-hidden="true" tabindex="-1"></a><span class="kw">pub</span> <span class="kw">enum</span> Rhs <span class="op">{</span></span>
<span id="cb23-3"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb23-3" aria-hidden="true" tabindex="-1"></a>    Number(<span class="dt">i32</span>)<span class="op">,</span></span>
<span id="cb23-4"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb23-4" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p><code>&lt;lhs&gt; ::= identifier | &#39;*&#39; identifier</code> なら</p>
<div class="sourceCode" id="cb24"><pre class="sourceCode rust"><code class="sourceCode rust"><span id="cb24-1"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb24-1" aria-hidden="true" tabindex="-1"></a><span class="at">#[</span>derive<span class="at">(</span><span class="bu">Debug</span><span class="op">,</span> <span class="bu">PartialEq</span><span class="at">)]</span></span>
<span id="cb24-2"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb24-2" aria-hidden="true" tabindex="-1"></a><span class="kw">pub</span> <span class="kw">enum</span> Lhs <span class="op">{</span></span>
<span id="cb24-3"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb24-3" aria-hidden="true" tabindex="-1"></a>    <span class="bu">Pointer</span>(<span class="dt">String</span>)<span class="op">,</span></span>
<span id="cb24-4"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb24-4" aria-hidden="true" tabindex="-1"></a>    Dereference(<span class="dt">String</span>)<span class="op">,</span></span>
<span id="cb24-5"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb24-5" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>という感じです。</p>
<p>残りの要素の型も書いていきます。<code>Statement::Block</code> など、自身のデータ型を持たせたいときにはポインタ型の <a href="https://doc.rust-lang.org/std/boxed/struct.Box.html" target="_blank" rel="nofollow noopener"><code>Box&lt;T&gt;</code></a> を使います。</p>
<div class="sourceCode" id="cb25"><pre class="sourceCode rust"><code class="sourceCode rust"><span id="cb25-1"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb25-1" aria-hidden="true" tabindex="-1"></a><span class="at">#[</span>derive<span class="at">(</span><span class="bu">Debug</span><span class="op">,</span> <span class="bu">PartialEq</span><span class="at">)]</span></span>
<span id="cb25-2"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb25-2" aria-hidden="true" tabindex="-1"></a><span class="kw">pub</span> <span class="kw">enum</span> Expression <span class="op">{</span></span>
<span id="cb25-3"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb25-3" aria-hidden="true" tabindex="-1"></a>    AssignAdd(Lhs<span class="op">,</span> Rhs)<span class="op">,</span></span>
<span id="cb25-4"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb25-4" aria-hidden="true" tabindex="-1"></a>    AssignSub(Lhs<span class="op">,</span> Rhs)<span class="op">,</span></span>
<span id="cb25-5"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb25-5" aria-hidden="true" tabindex="-1"></a>    FunctionCall(Lhs)<span class="op">,</span></span>
<span id="cb25-6"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb25-6" aria-hidden="true" tabindex="-1"></a>    Lhs(Lhs)<span class="op">,</span></span>
<span id="cb25-7"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb25-7" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb25-8"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb25-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-9"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb25-9" aria-hidden="true" tabindex="-1"></a><span class="at">#[</span>derive<span class="at">(</span><span class="bu">Debug</span><span class="op">,</span> <span class="bu">PartialEq</span><span class="at">)]</span></span>
<span id="cb25-10"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb25-10" aria-hidden="true" tabindex="-1"></a><span class="kw">pub</span> <span class="kw">enum</span> Statement <span class="op">{</span></span>
<span id="cb25-11"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb25-11" aria-hidden="true" tabindex="-1"></a>    Expression(Expression)<span class="op">,</span></span>
<span id="cb25-12"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb25-12" aria-hidden="true" tabindex="-1"></a>    Block(<span class="dt">Box</span><span class="op">&lt;</span>Block<span class="op">&gt;</span>)<span class="op">,</span></span>
<span id="cb25-13"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb25-13" aria-hidden="true" tabindex="-1"></a>    While(Expression<span class="op">,</span> <span class="dt">Box</span><span class="op">&lt;</span>Block<span class="op">&gt;</span>)<span class="op">,</span></span>
<span id="cb25-14"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb25-14" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb25-15"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb25-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-16"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb25-16" aria-hidden="true" tabindex="-1"></a><span class="at">#[</span>derive<span class="at">(</span><span class="bu">Debug</span><span class="op">,</span> <span class="bu">PartialEq</span><span class="at">)]</span></span>
<span id="cb25-17"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb25-17" aria-hidden="true" tabindex="-1"></a><span class="kw">pub</span> <span class="kw">enum</span> Statements <span class="op">{</span></span>
<span id="cb25-18"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb25-18" aria-hidden="true" tabindex="-1"></a>    Statements(<span class="dt">Box</span><span class="op">&lt;</span>Statements<span class="op">&gt;,</span> Statement)<span class="op">,</span></span>
<span id="cb25-19"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb25-19" aria-hidden="true" tabindex="-1"></a>    Statement(Statement)<span class="op">,</span></span>
<span id="cb25-20"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb25-20" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb25-21"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb25-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-22"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb25-22" aria-hidden="true" tabindex="-1"></a><span class="at">#[</span>derive<span class="at">(</span><span class="bu">Debug</span><span class="op">,</span> <span class="bu">PartialEq</span><span class="at">)]</span></span>
<span id="cb25-23"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb25-23" aria-hidden="true" tabindex="-1"></a><span class="kw">pub</span> <span class="kw">enum</span> Block <span class="op">{</span></span>
<span id="cb25-24"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb25-24" aria-hidden="true" tabindex="-1"></a>    Statements(Statements)<span class="op">,</span></span>
<span id="cb25-25"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb25-25" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb25-26"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb25-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-27"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb25-27" aria-hidden="true" tabindex="-1"></a><span class="at">#[</span>derive<span class="at">(</span><span class="bu">Debug</span><span class="op">,</span> <span class="bu">PartialEq</span><span class="at">)]</span></span>
<span id="cb25-28"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb25-28" aria-hidden="true" tabindex="-1"></a><span class="kw">pub</span> <span class="kw">enum</span> Program <span class="op">{</span></span>
<span id="cb25-29"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb25-29" aria-hidden="true" tabindex="-1"></a>    Statements(Statements)<span class="op">,</span></span>
<span id="cb25-30"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb25-30" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>これで <code>Program</code> を根にすれば構文木を表現できます。例えば次のコードの構文木は</p>
<div class="sourceCode" id="cb26"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb26-1"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb26-1" aria-hidden="true" tabindex="-1"></a><span class="op">*</span>ptr <span class="op">+=</span> <span class="dv">65</span><span class="op">;</span></span>
<span id="cb26-2"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb26-2" aria-hidden="true" tabindex="-1"></a>putchar<span class="op">();</span></span></code></pre></div>
<p><img src="/entry/2019/10/21/make-own-language-and-compiler/g.svg" /></p>
<p>定義したデータ型を使って表現するとこんな感じになります。</p>
<div class="sourceCode" id="cb27"><pre class="sourceCode rust"><code class="sourceCode rust"><span id="cb27-1"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb27-1" aria-hidden="true" tabindex="-1"></a><span class="kw">let</span> tree <span class="op">=</span> <span class="pp">Program::</span>Statements(<span class="pp">Statements::</span>Statements(</span>
<span id="cb27-2"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb27-2" aria-hidden="true" tabindex="-1"></a>    <span class="dt">Box</span><span class="pp">::</span>new(<span class="pp">Statements::</span>Statement(<span class="pp">Statement::</span>Expression(</span>
<span id="cb27-3"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb27-3" aria-hidden="true" tabindex="-1"></a>        <span class="pp">Expression::</span>AssignAdd(<span class="pp">Lhs::</span>Dereference(<span class="st">&quot;ptr&quot;</span><span class="op">.</span>to_owned())<span class="op">,</span> <span class="pp">Rhs::</span>Number(<span class="dv">65</span>))<span class="op">,</span></span>
<span id="cb27-4"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb27-4" aria-hidden="true" tabindex="-1"></a>    )))<span class="op">,</span></span>
<span id="cb27-5"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb27-5" aria-hidden="true" tabindex="-1"></a>    <span class="pp">Statement::</span>Expression(<span class="pp">Expression::</span>FunctionCall(<span class="pp">Lhs::</span><span class="bu">Pointer</span>(</span>
<span id="cb27-6"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb27-6" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;putchar&quot;</span><span class="op">.</span>to_owned()<span class="op">,</span></span>
<span id="cb27-7"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb27-7" aria-hidden="true" tabindex="-1"></a>    )))<span class="op">,</span></span>
<span id="cb27-8"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb27-8" aria-hidden="true" tabindex="-1"></a>))<span class="op">;</span></span></code></pre></div>
<p>ちなみにこのデータ型は <a href="https://doc.rust-lang.org/std/fmt/trait.Debug.html" target="_blank" rel="nofollow noopener"><code>Debug</code></a> trait を <code>derive</code> しているので、<a href="https://doc.rust-lang.org/std/macro.println.html" target="_blank" rel="nofollow noopener"><code>println!</code></a> などに渡すフォーマットに <code>{:#?}</code> を指定するといい感じに表示できたりします。便利。</p>
<div class="sourceCode" id="cb28"><pre class="sourceCode rust"><code class="sourceCode rust"><span id="cb28-1"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb28-1" aria-hidden="true" tabindex="-1"></a><span class="pp">println!</span>(<span class="st">&quot;{:#?}&quot;</span><span class="op">,</span> tree)<span class="op">;</span></span></code></pre></div>
<div class="sourceCode" id="cb29"><pre class="sourceCode rust"><code class="sourceCode rust"><span id="cb29-1"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb29-1" aria-hidden="true" tabindex="-1"></a>Statements(</span>
<span id="cb29-2"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb29-2" aria-hidden="true" tabindex="-1"></a>    Statements(</span>
<span id="cb29-3"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb29-3" aria-hidden="true" tabindex="-1"></a>        Statement(</span>
<span id="cb29-4"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb29-4" aria-hidden="true" tabindex="-1"></a>            Expression(</span>
<span id="cb29-5"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb29-5" aria-hidden="true" tabindex="-1"></a>                AssignAdd(</span>
<span id="cb29-6"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb29-6" aria-hidden="true" tabindex="-1"></a>                    Dereference(</span>
<span id="cb29-7"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb29-7" aria-hidden="true" tabindex="-1"></a>                        <span class="st">&quot;ptr&quot;</span><span class="op">,</span></span>
<span id="cb29-8"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb29-8" aria-hidden="true" tabindex="-1"></a>                    )<span class="op">,</span></span>
<span id="cb29-9"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb29-9" aria-hidden="true" tabindex="-1"></a>                    Number(</span>
<span id="cb29-10"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb29-10" aria-hidden="true" tabindex="-1"></a>                        <span class="dv">65</span><span class="op">,</span></span>
<span id="cb29-11"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb29-11" aria-hidden="true" tabindex="-1"></a>                    )<span class="op">,</span></span>
<span id="cb29-12"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb29-12" aria-hidden="true" tabindex="-1"></a>                )<span class="op">,</span></span>
<span id="cb29-13"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb29-13" aria-hidden="true" tabindex="-1"></a>            )<span class="op">,</span></span>
<span id="cb29-14"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb29-14" aria-hidden="true" tabindex="-1"></a>        )<span class="op">,</span></span>
<span id="cb29-15"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb29-15" aria-hidden="true" tabindex="-1"></a>        Expression(</span>
<span id="cb29-16"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb29-16" aria-hidden="true" tabindex="-1"></a>            FunctionCall(</span>
<span id="cb29-17"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb29-17" aria-hidden="true" tabindex="-1"></a>                <span class="bu">Pointer</span>(</span>
<span id="cb29-18"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb29-18" aria-hidden="true" tabindex="-1"></a>                    <span class="st">&quot;putchar&quot;</span><span class="op">,</span></span>
<span id="cb29-19"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb29-19" aria-hidden="true" tabindex="-1"></a>                )<span class="op">,</span></span>
<span id="cb29-20"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb29-20" aria-hidden="true" tabindex="-1"></a>            )<span class="op">,</span></span>
<span id="cb29-21"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb29-21" aria-hidden="true" tabindex="-1"></a>        )<span class="op">,</span></span>
<span id="cb29-22"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb29-22" aria-hidden="true" tabindex="-1"></a>    )<span class="op">,</span></span>
<span id="cb29-23"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb29-23" aria-hidden="true" tabindex="-1"></a>)</span></code></pre></div>
<h3 id="top-down-型の構文解析を実装する">Top-Down 型の構文解析を実装する</h3>
<p>では実際に構文解析を実装していきます。今回は比較的お手軽に実装できる Top-Down<a href="/entry/2019/10/21/make-own-language-and-compiler/#fn4" class="footnote-ref" id="fnref4" role="doc-noteref"><sup>4</sup></a> (下降、下向き などと訳される) 型の構文解析を実装します。</p>
<p><code>src/parser.rs</code> に、まず <code>rhs</code> を認識する関数 <code>rhs()</code> をこんな感じに実装してみました。この関数は注目しているトークン列 <code>tokens</code> を受け取り、<code>rhs</code> の文法にマッチしていたらその結果と残りのトークン列を返すというものです。</p>
<div class="sourceCode" id="cb30"><pre class="sourceCode rust"><code class="sourceCode rust"><span id="cb30-1"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb30-1" aria-hidden="true" tabindex="-1"></a><span class="kw">pub</span> <span class="kw">fn</span> rhs(tokens<span class="op">:</span> <span class="op">&amp;</span>[Token]) <span class="op">-&gt;</span> <span class="dt">Option</span><span class="op">&lt;</span>(<span class="op">&amp;</span>[Token]<span class="op">,</span> Rhs)<span class="op">&gt;</span> <span class="op">{</span></span>
<span id="cb30-2"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb30-2" aria-hidden="true" tabindex="-1"></a>    tokens<span class="op">.</span>first()<span class="op">.</span>and_then(<span class="op">|</span>t<span class="op">|</span> <span class="cf">match</span> t <span class="op">{</span></span>
<span id="cb30-3"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb30-3" aria-hidden="true" tabindex="-1"></a>        <span class="co">// トークン列の先頭が Token::Integer だったら Rhs::Number</span></span>
<span id="cb30-4"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb30-4" aria-hidden="true" tabindex="-1"></a>        <span class="pp">Token::</span>Integer(i) <span class="op">=&gt;</span> <span class="cn">Some</span>((<span class="op">&amp;</span>tokens[<span class="dv">1</span><span class="op">..</span>]<span class="op">,</span> <span class="pp">Rhs::</span>Number(<span class="op">*</span>i)))<span class="op">,</span></span>
<span id="cb30-5"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb30-5" aria-hidden="true" tabindex="-1"></a>        _ <span class="op">=&gt;</span> <span class="cn">None</span><span class="op">,</span></span>
<span id="cb30-6"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb30-6" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span>)</span>
<span id="cb30-7"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb30-7" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb30-8"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb30-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-9"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb30-9" aria-hidden="true" tabindex="-1"></a><span class="at">#[</span>test<span class="at">]</span></span>
<span id="cb30-10"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb30-10" aria-hidden="true" tabindex="-1"></a><span class="kw">fn</span> test_rhs() <span class="op">{</span></span>
<span id="cb30-11"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb30-11" aria-hidden="true" tabindex="-1"></a>    <span class="pp">assert_eq!</span>(rhs(<span class="op">&amp;</span>[])<span class="op">,</span> <span class="cn">None</span>)<span class="op">;</span></span>
<span id="cb30-12"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb30-12" aria-hidden="true" tabindex="-1"></a>    <span class="pp">assert_eq!</span>(rhs(<span class="op">&amp;</span>[<span class="pp">Token::</span>CurlyOpen])<span class="op">,</span> <span class="cn">None</span>)<span class="op">;</span></span>
<span id="cb30-13"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb30-13" aria-hidden="true" tabindex="-1"></a>    <span class="pp">assert_eq!</span>(rhs(<span class="op">&amp;</span>[<span class="pp">Token::</span>Identifier(<span class="st">&quot;123&quot;</span><span class="op">.</span>to_owned())])<span class="op">,</span> <span class="cn">None</span>)<span class="op">;</span></span>
<span id="cb30-14"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb30-14" aria-hidden="true" tabindex="-1"></a>    <span class="pp">assert_eq!</span>(</span>
<span id="cb30-15"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb30-15" aria-hidden="true" tabindex="-1"></a>        rhs(<span class="op">&amp;</span>[<span class="pp">Token::</span>Integer(<span class="dv">123</span>)])<span class="op">,</span></span>
<span id="cb30-16"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb30-16" aria-hidden="true" tabindex="-1"></a>        <span class="cn">Some</span>((<span class="op">&amp;</span>[] <span class="kw">as</span> <span class="op">&amp;</span>[Token]<span class="op">,</span> <span class="pp">Rhs::</span>Number(<span class="dv">123</span>)))</span>
<span id="cb30-17"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb30-17" aria-hidden="true" tabindex="-1"></a>    )<span class="op">;</span></span>
<span id="cb30-18"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb30-18" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>同様に <code>lhs</code> を認識する関数 <code>lhs()</code> はこんな感じです。ここまではまぁそのままって感じですね。</p>
<div class="sourceCode" id="cb31"><pre class="sourceCode rust"><code class="sourceCode rust"><span id="cb31-1"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb31-1" aria-hidden="true" tabindex="-1"></a><span class="kw">pub</span> <span class="kw">fn</span> lhs(tokens<span class="op">:</span> <span class="op">&amp;</span>[Token]) <span class="op">-&gt;</span> <span class="dt">Option</span><span class="op">&lt;</span>(<span class="op">&amp;</span>[Token]<span class="op">,</span> Lhs)<span class="op">&gt;</span> <span class="op">{</span></span>
<span id="cb31-2"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb31-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">// トークン列の先頭2要素が</span></span>
<span id="cb31-3"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb31-3" aria-hidden="true" tabindex="-1"></a>    <span class="cf">match</span> (tokens<span class="op">.</span>get(<span class="dv">0</span>)<span class="op">,</span> tokens<span class="op">.</span>get(<span class="dv">1</span>)) <span class="op">{</span></span>
<span id="cb31-4"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb31-4" aria-hidden="true" tabindex="-1"></a>        <span class="co">// [Token::Star, Token::Identifier, ...] だったら Lhs::Dereference</span></span>
<span id="cb31-5"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb31-5" aria-hidden="true" tabindex="-1"></a>        (<span class="cn">Some</span>(<span class="pp">Token::</span>Star)<span class="op">,</span> <span class="cn">Some</span>(<span class="pp">Token::</span>Identifier(s))) <span class="op">=&gt;</span> <span class="op">{</span></span>
<span id="cb31-6"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb31-6" aria-hidden="true" tabindex="-1"></a>            <span class="cn">Some</span>((<span class="op">&amp;</span>tokens[<span class="dv">2</span><span class="op">..</span>]<span class="op">,</span> <span class="pp">Lhs::</span>Dereference(s<span class="op">.</span>to_string())))</span>
<span id="cb31-7"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb31-7" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb31-8"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb31-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-9"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb31-9" aria-hidden="true" tabindex="-1"></a>        <span class="co">// [Token::Identifier, ...] だったら Lhs::Pointer</span></span>
<span id="cb31-10"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb31-10" aria-hidden="true" tabindex="-1"></a>        (<span class="cn">Some</span>(<span class="pp">Token::</span>Identifier(s))<span class="op">,</span> _) <span class="op">=&gt;</span> <span class="cn">Some</span>((<span class="op">&amp;</span>tokens[<span class="dv">1</span><span class="op">..</span>]<span class="op">,</span> <span class="pp">Lhs::</span><span class="bu">Pointer</span>(s<span class="op">.</span>to_string())))<span class="op">,</span></span>
<span id="cb31-11"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb31-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-12"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb31-12" aria-hidden="true" tabindex="-1"></a>        _ <span class="op">=&gt;</span> <span class="cn">None</span><span class="op">,</span></span>
<span id="cb31-13"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb31-13" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb31-14"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb31-14" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb31-15"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb31-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-16"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb31-16" aria-hidden="true" tabindex="-1"></a><span class="at">#[</span>test<span class="at">]</span></span>
<span id="cb31-17"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb31-17" aria-hidden="true" tabindex="-1"></a><span class="kw">fn</span> test_lhs() <span class="op">{</span></span>
<span id="cb31-18"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb31-18" aria-hidden="true" tabindex="-1"></a>    <span class="pp">assert_eq!</span>(lhs(<span class="op">&amp;</span>[])<span class="op">,</span> <span class="cn">None</span>)<span class="op">;</span></span>
<span id="cb31-19"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb31-19" aria-hidden="true" tabindex="-1"></a>    <span class="pp">assert_eq!</span>(lhs(<span class="op">&amp;</span>[<span class="pp">Token::</span>CurlyOpen])<span class="op">,</span> <span class="cn">None</span>)<span class="op">;</span></span>
<span id="cb31-20"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb31-20" aria-hidden="true" tabindex="-1"></a>    <span class="pp">assert_eq!</span>(lhs(<span class="op">&amp;</span>[<span class="pp">Token::</span>Integer(<span class="dv">123</span>)])<span class="op">,</span> <span class="cn">None</span>)<span class="op">;</span></span>
<span id="cb31-21"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb31-21" aria-hidden="true" tabindex="-1"></a>    <span class="pp">assert_eq!</span>(</span>
<span id="cb31-22"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb31-22" aria-hidden="true" tabindex="-1"></a>        lhs(<span class="op">&amp;</span>[<span class="pp">Token::</span>Identifier(<span class="st">&quot;hoge&quot;</span><span class="op">.</span>to_owned())])<span class="op">,</span></span>
<span id="cb31-23"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb31-23" aria-hidden="true" tabindex="-1"></a>        <span class="cn">Some</span>((<span class="op">&amp;</span>[] <span class="kw">as</span> <span class="op">&amp;</span>[Token]<span class="op">,</span> <span class="pp">Lhs::</span><span class="bu">Pointer</span>(<span class="st">&quot;hoge&quot;</span><span class="op">.</span>to_owned())))</span>
<span id="cb31-24"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb31-24" aria-hidden="true" tabindex="-1"></a>    )<span class="op">;</span></span>
<span id="cb31-25"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb31-25" aria-hidden="true" tabindex="-1"></a>    <span class="pp">assert_eq!</span>(</span>
<span id="cb31-26"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb31-26" aria-hidden="true" tabindex="-1"></a>        lhs(<span class="op">&amp;</span>[<span class="pp">Token::</span>Star<span class="op">,</span> <span class="pp">Token::</span>Identifier(<span class="st">&quot;hoge&quot;</span><span class="op">.</span>to_owned())])<span class="op">,</span></span>
<span id="cb31-27"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb31-27" aria-hidden="true" tabindex="-1"></a>        <span class="cn">Some</span>((<span class="op">&amp;</span>[] <span class="kw">as</span> <span class="op">&amp;</span>[Token]<span class="op">,</span> <span class="pp">Lhs::</span>Dereference(<span class="st">&quot;hoge&quot;</span><span class="op">.</span>to_owned())))</span>
<span id="cb31-28"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb31-28" aria-hidden="true" tabindex="-1"></a>    )<span class="op">;</span></span>
<span id="cb31-29"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb31-29" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>この方式で実装する構文解析のおもしろいところは、別の構文解析の関数を組み合わせてより複雑な構文解析を実装できるところです。例えば <code>expression</code> を認識する関数 <code>expression()</code> は <code>rhs()</code> と <code>lhs()</code> を組み合わせてこんな感じに実装できます。</p>
<div class="sourceCode" id="cb32"><pre class="sourceCode rust"><code class="sourceCode rust"><span id="cb32-1"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb32-1" aria-hidden="true" tabindex="-1"></a><span class="kw">pub</span> <span class="kw">fn</span> expression(tokens<span class="op">:</span> <span class="op">&amp;</span>[Token]) <span class="op">-&gt;</span> <span class="dt">Option</span><span class="op">&lt;</span>(<span class="op">&amp;</span>[Token]<span class="op">,</span> Expression)<span class="op">&gt;</span> <span class="op">{</span></span>
<span id="cb32-2"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb32-2" aria-hidden="true" tabindex="-1"></a>    <span class="co">// lhs が認識できるかチェックし、その後に続くトークン列が</span></span>
<span id="cb32-3"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb32-3" aria-hidden="true" tabindex="-1"></a>    lhs(tokens)<span class="op">.</span>and_then(<span class="op">|</span>(tokens<span class="op">,</span> l)<span class="op">|</span> <span class="cf">match</span> (tokens<span class="op">.</span>get(<span class="dv">0</span>)<span class="op">,</span> tokens<span class="op">.</span>get(<span class="dv">1</span>)) <span class="op">{</span></span>
<span id="cb32-4"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb32-4" aria-hidden="true" tabindex="-1"></a>        <span class="co">// &#39;+=&#39; かつその後に rhs が続いたら Expression::AssignAdd</span></span>
<span id="cb32-5"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb32-5" aria-hidden="true" tabindex="-1"></a>        (<span class="cn">Some</span>(<span class="pp">Token::</span>PlusEq)<span class="op">,</span> _) <span class="op">=&gt;</span> <span class="op">{</span></span>
<span id="cb32-6"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb32-6" aria-hidden="true" tabindex="-1"></a>            rhs(<span class="op">&amp;</span>tokens[<span class="dv">1</span><span class="op">..</span>])<span class="op">.</span>map(<span class="op">|</span>(t<span class="op">,</span> r)<span class="op">|</span> (t<span class="op">,</span> <span class="pp">Expression::</span>AssignAdd(l<span class="op">,</span> r)))</span>
<span id="cb32-7"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb32-7" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb32-8"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb32-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-9"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb32-9" aria-hidden="true" tabindex="-1"></a>        <span class="co">// &#39;-=&#39; かつその後に rhs が続いたら Expression::AssignSub</span></span>
<span id="cb32-10"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb32-10" aria-hidden="true" tabindex="-1"></a>        (<span class="cn">Some</span>(<span class="pp">Token::</span>MinusEq)<span class="op">,</span> _) <span class="op">=&gt;</span> <span class="op">{</span></span>
<span id="cb32-11"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb32-11" aria-hidden="true" tabindex="-1"></a>            rhs(<span class="op">&amp;</span>tokens[<span class="dv">1</span><span class="op">..</span>])<span class="op">.</span>map(<span class="op">|</span>(t<span class="op">,</span> r)<span class="op">|</span> (t<span class="op">,</span> <span class="pp">Expression::</span>AssignSub(l<span class="op">,</span> r)))</span>
<span id="cb32-12"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb32-12" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb32-13"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb32-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-14"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb32-14" aria-hidden="true" tabindex="-1"></a>        <span class="co">// &#39;(&#39; &#39;)&#39; なら Expression::FunctionCall</span></span>
<span id="cb32-15"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb32-15" aria-hidden="true" tabindex="-1"></a>        (<span class="cn">Some</span>(<span class="pp">Token::</span>ParenOpen)<span class="op">,</span> <span class="cn">Some</span>(<span class="pp">Token::</span>ParenClose)) <span class="op">=&gt;</span> <span class="op">{</span></span>
<span id="cb32-16"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb32-16" aria-hidden="true" tabindex="-1"></a>            <span class="cn">Some</span>((<span class="op">&amp;</span>tokens[<span class="dv">2</span><span class="op">..</span>]<span class="op">,</span> <span class="pp">Expression::</span>FunctionCall(l)))</span>
<span id="cb32-17"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb32-17" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb32-18"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb32-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-19"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb32-19" aria-hidden="true" tabindex="-1"></a>        <span class="co">// それ以外なら Expression::Lhs</span></span>
<span id="cb32-20"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb32-20" aria-hidden="true" tabindex="-1"></a>        _ <span class="op">=&gt;</span> <span class="cn">Some</span>((tokens<span class="op">,</span> <span class="pp">Expression::</span>Lhs(l)))<span class="op">,</span></span>
<span id="cb32-21"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb32-21" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span>)</span>
<span id="cb32-22"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb32-22" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb32-23"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb32-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-24"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb32-24" aria-hidden="true" tabindex="-1"></a><span class="at">#[</span>test<span class="at">]</span></span>
<span id="cb32-25"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb32-25" aria-hidden="true" tabindex="-1"></a><span class="kw">fn</span> test_expression() <span class="op">{</span></span>
<span id="cb32-26"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb32-26" aria-hidden="true" tabindex="-1"></a>    <span class="pp">assert_eq!</span>(expression(<span class="op">&amp;</span>[])<span class="op">,</span> <span class="cn">None</span>)<span class="op">;</span></span>
<span id="cb32-27"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb32-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-28"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb32-28" aria-hidden="true" tabindex="-1"></a>    <span class="pp">assert_eq!</span>(</span>
<span id="cb32-29"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb32-29" aria-hidden="true" tabindex="-1"></a>        expression(<span class="op">&amp;</span>[<span class="pp">Token::</span>Identifier(<span class="st">&quot;hoge&quot;</span><span class="op">.</span>to_owned())])<span class="op">,</span></span>
<span id="cb32-30"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb32-30" aria-hidden="true" tabindex="-1"></a>        <span class="cn">Some</span>((</span>
<span id="cb32-31"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb32-31" aria-hidden="true" tabindex="-1"></a>            <span class="op">&amp;</span>[] <span class="kw">as</span> <span class="op">&amp;</span>[Token]<span class="op">,</span></span>
<span id="cb32-32"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb32-32" aria-hidden="true" tabindex="-1"></a>            <span class="pp">Expression::</span>Lhs(<span class="pp">Lhs::</span><span class="bu">Pointer</span>(<span class="st">&quot;hoge&quot;</span><span class="op">.</span>to_owned()))</span>
<span id="cb32-33"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb32-33" aria-hidden="true" tabindex="-1"></a>        ))</span>
<span id="cb32-34"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb32-34" aria-hidden="true" tabindex="-1"></a>    )<span class="op">;</span></span>
<span id="cb32-35"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb32-35" aria-hidden="true" tabindex="-1"></a>    <span class="pp">assert_eq!</span>(</span>
<span id="cb32-36"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb32-36" aria-hidden="true" tabindex="-1"></a>        expression(<span class="op">&amp;</span>[<span class="pp">Token::</span>Star<span class="op">,</span> <span class="pp">Token::</span>Identifier(<span class="st">&quot;hoge&quot;</span><span class="op">.</span>to_owned())])<span class="op">,</span></span>
<span id="cb32-37"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb32-37" aria-hidden="true" tabindex="-1"></a>        <span class="cn">Some</span>((</span>
<span id="cb32-38"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb32-38" aria-hidden="true" tabindex="-1"></a>            <span class="op">&amp;</span>[] <span class="kw">as</span> <span class="op">&amp;</span>[Token]<span class="op">,</span></span>
<span id="cb32-39"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb32-39" aria-hidden="true" tabindex="-1"></a>            <span class="pp">Expression::</span>Lhs(<span class="pp">Lhs::</span>Dereference(<span class="st">&quot;hoge&quot;</span><span class="op">.</span>to_owned()))</span>
<span id="cb32-40"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb32-40" aria-hidden="true" tabindex="-1"></a>        ))</span>
<span id="cb32-41"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb32-41" aria-hidden="true" tabindex="-1"></a>    )<span class="op">;</span></span>
<span id="cb32-42"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb32-42" aria-hidden="true" tabindex="-1"></a>    <span class="pp">assert_eq!</span>(</span>
<span id="cb32-43"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb32-43" aria-hidden="true" tabindex="-1"></a>        expression(<span class="op">&amp;</span>[</span>
<span id="cb32-44"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb32-44" aria-hidden="true" tabindex="-1"></a>            <span class="pp">Token::</span>Identifier(<span class="st">&quot;hoge&quot;</span><span class="op">.</span>to_owned())<span class="op">,</span></span>
<span id="cb32-45"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb32-45" aria-hidden="true" tabindex="-1"></a>            <span class="pp">Token::</span>Identifier(<span class="st">&quot;hoge&quot;</span><span class="op">.</span>to_owned())</span>
<span id="cb32-46"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb32-46" aria-hidden="true" tabindex="-1"></a>        ])<span class="op">,</span></span>
<span id="cb32-47"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb32-47" aria-hidden="true" tabindex="-1"></a>        <span class="cn">Some</span>((</span>
<span id="cb32-48"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb32-48" aria-hidden="true" tabindex="-1"></a>            <span class="op">&amp;</span>[<span class="pp">Token::</span>Identifier(<span class="st">&quot;hoge&quot;</span><span class="op">.</span>to_owned())] <span class="kw">as</span> <span class="op">&amp;</span>[Token]<span class="op">,</span></span>
<span id="cb32-49"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb32-49" aria-hidden="true" tabindex="-1"></a>            <span class="pp">Expression::</span>Lhs(<span class="pp">Lhs::</span><span class="bu">Pointer</span>(<span class="st">&quot;hoge&quot;</span><span class="op">.</span>to_owned()))</span>
<span id="cb32-50"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb32-50" aria-hidden="true" tabindex="-1"></a>        ))</span>
<span id="cb32-51"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb32-51" aria-hidden="true" tabindex="-1"></a>    )<span class="op">;</span></span>
<span id="cb32-52"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb32-52" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-53"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb32-53" aria-hidden="true" tabindex="-1"></a>    <span class="pp">assert_eq!</span>(</span>
<span id="cb32-54"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb32-54" aria-hidden="true" tabindex="-1"></a>        expression(<span class="op">&amp;</span>[</span>
<span id="cb32-55"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb32-55" aria-hidden="true" tabindex="-1"></a>            <span class="pp">Token::</span>Identifier(<span class="st">&quot;hoge&quot;</span><span class="op">.</span>to_owned())<span class="op">,</span></span>
<span id="cb32-56"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb32-56" aria-hidden="true" tabindex="-1"></a>            <span class="pp">Token::</span>PlusEq<span class="op">,</span></span>
<span id="cb32-57"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb32-57" aria-hidden="true" tabindex="-1"></a>            <span class="pp">Token::</span>Integer(<span class="dv">123</span>)</span>
<span id="cb32-58"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb32-58" aria-hidden="true" tabindex="-1"></a>        ])<span class="op">,</span></span>
<span id="cb32-59"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb32-59" aria-hidden="true" tabindex="-1"></a>        <span class="cn">Some</span>((</span>
<span id="cb32-60"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb32-60" aria-hidden="true" tabindex="-1"></a>            <span class="op">&amp;</span>[] <span class="kw">as</span> <span class="op">&amp;</span>[Token]<span class="op">,</span></span>
<span id="cb32-61"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb32-61" aria-hidden="true" tabindex="-1"></a>            <span class="pp">Expression::</span>AssignAdd(<span class="pp">Lhs::</span><span class="bu">Pointer</span>(<span class="st">&quot;hoge&quot;</span><span class="op">.</span>to_owned())<span class="op">,</span> <span class="pp">Rhs::</span>Number(<span class="dv">123</span>))</span>
<span id="cb32-62"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb32-62" aria-hidden="true" tabindex="-1"></a>        ))</span>
<span id="cb32-63"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb32-63" aria-hidden="true" tabindex="-1"></a>    )<span class="op">;</span></span>
<span id="cb32-64"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb32-64" aria-hidden="true" tabindex="-1"></a>    <span class="pp">assert_eq!</span>(</span>
<span id="cb32-65"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb32-65" aria-hidden="true" tabindex="-1"></a>        expression(<span class="op">&amp;</span>[</span>
<span id="cb32-66"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb32-66" aria-hidden="true" tabindex="-1"></a>            <span class="pp">Token::</span>Star<span class="op">,</span></span>
<span id="cb32-67"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb32-67" aria-hidden="true" tabindex="-1"></a>            <span class="pp">Token::</span>Identifier(<span class="st">&quot;hoge&quot;</span><span class="op">.</span>to_owned())<span class="op">,</span></span>
<span id="cb32-68"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb32-68" aria-hidden="true" tabindex="-1"></a>            <span class="pp">Token::</span>PlusEq<span class="op">,</span></span>
<span id="cb32-69"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb32-69" aria-hidden="true" tabindex="-1"></a>            <span class="pp">Token::</span>Integer(<span class="dv">123</span>)</span>
<span id="cb32-70"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb32-70" aria-hidden="true" tabindex="-1"></a>        ])<span class="op">,</span></span>
<span id="cb32-71"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb32-71" aria-hidden="true" tabindex="-1"></a>        <span class="cn">Some</span>((</span>
<span id="cb32-72"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb32-72" aria-hidden="true" tabindex="-1"></a>            <span class="op">&amp;</span>[] <span class="kw">as</span> <span class="op">&amp;</span>[Token]<span class="op">,</span></span>
<span id="cb32-73"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb32-73" aria-hidden="true" tabindex="-1"></a>            <span class="pp">Expression::</span>AssignAdd(<span class="pp">Lhs::</span>Dereference(<span class="st">&quot;hoge&quot;</span><span class="op">.</span>to_owned())<span class="op">,</span> <span class="pp">Rhs::</span>Number(<span class="dv">123</span>))</span>
<span id="cb32-74"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb32-74" aria-hidden="true" tabindex="-1"></a>        ))</span>
<span id="cb32-75"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb32-75" aria-hidden="true" tabindex="-1"></a>    )<span class="op">;</span></span>
<span id="cb32-76"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb32-76" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-77"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb32-77" aria-hidden="true" tabindex="-1"></a>    <span class="pp">assert_eq!</span>(</span>
<span id="cb32-78"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb32-78" aria-hidden="true" tabindex="-1"></a>        expression(<span class="op">&amp;</span>[</span>
<span id="cb32-79"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb32-79" aria-hidden="true" tabindex="-1"></a>            <span class="pp">Token::</span>Identifier(<span class="st">&quot;hoge&quot;</span><span class="op">.</span>to_owned())<span class="op">,</span></span>
<span id="cb32-80"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb32-80" aria-hidden="true" tabindex="-1"></a>            <span class="pp">Token::</span>MinusEq<span class="op">,</span></span>
<span id="cb32-81"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb32-81" aria-hidden="true" tabindex="-1"></a>            <span class="pp">Token::</span>Integer(<span class="dv">123</span>)</span>
<span id="cb32-82"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb32-82" aria-hidden="true" tabindex="-1"></a>        ])<span class="op">,</span></span>
<span id="cb32-83"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb32-83" aria-hidden="true" tabindex="-1"></a>        <span class="cn">Some</span>((</span>
<span id="cb32-84"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb32-84" aria-hidden="true" tabindex="-1"></a>            <span class="op">&amp;</span>[] <span class="kw">as</span> <span class="op">&amp;</span>[Token]<span class="op">,</span></span>
<span id="cb32-85"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb32-85" aria-hidden="true" tabindex="-1"></a>            <span class="pp">Expression::</span>AssignSub(<span class="pp">Lhs::</span><span class="bu">Pointer</span>(<span class="st">&quot;hoge&quot;</span><span class="op">.</span>to_owned())<span class="op">,</span> <span class="pp">Rhs::</span>Number(<span class="dv">123</span>))</span>
<span id="cb32-86"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb32-86" aria-hidden="true" tabindex="-1"></a>        ))</span>
<span id="cb32-87"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb32-87" aria-hidden="true" tabindex="-1"></a>    )<span class="op">;</span></span>
<span id="cb32-88"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb32-88" aria-hidden="true" tabindex="-1"></a>    <span class="pp">assert_eq!</span>(</span>
<span id="cb32-89"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb32-89" aria-hidden="true" tabindex="-1"></a>        expression(<span class="op">&amp;</span>[</span>
<span id="cb32-90"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb32-90" aria-hidden="true" tabindex="-1"></a>            <span class="pp">Token::</span>Star<span class="op">,</span></span>
<span id="cb32-91"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb32-91" aria-hidden="true" tabindex="-1"></a>            <span class="pp">Token::</span>Identifier(<span class="st">&quot;hoge&quot;</span><span class="op">.</span>to_owned())<span class="op">,</span></span>
<span id="cb32-92"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb32-92" aria-hidden="true" tabindex="-1"></a>            <span class="pp">Token::</span>MinusEq<span class="op">,</span></span>
<span id="cb32-93"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb32-93" aria-hidden="true" tabindex="-1"></a>            <span class="pp">Token::</span>Integer(<span class="dv">123</span>)</span>
<span id="cb32-94"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb32-94" aria-hidden="true" tabindex="-1"></a>        ])<span class="op">,</span></span>
<span id="cb32-95"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb32-95" aria-hidden="true" tabindex="-1"></a>        <span class="cn">Some</span>((</span>
<span id="cb32-96"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb32-96" aria-hidden="true" tabindex="-1"></a>            <span class="op">&amp;</span>[] <span class="kw">as</span> <span class="op">&amp;</span>[Token]<span class="op">,</span></span>
<span id="cb32-97"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb32-97" aria-hidden="true" tabindex="-1"></a>            <span class="pp">Expression::</span>AssignSub(<span class="pp">Lhs::</span>Dereference(<span class="st">&quot;hoge&quot;</span><span class="op">.</span>to_owned())<span class="op">,</span> <span class="pp">Rhs::</span>Number(<span class="dv">123</span>))</span>
<span id="cb32-98"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb32-98" aria-hidden="true" tabindex="-1"></a>        ))</span>
<span id="cb32-99"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb32-99" aria-hidden="true" tabindex="-1"></a>    )<span class="op">;</span></span>
<span id="cb32-100"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb32-100" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-101"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb32-101" aria-hidden="true" tabindex="-1"></a>    <span class="pp">assert_eq!</span>(</span>
<span id="cb32-102"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb32-102" aria-hidden="true" tabindex="-1"></a>        expression(<span class="op">&amp;</span>[</span>
<span id="cb32-103"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb32-103" aria-hidden="true" tabindex="-1"></a>            <span class="pp">Token::</span>Identifier(<span class="st">&quot;hoge&quot;</span><span class="op">.</span>to_owned())<span class="op">,</span></span>
<span id="cb32-104"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb32-104" aria-hidden="true" tabindex="-1"></a>            <span class="pp">Token::</span>ParenOpen<span class="op">,</span></span>
<span id="cb32-105"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb32-105" aria-hidden="true" tabindex="-1"></a>            <span class="pp">Token::</span>ParenClose</span>
<span id="cb32-106"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb32-106" aria-hidden="true" tabindex="-1"></a>        ])<span class="op">,</span></span>
<span id="cb32-107"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb32-107" aria-hidden="true" tabindex="-1"></a>        <span class="cn">Some</span>((</span>
<span id="cb32-108"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb32-108" aria-hidden="true" tabindex="-1"></a>            <span class="op">&amp;</span>[] <span class="kw">as</span> <span class="op">&amp;</span>[Token]<span class="op">,</span></span>
<span id="cb32-109"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb32-109" aria-hidden="true" tabindex="-1"></a>            <span class="pp">Expression::</span>FunctionCall(<span class="pp">Lhs::</span><span class="bu">Pointer</span>(<span class="st">&quot;hoge&quot;</span><span class="op">.</span>to_owned()))</span>
<span id="cb32-110"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb32-110" aria-hidden="true" tabindex="-1"></a>        ))</span>
<span id="cb32-111"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb32-111" aria-hidden="true" tabindex="-1"></a>    )<span class="op">;</span></span>
<span id="cb32-112"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb32-112" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb32-113"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb32-113" aria-hidden="true" tabindex="-1"></a>    <span class="pp">assert_eq!</span>(</span>
<span id="cb32-114"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb32-114" aria-hidden="true" tabindex="-1"></a>        expression(<span class="op">&amp;</span>[</span>
<span id="cb32-115"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb32-115" aria-hidden="true" tabindex="-1"></a>            <span class="pp">Token::</span>Identifier(<span class="st">&quot;hoge&quot;</span><span class="op">.</span>to_owned())<span class="op">,</span></span>
<span id="cb32-116"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb32-116" aria-hidden="true" tabindex="-1"></a>            <span class="pp">Token::</span>MinusEq<span class="op">,</span></span>
<span id="cb32-117"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb32-117" aria-hidden="true" tabindex="-1"></a>            <span class="pp">Token::</span>Identifier(<span class="st">&quot;hoge&quot;</span><span class="op">.</span>to_owned())<span class="op">,</span></span>
<span id="cb32-118"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb32-118" aria-hidden="true" tabindex="-1"></a>        ])<span class="op">,</span></span>
<span id="cb32-119"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb32-119" aria-hidden="true" tabindex="-1"></a>        <span class="cn">None</span></span>
<span id="cb32-120"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb32-120" aria-hidden="true" tabindex="-1"></a>    )<span class="op">;</span></span>
<span id="cb32-121"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb32-121" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>こんな感じにほかのも実装していきます。</p>
<div class="sourceCode" id="cb33"><pre class="sourceCode rust"><code class="sourceCode rust"><span id="cb33-1"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb33-1" aria-hidden="true" tabindex="-1"></a><span class="kw">pub</span> <span class="kw">fn</span> statement(tokens<span class="op">:</span> <span class="op">&amp;</span>[Token]) <span class="op">-&gt;</span> <span class="dt">Option</span><span class="op">&lt;</span>(<span class="op">&amp;</span>[Token]<span class="op">,</span> Statement)<span class="op">&gt;</span> <span class="op">{</span></span>
<span id="cb33-2"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb33-2" aria-hidden="true" tabindex="-1"></a>    <span class="kw">fn</span> expression_s(tokens<span class="op">:</span> <span class="op">&amp;</span>[Token]) <span class="op">-&gt;</span> <span class="dt">Option</span><span class="op">&lt;</span>(<span class="op">&amp;</span>[Token]<span class="op">,</span> Statement)<span class="op">&gt;</span> <span class="op">{</span></span>
<span id="cb33-3"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb33-3" aria-hidden="true" tabindex="-1"></a>        expression(tokens)<span class="op">.</span>and_then(<span class="op">|</span>(t<span class="op">,</span> e)<span class="op">|</span> <span class="cf">match</span> t<span class="op">.</span>first() <span class="op">{</span></span>
<span id="cb33-4"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb33-4" aria-hidden="true" tabindex="-1"></a>            <span class="cn">Some</span>(<span class="pp">Token::</span>Semi) <span class="op">=&gt;</span> <span class="cn">Some</span>((<span class="op">&amp;</span>t[<span class="dv">1</span><span class="op">..</span>]<span class="op">,</span> <span class="pp">Statement::</span>Expression(e)))<span class="op">,</span></span>
<span id="cb33-5"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb33-5" aria-hidden="true" tabindex="-1"></a>            _ <span class="op">=&gt;</span> <span class="cn">None</span><span class="op">,</span></span>
<span id="cb33-6"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb33-6" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span>)</span>
<span id="cb33-7"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb33-7" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb33-8"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb33-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-9"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb33-9" aria-hidden="true" tabindex="-1"></a>    <span class="kw">fn</span> block_s(tokens<span class="op">:</span> <span class="op">&amp;</span>[Token]) <span class="op">-&gt;</span> <span class="dt">Option</span><span class="op">&lt;</span>(<span class="op">&amp;</span>[Token]<span class="op">,</span> Statement)<span class="op">&gt;</span> <span class="op">{</span></span>
<span id="cb33-10"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb33-10" aria-hidden="true" tabindex="-1"></a>        block(tokens)<span class="op">.</span>map(<span class="op">|</span>(tokens<span class="op">,</span> b)<span class="op">|</span> (tokens<span class="op">,</span> <span class="pp">Statement::</span>Block(<span class="dt">Box</span><span class="pp">::</span>new(b))))</span>
<span id="cb33-11"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb33-11" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb33-12"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb33-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-13"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb33-13" aria-hidden="true" tabindex="-1"></a>    <span class="kw">fn</span> while_s(tokens<span class="op">:</span> <span class="op">&amp;</span>[Token]) <span class="op">-&gt;</span> <span class="dt">Option</span><span class="op">&lt;</span>(<span class="op">&amp;</span>[Token]<span class="op">,</span> Statement)<span class="op">&gt;</span> <span class="op">{</span></span>
<span id="cb33-14"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb33-14" aria-hidden="true" tabindex="-1"></a>        <span class="cf">match</span> tokens<span class="op">.</span>first() <span class="op">{</span></span>
<span id="cb33-15"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb33-15" aria-hidden="true" tabindex="-1"></a>            <span class="cn">Some</span>(<span class="pp">Token::</span>While) <span class="op">=&gt;</span> <span class="op">{</span></span>
<span id="cb33-16"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb33-16" aria-hidden="true" tabindex="-1"></a>                <span class="kw">let</span> (tokens<span class="op">,</span> e) <span class="op">=</span> expression(<span class="op">&amp;</span>tokens[<span class="dv">1</span><span class="op">..</span>])<span class="op">?;</span></span>
<span id="cb33-17"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb33-17" aria-hidden="true" tabindex="-1"></a>                <span class="kw">let</span> (tokens<span class="op">,</span> b) <span class="op">=</span> block(tokens)<span class="op">?;</span></span>
<span id="cb33-18"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb33-18" aria-hidden="true" tabindex="-1"></a>                <span class="cn">Some</span>((tokens<span class="op">,</span> <span class="pp">Statement::</span>While(e<span class="op">,</span> <span class="dt">Box</span><span class="pp">::</span>new(b))))</span>
<span id="cb33-19"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb33-19" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span></span>
<span id="cb33-20"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb33-20" aria-hidden="true" tabindex="-1"></a>            _ <span class="op">=&gt;</span> <span class="cn">None</span><span class="op">,</span></span>
<span id="cb33-21"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb33-21" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb33-22"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb33-22" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb33-23"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb33-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-24"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb33-24" aria-hidden="true" tabindex="-1"></a>    expression_s(tokens)</span>
<span id="cb33-25"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb33-25" aria-hidden="true" tabindex="-1"></a>        <span class="op">.</span>or_else(<span class="op">||</span> block_s(tokens))</span>
<span id="cb33-26"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb33-26" aria-hidden="true" tabindex="-1"></a>        <span class="op">.</span>or_else(<span class="op">||</span> while_s(tokens))</span>
<span id="cb33-27"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb33-27" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb33-28"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb33-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-29"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb33-29" aria-hidden="true" tabindex="-1"></a><span class="at">#[</span>test<span class="at">]</span></span>
<span id="cb33-30"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb33-30" aria-hidden="true" tabindex="-1"></a><span class="kw">fn</span> test_statement() <span class="op">{</span></span>
<span id="cb33-31"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb33-31" aria-hidden="true" tabindex="-1"></a>    <span class="co">// ...</span></span>
<span id="cb33-32"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb33-32" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb33-33"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb33-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-34"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb33-34" aria-hidden="true" tabindex="-1"></a><span class="kw">pub</span> <span class="kw">fn</span> statements(tokens<span class="op">:</span> <span class="op">&amp;</span>[Token]) <span class="op">-&gt;</span> <span class="dt">Option</span><span class="op">&lt;</span>(<span class="op">&amp;</span>[Token]<span class="op">,</span> Statements)<span class="op">&gt;</span> <span class="op">{</span></span>
<span id="cb33-35"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb33-35" aria-hidden="true" tabindex="-1"></a>    <span class="kw">fn</span> statements_inner(init<span class="op">:</span> (<span class="op">&amp;</span>[Token]<span class="op">,</span> Statements)) <span class="op">-&gt;</span> <span class="dt">Option</span><span class="op">&lt;</span>(<span class="op">&amp;</span>[Token]<span class="op">,</span> Statements)<span class="op">&gt;</span> <span class="op">{</span></span>
<span id="cb33-36"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb33-36" aria-hidden="true" tabindex="-1"></a>        <span class="cf">match</span> statement(init<span class="op">.</span><span class="dv">0</span>) <span class="op">{</span></span>
<span id="cb33-37"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb33-37" aria-hidden="true" tabindex="-1"></a>            <span class="cn">Some</span>((tokens<span class="op">,</span> s)) <span class="op">=&gt;</span> <span class="op">{</span></span>
<span id="cb33-38"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb33-38" aria-hidden="true" tabindex="-1"></a>                statements_inner((tokens<span class="op">,</span> <span class="pp">Statements::</span>Statements(<span class="dt">Box</span><span class="pp">::</span>new(init<span class="op">.</span><span class="dv">1</span>)<span class="op">,</span> s)))</span>
<span id="cb33-39"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb33-39" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span></span>
<span id="cb33-40"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb33-40" aria-hidden="true" tabindex="-1"></a>            _ <span class="op">=&gt;</span> <span class="cn">Some</span>(init)<span class="op">,</span></span>
<span id="cb33-41"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb33-41" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb33-42"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb33-42" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb33-43"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb33-43" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-44"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb33-44" aria-hidden="true" tabindex="-1"></a>    statement(tokens)<span class="op">.</span>and_then(<span class="op">|</span>(tokens<span class="op">,</span> s)<span class="op">|</span> statements_inner((tokens<span class="op">,</span> <span class="pp">Statements::</span>Statement(s))))</span>
<span id="cb33-45"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb33-45" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb33-46"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb33-46" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-47"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb33-47" aria-hidden="true" tabindex="-1"></a><span class="at">#[</span>test<span class="at">]</span></span>
<span id="cb33-48"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb33-48" aria-hidden="true" tabindex="-1"></a><span class="kw">fn</span> test_statements() <span class="op">{</span></span>
<span id="cb33-49"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb33-49" aria-hidden="true" tabindex="-1"></a>    <span class="co">// ...</span></span>
<span id="cb33-50"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb33-50" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb33-51"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb33-51" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-52"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb33-52" aria-hidden="true" tabindex="-1"></a><span class="kw">pub</span> <span class="kw">fn</span> block(tokens<span class="op">:</span> <span class="op">&amp;</span>[Token]) <span class="op">-&gt;</span> <span class="dt">Option</span><span class="op">&lt;</span>(<span class="op">&amp;</span>[Token]<span class="op">,</span> Block)<span class="op">&gt;</span> <span class="op">{</span></span>
<span id="cb33-53"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb33-53" aria-hidden="true" tabindex="-1"></a>    tokens<span class="op">.</span>first()<span class="op">.</span>filter(<span class="op">|</span>t<span class="op">|</span> <span class="op">**</span>t <span class="op">==</span> <span class="pp">Token::</span>CurlyOpen)<span class="op">?;</span></span>
<span id="cb33-54"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb33-54" aria-hidden="true" tabindex="-1"></a>    <span class="kw">let</span> (tokens<span class="op">,</span> s) <span class="op">=</span> statements(<span class="op">&amp;</span>tokens[<span class="dv">1</span><span class="op">..</span>])<span class="op">?;</span></span>
<span id="cb33-55"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb33-55" aria-hidden="true" tabindex="-1"></a>    tokens<span class="op">.</span>first()<span class="op">.</span>filter(<span class="op">|</span>t<span class="op">|</span> <span class="op">**</span>t <span class="op">==</span> <span class="pp">Token::</span>CurlyClose)<span class="op">?;</span></span>
<span id="cb33-56"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb33-56" aria-hidden="true" tabindex="-1"></a>    <span class="cn">Some</span>((<span class="op">&amp;</span>tokens[<span class="dv">1</span><span class="op">..</span>]<span class="op">,</span> <span class="pp">Block::</span>Statements(s)))</span>
<span id="cb33-57"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb33-57" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb33-58"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb33-58" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-59"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb33-59" aria-hidden="true" tabindex="-1"></a><span class="at">#[</span>test<span class="at">]</span></span>
<span id="cb33-60"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb33-60" aria-hidden="true" tabindex="-1"></a><span class="kw">fn</span> test_block() <span class="op">{</span></span>
<span id="cb33-61"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb33-61" aria-hidden="true" tabindex="-1"></a>    <span class="co">// ...</span></span>
<span id="cb33-62"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb33-62" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb33-63"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb33-63" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-64"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb33-64" aria-hidden="true" tabindex="-1"></a><span class="kw">pub</span> <span class="kw">fn</span> program(tokens<span class="op">:</span> <span class="op">&amp;</span>[Token]) <span class="op">-&gt;</span> <span class="dt">Option</span><span class="op">&lt;</span>(<span class="op">&amp;</span>[Token]<span class="op">,</span> Program)<span class="op">&gt;</span> <span class="op">{</span></span>
<span id="cb33-65"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb33-65" aria-hidden="true" tabindex="-1"></a>    statements(tokens)<span class="op">.</span>map(<span class="op">|</span>(tokens<span class="op">,</span> s)<span class="op">|</span> (tokens<span class="op">,</span> <span class="pp">Program::</span>Statements(s)))</span>
<span id="cb33-66"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb33-66" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb33-67"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb33-67" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-68"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb33-68" aria-hidden="true" tabindex="-1"></a><span class="at">#[</span>test<span class="at">]</span></span>
<span id="cb33-69"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb33-69" aria-hidden="true" tabindex="-1"></a><span class="kw">fn</span> test_program() <span class="op">{</span></span>
<span id="cb33-70"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb33-70" aria-hidden="true" tabindex="-1"></a>    <span class="pp">assert_eq!</span>(program(<span class="op">&amp;</span>[])<span class="op">,</span> <span class="cn">None</span>)<span class="op">;</span></span>
<span id="cb33-71"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb33-71" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-72"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb33-72" aria-hidden="true" tabindex="-1"></a>    <span class="pp">assert_eq!</span>(</span>
<span id="cb33-73"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb33-73" aria-hidden="true" tabindex="-1"></a>        program(<span class="op">&amp;</span>[</span>
<span id="cb33-74"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb33-74" aria-hidden="true" tabindex="-1"></a>            <span class="pp">Token::</span>Identifier(<span class="st">&quot;hoge&quot;</span><span class="op">.</span>to_owned())<span class="op">,</span></span>
<span id="cb33-75"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb33-75" aria-hidden="true" tabindex="-1"></a>            <span class="pp">Token::</span>PlusEq<span class="op">,</span></span>
<span id="cb33-76"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb33-76" aria-hidden="true" tabindex="-1"></a>            <span class="pp">Token::</span>Integer(<span class="dv">123</span>)<span class="op">,</span></span>
<span id="cb33-77"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb33-77" aria-hidden="true" tabindex="-1"></a>            <span class="pp">Token::</span>Semi<span class="op">,</span></span>
<span id="cb33-78"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb33-78" aria-hidden="true" tabindex="-1"></a>        ])<span class="op">,</span></span>
<span id="cb33-79"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb33-79" aria-hidden="true" tabindex="-1"></a>        <span class="cn">Some</span>((</span>
<span id="cb33-80"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb33-80" aria-hidden="true" tabindex="-1"></a>            <span class="op">&amp;</span>[] <span class="kw">as</span> <span class="op">&amp;</span>[Token]<span class="op">,</span></span>
<span id="cb33-81"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb33-81" aria-hidden="true" tabindex="-1"></a>            <span class="pp">Program::</span>Statements(<span class="pp">Statements::</span>Statement(<span class="pp">Statement::</span>Expression(</span>
<span id="cb33-82"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb33-82" aria-hidden="true" tabindex="-1"></a>                <span class="pp">Expression::</span>AssignAdd(<span class="pp">Lhs::</span><span class="bu">Pointer</span>(<span class="st">&quot;hoge&quot;</span><span class="op">.</span>to_owned())<span class="op">,</span> <span class="pp">Rhs::</span>Number(<span class="dv">123</span>))</span>
<span id="cb33-83"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb33-83" aria-hidden="true" tabindex="-1"></a>            )))</span>
<span id="cb33-84"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb33-84" aria-hidden="true" tabindex="-1"></a>        ))</span>
<span id="cb33-85"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb33-85" aria-hidden="true" tabindex="-1"></a>    )<span class="op">;</span></span>
<span id="cb33-86"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb33-86" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-87"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb33-87" aria-hidden="true" tabindex="-1"></a>    <span class="pp">assert_eq!</span>(</span>
<span id="cb33-88"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb33-88" aria-hidden="true" tabindex="-1"></a>        program(<span class="op">&amp;</span>[</span>
<span id="cb33-89"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb33-89" aria-hidden="true" tabindex="-1"></a>            <span class="pp">Token::</span>Identifier(<span class="st">&quot;hoge&quot;</span><span class="op">.</span>to_owned())<span class="op">,</span></span>
<span id="cb33-90"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb33-90" aria-hidden="true" tabindex="-1"></a>            <span class="pp">Token::</span>PlusEq<span class="op">,</span></span>
<span id="cb33-91"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb33-91" aria-hidden="true" tabindex="-1"></a>            <span class="pp">Token::</span>Integer(<span class="dv">123</span>)<span class="op">,</span></span>
<span id="cb33-92"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb33-92" aria-hidden="true" tabindex="-1"></a>            <span class="pp">Token::</span>Semi<span class="op">,</span></span>
<span id="cb33-93"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb33-93" aria-hidden="true" tabindex="-1"></a>            <span class="pp">Token::</span>Star<span class="op">,</span></span>
<span id="cb33-94"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb33-94" aria-hidden="true" tabindex="-1"></a>            <span class="pp">Token::</span>Identifier(<span class="st">&quot;hoge&quot;</span><span class="op">.</span>to_owned())<span class="op">,</span></span>
<span id="cb33-95"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb33-95" aria-hidden="true" tabindex="-1"></a>            <span class="pp">Token::</span>PlusEq<span class="op">,</span></span>
<span id="cb33-96"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb33-96" aria-hidden="true" tabindex="-1"></a>            <span class="pp">Token::</span>Integer(<span class="dv">123</span>)<span class="op">,</span></span>
<span id="cb33-97"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb33-97" aria-hidden="true" tabindex="-1"></a>            <span class="pp">Token::</span>Semi<span class="op">,</span></span>
<span id="cb33-98"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb33-98" aria-hidden="true" tabindex="-1"></a>        ])<span class="op">,</span></span>
<span id="cb33-99"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb33-99" aria-hidden="true" tabindex="-1"></a>        <span class="cn">Some</span>((</span>
<span id="cb33-100"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb33-100" aria-hidden="true" tabindex="-1"></a>            <span class="op">&amp;</span>[] <span class="kw">as</span> <span class="op">&amp;</span>[Token]<span class="op">,</span></span>
<span id="cb33-101"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb33-101" aria-hidden="true" tabindex="-1"></a>            <span class="pp">Program::</span>Statements(<span class="pp">Statements::</span>Statements(</span>
<span id="cb33-102"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb33-102" aria-hidden="true" tabindex="-1"></a>                <span class="dt">Box</span><span class="pp">::</span>new(<span class="pp">Statements::</span>Statement(<span class="pp">Statement::</span>Expression(</span>
<span id="cb33-103"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb33-103" aria-hidden="true" tabindex="-1"></a>                    <span class="pp">Expression::</span>AssignAdd(<span class="pp">Lhs::</span><span class="bu">Pointer</span>(<span class="st">&quot;hoge&quot;</span><span class="op">.</span>to_owned())<span class="op">,</span> <span class="pp">Rhs::</span>Number(<span class="dv">123</span>))</span>
<span id="cb33-104"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb33-104" aria-hidden="true" tabindex="-1"></a>                )))<span class="op">,</span></span>
<span id="cb33-105"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb33-105" aria-hidden="true" tabindex="-1"></a>                <span class="pp">Statement::</span>Expression(<span class="pp">Expression::</span>AssignAdd(</span>
<span id="cb33-106"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb33-106" aria-hidden="true" tabindex="-1"></a>                    <span class="pp">Lhs::</span>Dereference(<span class="st">&quot;hoge&quot;</span><span class="op">.</span>to_owned())<span class="op">,</span></span>
<span id="cb33-107"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb33-107" aria-hidden="true" tabindex="-1"></a>                    <span class="pp">Rhs::</span>Number(<span class="dv">123</span>)</span>
<span id="cb33-108"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb33-108" aria-hidden="true" tabindex="-1"></a>                ))</span>
<span id="cb33-109"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb33-109" aria-hidden="true" tabindex="-1"></a>            ))</span>
<span id="cb33-110"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb33-110" aria-hidden="true" tabindex="-1"></a>        ))</span>
<span id="cb33-111"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb33-111" aria-hidden="true" tabindex="-1"></a>    )<span class="op">;</span></span>
<span id="cb33-112"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb33-112" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>これで <code>program()</code> にトークン列を渡すことで構文木を組み立てることができるようになりました。ちなみに今回のトークン列 <code>tokens</code> を連れ回す実装をもっといい感じに書けないのかなーと思った方はぜひ “Monadic Parsing” などと検索してみましょう。きっとまた新しいプログラミングの世界に出会えるはずです。</p>
<h2 id="構文木からコードを生成する">構文木からコードを生成する</h2>
<p>構文木を作れるようになったので、今度は構文木に対応するコードを出力できるようにしていきます。<a href="https://github.com/Tosainu/chiya/blob/b299a566dd45e919ff42dbf879e684ed641843ef/src/codegen.rs" target="_blank" rel="nofollow noopener"><code>src/codegen.rs</code></a> にこんな感じの実装を追加しました。関数 <code>gen()</code> で構文木を <code>Program</code> からたどっていき、必要な箇所で <code>Emitter</code> の各種メソッドを呼び出してコードを生成したり、生成されたコードを結合したりする感じです。</p>
<div class="sourceCode" id="cb34"><pre class="sourceCode rust"><code class="sourceCode rust"><span id="cb34-1"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb34-1" aria-hidden="true" tabindex="-1"></a><span class="kw">use</span> <span class="kw">crate</span><span class="pp">::parser::</span><span class="op">{</span>Block<span class="op">,</span> Expression<span class="op">,</span> Lhs<span class="op">,</span> Program<span class="op">,</span> Rhs<span class="op">,</span> Statement<span class="op">,</span> Statements<span class="op">};</span></span>
<span id="cb34-2"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb34-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-3"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb34-3" aria-hidden="true" tabindex="-1"></a><span class="at">#[</span>derive<span class="at">(</span><span class="bu">Debug</span><span class="op">,</span> <span class="bu">PartialEq</span><span class="op">,</span> <span class="pp">failure::</span>Fail<span class="at">)]</span></span>
<span id="cb34-4"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb34-4" aria-hidden="true" tabindex="-1"></a><span class="kw">pub</span> <span class="kw">enum</span> CodegenError <span class="op">{</span></span>
<span id="cb34-5"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb34-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">#[</span>fail<span class="at">(</span>display <span class="op">=</span> <span class="st">&quot;invalid variable name: &#39;{}&#39;&quot;</span><span class="op">,</span> name<span class="at">)]</span></span>
<span id="cb34-6"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb34-6" aria-hidden="true" tabindex="-1"></a>    InvalidVariableName <span class="op">{</span> name<span class="op">:</span> <span class="dt">String</span> <span class="op">},</span></span>
<span id="cb34-7"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb34-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-8"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb34-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">#[</span>fail<span class="at">(</span>display <span class="op">=</span> <span class="st">&quot;invalid function name: &#39;{}&#39;&quot;</span><span class="op">,</span> name<span class="at">)]</span></span>
<span id="cb34-9"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb34-9" aria-hidden="true" tabindex="-1"></a>    InvalidFunctionName <span class="op">{</span> name<span class="op">:</span> <span class="dt">String</span> <span class="op">},</span></span>
<span id="cb34-10"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb34-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-11"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb34-11" aria-hidden="true" tabindex="-1"></a>    <span class="at">#[</span>fail<span class="at">(</span>display <span class="op">=</span> <span class="st">&quot;not implemented&quot;</span><span class="at">)]</span></span>
<span id="cb34-12"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb34-12" aria-hidden="true" tabindex="-1"></a>    NotImplemented<span class="op">,</span></span>
<span id="cb34-13"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb34-13" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb34-14"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb34-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-15"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb34-15" aria-hidden="true" tabindex="-1"></a><span class="kw">pub</span> <span class="kw">fn</span> gen<span class="op">&lt;</span>E<span class="op">:</span> <span class="pp">emitter::</span>Emitter<span class="op">&gt;</span>(emitter<span class="op">:</span> <span class="op">&amp;</span><span class="kw">mut</span> E<span class="op">,</span> tree<span class="op">:</span> <span class="op">&amp;</span>Program) <span class="op">-&gt;</span> <span class="dt">Result</span><span class="op">&lt;</span><span class="dt">String</span><span class="op">,</span> CodegenError<span class="op">&gt;</span> <span class="op">{</span></span>
<span id="cb34-16"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb34-16" aria-hidden="true" tabindex="-1"></a>    <span class="cf">match</span> tree <span class="op">{</span></span>
<span id="cb34-17"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb34-17" aria-hidden="true" tabindex="-1"></a>        <span class="pp">Program::</span>Statements(ss) <span class="op">=&gt;</span> <span class="op">{</span></span>
<span id="cb34-18"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb34-18" aria-hidden="true" tabindex="-1"></a>            <span class="kw">let</span> header <span class="op">=</span> emitter<span class="op">.</span>emit_header()<span class="op">;</span></span>
<span id="cb34-19"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb34-19" aria-hidden="true" tabindex="-1"></a>            <span class="kw">let</span> body <span class="op">=</span> statements(emitter<span class="op">,</span> ss)<span class="op">?;</span></span>
<span id="cb34-20"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb34-20" aria-hidden="true" tabindex="-1"></a>            <span class="kw">let</span> footer <span class="op">=</span> emitter<span class="op">.</span>emit_footer()<span class="op">;</span></span>
<span id="cb34-21"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb34-21" aria-hidden="true" tabindex="-1"></a>            <span class="cn">Ok</span>(<span class="pp">format!</span>(<span class="st">&quot;{}{}{}&quot;</span><span class="op">,</span> header<span class="op">,</span> body<span class="op">,</span> footer))</span>
<span id="cb34-22"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb34-22" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb34-23"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb34-23" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb34-24"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb34-24" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb34-25"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb34-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-26"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb34-26" aria-hidden="true" tabindex="-1"></a><span class="kw">fn</span> statements<span class="op">&lt;</span>E<span class="op">:</span> <span class="pp">emitter::</span>Emitter<span class="op">&gt;</span>(</span>
<span id="cb34-27"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb34-27" aria-hidden="true" tabindex="-1"></a>    emitter<span class="op">:</span> <span class="op">&amp;</span><span class="kw">mut</span> E<span class="op">,</span></span>
<span id="cb34-28"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb34-28" aria-hidden="true" tabindex="-1"></a>    tree<span class="op">:</span> <span class="op">&amp;</span>Statements<span class="op">,</span></span>
<span id="cb34-29"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb34-29" aria-hidden="true" tabindex="-1"></a>) <span class="op">-&gt;</span> <span class="dt">Result</span><span class="op">&lt;</span><span class="dt">String</span><span class="op">,</span> CodegenError<span class="op">&gt;</span> <span class="op">{</span></span>
<span id="cb34-30"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb34-30" aria-hidden="true" tabindex="-1"></a>    <span class="cf">match</span> tree <span class="op">{</span></span>
<span id="cb34-31"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb34-31" aria-hidden="true" tabindex="-1"></a>        <span class="pp">Statements::</span>Statement(s) <span class="op">=&gt;</span> statement(emitter<span class="op">,</span> s)<span class="op">,</span></span>
<span id="cb34-32"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb34-32" aria-hidden="true" tabindex="-1"></a>        <span class="pp">Statements::</span>Statements(ss<span class="op">,</span> s) <span class="op">=&gt;</span> statements(emitter<span class="op">,</span> ss)</span>
<span id="cb34-33"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb34-33" aria-hidden="true" tabindex="-1"></a>            <span class="op">.</span>and_then(<span class="op">|</span>s0<span class="op">|</span> statement(emitter<span class="op">,</span> s)<span class="op">.</span>map(<span class="op">|</span>s1<span class="op">|</span> <span class="pp">format!</span>(<span class="st">&quot;{}{}&quot;</span><span class="op">,</span> s0<span class="op">,</span> s1)))<span class="op">,</span></span>
<span id="cb34-34"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb34-34" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb34-35"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb34-35" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb34-36"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb34-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-37"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb34-37" aria-hidden="true" tabindex="-1"></a><span class="kw">fn</span> statement<span class="op">&lt;</span>E<span class="op">:</span> <span class="pp">emitter::</span>Emitter<span class="op">&gt;</span>(</span>
<span id="cb34-38"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb34-38" aria-hidden="true" tabindex="-1"></a>    emitter<span class="op">:</span> <span class="op">&amp;</span><span class="kw">mut</span> E<span class="op">,</span></span>
<span id="cb34-39"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb34-39" aria-hidden="true" tabindex="-1"></a>    tree<span class="op">:</span> <span class="op">&amp;</span>Statement<span class="op">,</span></span>
<span id="cb34-40"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb34-40" aria-hidden="true" tabindex="-1"></a>) <span class="op">-&gt;</span> <span class="dt">Result</span><span class="op">&lt;</span><span class="dt">String</span><span class="op">,</span> CodegenError<span class="op">&gt;</span> <span class="op">{</span></span>
<span id="cb34-41"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb34-41" aria-hidden="true" tabindex="-1"></a>    <span class="cf">match</span> tree <span class="op">{</span></span>
<span id="cb34-42"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb34-42" aria-hidden="true" tabindex="-1"></a>        <span class="pp">Statement::</span>Expression(e) <span class="op">=&gt;</span> expression(emitter<span class="op">,</span> e)<span class="op">,</span></span>
<span id="cb34-43"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb34-43" aria-hidden="true" tabindex="-1"></a>        <span class="pp">Statement::</span>Block(b) <span class="op">=&gt;</span> block(emitter<span class="op">,</span> b)<span class="op">,</span></span>
<span id="cb34-44"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb34-44" aria-hidden="true" tabindex="-1"></a>        <span class="pp">Statement::</span>While(e<span class="op">,</span> b) <span class="op">=&gt;</span> while_s(emitter<span class="op">,</span> e<span class="op">,</span> b)<span class="op">,</span></span>
<span id="cb34-45"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb34-45" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb34-46"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb34-46" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb34-47"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb34-47" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-48"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb34-48" aria-hidden="true" tabindex="-1"></a><span class="kw">fn</span> block<span class="op">&lt;</span>E<span class="op">:</span> <span class="pp">emitter::</span>Emitter<span class="op">&gt;</span>(emitter<span class="op">:</span> <span class="op">&amp;</span><span class="kw">mut</span> E<span class="op">,</span> tree<span class="op">:</span> <span class="op">&amp;</span>Block) <span class="op">-&gt;</span> <span class="dt">Result</span><span class="op">&lt;</span><span class="dt">String</span><span class="op">,</span> CodegenError<span class="op">&gt;</span> <span class="op">{</span></span>
<span id="cb34-49"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb34-49" aria-hidden="true" tabindex="-1"></a>    <span class="cf">match</span> tree <span class="op">{</span></span>
<span id="cb34-50"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb34-50" aria-hidden="true" tabindex="-1"></a>        <span class="pp">Block::</span>Statements(ss) <span class="op">=&gt;</span> statements(emitter<span class="op">,</span> ss)<span class="op">,</span></span>
<span id="cb34-51"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb34-51" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb34-52"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb34-52" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb34-53"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb34-53" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-54"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb34-54" aria-hidden="true" tabindex="-1"></a><span class="kw">fn</span> expression<span class="op">&lt;</span>E<span class="op">:</span> <span class="pp">emitter::</span>Emitter<span class="op">&gt;</span>(</span>
<span id="cb34-55"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb34-55" aria-hidden="true" tabindex="-1"></a>    emitter<span class="op">:</span> <span class="op">&amp;</span><span class="kw">mut</span> E<span class="op">,</span></span>
<span id="cb34-56"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb34-56" aria-hidden="true" tabindex="-1"></a>    tree<span class="op">:</span> <span class="op">&amp;</span>Expression<span class="op">,</span></span>
<span id="cb34-57"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb34-57" aria-hidden="true" tabindex="-1"></a>) <span class="op">-&gt;</span> <span class="dt">Result</span><span class="op">&lt;</span><span class="dt">String</span><span class="op">,</span> CodegenError<span class="op">&gt;</span> <span class="op">{</span></span>
<span id="cb34-58"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb34-58" aria-hidden="true" tabindex="-1"></a>    <span class="co">// ...</span></span>
<span id="cb34-59"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb34-59" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb34-60"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb34-60" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-61"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb34-61" aria-hidden="true" tabindex="-1"></a><span class="kw">fn</span> while_s<span class="op">&lt;</span>E<span class="op">:</span> <span class="pp">emitter::</span>Emitter<span class="op">&gt;</span>(</span>
<span id="cb34-62"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb34-62" aria-hidden="true" tabindex="-1"></a>    emitter<span class="op">:</span> <span class="op">&amp;</span><span class="kw">mut</span> E<span class="op">,</span></span>
<span id="cb34-63"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb34-63" aria-hidden="true" tabindex="-1"></a>    cond<span class="op">:</span> <span class="op">&amp;</span>Expression<span class="op">,</span></span>
<span id="cb34-64"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb34-64" aria-hidden="true" tabindex="-1"></a>    body<span class="op">:</span> <span class="op">&amp;</span>Block<span class="op">,</span></span>
<span id="cb34-65"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb34-65" aria-hidden="true" tabindex="-1"></a>) <span class="op">-&gt;</span> <span class="dt">Result</span><span class="op">&lt;</span><span class="dt">String</span><span class="op">,</span> CodegenError<span class="op">&gt;</span> <span class="op">{</span></span>
<span id="cb34-66"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb34-66" aria-hidden="true" tabindex="-1"></a>    <span class="cf">match</span> cond <span class="op">{</span></span>
<span id="cb34-67"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb34-67" aria-hidden="true" tabindex="-1"></a>        <span class="pp">Expression::</span>Lhs(<span class="pp">Lhs::</span>Dereference(ptr)) <span class="op">=&gt;</span> <span class="op">{</span></span>
<span id="cb34-68"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb34-68" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> ptr <span class="op">!=</span> <span class="st">&quot;ptr&quot;</span> <span class="op">{</span></span>
<span id="cb34-69"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb34-69" aria-hidden="true" tabindex="-1"></a>                <span class="cn">Err</span>(<span class="pp">CodegenError::</span>InvalidVariableName <span class="op">{</span></span>
<span id="cb34-70"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb34-70" aria-hidden="true" tabindex="-1"></a>                    name<span class="op">:</span> ptr<span class="op">.</span>to_string()<span class="op">,</span></span>
<span id="cb34-71"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb34-71" aria-hidden="true" tabindex="-1"></a>                <span class="op">}</span>)</span>
<span id="cb34-72"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb34-72" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span> <span class="cf">else</span> <span class="op">{</span></span>
<span id="cb34-73"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb34-73" aria-hidden="true" tabindex="-1"></a>                <span class="kw">let</span> header <span class="op">=</span> emitter<span class="op">.</span>emit_loop_begin()<span class="op">;</span></span>
<span id="cb34-74"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb34-74" aria-hidden="true" tabindex="-1"></a>                <span class="kw">let</span> body <span class="op">=</span> block(emitter<span class="op">,</span> body)<span class="op">?;</span></span>
<span id="cb34-75"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb34-75" aria-hidden="true" tabindex="-1"></a>                <span class="kw">let</span> footer <span class="op">=</span> emitter<span class="op">.</span>emit_loop_end()<span class="op">;</span></span>
<span id="cb34-76"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb34-76" aria-hidden="true" tabindex="-1"></a>                <span class="cn">Ok</span>(<span class="pp">format!</span>(<span class="st">&quot;{}{}{}&quot;</span><span class="op">,</span> header<span class="op">,</span> body<span class="op">,</span> footer))</span>
<span id="cb34-77"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb34-77" aria-hidden="true" tabindex="-1"></a>            <span class="op">}</span></span>
<span id="cb34-78"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb34-78" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb34-79"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb34-79" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-80"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb34-80" aria-hidden="true" tabindex="-1"></a>        _ <span class="op">=&gt;</span> <span class="cn">Err</span>(<span class="pp">CodegenError::</span>NotImplemented)<span class="op">,</span></span>
<span id="cb34-81"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb34-81" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb34-82"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb34-82" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p><code>expression()</code> はこんな感じになっています。<code>Emitter</code> の <code>emit_move_ptr()</code>, <code>emit_add()</code>, <code>emit_call_{putchar,emitter}()</code> メソッドのラッパのような関数 <code>move_ptr()</code>, <code>add()</code>, <code>function_call()</code> を作り、<code>Expression</code> のパターンマッチで対応する関数を呼び出しています。</p>
<div class="sourceCode" id="cb35"><pre class="sourceCode rust"><code class="sourceCode rust"><span id="cb35-1"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb35-1" aria-hidden="true" tabindex="-1"></a><span class="kw">fn</span> expression<span class="op">&lt;</span>E<span class="op">:</span> <span class="pp">emitter::</span>Emitter<span class="op">&gt;</span>(</span>
<span id="cb35-2"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb35-2" aria-hidden="true" tabindex="-1"></a>    emitter<span class="op">:</span> <span class="op">&amp;</span><span class="kw">mut</span> E<span class="op">,</span></span>
<span id="cb35-3"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb35-3" aria-hidden="true" tabindex="-1"></a>    tree<span class="op">:</span> <span class="op">&amp;</span>Expression<span class="op">,</span></span>
<span id="cb35-4"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb35-4" aria-hidden="true" tabindex="-1"></a>) <span class="op">-&gt;</span> <span class="dt">Result</span><span class="op">&lt;</span><span class="dt">String</span><span class="op">,</span> CodegenError<span class="op">&gt;</span> <span class="op">{</span></span>
<span id="cb35-5"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb35-5" aria-hidden="true" tabindex="-1"></a>    <span class="cf">match</span> tree <span class="op">{</span></span>
<span id="cb35-6"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb35-6" aria-hidden="true" tabindex="-1"></a>        <span class="pp">Expression::</span>AssignAdd(<span class="pp">Lhs::</span><span class="bu">Pointer</span>(p)<span class="op">,</span> <span class="pp">Rhs::</span>Number(n)) <span class="op">=&gt;</span> move_ptr(emitter<span class="op">,</span> p<span class="op">,</span> <span class="op">*</span>n)<span class="op">,</span></span>
<span id="cb35-7"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb35-7" aria-hidden="true" tabindex="-1"></a>        <span class="pp">Expression::</span>AssignSub(<span class="pp">Lhs::</span><span class="bu">Pointer</span>(p)<span class="op">,</span> <span class="pp">Rhs::</span>Number(n)) <span class="op">=&gt;</span> move_ptr(emitter<span class="op">,</span> p<span class="op">,</span> <span class="op">-*</span>n)<span class="op">,</span></span>
<span id="cb35-8"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb35-8" aria-hidden="true" tabindex="-1"></a>        <span class="pp">Expression::</span>AssignAdd(<span class="pp">Lhs::</span>Dereference(p)<span class="op">,</span> <span class="pp">Rhs::</span>Number(n)) <span class="op">=&gt;</span> add(emitter<span class="op">,</span> p<span class="op">,</span> <span class="op">*</span>n)<span class="op">,</span></span>
<span id="cb35-9"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb35-9" aria-hidden="true" tabindex="-1"></a>        <span class="pp">Expression::</span>AssignSub(<span class="pp">Lhs::</span>Dereference(p)<span class="op">,</span> <span class="pp">Rhs::</span>Number(n)) <span class="op">=&gt;</span> add(emitter<span class="op">,</span> p<span class="op">,</span> <span class="op">-*</span>n)<span class="op">,</span></span>
<span id="cb35-10"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb35-10" aria-hidden="true" tabindex="-1"></a>        <span class="pp">Expression::</span>FunctionCall(<span class="pp">Lhs::</span><span class="bu">Pointer</span>(p)) <span class="op">=&gt;</span> function_call(emitter<span class="op">,</span> p)<span class="op">,</span></span>
<span id="cb35-11"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb35-11" aria-hidden="true" tabindex="-1"></a>        _ <span class="op">=&gt;</span> <span class="cn">Err</span>(<span class="pp">CodegenError::</span>NotImplemented)<span class="op">,</span></span>
<span id="cb35-12"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb35-12" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb35-13"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb35-13" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb35-14"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb35-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-15"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb35-15" aria-hidden="true" tabindex="-1"></a><span class="kw">fn</span> move_ptr<span class="op">&lt;</span>E<span class="op">:</span> <span class="pp">emitter::</span>Emitter<span class="op">&gt;</span>(</span>
<span id="cb35-16"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb35-16" aria-hidden="true" tabindex="-1"></a>    emitter<span class="op">:</span> <span class="op">&amp;</span><span class="kw">mut</span> E<span class="op">,</span></span>
<span id="cb35-17"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb35-17" aria-hidden="true" tabindex="-1"></a>    ptr<span class="op">:</span> <span class="op">&amp;</span><span class="dt">str</span><span class="op">,</span></span>
<span id="cb35-18"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb35-18" aria-hidden="true" tabindex="-1"></a>    offset<span class="op">:</span> <span class="dt">i32</span><span class="op">,</span></span>
<span id="cb35-19"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb35-19" aria-hidden="true" tabindex="-1"></a>) <span class="op">-&gt;</span> <span class="dt">Result</span><span class="op">&lt;</span><span class="dt">String</span><span class="op">,</span> CodegenError<span class="op">&gt;</span> <span class="op">{</span></span>
<span id="cb35-20"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb35-20" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> ptr <span class="op">!=</span> <span class="st">&quot;ptr&quot;</span> <span class="op">{</span></span>
<span id="cb35-21"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb35-21" aria-hidden="true" tabindex="-1"></a>        <span class="cn">Err</span>(<span class="pp">CodegenError::</span>InvalidVariableName <span class="op">{</span></span>
<span id="cb35-22"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb35-22" aria-hidden="true" tabindex="-1"></a>            name<span class="op">:</span> ptr<span class="op">.</span>to_string()<span class="op">,</span></span>
<span id="cb35-23"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb35-23" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span>)</span>
<span id="cb35-24"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb35-24" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span> <span class="cf">else</span> <span class="op">{</span></span>
<span id="cb35-25"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb35-25" aria-hidden="true" tabindex="-1"></a>        <span class="cn">Ok</span>(emitter<span class="op">.</span>emit_move_ptr(offset))</span>
<span id="cb35-26"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb35-26" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb35-27"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb35-27" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb35-28"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb35-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-29"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb35-29" aria-hidden="true" tabindex="-1"></a><span class="kw">fn</span> add<span class="op">&lt;</span>E<span class="op">:</span> <span class="pp">emitter::</span>Emitter<span class="op">&gt;</span>(emitter<span class="op">:</span> <span class="op">&amp;</span><span class="kw">mut</span> E<span class="op">,</span> ptr<span class="op">:</span> <span class="op">&amp;</span><span class="dt">str</span><span class="op">,</span> n<span class="op">:</span> <span class="dt">i32</span>) <span class="op">-&gt;</span> <span class="dt">Result</span><span class="op">&lt;</span><span class="dt">String</span><span class="op">,</span> CodegenError<span class="op">&gt;</span> <span class="op">{</span></span>
<span id="cb35-30"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb35-30" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> ptr <span class="op">!=</span> <span class="st">&quot;ptr&quot;</span> <span class="op">{</span></span>
<span id="cb35-31"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb35-31" aria-hidden="true" tabindex="-1"></a>        <span class="cn">Err</span>(<span class="pp">CodegenError::</span>InvalidVariableName <span class="op">{</span></span>
<span id="cb35-32"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb35-32" aria-hidden="true" tabindex="-1"></a>            name<span class="op">:</span> ptr<span class="op">.</span>to_string()<span class="op">,</span></span>
<span id="cb35-33"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb35-33" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span>)</span>
<span id="cb35-34"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb35-34" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span> <span class="cf">else</span> <span class="op">{</span></span>
<span id="cb35-35"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb35-35" aria-hidden="true" tabindex="-1"></a>        <span class="cn">Ok</span>(emitter<span class="op">.</span>emit_add(n))</span>
<span id="cb35-36"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb35-36" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb35-37"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb35-37" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb35-38"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb35-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-39"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb35-39" aria-hidden="true" tabindex="-1"></a><span class="kw">fn</span> function_call<span class="op">&lt;</span>E<span class="op">:</span> <span class="pp">emitter::</span>Emitter<span class="op">&gt;</span>(</span>
<span id="cb35-40"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb35-40" aria-hidden="true" tabindex="-1"></a>    emitter<span class="op">:</span> <span class="op">&amp;</span><span class="kw">mut</span> E<span class="op">,</span></span>
<span id="cb35-41"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb35-41" aria-hidden="true" tabindex="-1"></a>    funcname<span class="op">:</span> <span class="op">&amp;</span><span class="dt">str</span><span class="op">,</span></span>
<span id="cb35-42"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb35-42" aria-hidden="true" tabindex="-1"></a>) <span class="op">-&gt;</span> <span class="dt">Result</span><span class="op">&lt;</span><span class="dt">String</span><span class="op">,</span> CodegenError<span class="op">&gt;</span> <span class="op">{</span></span>
<span id="cb35-43"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb35-43" aria-hidden="true" tabindex="-1"></a>    <span class="cf">match</span> funcname <span class="op">{</span></span>
<span id="cb35-44"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb35-44" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;getchar&quot;</span> <span class="op">=&gt;</span> <span class="cn">Ok</span>(emitter<span class="op">.</span>emit_call_getchar())<span class="op">,</span></span>
<span id="cb35-45"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb35-45" aria-hidden="true" tabindex="-1"></a>        <span class="st">&quot;putchar&quot;</span> <span class="op">=&gt;</span> <span class="cn">Ok</span>(emitter<span class="op">.</span>emit_call_putchar())<span class="op">,</span></span>
<span id="cb35-46"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb35-46" aria-hidden="true" tabindex="-1"></a>        _ <span class="op">=&gt;</span> <span class="cn">Err</span>(<span class="pp">CodegenError::</span>InvalidFunctionName <span class="op">{</span></span>
<span id="cb35-47"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb35-47" aria-hidden="true" tabindex="-1"></a>            name<span class="op">:</span> funcname<span class="op">.</span>to_string()<span class="op">,</span></span>
<span id="cb35-48"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb35-48" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span>)<span class="op">,</span></span>
<span id="cb35-49"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb35-49" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb35-50"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb35-50" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<h2 id="全部を組み合わせてみる">全部を組み合わせてみる</h2>
<p>必要なものは揃ったので、これらを組み合わせてみます。<a href="https://github.com/Tosainu/chiya/blob/54f3e9ba782222477a437d3517e6738ad3261824/src/bin/chiya.rs" target="_blank" rel="nofollow noopener"><code>src/bin/chiya.rs</code></a> をこんな感じに変更しました。標準入力から読んだ文字列を、字句解析、構文解析、コード生成と順番に渡しているだけです。実行時、コマンドラインに <code>--debug</code> オプションが付いていたときにはトークン列と構文木を確認できるようにしています。また、<a href="/entry/2019/10/21/make-own-language-and-compiler/#とりあえず動かしてみる">最初に実装した Brainf**k のコンパイル処理</a>はせっかくなので <code>compile_bf()</code> 関数に切り出してコマンドラインオプション <code>--bf</code> の有無で切り替えられるようにしてみました。</p>
<div class="sourceCode" id="cb36"><pre class="sourceCode rust"><code class="sourceCode rust"><span id="cb36-1"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb36-1" aria-hidden="true" tabindex="-1"></a><span class="kw">use</span> <span class="pp">std::io::</span><span class="bu">Read</span><span class="op">;</span></span>
<span id="cb36-2"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb36-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-3"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb36-3" aria-hidden="true" tabindex="-1"></a><span class="kw">use</span> <span class="pp">chiya::codegen::</span><span class="op">{</span><span class="kw">self</span><span class="op">,</span> <span class="pp">emitter::</span>Emitter<span class="op">,</span> <span class="pp">llvm::</span>LLVM<span class="op">};</span></span>
<span id="cb36-4"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb36-4" aria-hidden="true" tabindex="-1"></a><span class="kw">use</span> <span class="pp">chiya::</span>parser<span class="op">;</span></span>
<span id="cb36-5"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb36-5" aria-hidden="true" tabindex="-1"></a><span class="kw">use</span> <span class="pp">chiya::</span>token<span class="op">;</span></span>
<span id="cb36-6"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb36-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-7"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb36-7" aria-hidden="true" tabindex="-1"></a><span class="kw">fn</span> main() <span class="op">-&gt;</span> <span class="dt">Result</span><span class="op">&lt;</span>()<span class="op">,</span> <span class="pp">failure::</span><span class="bu">Error</span><span class="op">&gt;</span> <span class="op">{</span></span>
<span id="cb36-8"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb36-8" aria-hidden="true" tabindex="-1"></a>    <span class="kw">let</span> args <span class="op">=</span> <span class="pp">std::env::</span>args()<span class="op">.</span><span class="pp">collect::</span><span class="op">&lt;</span><span class="dt">Vec</span><span class="op">&lt;</span>_<span class="op">&gt;&gt;</span>()<span class="op">;</span></span>
<span id="cb36-9"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb36-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-10"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb36-10" aria-hidden="true" tabindex="-1"></a>    <span class="kw">let</span> debug <span class="op">=</span> args<span class="op">.</span>iter()<span class="op">.</span>any(<span class="op">|</span>a<span class="op">|</span> <span class="op">*</span>a <span class="op">==</span> <span class="st">&quot;--debug&quot;</span>)<span class="op">;</span></span>
<span id="cb36-11"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb36-11" aria-hidden="true" tabindex="-1"></a>    <span class="kw">let</span> bf <span class="op">=</span> args<span class="op">.</span>iter()<span class="op">.</span>any(<span class="op">|</span>a<span class="op">|</span> <span class="op">*</span>a <span class="op">==</span> <span class="st">&quot;--bf&quot;</span>)<span class="op">;</span></span>
<span id="cb36-12"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb36-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-13"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb36-13" aria-hidden="true" tabindex="-1"></a>    <span class="kw">let</span> <span class="kw">mut</span> src <span class="op">=</span> <span class="dt">String</span><span class="pp">::</span>new()<span class="op">;</span></span>
<span id="cb36-14"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb36-14" aria-hidden="true" tabindex="-1"></a>    <span class="pp">std::io::</span>stdin()<span class="op">.</span>read_to_string(<span class="op">&amp;</span><span class="kw">mut</span> src)<span class="op">?;</span></span>
<span id="cb36-15"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb36-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-16"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb36-16" aria-hidden="true" tabindex="-1"></a>    <span class="kw">let</span> e <span class="op">=</span> <span class="pp">LLVM::</span>new()<span class="op">;</span></span>
<span id="cb36-17"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb36-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-18"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb36-18" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> bf <span class="op">{</span></span>
<span id="cb36-19"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb36-19" aria-hidden="true" tabindex="-1"></a>        compile_bf(e<span class="op">,</span> <span class="op">&amp;</span>src)<span class="op">?;</span></span>
<span id="cb36-20"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb36-20" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span> <span class="cf">else</span> <span class="op">{</span></span>
<span id="cb36-21"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb36-21" aria-hidden="true" tabindex="-1"></a>        compile(e<span class="op">,</span> <span class="op">&amp;</span>src<span class="op">,</span> debug)<span class="op">?;</span></span>
<span id="cb36-22"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb36-22" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb36-23"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb36-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-24"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb36-24" aria-hidden="true" tabindex="-1"></a>    <span class="cn">Ok</span>(())</span>
<span id="cb36-25"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb36-25" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb36-26"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb36-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-27"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb36-27" aria-hidden="true" tabindex="-1"></a><span class="kw">fn</span> compile<span class="op">&lt;</span>E<span class="op">:</span> Emitter<span class="op">&gt;</span>(<span class="kw">mut</span> e<span class="op">:</span> E<span class="op">,</span> src<span class="op">:</span> <span class="op">&amp;</span><span class="dt">str</span><span class="op">,</span> debug<span class="op">:</span> <span class="dt">bool</span>) <span class="op">-&gt;</span> <span class="dt">Result</span><span class="op">&lt;</span>()<span class="op">,</span> <span class="pp">failure::</span><span class="bu">Error</span><span class="op">&gt;</span> <span class="op">{</span></span>
<span id="cb36-28"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb36-28" aria-hidden="true" tabindex="-1"></a>    <span class="kw">let</span> tokens <span class="op">=</span> <span class="pp">token::</span>tokenize(<span class="op">&amp;</span>src)<span class="op">?;</span></span>
<span id="cb36-29"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb36-29" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> debug <span class="op">{</span></span>
<span id="cb36-30"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb36-30" aria-hidden="true" tabindex="-1"></a>        <span class="pp">eprintln!</span>(<span class="st">&quot;tokens: {:?}&quot;</span><span class="op">,</span> tokens)<span class="op">;</span></span>
<span id="cb36-31"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb36-31" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb36-32"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb36-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-33"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb36-33" aria-hidden="true" tabindex="-1"></a>    <span class="kw">let</span> tree <span class="op">=</span> <span class="pp">parser::</span>program(<span class="op">&amp;</span>tokens)<span class="op">.</span>ok_or_else(<span class="op">||</span> <span class="pp">failure::format_err!</span>(<span class="st">&quot;parse error&quot;</span>))<span class="op">?;</span></span>
<span id="cb36-34"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb36-34" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> debug <span class="op">{</span></span>
<span id="cb36-35"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb36-35" aria-hidden="true" tabindex="-1"></a>        <span class="pp">eprintln!</span>(<span class="st">&quot;syntax tree:</span><span class="sc">\n</span><span class="st">{:#?}&quot;</span><span class="op">,</span> tree<span class="op">.</span><span class="dv">1</span>)<span class="op">;</span></span>
<span id="cb36-36"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb36-36" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb36-37"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb36-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-38"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb36-38" aria-hidden="true" tabindex="-1"></a>    <span class="kw">let</span> code <span class="op">=</span> <span class="pp">codegen::</span>gen(<span class="op">&amp;</span><span class="kw">mut</span> e<span class="op">,</span> <span class="op">&amp;</span>tree<span class="op">.</span><span class="dv">1</span>)<span class="op">?;</span></span>
<span id="cb36-39"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb36-39" aria-hidden="true" tabindex="-1"></a>    <span class="pp">println!</span>(<span class="st">&quot;{}&quot;</span><span class="op">,</span> code)<span class="op">;</span></span>
<span id="cb36-40"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb36-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-41"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb36-41" aria-hidden="true" tabindex="-1"></a>    <span class="cn">Ok</span>(())</span>
<span id="cb36-42"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb36-42" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb36-43"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb36-43" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-44"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb36-44" aria-hidden="true" tabindex="-1"></a><span class="kw">fn</span> compile_bf<span class="op">&lt;</span>E<span class="op">:</span> Emitter<span class="op">&gt;</span>(<span class="kw">mut</span> e<span class="op">:</span> E<span class="op">,</span> src<span class="op">:</span> <span class="op">&amp;</span><span class="dt">str</span>) <span class="op">-&gt;</span> <span class="dt">Result</span><span class="op">&lt;</span>()<span class="op">,</span> <span class="pp">failure::</span><span class="bu">Error</span><span class="op">&gt;</span> <span class="op">{</span></span>
<span id="cb36-45"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb36-45" aria-hidden="true" tabindex="-1"></a>    <span class="co">// ...</span></span>
<span id="cb36-46"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb36-46" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>ではいろいろ動かしてみます。まずは ABC を表示するだけの簡単なものから。</p>
<div class="sourceCode" id="cb37"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb37-1"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb37-1" aria-hidden="true" tabindex="-1"></a><span class="op">*</span>ptr <span class="op">+=</span> <span class="dv">65</span><span class="op">;</span> <span class="co">// ptr[0] = &#39;A&#39;</span></span>
<span id="cb37-2"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb37-2" aria-hidden="true" tabindex="-1"></a>putchar<span class="op">();</span></span>
<span id="cb37-3"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb37-3" aria-hidden="true" tabindex="-1"></a><span class="op">*</span>ptr <span class="op">+=</span> <span class="dv">1</span><span class="op">;</span>  <span class="co">// &#39;B&#39;</span></span>
<span id="cb37-4"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb37-4" aria-hidden="true" tabindex="-1"></a>putchar<span class="op">();</span></span>
<span id="cb37-5"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb37-5" aria-hidden="true" tabindex="-1"></a><span class="op">*</span>ptr <span class="op">+=</span> <span class="dv">1</span><span class="op">;</span>  <span class="co">// &#39;C&#39;</span></span>
<span id="cb37-6"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb37-6" aria-hidden="true" tabindex="-1"></a>putchar<span class="op">();</span></span>
<span id="cb37-7"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb37-7" aria-hidden="true" tabindex="-1"></a>ptr <span class="op">+=</span> <span class="dv">1</span><span class="op">;</span>   <span class="co">// ptr[1] = &#39;\n&#39;</span></span>
<span id="cb37-8"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb37-8" aria-hidden="true" tabindex="-1"></a><span class="op">*</span>ptr <span class="op">+=</span> <span class="dv">10</span><span class="op">;</span></span>
<span id="cb37-9"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb37-9" aria-hidden="true" tabindex="-1"></a>putchar<span class="op">();</span></span></code></pre></div>
<pre><code>$ cargo run -q &lt; ex1 &gt; ex1.ll

$ lli ex1.ll
ABC</code></pre>
<p>ループや <code>getchar()</code> も使ってみます。0 ~ 9 の値を1つ読み込み、その回数だけ ABC を表示するコードです。</p>
<div class="sourceCode" id="cb39"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb39-1"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb39-1" aria-hidden="true" tabindex="-1"></a><span class="co">// ptr[0] ~ ptr[3]: 文字</span></span>
<span id="cb39-2"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb39-2" aria-hidden="true" tabindex="-1"></a><span class="co">// ptr[4]: ループカウンタ</span></span>
<span id="cb39-3"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb39-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-4"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb39-4" aria-hidden="true" tabindex="-1"></a><span class="op">*</span>ptr <span class="op">+=</span> <span class="dv">65</span><span class="op">;</span>   <span class="co">// ptr[0] = &#39;A&#39;</span></span>
<span id="cb39-5"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb39-5" aria-hidden="true" tabindex="-1"></a>ptr <span class="op">+=</span> <span class="dv">1</span><span class="op">;</span>     <span class="co">// ptr[1] = &#39;B&#39;</span></span>
<span id="cb39-6"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb39-6" aria-hidden="true" tabindex="-1"></a><span class="op">*</span>ptr <span class="op">+=</span> <span class="dv">66</span><span class="op">;</span></span>
<span id="cb39-7"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb39-7" aria-hidden="true" tabindex="-1"></a>ptr <span class="op">+=</span> <span class="dv">1</span><span class="op">;</span>     <span class="co">// ptr[2] = &#39;C&#39;</span></span>
<span id="cb39-8"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb39-8" aria-hidden="true" tabindex="-1"></a><span class="op">*</span>ptr <span class="op">+=</span> <span class="dv">67</span><span class="op">;</span></span>
<span id="cb39-9"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb39-9" aria-hidden="true" tabindex="-1"></a>ptr <span class="op">+=</span> <span class="dv">1</span><span class="op">;</span>     <span class="co">// ptr[3] = &#39;\n&#39;</span></span>
<span id="cb39-10"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb39-10" aria-hidden="true" tabindex="-1"></a><span class="op">*</span>ptr <span class="op">+=</span> <span class="dv">10</span><span class="op">;</span></span>
<span id="cb39-11"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb39-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-12"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb39-12" aria-hidden="true" tabindex="-1"></a>ptr <span class="op">+=</span> <span class="dv">1</span><span class="op">;</span></span>
<span id="cb39-13"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb39-13" aria-hidden="true" tabindex="-1"></a>getchar<span class="op">();</span></span>
<span id="cb39-14"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb39-14" aria-hidden="true" tabindex="-1"></a><span class="op">*</span>ptr <span class="op">-=</span> <span class="dv">48</span><span class="op">;</span>   <span class="co">// ptr[4] -= &#39;0&#39;</span></span>
<span id="cb39-15"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb39-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-16"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb39-16" aria-hidden="true" tabindex="-1"></a><span class="cf">while</span> <span class="op">*</span>ptr <span class="op">{</span></span>
<span id="cb39-17"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb39-17" aria-hidden="true" tabindex="-1"></a>    ptr <span class="op">-=</span> <span class="dv">4</span><span class="op">;</span></span>
<span id="cb39-18"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb39-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-19"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb39-19" aria-hidden="true" tabindex="-1"></a>    putchar<span class="op">();</span></span>
<span id="cb39-20"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb39-20" aria-hidden="true" tabindex="-1"></a>    ptr <span class="op">+=</span> <span class="dv">1</span><span class="op">;</span></span>
<span id="cb39-21"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb39-21" aria-hidden="true" tabindex="-1"></a>    putchar<span class="op">();</span></span>
<span id="cb39-22"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb39-22" aria-hidden="true" tabindex="-1"></a>    ptr <span class="op">+=</span> <span class="dv">1</span><span class="op">;</span></span>
<span id="cb39-23"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb39-23" aria-hidden="true" tabindex="-1"></a>    putchar<span class="op">();</span></span>
<span id="cb39-24"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb39-24" aria-hidden="true" tabindex="-1"></a>    ptr <span class="op">+=</span> <span class="dv">1</span><span class="op">;</span></span>
<span id="cb39-25"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb39-25" aria-hidden="true" tabindex="-1"></a>    putchar<span class="op">();</span></span>
<span id="cb39-26"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb39-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-27"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb39-27" aria-hidden="true" tabindex="-1"></a>    ptr <span class="op">+=</span> <span class="dv">1</span><span class="op">;</span></span>
<span id="cb39-28"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb39-28" aria-hidden="true" tabindex="-1"></a>    <span class="op">*</span>ptr <span class="op">-=</span> <span class="dv">1</span><span class="op">;</span>    <span class="co">// ptr[4] -= 1</span></span>
<span id="cb39-29"><a href="/entry/2019/10/21/make-own-language-and-compiler/#cb39-29" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<pre><code>$ cargo run -q &lt; ex2 &gt; ex2.ll 

$ echo -n 2 | lli ex2.ll
ABC
ABC

$ echo -n 3 | lli ex2.ll
ABC
ABC
ABC

$ echo -n 5 | lli ex2.ll
ABC
ABC
ABC
ABC
ABC

$ echo -n 7 | lli ex2.ll
ABC
ABC
ABC
ABC
ABC
ABC
ABC</code></pre>
<p>+。:.ﾟ٩(๑＞◡＜๑)۶:.｡+ﾟ</p>
<h2 id="まとめ">まとめ</h2>
<p>Brainf**k 処理系をきっかけにして生まれたコンパイラ chiya の実装を紹介しました。一部で流行りの自作 C コンパイラなどと比べるととても簡素なものだけれども、個人的には挫折したままになっていたコンパイラ実装をとりあえず達成でき、とてもスッキリしたので良かったなと思っています。また機会があれば、今度は流行りの C や <a href="https://github.com/rhysd/gocaml" target="_blank" rel="nofollow noopener">Linda_pp さんの gocaml</a> みたいな関数型言語などより複雑な言語のコンパイラであったり、今回は省略した意味解析フェーズあたりに重みをおいて型・型推論システムの実装などもしてみたいなぁ…</p>
<p>chiya の実装は Rust でなにか書いてみるという目的もあったりしました。実際に書いてみた感想としては、<code>enum</code> で構文木がいい感じに表現できたり、<code>Option&lt;T&gt;</code> に <a href="https://doc.rust-lang.org/std/option/enum.Option.html#method.map" target="_blank" rel="nofollow noopener"><code>map()</code></a>, <a href="https://doc.rust-lang.org/std/option/enum.Option.html#method.and_then" target="_blank" rel="nofollow noopener"><code>and_then()</code></a>, <a href="https://doc.rust-lang.org/std/option/enum.Option.html#method.or_else" target="_blank" rel="nofollow noopener"><code>or_else()</code></a> などのメソッドが<strong>ちゃんと</strong>生えていたりなど、C++ と Haskell を触った経験からくる「これ！！！！！！」なポイントがたくさんあってとても気持ちよかったです。実は Rust が話題になり始めた当初、TOML があまり好きじゃないとか <code>println!()</code> がマクロだとか<a href="/entry/2019/10/21/make-own-language-and-compiler/#fn5" class="footnote-ref" id="fnref5" role="doc-noteref"><sup>5</sup></a>などのしょうもない理由で避けていたのですが、そんなことで流行に乗り遅れたことを本当に後悔するくらいに良い言語だなと思います。はやくガリガリ書けるようになりたいですね。</p>
<section class="footnotes footnotes-end-of-document" role="doc-endnotes">
<hr />
<ol>
<li id="fn1" role="doc-endnote"><p>具体的な設計などの前に「こんな感じの処理ってプログラムできるかなー」とか「このライブラリ使えないかなー」とかを確認する実装をしたりします<a href="/entry/2019/10/21/make-own-language-and-compiler/#fnref1" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn2" role="doc-endnote"><p>Rust 的には package ってワードのほうが良さそうかも <a href="https://doc.rust-lang.org/book/ch07-01-packages-and-crates.html" class="uri" target="_blank" rel="nofollow noopener">https://doc.rust-lang.org/book/ch07-01-packages-and-crates.html</a><a href="/entry/2019/10/21/make-own-language-and-compiler/#fnref2" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn3" role="doc-endnote"><p><a href="http://releases.llvm.org/9.0.0/docs/LangRef.html#abstract" target="_blank" rel="nofollow noopener">公式リファレンス</a> を見た感じ “LLVM assembly language” や “LLVM language” が正式名称？っぽいけど、この記事では “LLVM IR” と書くことにします<a href="/entry/2019/10/21/make-own-language-and-compiler/#fnref3" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn4" role="doc-endnote"><p>構文木の上の要素 (今回だと <code>program</code>) から対応をとっていくので “Top-Down”、逆に下の要素 (今回だと <code>lhs</code> や <code>rhs</code>) から対応をとっていく “Bottom-Up” な構文解析もある<a href="/entry/2019/10/21/make-own-language-and-compiler/#fnref4" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn5" role="doc-endnote"><p>プログラミング言語でマクロといわれると C プリプロセッサのイメージがあるので、某所のコードや某 GUI フレームワークなどで散々苦しめられた経験から (╯•﹏•╰) ってなっちゃう<a href="/entry/2019/10/21/make-own-language-and-compiler/#fnref5" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
</ol>
</section></div><aside class="comments"><div id="disqus_thread"></div><script>(function() { var d = document, s = d.createElement('script');s.src = 'https://tosainu.disqus.com/embed.js';s.setAttribute('data-timestamp', +new Date());(d.head || d.body).appendChild(s); })();</script><noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" target="_blank" rel="nofollow noopener">comments powered by Disqus.</a></noscript></aside></div></article></main><footer class="site-footer"><div class="footer-widgets"><div class="container"><div class="col"><section class="about-me"><h4><svg class="svg-inline--fa fa-user fa-fw" focusable="false" aria-hidden="true" role="img" viewBox="0 0 448 512" data-icon="user" data-prefix="fas" xmlns="http://www.w3.org/2000/svg"><path d="M224 256c70.7 0 128-57.3 128-128S294.7 0 224 0S96 57.3 96 128s57.3 128 128 128zm-45.7 48C79.8 304 0 383.8 0 482.3C0 498.7 13.3 512 29.7 512H418.3c16.4 0 29.7-13.3 29.7-29.7C448 383.8 368.2 304 269.7 304H178.3z" fill="currentColor"></path></svg> About Me</h4><div class="about"><div class="avatar"><img src="/images/icon/cocoa.svg" class="icon" alt="avatar"></div><div class="info"><div class="name"><a href="https://myon.info" target="_blank" rel="nofollow noopener">Tosainu</a></div><div class="info">❤ Arch Linux, ごちうさ</div></div></div></section><section class="recent-posts"><h4><svg class="svg-inline--fa fa-file fa-fw" focusable="false" aria-hidden="true" role="img" viewBox="0 0 384 512" data-icon="file" data-prefix="fas" xmlns="http://www.w3.org/2000/svg"><path d="M0 64C0 28.7 28.7 0 64 0H224V128c0 17.7 14.3 32 32 32H384V448c0 35.3-28.7 64-64 64H64c-35.3 0-64-28.7-64-64V64zm384 64H256V0L384 128z" fill="currentColor"></path></svg> Recent Posts</h4><ul><li><a href="/entry/2022/09/19/earthly-zynqmp/">とにかく複雑な Zynq のソフトウェアを Earthly でビルドする</a></li><li><a href="/entry/2020/11/29/archlinux-arm-on-zu/">Ultra96 で Arch Linux ARM を動かす</a></li><li><a href="/entry/2020/09/01/thinkpad-x13/">ThinkPad X13 を買いました</a></li><li><a href="/entry/2020/07/05/bus-blaster/">Bus Blaster で Raspberry Pi Model B を JTAG デバッグしてみる</a></li><li><a href="/entry/2019/10/21/make-own-language-and-compiler/">Brainf**k からはじめる自作コンパイラ</a></li></ul></section></div><section class="tag-cloud"><h4><svg class="svg-inline--fa fa-tags fa-fw" focusable="false" aria-hidden="true" role="img" viewBox="0 0 512 512" data-icon="tags" data-prefix="fas" xmlns="http://www.w3.org/2000/svg"><path d="M345 39.1L472.8 168.4c52.4 53 52.4 138.2 0 191.2L360.8 472.9c-9.3 9.4-24.5 9.5-33.9 .2s-9.5-24.5-.2-33.9L438.6 325.9c33.9-34.3 33.9-89.4 0-123.7L310.9 72.9c-9.3-9.4-9.2-24.6 .2-33.9s24.6-9.2 33.9 .2zM0 229.5V80C0 53.5 21.5 32 48 32H197.5c17 0 33.3 6.7 45.3 18.7l168 168c25 25 25 65.5 0 90.5L277.3 442.7c-25 25-65.5 25-90.5 0l-168-168C6.7 262.7 0 246.5 0 229.5zM144 144c0-17.7-14.3-32-32-32s-32 14.3-32 32s14.3 32 32 32s32-14.3 32-32z" fill="currentColor"></path></svg> Tags</h4><ul class="tag-list"><li><a href="/entry/tags/android/"><span>Android</span></a></li><li><a href="/entry/tags/arch-linux/"><span>Arch Linux</span></a></li><li><a href="/entry/tags/arduino/"><span>Arduino</span></a></li><li><a href="/entry/tags/c/"><span>C++</span></a></li><li><a href="/entry/tags/ctf/"><span>CTF</span></a></li><li><a href="/entry/tags/diy-pc/"><span>DIY PC</span></a></li><li><a href="/entry/tags/docker/"><span>Docker</span></a></li><li><a href="/entry/tags/fpga/"><span>FPGA</span></a></li><li><a href="/entry/tags/game/"><span>Game</span></a></li><li><a href="/entry/tags/gochiusa/"><span>Gochiusa</span></a></li><li><a href="/entry/tags/hakyll/"><span>Hakyll</span></a></li><li><a href="/entry/tags/haskell/"><span>Haskell</span></a></li><li><a href="/entry/tags/linux/"><span>Linux</span></a></li><li><a href="/entry/tags/machine-learning/"><span>Machine learning</span></a></li><li><a href="/entry/tags/network/"><span>Network</span></a></li><li><a href="/entry/tags/raspberry-pi/"><span>Raspberry Pi</span></a></li><li><a href="/entry/tags/rust/"><span>Rust</span></a></li><li><a href="/entry/tags/slack/"><span>Slack</span></a></li><li><a href="/entry/tags/thinkpad-x13/"><span>ThinkPad X13</span></a></li><li><a href="/entry/tags/vaio-z2/"><span>VAIO Z2</span></a></li><li><a href="/entry/tags/vim/"><span>Vim</span></a></li><li><a href="/entry/tags/walkmanz/"><span>WalkmanZ</span></a></li><li><a href="/entry/tags/website/"><span>Website</span></a></li><li><a href="/entry/tags/xperia-nx/"><span>Xperia NX</span></a></li><li><a href="/entry/tags/xperia-arc/"><span>Xperia arc</span></a></li><li><a href="/entry/tags/xperia2011/"><span>Xperia2011</span></a></li><li><a href="/entry/tags/seccamp/"><span>seccamp</span></a></li></ul></section><section class="archives"><h4><svg class="svg-inline--fa fa-box-archive fa-fw" focusable="false" aria-hidden="true" role="img" viewBox="0 0 512 512" data-icon="box-archive" data-prefix="fas" xmlns="http://www.w3.org/2000/svg"><path d="M32 32H480c17.7 0 32 14.3 32 32V96c0 17.7-14.3 32-32 32H32C14.3 128 0 113.7 0 96V64C0 46.3 14.3 32 32 32zm0 128H480V416c0 35.3-28.7 64-64 64H96c-35.3 0-64-28.7-64-64V160zm128 80c0 8.8 7.2 16 16 16H336c8.8 0 16-7.2 16-16s-7.2-16-16-16H176c-8.8 0-16 7.2-16 16z" fill="currentColor"></path></svg> Archives</h4><ul class="archive-tree"><li><input class="tree-toggle" type="checkbox" id="tree-label-2022"><label class="tree-toggle-button" for="tree-label-2022"><svg class="svg-inline--fa fa-angle-right fa-fw" focusable="false" aria-hidden="true" role="img" viewBox="0 0 320 512" data-icon="angle-right" data-prefix="fas" xmlns="http://www.w3.org/2000/svg"><path d="M278.6 233.4c12.5 12.5 12.5 32.8 0 45.3l-160 160c-12.5 12.5-32.8 12.5-45.3 0s-12.5-32.8 0-45.3L210.7 256 73.4 118.6c-12.5-12.5-12.5-32.8 0-45.3s32.8-12.5 45.3 0l160 160z" fill="currentColor"></path></svg><svg class="svg-inline--fa fa-angle-down fa-fw" focusable="false" aria-hidden="true" role="img" viewBox="0 0 448 512" data-icon="angle-down" data-prefix="fas" xmlns="http://www.w3.org/2000/svg"><path d="M201.4 374.6c12.5 12.5 32.8 12.5 45.3 0l160-160c12.5-12.5 12.5-32.8 0-45.3s-32.8-12.5-45.3 0L224 306.7 86.6 169.4c-12.5-12.5-32.8-12.5-45.3 0s-12.5 32.8 0 45.3l160 160z" fill="currentColor"></path></svg><a href="/entry/2022/">2022 (1)</a></label><ul class="tree-child"><li><a href="/entry/2022/09/">2022/09 (1)</a></li></ul></li><li><input class="tree-toggle" type="checkbox" id="tree-label-2020"><label class="tree-toggle-button" for="tree-label-2020"><svg class="svg-inline--fa fa-angle-right fa-fw" focusable="false" aria-hidden="true" role="img" viewBox="0 0 320 512" data-icon="angle-right" data-prefix="fas" xmlns="http://www.w3.org/2000/svg"><path d="M278.6 233.4c12.5 12.5 12.5 32.8 0 45.3l-160 160c-12.5 12.5-32.8 12.5-45.3 0s-12.5-32.8 0-45.3L210.7 256 73.4 118.6c-12.5-12.5-12.5-32.8 0-45.3s32.8-12.5 45.3 0l160 160z" fill="currentColor"></path></svg><svg class="svg-inline--fa fa-angle-down fa-fw" focusable="false" aria-hidden="true" role="img" viewBox="0 0 448 512" data-icon="angle-down" data-prefix="fas" xmlns="http://www.w3.org/2000/svg"><path d="M201.4 374.6c12.5 12.5 32.8 12.5 45.3 0l160-160c12.5-12.5 12.5-32.8 0-45.3s-32.8-12.5-45.3 0L224 306.7 86.6 169.4c-12.5-12.5-32.8-12.5-45.3 0s-12.5 32.8 0 45.3l160 160z" fill="currentColor"></path></svg><a href="/entry/2020/">2020 (3)</a></label><ul class="tree-child"><li><a href="/entry/2020/11/">2020/11 (1)</a></li><li><a href="/entry/2020/09/">2020/09 (1)</a></li><li><a href="/entry/2020/07/">2020/07 (1)</a></li></ul></li><li><input class="tree-toggle" type="checkbox" id="tree-label-2019" checked><label class="tree-toggle-button" for="tree-label-2019"><svg class="svg-inline--fa fa-angle-right fa-fw" focusable="false" aria-hidden="true" role="img" viewBox="0 0 320 512" data-icon="angle-right" data-prefix="fas" xmlns="http://www.w3.org/2000/svg"><path d="M278.6 233.4c12.5 12.5 12.5 32.8 0 45.3l-160 160c-12.5 12.5-32.8 12.5-45.3 0s-12.5-32.8 0-45.3L210.7 256 73.4 118.6c-12.5-12.5-12.5-32.8 0-45.3s32.8-12.5 45.3 0l160 160z" fill="currentColor"></path></svg><svg class="svg-inline--fa fa-angle-down fa-fw" focusable="false" aria-hidden="true" role="img" viewBox="0 0 448 512" data-icon="angle-down" data-prefix="fas" xmlns="http://www.w3.org/2000/svg"><path d="M201.4 374.6c12.5 12.5 32.8 12.5 45.3 0l160-160c12.5-12.5 12.5-32.8 0-45.3s-32.8-12.5-45.3 0L224 306.7 86.6 169.4c-12.5-12.5-32.8-12.5-45.3 0s-12.5 32.8 0 45.3l160 160z" fill="currentColor"></path></svg><a href="/entry/2019/">2019 (4)</a></label><ul class="tree-child"><li><a href="/entry/2019/10/">2019/10 (1)</a></li><li><a href="/entry/2019/08/">2019/08 (2)</a></li><li><a href="/entry/2019/05/">2019/05 (1)</a></li></ul></li><li><input class="tree-toggle" type="checkbox" id="tree-label-2018"><label class="tree-toggle-button" for="tree-label-2018"><svg class="svg-inline--fa fa-angle-right fa-fw" focusable="false" aria-hidden="true" role="img" viewBox="0 0 320 512" data-icon="angle-right" data-prefix="fas" xmlns="http://www.w3.org/2000/svg"><path d="M278.6 233.4c12.5 12.5 12.5 32.8 0 45.3l-160 160c-12.5 12.5-32.8 12.5-45.3 0s-12.5-32.8 0-45.3L210.7 256 73.4 118.6c-12.5-12.5-12.5-32.8 0-45.3s32.8-12.5 45.3 0l160 160z" fill="currentColor"></path></svg><svg class="svg-inline--fa fa-angle-down fa-fw" focusable="false" aria-hidden="true" role="img" viewBox="0 0 448 512" data-icon="angle-down" data-prefix="fas" xmlns="http://www.w3.org/2000/svg"><path d="M201.4 374.6c12.5 12.5 32.8 12.5 45.3 0l160-160c12.5-12.5 12.5-32.8 0-45.3s-32.8-12.5-45.3 0L224 306.7 86.6 169.4c-12.5-12.5-32.8-12.5-45.3 0s-12.5 32.8 0 45.3l160 160z" fill="currentColor"></path></svg><a href="/entry/2018/">2018 (5)</a></label><ul class="tree-child"><li><a href="/entry/2018/10/">2018/10 (1)</a></li><li><a href="/entry/2018/09/">2018/09 (1)</a></li><li><a href="/entry/2018/08/">2018/08 (1)</a></li><li><a href="/entry/2018/03/">2018/03 (1)</a></li><li><a href="/entry/2018/01/">2018/01 (1)</a></li></ul></li><li><input class="tree-toggle" type="checkbox" id="tree-label-2017"><label class="tree-toggle-button" for="tree-label-2017"><svg class="svg-inline--fa fa-angle-right fa-fw" focusable="false" aria-hidden="true" role="img" viewBox="0 0 320 512" data-icon="angle-right" data-prefix="fas" xmlns="http://www.w3.org/2000/svg"><path d="M278.6 233.4c12.5 12.5 12.5 32.8 0 45.3l-160 160c-12.5 12.5-32.8 12.5-45.3 0s-12.5-32.8 0-45.3L210.7 256 73.4 118.6c-12.5-12.5-12.5-32.8 0-45.3s32.8-12.5 45.3 0l160 160z" fill="currentColor"></path></svg><svg class="svg-inline--fa fa-angle-down fa-fw" focusable="false" aria-hidden="true" role="img" viewBox="0 0 448 512" data-icon="angle-down" data-prefix="fas" xmlns="http://www.w3.org/2000/svg"><path d="M201.4 374.6c12.5 12.5 32.8 12.5 45.3 0l160-160c12.5-12.5 12.5-32.8 0-45.3s-32.8-12.5-45.3 0L224 306.7 86.6 169.4c-12.5-12.5-32.8-12.5-45.3 0s-12.5 32.8 0 45.3l160 160z" fill="currentColor"></path></svg><a href="/entry/2017/">2017 (5)</a></label><ul class="tree-child"><li><a href="/entry/2017/09/">2017/09 (1)</a></li><li><a href="/entry/2017/05/">2017/05 (1)</a></li><li><a href="/entry/2017/02/">2017/02 (3)</a></li></ul></li><li><input class="tree-toggle" type="checkbox" id="tree-label-2016"><label class="tree-toggle-button" for="tree-label-2016"><svg class="svg-inline--fa fa-angle-right fa-fw" focusable="false" aria-hidden="true" role="img" viewBox="0 0 320 512" data-icon="angle-right" data-prefix="fas" xmlns="http://www.w3.org/2000/svg"><path d="M278.6 233.4c12.5 12.5 12.5 32.8 0 45.3l-160 160c-12.5 12.5-32.8 12.5-45.3 0s-12.5-32.8 0-45.3L210.7 256 73.4 118.6c-12.5-12.5-12.5-32.8 0-45.3s32.8-12.5 45.3 0l160 160z" fill="currentColor"></path></svg><svg class="svg-inline--fa fa-angle-down fa-fw" focusable="false" aria-hidden="true" role="img" viewBox="0 0 448 512" data-icon="angle-down" data-prefix="fas" xmlns="http://www.w3.org/2000/svg"><path d="M201.4 374.6c12.5 12.5 32.8 12.5 45.3 0l160-160c12.5-12.5 12.5-32.8 0-45.3s-32.8-12.5-45.3 0L224 306.7 86.6 169.4c-12.5-12.5-32.8-12.5-45.3 0s-12.5 32.8 0 45.3l160 160z" fill="currentColor"></path></svg><a href="/entry/2016/">2016 (8)</a></label><ul class="tree-child"><li><a href="/entry/2016/08/">2016/08 (2)</a></li><li><a href="/entry/2016/07/">2016/07 (1)</a></li><li><a href="/entry/2016/06/">2016/06 (1)</a></li><li><a href="/entry/2016/05/">2016/05 (1)</a></li><li><a href="/entry/2016/03/">2016/03 (1)</a></li><li><a href="/entry/2016/01/">2016/01 (2)</a></li></ul></li><li><input class="tree-toggle" type="checkbox" id="tree-label-2015"><label class="tree-toggle-button" for="tree-label-2015"><svg class="svg-inline--fa fa-angle-right fa-fw" focusable="false" aria-hidden="true" role="img" viewBox="0 0 320 512" data-icon="angle-right" data-prefix="fas" xmlns="http://www.w3.org/2000/svg"><path d="M278.6 233.4c12.5 12.5 12.5 32.8 0 45.3l-160 160c-12.5 12.5-32.8 12.5-45.3 0s-12.5-32.8 0-45.3L210.7 256 73.4 118.6c-12.5-12.5-12.5-32.8 0-45.3s32.8-12.5 45.3 0l160 160z" fill="currentColor"></path></svg><svg class="svg-inline--fa fa-angle-down fa-fw" focusable="false" aria-hidden="true" role="img" viewBox="0 0 448 512" data-icon="angle-down" data-prefix="fas" xmlns="http://www.w3.org/2000/svg"><path d="M201.4 374.6c12.5 12.5 32.8 12.5 45.3 0l160-160c12.5-12.5 12.5-32.8 0-45.3s-32.8-12.5-45.3 0L224 306.7 86.6 169.4c-12.5-12.5-32.8-12.5-45.3 0s-12.5 32.8 0 45.3l160 160z" fill="currentColor"></path></svg><a href="/entry/2015/">2015 (12)</a></label><ul class="tree-child"><li><a href="/entry/2015/12/">2015/12 (1)</a></li><li><a href="/entry/2015/08/">2015/08 (1)</a></li><li><a href="/entry/2015/06/">2015/06 (2)</a></li><li><a href="/entry/2015/05/">2015/05 (2)</a></li><li><a href="/entry/2015/04/">2015/04 (1)</a></li><li><a href="/entry/2015/03/">2015/03 (2)</a></li><li><a href="/entry/2015/02/">2015/02 (1)</a></li><li><a href="/entry/2015/01/">2015/01 (2)</a></li></ul></li><li><input class="tree-toggle" type="checkbox" id="tree-label-2014"><label class="tree-toggle-button" for="tree-label-2014"><svg class="svg-inline--fa fa-angle-right fa-fw" focusable="false" aria-hidden="true" role="img" viewBox="0 0 320 512" data-icon="angle-right" data-prefix="fas" xmlns="http://www.w3.org/2000/svg"><path d="M278.6 233.4c12.5 12.5 12.5 32.8 0 45.3l-160 160c-12.5 12.5-32.8 12.5-45.3 0s-12.5-32.8 0-45.3L210.7 256 73.4 118.6c-12.5-12.5-12.5-32.8 0-45.3s32.8-12.5 45.3 0l160 160z" fill="currentColor"></path></svg><svg class="svg-inline--fa fa-angle-down fa-fw" focusable="false" aria-hidden="true" role="img" viewBox="0 0 448 512" data-icon="angle-down" data-prefix="fas" xmlns="http://www.w3.org/2000/svg"><path d="M201.4 374.6c12.5 12.5 32.8 12.5 45.3 0l160-160c12.5-12.5 12.5-32.8 0-45.3s-32.8-12.5-45.3 0L224 306.7 86.6 169.4c-12.5-12.5-32.8-12.5-45.3 0s-12.5 32.8 0 45.3l160 160z" fill="currentColor"></path></svg><a href="/entry/2014/">2014 (62)</a></label><ul class="tree-child"><li><a href="/entry/2014/12/">2014/12 (7)</a></li><li><a href="/entry/2014/11/">2014/11 (4)</a></li><li><a href="/entry/2014/10/">2014/10 (3)</a></li><li><a href="/entry/2014/09/">2014/09 (3)</a></li><li><a href="/entry/2014/08/">2014/08 (5)</a></li><li><a href="/entry/2014/07/">2014/07 (6)</a></li><li><a href="/entry/2014/06/">2014/06 (6)</a></li><li><a href="/entry/2014/05/">2014/05 (4)</a></li><li><a href="/entry/2014/04/">2014/04 (6)</a></li><li><a href="/entry/2014/03/">2014/03 (7)</a></li><li><a href="/entry/2014/02/">2014/02 (5)</a></li><li><a href="/entry/2014/01/">2014/01 (6)</a></li></ul></li><li><input class="tree-toggle" type="checkbox" id="tree-label-2013"><label class="tree-toggle-button" for="tree-label-2013"><svg class="svg-inline--fa fa-angle-right fa-fw" focusable="false" aria-hidden="true" role="img" viewBox="0 0 320 512" data-icon="angle-right" data-prefix="fas" xmlns="http://www.w3.org/2000/svg"><path d="M278.6 233.4c12.5 12.5 12.5 32.8 0 45.3l-160 160c-12.5 12.5-32.8 12.5-45.3 0s-12.5-32.8 0-45.3L210.7 256 73.4 118.6c-12.5-12.5-12.5-32.8 0-45.3s32.8-12.5 45.3 0l160 160z" fill="currentColor"></path></svg><svg class="svg-inline--fa fa-angle-down fa-fw" focusable="false" aria-hidden="true" role="img" viewBox="0 0 448 512" data-icon="angle-down" data-prefix="fas" xmlns="http://www.w3.org/2000/svg"><path d="M201.4 374.6c12.5 12.5 32.8 12.5 45.3 0l160-160c12.5-12.5 12.5-32.8 0-45.3s-32.8-12.5-45.3 0L224 306.7 86.6 169.4c-12.5-12.5-32.8-12.5-45.3 0s-12.5 32.8 0 45.3l160 160z" fill="currentColor"></path></svg><a href="/entry/2013/">2013 (116)</a></label><ul class="tree-child"><li><a href="/entry/2013/12/">2013/12 (8)</a></li><li><a href="/entry/2013/11/">2013/11 (6)</a></li><li><a href="/entry/2013/10/">2013/10 (5)</a></li><li><a href="/entry/2013/09/">2013/09 (5)</a></li><li><a href="/entry/2013/08/">2013/08 (4)</a></li><li><a href="/entry/2013/07/">2013/07 (3)</a></li><li><a href="/entry/2013/06/">2013/06 (12)</a></li><li><a href="/entry/2013/05/">2013/05 (16)</a></li><li><a href="/entry/2013/04/">2013/04 (16)</a></li><li><a href="/entry/2013/03/">2013/03 (27)</a></li><li><a href="/entry/2013/02/">2013/02 (7)</a></li><li><a href="/entry/2013/01/">2013/01 (7)</a></li></ul></li><li><input class="tree-toggle" type="checkbox" id="tree-label-2012"><label class="tree-toggle-button" for="tree-label-2012"><svg class="svg-inline--fa fa-angle-right fa-fw" focusable="false" aria-hidden="true" role="img" viewBox="0 0 320 512" data-icon="angle-right" data-prefix="fas" xmlns="http://www.w3.org/2000/svg"><path d="M278.6 233.4c12.5 12.5 12.5 32.8 0 45.3l-160 160c-12.5 12.5-32.8 12.5-45.3 0s-12.5-32.8 0-45.3L210.7 256 73.4 118.6c-12.5-12.5-12.5-32.8 0-45.3s32.8-12.5 45.3 0l160 160z" fill="currentColor"></path></svg><svg class="svg-inline--fa fa-angle-down fa-fw" focusable="false" aria-hidden="true" role="img" viewBox="0 0 448 512" data-icon="angle-down" data-prefix="fas" xmlns="http://www.w3.org/2000/svg"><path d="M201.4 374.6c12.5 12.5 32.8 12.5 45.3 0l160-160c12.5-12.5 12.5-32.8 0-45.3s-32.8-12.5-45.3 0L224 306.7 86.6 169.4c-12.5-12.5-32.8-12.5-45.3 0s-12.5 32.8 0 45.3l160 160z" fill="currentColor"></path></svg><a href="/entry/2012/">2012 (11)</a></label><ul class="tree-child"><li><a href="/entry/2012/12/">2012/12 (3)</a></li><li><a href="/entry/2012/09/">2012/09 (1)</a></li><li><a href="/entry/2012/07/">2012/07 (4)</a></li><li><a href="/entry/2012/04/">2012/04 (1)</a></li><li><a href="/entry/2012/03/">2012/03 (1)</a></li><li><a href="/entry/2012/01/">2012/01 (1)</a></li></ul></li><li><input class="tree-toggle" type="checkbox" id="tree-label-2011"><label class="tree-toggle-button" for="tree-label-2011"><svg class="svg-inline--fa fa-angle-right fa-fw" focusable="false" aria-hidden="true" role="img" viewBox="0 0 320 512" data-icon="angle-right" data-prefix="fas" xmlns="http://www.w3.org/2000/svg"><path d="M278.6 233.4c12.5 12.5 12.5 32.8 0 45.3l-160 160c-12.5 12.5-32.8 12.5-45.3 0s-12.5-32.8 0-45.3L210.7 256 73.4 118.6c-12.5-12.5-12.5-32.8 0-45.3s32.8-12.5 45.3 0l160 160z" fill="currentColor"></path></svg><svg class="svg-inline--fa fa-angle-down fa-fw" focusable="false" aria-hidden="true" role="img" viewBox="0 0 448 512" data-icon="angle-down" data-prefix="fas" xmlns="http://www.w3.org/2000/svg"><path d="M201.4 374.6c12.5 12.5 32.8 12.5 45.3 0l160-160c12.5-12.5 12.5-32.8 0-45.3s-32.8-12.5-45.3 0L224 306.7 86.6 169.4c-12.5-12.5-32.8-12.5-45.3 0s-12.5 32.8 0 45.3l160 160z" fill="currentColor"></path></svg><a href="/entry/2011/">2011 (12)</a></label><ul class="tree-child"><li><a href="/entry/2011/09/">2011/09 (1)</a></li><li><a href="/entry/2011/06/">2011/06 (1)</a></li><li><a href="/entry/2011/05/">2011/05 (1)</a></li><li><a href="/entry/2011/03/">2011/03 (6)</a></li><li><a href="/entry/2011/02/">2011/02 (1)</a></li><li><a href="/entry/2011/01/">2011/01 (2)</a></li></ul></li></ul></section></div></div><div class="footer-bottom"><div class="container"><div class="copyright">© 2011-2022 Tosainu. Site generated by <a href="https://jaspervdj.be/hakyll/" target="_blank" rel="nofollow noopener">Hakyll</a>.</div></div></div></footer></body></html>
