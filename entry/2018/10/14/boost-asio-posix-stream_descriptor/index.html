<!DOCTYPE HTML><html lang="ja"><head><meta charset="utf-8"><meta content="Tosainu" name="author"><meta content="C++熱は冷めてしまったのですが、いつか書こうと思っていたことを書かないのもアレだなぁということで、久しぶりの C++ ネタです。[Boost.Asio](https://www.boost.org/doc/libs/1_68_0/doc/html/boost_asio.html) は、個人的に好き" name="description"><meta content="Hakyll" name="generator"><meta content="width=device-width, initial-scale=1" name="viewport"><meta property="twitter:card" content="summary"><meta property="twitter:site" content="myon___"><meta property="twitter:creator" content="myon___"><meta property="og:type" content="article"><meta property="og:url" content="https://blog.myon.info/entry/2018/10/14/boost-asio-posix-stream_descriptor/index.html"><meta property="og:title" content="Boost.Asio の posix::stream_descriptor を使う | Tosainu Lab"><meta property="og:description" content="C++熱は冷めてしまったのですが、いつか書こうと思っていたことを書かないのもアレだなぁということで、久しぶりの C++ ネタです。[Boost.Asio](https://www.boost.org/doc/libs/1_68_0/doc/html/boost_asio.html) は、個人的に好き"><meta property="og:site_name" content="Tosainu Lab"><meta property="og:image" content="https://blog.myon.info/images/icon/cocoa-512.jpg"><title>Boost.Asio の posix::stream_descriptor を使う | Tosainu Lab</title><link href="/vendor/normalize.css/normalize.css" rel="stylesheet"><link href="/stylesheets/style.css" rel="stylesheet"><link href="/stylesheets/highlight.css" rel="stylesheet"><link href="/vendor/fontawesome/style.css" rel="stylesheet"><link href="/vendor/katex/katex.min.css" rel="stylesheet"><link href="/feed.xml" title="Atom Feed" type="application/atom+xml" rel="alternate"><script async src="https://www.googletagmanager.com/gtag/js?id=G-X1CGBSMEQW"></script><script>window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments);}gtag('js',new Date());gtag('config','G-X1CGBSMEQW');</script></head><body><header class="site-header"><div class="container"><h1><a href="/" title="home">Tosainu Lab</a></h1></div></header><main class="post"><article><header class="post-header"><div class="container"><h1><a href="/entry/2018/10/14/boost-asio-posix-stream_descriptor/">Boost.Asio の posix::stream_descriptor を使う</a></h1><ul class="post-meta"><li><svg class="svg-inline--fa fa-calendar" focusable="false" aria-hidden="true" role="img" viewBox="0 0 448 512" data-icon="calendar" data-prefix="fas" xmlns="http://www.w3.org/2000/svg"><path d="M96 32V64H48C21.5 64 0 85.5 0 112v48H448V112c0-26.5-21.5-48-48-48H352V32c0-17.7-14.3-32-32-32s-32 14.3-32 32V64H160V32c0-17.7-14.3-32-32-32S96 14.3 96 32zM448 192H0V464c0 26.5 21.5 48 48 48H400c26.5 0 48-21.5 48-48V192z" fill="currentColor"></path></svg></li><li class="date">2018/10/14 22:59</li><li><svg class="svg-inline--fa fa-tags" focusable="false" aria-hidden="true" role="img" viewBox="0 0 512 512" data-icon="tags" data-prefix="fas" xmlns="http://www.w3.org/2000/svg"><path d="M345 39.1L472.8 168.4c52.4 53 52.4 138.2 0 191.2L360.8 472.9c-9.3 9.4-24.5 9.5-33.9 .2s-9.5-24.5-.2-33.9L438.6 325.9c33.9-34.3 33.9-89.4 0-123.7L310.9 72.9c-9.3-9.4-9.2-24.6 .2-33.9s24.6-9.2 33.9 .2zM0 229.5V80C0 53.5 21.5 32 48 32H197.5c17 0 33.3 6.7 45.3 18.7l168 168c25 25 25 65.5 0 90.5L277.3 442.7c-25 25-65.5 25-90.5 0l-168-168C6.7 262.7 0 246.5 0 229.5zM144 144c0-17.7-14.3-32-32-32s-32 14.3-32 32s14.3 32 32 32s32-14.3 32-32z" fill="currentColor"></path></svg></li><li><ul class="tag-list"><li><a href="/entry/tags/c/"><span>C++</span></a></li><li><a href="/entry/tags/linux/"><span>Linux</span></a></li></ul></li></ul></div></header><div class="container"><div class="post-contents"><p>C++熱は冷めてしまったのですが、いつか書こうと思っていたことを書かないのもアレだなぁということで、久しぶりの C++ ネタです。</p>
<p><a href="https://www.boost.org/doc/libs/1_68_0/doc/html/boost_asio.html" target="_blank" rel="nofollow noopener">Boost.Asio</a> は、個人的に好きな C++ ライブラリの1つです。以前にもこのブログで、HTTP クライアント (Twitter API というか OAuth を叩くライブラリ) やシリアル通信をする例を紹介しました。</p>
<p>今回紹介するのは <a href="https://www.boost.org/doc/libs/1_68_0/doc/html/boost_asio/reference/posix__stream_descriptor.html" target="_blank" rel="nofollow noopener"><code>posix::stream_descriptor</code></a> です。名前からなんとなく想像できるように、ファイルディスクリプタを渡してストリーム形式のデータをやり取りするためのものです。これを使って、<code>open(2)</code> したデバイスを Boost.Asio の API で操作してみたいと思います。</p>
<!--more-->
<h2 id="環境">環境</h2>
<ul>
<li>Arch Linux (x86_64)
<ul>
<li>boost: 1.68.0</li>
<li>clang: 7.0.0-1</li>
<li>glibc: 2.28-4</li>
<li>linux-api-headers: 4.17.11-1</li>
<li>linux: 4.18.12.arch1-1</li>
</ul></li>
<li>Logicool Gamepad F310</li>
</ul>
<h2 id="とりあえず使ってみる">とりあえず使ってみる</h2>
<p>身近なファイルディスクリプタといわれてまず挙がるのが標準入出力 (<code>STDIN_FILENO</code>, <code>STDOUT_FILENO</code>) でしょう。<a href="https://www.boost.org/doc/libs/1_68_0/doc/html/boost_asio/reference/posix__stream_descriptor.html" target="_blank" rel="nofollow noopener"><code>posix::stream_descriptor</code></a> でこれらのファイルディスクリプタを操作して、入力されたものをそのまま出力する、引数なしで実行した <a href="https://linux.die.net/man/1/cat" target="_blank" rel="nofollow noopener"><code>cat(1)</code></a> コマンドのような動作をするプログラムを書いてみるとこんな感じです。</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb1-1"><a href="/entry/2018/10/14/boost-asio-posix-stream_descriptor/#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;iostream&gt;</span></span>
<span id="cb1-2"><a href="/entry/2018/10/14/boost-asio-posix-stream_descriptor/#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;boost/asio.hpp&gt;</span></span>
<span id="cb1-3"><a href="/entry/2018/10/14/boost-asio-posix-stream_descriptor/#cb1-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-4"><a href="/entry/2018/10/14/boost-asio-posix-stream_descriptor/#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="at">extern</span> <span class="st">&quot;C&quot;</span> <span class="op">{</span></span>
<span id="cb1-5"><a href="/entry/2018/10/14/boost-asio-posix-stream_descriptor/#cb1-5" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;unistd.h&gt;</span></span>
<span id="cb1-6"><a href="/entry/2018/10/14/boost-asio-posix-stream_descriptor/#cb1-6" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb1-7"><a href="/entry/2018/10/14/boost-asio-posix-stream_descriptor/#cb1-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-8"><a href="/entry/2018/10/14/boost-asio-posix-stream_descriptor/#cb1-8" aria-hidden="true" tabindex="-1"></a><span class="kw">auto</span> main<span class="op">()</span> <span class="op">-&gt;</span> <span class="dt">int</span> <span class="op">{</span></span>
<span id="cb1-9"><a href="/entry/2018/10/14/boost-asio-posix-stream_descriptor/#cb1-9" aria-hidden="true" tabindex="-1"></a>  <span class="ex">boost::</span>asio<span class="ex">::</span>io_context<span class="op"> </span>ctx<span class="op">{};</span></span>
<span id="cb1-10"><a href="/entry/2018/10/14/boost-asio-posix-stream_descriptor/#cb1-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-11"><a href="/entry/2018/10/14/boost-asio-posix-stream_descriptor/#cb1-11" aria-hidden="true" tabindex="-1"></a>  <span class="ex">boost::</span>asio<span class="ex">::</span>posix<span class="ex">::</span>stream_descriptor<span class="op"> </span>stream_in<span class="op">{</span>ctx<span class="op">,</span> <span class="op">::</span>dup<span class="op">(</span>STDIN_FILENO<span class="op">)};</span></span>
<span id="cb1-12"><a href="/entry/2018/10/14/boost-asio-posix-stream_descriptor/#cb1-12" aria-hidden="true" tabindex="-1"></a>  <span class="ex">boost::</span>asio<span class="ex">::</span>posix<span class="ex">::</span>stream_descriptor<span class="op"> </span>stream_out<span class="op">{</span>ctx<span class="op">,</span> <span class="op">::</span>dup<span class="op">(</span>STDOUT_FILENO<span class="op">)};</span></span>
<span id="cb1-13"><a href="/entry/2018/10/14/boost-asio-posix-stream_descriptor/#cb1-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-14"><a href="/entry/2018/10/14/boost-asio-posix-stream_descriptor/#cb1-14" aria-hidden="true" tabindex="-1"></a>  <span class="ex">boost::</span>asio<span class="ex">::</span>streambuf<span class="op"> </span>buffer<span class="op">{};</span></span>
<span id="cb1-15"><a href="/entry/2018/10/14/boost-asio-posix-stream_descriptor/#cb1-15" aria-hidden="true" tabindex="-1"></a>  <span class="ex">boost::</span>system<span class="ex">::</span>error_code<span class="op"> </span>error<span class="op">{};</span></span>
<span id="cb1-16"><a href="/entry/2018/10/14/boost-asio-posix-stream_descriptor/#cb1-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-17"><a href="/entry/2018/10/14/boost-asio-posix-stream_descriptor/#cb1-17" aria-hidden="true" tabindex="-1"></a>  <span class="cf">while</span> <span class="op">(</span><span class="ex">boost::</span>asio<span class="ex">::</span>read<span class="op">(</span>stream_in<span class="op">,</span> buffer<span class="op">,</span> <span class="ex">boost::</span>asio<span class="ex">::</span>transfer_at_least<span class="op">(</span><span class="dv">1</span><span class="op">),</span> error<span class="op">))</span> <span class="op">{</span></span>
<span id="cb1-18"><a href="/entry/2018/10/14/boost-asio-posix-stream_descriptor/#cb1-18" aria-hidden="true" tabindex="-1"></a>    <span class="ex">boost::</span>asio<span class="ex">::</span>write<span class="op">(</span>stream_out<span class="op">,</span> buffer<span class="op">);</span></span>
<span id="cb1-19"><a href="/entry/2018/10/14/boost-asio-posix-stream_descriptor/#cb1-19" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb1-20"><a href="/entry/2018/10/14/boost-asio-posix-stream_descriptor/#cb1-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-21"><a href="/entry/2018/10/14/boost-asio-posix-stream_descriptor/#cb1-21" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> <span class="op">(</span>error <span class="op">!=</span> <span class="ex">boost::</span>asio<span class="ex">::</span>error<span class="ex">::</span>eof<span class="op">)</span> <span class="op">{</span></span>
<span id="cb1-22"><a href="/entry/2018/10/14/boost-asio-posix-stream_descriptor/#cb1-22" aria-hidden="true" tabindex="-1"></a>    <span class="bu">std::</span>cerr<span class="op"> &lt;&lt;</span> error<span class="op">.</span>message<span class="op">()</span> <span class="op">&lt;&lt;</span> <span class="bu">std::</span>endl<span class="op">;</span></span>
<span id="cb1-23"><a href="/entry/2018/10/14/boost-asio-posix-stream_descriptor/#cb1-23" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="dv">1</span><span class="op">;</span></span>
<span id="cb1-24"><a href="/entry/2018/10/14/boost-asio-posix-stream_descriptor/#cb1-24" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb1-25"><a href="/entry/2018/10/14/boost-asio-posix-stream_descriptor/#cb1-25" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p><code>posix::stream_descriptor</code> は、コンストラクタに <a href="https://www.boost.org/doc/libs/1_68_0/doc/html/boost_asio/reference/io_context.html" target="_blank" rel="nofollow noopener"><code>io_context</code></a> と操作したいファイルディスクリプタを渡してやるだけで準備完了です。あとはいつものように、<a href="https://www.boost.org/doc/libs/1_68_0/doc/html/boost_asio/reference/read.html" target="_blank" rel="nofollow noopener"><code>read</code></a> や <a href="https://www.boost.org/doc/libs/1_68_0/doc/html/boost_asio/reference/write.html" target="_blank" rel="nofollow noopener"><code>write</code></a>、<code>async_xxx</code> などの操作ができるようになります。簡単ですね。</p>
<p style="text-align: center;">
<object data="/entry/2018/10/14/boost-asio-posix-stream_descriptor/mycat.svg" style="max-width: 100%">
</object>
</p>
<h2 id="linux-の-joystick-api">Linux の Joystick API</h2>
<p>もう少し複雑な <code>posix::stream_descriptor</code> の使用例として、Linux の Joystick API を使ったものを紹介しようと思います。なぜ Joystick なのかというと、<a href="https://www.kernel.org/doc/html/v4.18/input/joydev/joystick-api.html" target="_blank" rel="nofollow noopener">ドキュメント</a>にあるようにとても単純で、なにか対象をそれっぽく動かしたいときにシュッと使えていいなーと思っているからです<a href="/entry/2018/10/14/boost-asio-posix-stream_descriptor/#fn1" class="footnote-ref" id="fnref1" role="doc-noteref"><sup>1</sup></a>。</p>
<p>Linux マシンに Joystick を接続すると、<code>/dev/input/jsX</code> が出現します。これを <a href="https://linux.die.net/man/2/open" target="_blank" rel="nofollow noopener"><code>open(2)</code></a> して <a href="https://linux.die.net/man/2/read" target="_blank" rel="nofollow noopener"><code>read(2)</code></a> すると、Joystick の状態の変化を <code>struct js_event</code> の形式で取得することができます。</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb2-1"><a href="/entry/2018/10/14/boost-asio-posix-stream_descriptor/#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="kw">struct</span> js_event <span class="op">{</span></span>
<span id="cb2-2"><a href="/entry/2018/10/14/boost-asio-posix-stream_descriptor/#cb2-2" aria-hidden="true" tabindex="-1"></a>        __u32 time<span class="op">;</span>     <span class="co">/* event timestamp in milliseconds */</span></span>
<span id="cb2-3"><a href="/entry/2018/10/14/boost-asio-posix-stream_descriptor/#cb2-3" aria-hidden="true" tabindex="-1"></a>        __s16 value<span class="op">;</span>    <span class="co">/* value */</span></span>
<span id="cb2-4"><a href="/entry/2018/10/14/boost-asio-posix-stream_descriptor/#cb2-4" aria-hidden="true" tabindex="-1"></a>        __u8 type<span class="op">;</span>      <span class="co">/* event type */</span></span>
<span id="cb2-5"><a href="/entry/2018/10/14/boost-asio-posix-stream_descriptor/#cb2-5" aria-hidden="true" tabindex="-1"></a>        __u8 number<span class="op">;</span>    <span class="co">/* axis/button number */</span></span>
<span id="cb2-6"><a href="/entry/2018/10/14/boost-asio-posix-stream_descriptor/#cb2-6" aria-hidden="true" tabindex="-1"></a><span class="op">};</span></span></code></pre></div>
<p><a href="https://www.kernel.org/doc/html/v4.18/input/joydev/joystick-api.html#js-event-type" target="_blank" rel="nofollow noopener"><code>js_event.type</code></a> はイベントの種類を表すもので、ボタンが押された/離されたを示す <code>JS_EVENT_BUTTON</code>、スティックが動かされたかを示す <code>JS_EVENT_AXIS</code> があります。また、<code>open(2)</code> して最初に <code>read(2)</code> したときに Joystick が持つ全てのボタンやスティックの初期値が送られてくるのですが、その時の値は <code>JS_EVENT_INIT</code> との or をとった値になっています。</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb3-1"><a href="/entry/2018/10/14/boost-asio-posix-stream_descriptor/#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="pp">#define JS_EVENT_BUTTON         0x01    </span><span class="co">/* button pressed/released */</span></span>
<span id="cb3-2"><a href="/entry/2018/10/14/boost-asio-posix-stream_descriptor/#cb3-2" aria-hidden="true" tabindex="-1"></a><span class="pp">#define JS_EVENT_AXIS           0x02    </span><span class="co">/* joystick moved */</span></span>
<span id="cb3-3"><a href="/entry/2018/10/14/boost-asio-posix-stream_descriptor/#cb3-3" aria-hidden="true" tabindex="-1"></a><span class="pp">#define JS_EVENT_INIT           0x80    </span><span class="co">/* initial state of device */</span></span></code></pre></div>
<p><a href="https://www.kernel.org/doc/html/v4.18/input/joydev/joystick-api.html#js-event-number" target="_blank" rel="nofollow noopener"><code>js_event.number</code></a> はボタンやスティックのインデックス、<a href="https://www.kernel.org/doc/html/v4.18/input/joydev/joystick-api.html#js-event-value" target="_blank" rel="nofollow noopener"><code>js_event.value</code></a> は変化後の値です。</p>
<p>接続された Joystick に関する情報は <a href="https://linux.die.net/man/2/ioctl" target="_blank" rel="nofollow noopener"><code>ioctl(2)</code></a> で取得できます。取得できる情報には以下のようなものがあり、</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb4-1"><a href="/entry/2018/10/14/boost-asio-posix-stream_descriptor/#cb4-1" aria-hidden="true" tabindex="-1"></a>                        <span class="co">/* function                     3rd arg  */</span></span>
<span id="cb4-2"><a href="/entry/2018/10/14/boost-asio-posix-stream_descriptor/#cb4-2" aria-hidden="true" tabindex="-1"></a><span class="pp">#define JSIOCGAXES      </span><span class="co">/* get number of axes           char     */</span></span>
<span id="cb4-3"><a href="/entry/2018/10/14/boost-asio-posix-stream_descriptor/#cb4-3" aria-hidden="true" tabindex="-1"></a><span class="pp">#define JSIOCGBUTTONS   </span><span class="co">/* get number of buttons        char     */</span></span>
<span id="cb4-4"><a href="/entry/2018/10/14/boost-asio-posix-stream_descriptor/#cb4-4" aria-hidden="true" tabindex="-1"></a><span class="pp">#define JSIOCGVERSION   </span><span class="co">/* get driver version           int      */</span></span>
<span id="cb4-5"><a href="/entry/2018/10/14/boost-asio-posix-stream_descriptor/#cb4-5" aria-hidden="true" tabindex="-1"></a><span class="pp">#define JSIOCGNAME(len) </span><span class="co">/* get identifier string        char     */</span></span>
<span id="cb4-6"><a href="/entry/2018/10/14/boost-asio-posix-stream_descriptor/#cb4-6" aria-hidden="true" tabindex="-1"></a><span class="pp">#define JSIOCSCORR      </span><span class="co">/* set correction values        &amp;js_corr */</span></span>
<span id="cb4-7"><a href="/entry/2018/10/14/boost-asio-posix-stream_descriptor/#cb4-7" aria-hidden="true" tabindex="-1"></a><span class="pp">#define JSIOCGCORR      </span><span class="co">/* get correction values        &amp;js_corr */</span></span></code></pre></div>
<p>例えばスティックの数は次のようなコードで取得できます。</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb5-1"><a href="/entry/2018/10/14/boost-asio-posix-stream_descriptor/#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="dt">char</span> number_of_axes<span class="op">;</span></span>
<span id="cb5-2"><a href="/entry/2018/10/14/boost-asio-posix-stream_descriptor/#cb5-2" aria-hidden="true" tabindex="-1"></a>ioctl<span class="op">(</span>fd<span class="op">,</span> JSIOCGAXES<span class="op">,</span> <span class="op">&amp;</span>number_of_axes<span class="op">);</span></span></code></pre></div>
<h2 id="任意のタイミングで-joystick-の状態を取得したい">任意のタイミングで Joystick の状態を取得したい</h2>
<p>Linux の Joystick API は状態が変化したときにイベントが送られてくるというものなので、任意のタイミングで Joystick の状態を取得したいときにはイベントを監視して内部状態を更新するようなプログラムを実装する必要があります。</p>
<p>例えば 1/60 [s] 毎に Joystick の状態をコンソールに出力するプログラムを実装したいとします<a href="/entry/2018/10/14/boost-asio-posix-stream_descriptor/#fn2" class="footnote-ref" id="fnref2" role="doc-noteref"><sup>2</sup></a>。<a href="https://linux.die.net/man/1/jstest" target="_blank" rel="nofollow noopener"><code>jstest(1)</code> コマンド</a>のようなイメージです。</p>
<p>雑な実装としては nonblocking mode (<code>open</code> の第2引数に <code>O_NONBLOCK</code> を指定する) やスレッドを用いる方法、もう少し複雑な例としては <a href="https://linux.die.net/man/2/select" target="_blank" rel="nofollow noopener"><code>select(2)</code></a> を使う方法でしょうか。タイマーに <a href="https://linux.die.net/man/2/timerfd_create" target="_blank" rel="nofollow noopener"><code>timerfd_create(2)</code></a> を使い、ファイルディスクリプタの監視に <code>select(2)</code> を使って C で実装してみたのがこんな感じです。</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode c"><code class="sourceCode c"><span id="cb6-1"><a href="/entry/2018/10/14/boost-asio-posix-stream_descriptor/#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;inttypes.h&gt;</span></span>
<span id="cb6-2"><a href="/entry/2018/10/14/boost-asio-posix-stream_descriptor/#cb6-2" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;stdint.h&gt;</span></span>
<span id="cb6-3"><a href="/entry/2018/10/14/boost-asio-posix-stream_descriptor/#cb6-3" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;stdio.h&gt;</span></span>
<span id="cb6-4"><a href="/entry/2018/10/14/boost-asio-posix-stream_descriptor/#cb6-4" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;stdlib.h&gt;</span></span>
<span id="cb6-5"><a href="/entry/2018/10/14/boost-asio-posix-stream_descriptor/#cb6-5" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;time.h&gt;</span></span>
<span id="cb6-6"><a href="/entry/2018/10/14/boost-asio-posix-stream_descriptor/#cb6-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-7"><a href="/entry/2018/10/14/boost-asio-posix-stream_descriptor/#cb6-7" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;fcntl.h&gt;</span></span>
<span id="cb6-8"><a href="/entry/2018/10/14/boost-asio-posix-stream_descriptor/#cb6-8" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;linux/joystick.h&gt;</span></span>
<span id="cb6-9"><a href="/entry/2018/10/14/boost-asio-posix-stream_descriptor/#cb6-9" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;sys/ioctl.h&gt;</span></span>
<span id="cb6-10"><a href="/entry/2018/10/14/boost-asio-posix-stream_descriptor/#cb6-10" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;sys/select.h&gt;</span></span>
<span id="cb6-11"><a href="/entry/2018/10/14/boost-asio-posix-stream_descriptor/#cb6-11" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;sys/time.h&gt;</span></span>
<span id="cb6-12"><a href="/entry/2018/10/14/boost-asio-posix-stream_descriptor/#cb6-12" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;sys/timerfd.h&gt;</span></span>
<span id="cb6-13"><a href="/entry/2018/10/14/boost-asio-posix-stream_descriptor/#cb6-13" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;sys/types.h&gt;</span></span>
<span id="cb6-14"><a href="/entry/2018/10/14/boost-asio-posix-stream_descriptor/#cb6-14" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;unistd.h&gt;</span></span>
<span id="cb6-15"><a href="/entry/2018/10/14/boost-asio-posix-stream_descriptor/#cb6-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-16"><a href="/entry/2018/10/14/boost-asio-posix-stream_descriptor/#cb6-16" aria-hidden="true" tabindex="-1"></a><span class="kw">struct</span> joystick_state <span class="op">{</span></span>
<span id="cb6-17"><a href="/entry/2018/10/14/boost-asio-posix-stream_descriptor/#cb6-17" aria-hidden="true" tabindex="-1"></a>  <span class="dt">uint8_t</span> num_axes<span class="op">;</span></span>
<span id="cb6-18"><a href="/entry/2018/10/14/boost-asio-posix-stream_descriptor/#cb6-18" aria-hidden="true" tabindex="-1"></a>  <span class="dt">uint8_t</span> num_buttons<span class="op">;</span></span>
<span id="cb6-19"><a href="/entry/2018/10/14/boost-asio-posix-stream_descriptor/#cb6-19" aria-hidden="true" tabindex="-1"></a>  <span class="dt">int16_t</span><span class="op">*</span> axes<span class="op">;</span></span>
<span id="cb6-20"><a href="/entry/2018/10/14/boost-asio-posix-stream_descriptor/#cb6-20" aria-hidden="true" tabindex="-1"></a>  <span class="dt">int16_t</span><span class="op">*</span> buttons<span class="op">;</span></span>
<span id="cb6-21"><a href="/entry/2018/10/14/boost-asio-posix-stream_descriptor/#cb6-21" aria-hidden="true" tabindex="-1"></a><span class="op">};</span></span>
<span id="cb6-22"><a href="/entry/2018/10/14/boost-asio-posix-stream_descriptor/#cb6-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-23"><a href="/entry/2018/10/14/boost-asio-posix-stream_descriptor/#cb6-23" aria-hidden="true" tabindex="-1"></a><span class="dt">static</span> <span class="dt">void</span> perror_exit<span class="op">(</span><span class="dt">const</span> <span class="dt">char</span><span class="op">*</span> msg<span class="op">)</span> <span class="op">{</span></span>
<span id="cb6-24"><a href="/entry/2018/10/14/boost-asio-posix-stream_descriptor/#cb6-24" aria-hidden="true" tabindex="-1"></a>  perror<span class="op">(</span>msg<span class="op">);</span></span>
<span id="cb6-25"><a href="/entry/2018/10/14/boost-asio-posix-stream_descriptor/#cb6-25" aria-hidden="true" tabindex="-1"></a>  exit<span class="op">(</span>EXIT_FAILURE<span class="op">);</span></span>
<span id="cb6-26"><a href="/entry/2018/10/14/boost-asio-posix-stream_descriptor/#cb6-26" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb6-27"><a href="/entry/2018/10/14/boost-asio-posix-stream_descriptor/#cb6-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-28"><a href="/entry/2018/10/14/boost-asio-posix-stream_descriptor/#cb6-28" aria-hidden="true" tabindex="-1"></a><span class="dt">static</span> <span class="dt">void</span> update_joystick_state<span class="op">(</span><span class="kw">struct</span> joystick_state<span class="op">*</span> state<span class="op">,</span> <span class="kw">struct</span> js_event<span class="op">*</span> jse<span class="op">)</span> <span class="op">{</span></span>
<span id="cb6-29"><a href="/entry/2018/10/14/boost-asio-posix-stream_descriptor/#cb6-29" aria-hidden="true" tabindex="-1"></a>  <span class="cf">switch</span> <span class="op">(</span>jse<span class="op">-&gt;</span>type <span class="op">&amp;</span> <span class="op">~</span>JS_EVENT_INIT<span class="op">)</span> <span class="op">{</span></span>
<span id="cb6-30"><a href="/entry/2018/10/14/boost-asio-posix-stream_descriptor/#cb6-30" aria-hidden="true" tabindex="-1"></a>    <span class="cf">case</span> JS_EVENT_AXIS<span class="op">:</span></span>
<span id="cb6-31"><a href="/entry/2018/10/14/boost-asio-posix-stream_descriptor/#cb6-31" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> <span class="op">(</span>jse<span class="op">-&gt;</span>number <span class="op">&lt;</span> state<span class="op">-&gt;</span>num_axes<span class="op">)</span> <span class="op">{</span></span>
<span id="cb6-32"><a href="/entry/2018/10/14/boost-asio-posix-stream_descriptor/#cb6-32" aria-hidden="true" tabindex="-1"></a>        state<span class="op">-&gt;</span>axes<span class="op">[</span>jse<span class="op">-&gt;</span>number<span class="op">]</span> <span class="op">=</span> jse<span class="op">-&gt;</span>value<span class="op">;</span></span>
<span id="cb6-33"><a href="/entry/2018/10/14/boost-asio-posix-stream_descriptor/#cb6-33" aria-hidden="true" tabindex="-1"></a>      <span class="op">}</span></span>
<span id="cb6-34"><a href="/entry/2018/10/14/boost-asio-posix-stream_descriptor/#cb6-34" aria-hidden="true" tabindex="-1"></a>      <span class="cf">break</span><span class="op">;</span></span>
<span id="cb6-35"><a href="/entry/2018/10/14/boost-asio-posix-stream_descriptor/#cb6-35" aria-hidden="true" tabindex="-1"></a>    <span class="cf">case</span> JS_EVENT_BUTTON<span class="op">:</span></span>
<span id="cb6-36"><a href="/entry/2018/10/14/boost-asio-posix-stream_descriptor/#cb6-36" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> <span class="op">(</span>jse<span class="op">-&gt;</span>number <span class="op">&lt;</span> state<span class="op">-&gt;</span>num_buttons<span class="op">)</span> <span class="op">{</span></span>
<span id="cb6-37"><a href="/entry/2018/10/14/boost-asio-posix-stream_descriptor/#cb6-37" aria-hidden="true" tabindex="-1"></a>        state<span class="op">-&gt;</span>buttons<span class="op">[</span>jse<span class="op">-&gt;</span>number<span class="op">]</span> <span class="op">=</span> jse<span class="op">-&gt;</span>value<span class="op">;</span></span>
<span id="cb6-38"><a href="/entry/2018/10/14/boost-asio-posix-stream_descriptor/#cb6-38" aria-hidden="true" tabindex="-1"></a>      <span class="op">}</span></span>
<span id="cb6-39"><a href="/entry/2018/10/14/boost-asio-posix-stream_descriptor/#cb6-39" aria-hidden="true" tabindex="-1"></a>      <span class="cf">break</span><span class="op">;</span></span>
<span id="cb6-40"><a href="/entry/2018/10/14/boost-asio-posix-stream_descriptor/#cb6-40" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb6-41"><a href="/entry/2018/10/14/boost-asio-posix-stream_descriptor/#cb6-41" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb6-42"><a href="/entry/2018/10/14/boost-asio-posix-stream_descriptor/#cb6-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-43"><a href="/entry/2018/10/14/boost-asio-posix-stream_descriptor/#cb6-43" aria-hidden="true" tabindex="-1"></a><span class="dt">static</span> <span class="dt">void</span> print_joystick_state<span class="op">(</span><span class="kw">struct</span> joystick_state<span class="op">*</span> state<span class="op">)</span> <span class="op">{</span></span>
<span id="cb6-44"><a href="/entry/2018/10/14/boost-asio-posix-stream_descriptor/#cb6-44" aria-hidden="true" tabindex="-1"></a>  printf<span class="op">(</span><span class="st">&quot;</span><span class="sc">\r</span><span class="st">&quot;</span><span class="op">);</span></span>
<span id="cb6-45"><a href="/entry/2018/10/14/boost-asio-posix-stream_descriptor/#cb6-45" aria-hidden="true" tabindex="-1"></a>  printf<span class="op">(</span><span class="st">&quot;axes: &quot;</span><span class="op">);</span></span>
<span id="cb6-46"><a href="/entry/2018/10/14/boost-asio-posix-stream_descriptor/#cb6-46" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> <span class="op">(</span><span class="dt">uint16_t</span> i <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> i <span class="op">&lt;</span> <span class="op">(</span><span class="dt">uint16_t</span><span class="op">)</span>state<span class="op">-&gt;</span>num_axes<span class="op">;</span> <span class="op">++</span>i<span class="op">)</span> <span class="op">{</span></span>
<span id="cb6-47"><a href="/entry/2018/10/14/boost-asio-posix-stream_descriptor/#cb6-47" aria-hidden="true" tabindex="-1"></a>    printf<span class="op">(</span><span class="st">&quot;%6&quot;</span> PRId16 <span class="st">&quot; &quot;</span><span class="op">,</span> state<span class="op">-&gt;</span>axes<span class="op">[</span>i<span class="op">]);</span></span>
<span id="cb6-48"><a href="/entry/2018/10/14/boost-asio-posix-stream_descriptor/#cb6-48" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb6-49"><a href="/entry/2018/10/14/boost-asio-posix-stream_descriptor/#cb6-49" aria-hidden="true" tabindex="-1"></a>  printf<span class="op">(</span><span class="st">&quot;buttons: &quot;</span><span class="op">);</span></span>
<span id="cb6-50"><a href="/entry/2018/10/14/boost-asio-posix-stream_descriptor/#cb6-50" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> <span class="op">(</span><span class="dt">uint16_t</span> i <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> i <span class="op">&lt;</span> <span class="op">(</span><span class="dt">uint16_t</span><span class="op">)</span>state<span class="op">-&gt;</span>num_buttons<span class="op">;</span> <span class="op">++</span>i<span class="op">)</span> <span class="op">{</span></span>
<span id="cb6-51"><a href="/entry/2018/10/14/boost-asio-posix-stream_descriptor/#cb6-51" aria-hidden="true" tabindex="-1"></a>    printf<span class="op">(</span><span class="st">&quot;%&quot;</span> PRId16 <span class="st">&quot; &quot;</span><span class="op">,</span> state<span class="op">-&gt;</span>buttons<span class="op">[</span>i<span class="op">]);</span></span>
<span id="cb6-52"><a href="/entry/2018/10/14/boost-asio-posix-stream_descriptor/#cb6-52" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb6-53"><a href="/entry/2018/10/14/boost-asio-posix-stream_descriptor/#cb6-53" aria-hidden="true" tabindex="-1"></a>  fflush<span class="op">(</span>stdout<span class="op">);</span></span>
<span id="cb6-54"><a href="/entry/2018/10/14/boost-asio-posix-stream_descriptor/#cb6-54" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb6-55"><a href="/entry/2018/10/14/boost-asio-posix-stream_descriptor/#cb6-55" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-56"><a href="/entry/2018/10/14/boost-asio-posix-stream_descriptor/#cb6-56" aria-hidden="true" tabindex="-1"></a><span class="dt">int</span> main<span class="op">(</span><span class="dt">int</span> argc<span class="op">,</span> <span class="dt">char</span><span class="op">**</span> argv<span class="op">)</span> <span class="op">{</span></span>
<span id="cb6-57"><a href="/entry/2018/10/14/boost-asio-posix-stream_descriptor/#cb6-57" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> <span class="op">(</span>argc <span class="op">!=</span> <span class="dv">2</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb6-58"><a href="/entry/2018/10/14/boost-asio-posix-stream_descriptor/#cb6-58" aria-hidden="true" tabindex="-1"></a>    fprintf<span class="op">(</span>stderr<span class="op">,</span> <span class="st">&quot;usage: %s &lt;device&gt;</span><span class="sc">\n</span><span class="st">&quot;</span><span class="op">,</span> argv<span class="op">[</span><span class="dv">0</span><span class="op">]);</span></span>
<span id="cb6-59"><a href="/entry/2018/10/14/boost-asio-posix-stream_descriptor/#cb6-59" aria-hidden="true" tabindex="-1"></a>    exit<span class="op">(</span><span class="dv">1</span><span class="op">);</span></span>
<span id="cb6-60"><a href="/entry/2018/10/14/boost-asio-posix-stream_descriptor/#cb6-60" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb6-61"><a href="/entry/2018/10/14/boost-asio-posix-stream_descriptor/#cb6-61" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-62"><a href="/entry/2018/10/14/boost-asio-posix-stream_descriptor/#cb6-62" aria-hidden="true" tabindex="-1"></a>  <span class="dt">int</span> joy_fd <span class="op">=</span> open<span class="op">(</span>argv<span class="op">[</span><span class="dv">1</span><span class="op">],</span> O_RDONLY<span class="op">);</span></span>
<span id="cb6-63"><a href="/entry/2018/10/14/boost-asio-posix-stream_descriptor/#cb6-63" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> <span class="op">(</span>joy_fd <span class="op">&lt;</span> <span class="dv">0</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb6-64"><a href="/entry/2018/10/14/boost-asio-posix-stream_descriptor/#cb6-64" aria-hidden="true" tabindex="-1"></a>    perror_exit<span class="op">(</span>argv<span class="op">[</span><span class="dv">1</span><span class="op">]);</span></span>
<span id="cb6-65"><a href="/entry/2018/10/14/boost-asio-posix-stream_descriptor/#cb6-65" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb6-66"><a href="/entry/2018/10/14/boost-asio-posix-stream_descriptor/#cb6-66" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-67"><a href="/entry/2018/10/14/boost-asio-posix-stream_descriptor/#cb6-67" aria-hidden="true" tabindex="-1"></a>  <span class="kw">struct</span> joystick_state state<span class="op">;</span></span>
<span id="cb6-68"><a href="/entry/2018/10/14/boost-asio-posix-stream_descriptor/#cb6-68" aria-hidden="true" tabindex="-1"></a>  <span class="op">{</span></span>
<span id="cb6-69"><a href="/entry/2018/10/14/boost-asio-posix-stream_descriptor/#cb6-69" aria-hidden="true" tabindex="-1"></a>    ioctl<span class="op">(</span>joy_fd<span class="op">,</span> JSIOCGAXES<span class="op">,</span> <span class="op">&amp;</span>state<span class="op">.</span>num_axes<span class="op">);</span></span>
<span id="cb6-70"><a href="/entry/2018/10/14/boost-asio-posix-stream_descriptor/#cb6-70" aria-hidden="true" tabindex="-1"></a>    ioctl<span class="op">(</span>joy_fd<span class="op">,</span> JSIOCGBUTTONS<span class="op">,</span> <span class="op">&amp;</span>state<span class="op">.</span>num_buttons<span class="op">);</span></span>
<span id="cb6-71"><a href="/entry/2018/10/14/boost-asio-posix-stream_descriptor/#cb6-71" aria-hidden="true" tabindex="-1"></a>    state<span class="op">.</span>axes    <span class="op">=</span> <span class="op">(</span><span class="dt">int16_t</span><span class="op">*)</span>calloc<span class="op">(</span>state<span class="op">.</span>num_axes<span class="op">,</span> <span class="kw">sizeof</span><span class="op">(</span><span class="dt">int16_t</span><span class="op">));</span></span>
<span id="cb6-72"><a href="/entry/2018/10/14/boost-asio-posix-stream_descriptor/#cb6-72" aria-hidden="true" tabindex="-1"></a>    state<span class="op">.</span>buttons <span class="op">=</span> <span class="op">(</span><span class="dt">int16_t</span><span class="op">*)</span>calloc<span class="op">(</span>state<span class="op">.</span>num_buttons<span class="op">,</span> <span class="kw">sizeof</span><span class="op">(</span><span class="dt">int16_t</span><span class="op">));</span></span>
<span id="cb6-73"><a href="/entry/2018/10/14/boost-asio-posix-stream_descriptor/#cb6-73" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb6-74"><a href="/entry/2018/10/14/boost-asio-posix-stream_descriptor/#cb6-74" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-75"><a href="/entry/2018/10/14/boost-asio-posix-stream_descriptor/#cb6-75" aria-hidden="true" tabindex="-1"></a>  <span class="dt">int</span> timer_fd <span class="op">=</span> timerfd_create<span class="op">(</span>CLOCK_REALTIME<span class="op">,</span> <span class="dv">0</span><span class="op">);</span></span>
<span id="cb6-76"><a href="/entry/2018/10/14/boost-asio-posix-stream_descriptor/#cb6-76" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> <span class="op">(</span>timer_fd <span class="op">&lt;</span> <span class="dv">0</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb6-77"><a href="/entry/2018/10/14/boost-asio-posix-stream_descriptor/#cb6-77" aria-hidden="true" tabindex="-1"></a>    perror_exit<span class="op">(</span><span class="st">&quot;timerfd_create&quot;</span><span class="op">);</span></span>
<span id="cb6-78"><a href="/entry/2018/10/14/boost-asio-posix-stream_descriptor/#cb6-78" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb6-79"><a href="/entry/2018/10/14/boost-asio-posix-stream_descriptor/#cb6-79" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-80"><a href="/entry/2018/10/14/boost-asio-posix-stream_descriptor/#cb6-80" aria-hidden="true" tabindex="-1"></a>  <span class="kw">struct</span> itimerspec nexttime<span class="op">;</span></span>
<span id="cb6-81"><a href="/entry/2018/10/14/boost-asio-posix-stream_descriptor/#cb6-81" aria-hidden="true" tabindex="-1"></a>  <span class="op">{</span></span>
<span id="cb6-82"><a href="/entry/2018/10/14/boost-asio-posix-stream_descriptor/#cb6-82" aria-hidden="true" tabindex="-1"></a>    <span class="kw">struct</span> timespec now<span class="op">;</span></span>
<span id="cb6-83"><a href="/entry/2018/10/14/boost-asio-posix-stream_descriptor/#cb6-83" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>clock_gettime<span class="op">(</span>CLOCK_REALTIME<span class="op">,</span> <span class="op">&amp;</span>now<span class="op">)</span> <span class="op">!=</span> <span class="dv">0</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb6-84"><a href="/entry/2018/10/14/boost-asio-posix-stream_descriptor/#cb6-84" aria-hidden="true" tabindex="-1"></a>      perror_exit<span class="op">(</span><span class="st">&quot;clock_gettime&quot;</span><span class="op">);</span></span>
<span id="cb6-85"><a href="/entry/2018/10/14/boost-asio-posix-stream_descriptor/#cb6-85" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb6-86"><a href="/entry/2018/10/14/boost-asio-posix-stream_descriptor/#cb6-86" aria-hidden="true" tabindex="-1"></a>    <span class="co">// 1/60 [sec] = 16,666,666 [ns]</span></span>
<span id="cb6-87"><a href="/entry/2018/10/14/boost-asio-posix-stream_descriptor/#cb6-87" aria-hidden="true" tabindex="-1"></a>    nexttime<span class="op">.</span>it_interval<span class="op">.</span>tv_sec  <span class="op">=</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb6-88"><a href="/entry/2018/10/14/boost-asio-posix-stream_descriptor/#cb6-88" aria-hidden="true" tabindex="-1"></a>    nexttime<span class="op">.</span>it_interval<span class="op">.</span>tv_nsec <span class="op">=</span> <span class="dv">16666666</span><span class="op">;</span></span>
<span id="cb6-89"><a href="/entry/2018/10/14/boost-asio-posix-stream_descriptor/#cb6-89" aria-hidden="true" tabindex="-1"></a>    nexttime<span class="op">.</span>it_value<span class="op">.</span>tv_sec     <span class="op">=</span> nexttime<span class="op">.</span>it_interval<span class="op">.</span>tv_sec <span class="op">+</span> now<span class="op">.</span>tv_sec<span class="op">;</span></span>
<span id="cb6-90"><a href="/entry/2018/10/14/boost-asio-posix-stream_descriptor/#cb6-90" aria-hidden="true" tabindex="-1"></a>    nexttime<span class="op">.</span>it_value<span class="op">.</span>tv_nsec    <span class="op">=</span> nexttime<span class="op">.</span>it_interval<span class="op">.</span>tv_nsec <span class="op">+</span> now<span class="op">.</span>tv_nsec<span class="op">;</span></span>
<span id="cb6-91"><a href="/entry/2018/10/14/boost-asio-posix-stream_descriptor/#cb6-91" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb6-92"><a href="/entry/2018/10/14/boost-asio-posix-stream_descriptor/#cb6-92" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-93"><a href="/entry/2018/10/14/boost-asio-posix-stream_descriptor/#cb6-93" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> <span class="op">(</span>timerfd_settime<span class="op">(</span>timer_fd<span class="op">,</span> TFD_TIMER_ABSTIME<span class="op">,</span> <span class="op">&amp;</span>nexttime<span class="op">,</span> NULL<span class="op">)</span> <span class="op">!=</span> <span class="dv">0</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb6-94"><a href="/entry/2018/10/14/boost-asio-posix-stream_descriptor/#cb6-94" aria-hidden="true" tabindex="-1"></a>    perror_exit<span class="op">(</span><span class="st">&quot;timerfd_settime&quot;</span><span class="op">);</span></span>
<span id="cb6-95"><a href="/entry/2018/10/14/boost-asio-posix-stream_descriptor/#cb6-95" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb6-96"><a href="/entry/2018/10/14/boost-asio-posix-stream_descriptor/#cb6-96" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-97"><a href="/entry/2018/10/14/boost-asio-posix-stream_descriptor/#cb6-97" aria-hidden="true" tabindex="-1"></a>  print_joystick_state<span class="op">(&amp;</span>state<span class="op">);</span></span>
<span id="cb6-98"><a href="/entry/2018/10/14/boost-asio-posix-stream_descriptor/#cb6-98" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-99"><a href="/entry/2018/10/14/boost-asio-posix-stream_descriptor/#cb6-99" aria-hidden="true" tabindex="-1"></a>  <span class="cf">while</span> <span class="op">(</span><span class="dv">1</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb6-100"><a href="/entry/2018/10/14/boost-asio-posix-stream_descriptor/#cb6-100" aria-hidden="true" tabindex="-1"></a>    fd_set rfds<span class="op">;</span></span>
<span id="cb6-101"><a href="/entry/2018/10/14/boost-asio-posix-stream_descriptor/#cb6-101" aria-hidden="true" tabindex="-1"></a>    FD_ZERO<span class="op">(&amp;</span>rfds<span class="op">);</span></span>
<span id="cb6-102"><a href="/entry/2018/10/14/boost-asio-posix-stream_descriptor/#cb6-102" aria-hidden="true" tabindex="-1"></a>    FD_SET<span class="op">(</span>joy_fd<span class="op">,</span> <span class="op">&amp;</span>rfds<span class="op">);</span></span>
<span id="cb6-103"><a href="/entry/2018/10/14/boost-asio-posix-stream_descriptor/#cb6-103" aria-hidden="true" tabindex="-1"></a>    FD_SET<span class="op">(</span>timer_fd<span class="op">,</span> <span class="op">&amp;</span>rfds<span class="op">);</span></span>
<span id="cb6-104"><a href="/entry/2018/10/14/boost-asio-posix-stream_descriptor/#cb6-104" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-105"><a href="/entry/2018/10/14/boost-asio-posix-stream_descriptor/#cb6-105" aria-hidden="true" tabindex="-1"></a>    <span class="dt">int</span> maxfd <span class="op">=</span> joy_fd <span class="op">&gt;</span> timer_fd <span class="op">?</span> joy_fd <span class="op">:</span> timer_fd<span class="op">;</span></span>
<span id="cb6-106"><a href="/entry/2018/10/14/boost-asio-posix-stream_descriptor/#cb6-106" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-107"><a href="/entry/2018/10/14/boost-asio-posix-stream_descriptor/#cb6-107" aria-hidden="true" tabindex="-1"></a>    <span class="dt">int</span> ret <span class="op">=</span> select<span class="op">(</span>maxfd <span class="op">+</span> <span class="dv">1</span><span class="op">,</span> <span class="op">&amp;</span>rfds<span class="op">,</span> NULL<span class="op">,</span> NULL<span class="op">,</span> NULL<span class="op">);</span></span>
<span id="cb6-108"><a href="/entry/2018/10/14/boost-asio-posix-stream_descriptor/#cb6-108" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>ret <span class="op">&gt;</span> <span class="dv">0</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb6-109"><a href="/entry/2018/10/14/boost-asio-posix-stream_descriptor/#cb6-109" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> <span class="op">(</span>FD_ISSET<span class="op">(</span>joy_fd<span class="op">,</span> <span class="op">&amp;</span>rfds<span class="op">))</span> <span class="op">{</span></span>
<span id="cb6-110"><a href="/entry/2018/10/14/boost-asio-posix-stream_descriptor/#cb6-110" aria-hidden="true" tabindex="-1"></a>        <span class="kw">struct</span> js_event jse<span class="op">;</span></span>
<span id="cb6-111"><a href="/entry/2018/10/14/boost-asio-posix-stream_descriptor/#cb6-111" aria-hidden="true" tabindex="-1"></a>        <span class="dt">ssize_t</span> s <span class="op">=</span> read<span class="op">(</span>joy_fd<span class="op">,</span> <span class="op">&amp;</span>jse<span class="op">,</span> <span class="kw">sizeof</span> jse<span class="op">);</span></span>
<span id="cb6-112"><a href="/entry/2018/10/14/boost-asio-posix-stream_descriptor/#cb6-112" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="op">(</span>s <span class="op">!=</span> <span class="kw">sizeof</span> jse<span class="op">)</span> <span class="op">{</span></span>
<span id="cb6-113"><a href="/entry/2018/10/14/boost-asio-posix-stream_descriptor/#cb6-113" aria-hidden="true" tabindex="-1"></a>          perror_exit<span class="op">(</span><span class="st">&quot;read(joy_fd)&quot;</span><span class="op">);</span></span>
<span id="cb6-114"><a href="/entry/2018/10/14/boost-asio-posix-stream_descriptor/#cb6-114" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb6-115"><a href="/entry/2018/10/14/boost-asio-posix-stream_descriptor/#cb6-115" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-116"><a href="/entry/2018/10/14/boost-asio-posix-stream_descriptor/#cb6-116" aria-hidden="true" tabindex="-1"></a>        update_joystick_state<span class="op">(&amp;</span>state<span class="op">,</span> <span class="op">&amp;</span>jse<span class="op">);</span></span>
<span id="cb6-117"><a href="/entry/2018/10/14/boost-asio-posix-stream_descriptor/#cb6-117" aria-hidden="true" tabindex="-1"></a>      <span class="op">}</span></span>
<span id="cb6-118"><a href="/entry/2018/10/14/boost-asio-posix-stream_descriptor/#cb6-118" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-119"><a href="/entry/2018/10/14/boost-asio-posix-stream_descriptor/#cb6-119" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> <span class="op">(</span>FD_ISSET<span class="op">(</span>timer_fd<span class="op">,</span> <span class="op">&amp;</span>rfds<span class="op">))</span> <span class="op">{</span></span>
<span id="cb6-120"><a href="/entry/2018/10/14/boost-asio-posix-stream_descriptor/#cb6-120" aria-hidden="true" tabindex="-1"></a>        <span class="dt">uint64_t</span> t<span class="op">;</span></span>
<span id="cb6-121"><a href="/entry/2018/10/14/boost-asio-posix-stream_descriptor/#cb6-121" aria-hidden="true" tabindex="-1"></a>        <span class="dt">ssize_t</span> s <span class="op">=</span> read<span class="op">(</span>timer_fd<span class="op">,</span> <span class="op">&amp;</span>t<span class="op">,</span> <span class="kw">sizeof</span> t<span class="op">);</span></span>
<span id="cb6-122"><a href="/entry/2018/10/14/boost-asio-posix-stream_descriptor/#cb6-122" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="op">(</span>s <span class="op">!=</span> <span class="kw">sizeof</span> t<span class="op">)</span> <span class="op">{</span></span>
<span id="cb6-123"><a href="/entry/2018/10/14/boost-asio-posix-stream_descriptor/#cb6-123" aria-hidden="true" tabindex="-1"></a>          perror_exit<span class="op">(</span><span class="st">&quot;read(timer_fd)&quot;</span><span class="op">);</span></span>
<span id="cb6-124"><a href="/entry/2018/10/14/boost-asio-posix-stream_descriptor/#cb6-124" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb6-125"><a href="/entry/2018/10/14/boost-asio-posix-stream_descriptor/#cb6-125" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-126"><a href="/entry/2018/10/14/boost-asio-posix-stream_descriptor/#cb6-126" aria-hidden="true" tabindex="-1"></a>        print_joystick_state<span class="op">(&amp;</span>state<span class="op">);</span></span>
<span id="cb6-127"><a href="/entry/2018/10/14/boost-asio-posix-stream_descriptor/#cb6-127" aria-hidden="true" tabindex="-1"></a>      <span class="op">}</span></span>
<span id="cb6-128"><a href="/entry/2018/10/14/boost-asio-posix-stream_descriptor/#cb6-128" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span> <span class="cf">else</span> <span class="op">{</span></span>
<span id="cb6-129"><a href="/entry/2018/10/14/boost-asio-posix-stream_descriptor/#cb6-129" aria-hidden="true" tabindex="-1"></a>      perror_exit<span class="op">(</span><span class="st">&quot;select&quot;</span><span class="op">);</span></span>
<span id="cb6-130"><a href="/entry/2018/10/14/boost-asio-posix-stream_descriptor/#cb6-130" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb6-131"><a href="/entry/2018/10/14/boost-asio-posix-stream_descriptor/#cb6-131" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb6-132"><a href="/entry/2018/10/14/boost-asio-posix-stream_descriptor/#cb6-132" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p style="text-align: center;">
<object data="/entry/2018/10/14/boost-asio-posix-stream_descriptor/joy_c.svg" style="max-width: 100%">
</object>
</p>
<h2 id="posixstream_descriptor-で-joystick-api"><code>posix::stream_descriptor</code> で Joystick API</h2>
<p>先程の例ではタイマーや非同期 IO などが登場していました。そう、Boost.Asio の得意分野です。ということで、同様のプログラムを Boost.Asio で実装してみましょう。</p>
<p><code>include</code> するヘッダは以下の通り。今回は <a href="https://www.boost.org/doc/libs/1_68_0/doc/html/boost_asio/overview/core/spawn.html" target="_blank" rel="nofollow noopener">stackful coroutine</a> を使いたいので、<code>&lt;boost/asio/spawn.hpp&gt;</code> も <code>include</code> します。Boost.Asio の coroutine には boost 1.62.0 で deplicated になった Boost.Coroutine が使われていて警告メッセージが出るので、静かにしてもらうために <code>BOOST_COROUTINES_NO_DEPRECATION_WARNING</code> を <code>define</code> しています。C のヘッダは <code>extern &quot;C&quot;</code> で囲んでやりましょう。</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb7-1"><a href="/entry/2018/10/14/boost-asio-posix-stream_descriptor/#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;chrono&gt;</span></span>
<span id="cb7-2"><a href="/entry/2018/10/14/boost-asio-posix-stream_descriptor/#cb7-2" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;cinttypes&gt;</span></span>
<span id="cb7-3"><a href="/entry/2018/10/14/boost-asio-posix-stream_descriptor/#cb7-3" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;cstdint&gt;</span></span>
<span id="cb7-4"><a href="/entry/2018/10/14/boost-asio-posix-stream_descriptor/#cb7-4" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;cstdlib&gt;</span></span>
<span id="cb7-5"><a href="/entry/2018/10/14/boost-asio-posix-stream_descriptor/#cb7-5" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;iostream&gt;</span></span>
<span id="cb7-6"><a href="/entry/2018/10/14/boost-asio-posix-stream_descriptor/#cb7-6" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;vector&gt;</span></span>
<span id="cb7-7"><a href="/entry/2018/10/14/boost-asio-posix-stream_descriptor/#cb7-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-8"><a href="/entry/2018/10/14/boost-asio-posix-stream_descriptor/#cb7-8" aria-hidden="true" tabindex="-1"></a><span class="pp">#define BOOST_COROUTINES_NO_DEPRECATION_WARNING</span></span>
<span id="cb7-9"><a href="/entry/2018/10/14/boost-asio-posix-stream_descriptor/#cb7-9" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;boost/asio.hpp&gt;</span></span>
<span id="cb7-10"><a href="/entry/2018/10/14/boost-asio-posix-stream_descriptor/#cb7-10" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;boost/asio/spawn.hpp&gt;</span></span>
<span id="cb7-11"><a href="/entry/2018/10/14/boost-asio-posix-stream_descriptor/#cb7-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-12"><a href="/entry/2018/10/14/boost-asio-posix-stream_descriptor/#cb7-12" aria-hidden="true" tabindex="-1"></a><span class="at">extern</span> <span class="st">&quot;C&quot;</span> <span class="op">{</span></span>
<span id="cb7-13"><a href="/entry/2018/10/14/boost-asio-posix-stream_descriptor/#cb7-13" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;fcntl.h&gt;</span></span>
<span id="cb7-14"><a href="/entry/2018/10/14/boost-asio-posix-stream_descriptor/#cb7-14" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;linux/joystick.h&gt;</span></span>
<span id="cb7-15"><a href="/entry/2018/10/14/boost-asio-posix-stream_descriptor/#cb7-15" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;sys/ioctl.h&gt;</span></span>
<span id="cb7-16"><a href="/entry/2018/10/14/boost-asio-posix-stream_descriptor/#cb7-16" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;unistd.h&gt;</span></span>
<span id="cb7-17"><a href="/entry/2018/10/14/boost-asio-posix-stream_descriptor/#cb7-17" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>Joystick と <code>posix::stream_descriptor</code> の初期化周りのコードがこんな感じ。最初に示したコードでは、<code>posix::stream_descriptor</code> のコンストラクタにファイルディスクリプタを渡していましたが、<code>io_context</code> のみを渡して初期化した後、メンバ関数 <a href="https://www.boost.org/doc/libs/1_68_0/doc/html/boost_asio/reference/posix__stream_descriptor/assign.html" target="_blank" rel="nofollow noopener"><code>posix::stream_descriptor::assign</code></a> でファイルディスクリプタを割り当てることもできます。</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb8-1"><a href="/entry/2018/10/14/boost-asio-posix-stream_descriptor/#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="kw">struct</span> joystick_state <span class="op">{</span></span>
<span id="cb8-2"><a href="/entry/2018/10/14/boost-asio-posix-stream_descriptor/#cb8-2" aria-hidden="true" tabindex="-1"></a>  <span class="bu">std::</span>uint8_t<span class="op"> </span>num_axes<span class="op">;</span></span>
<span id="cb8-3"><a href="/entry/2018/10/14/boost-asio-posix-stream_descriptor/#cb8-3" aria-hidden="true" tabindex="-1"></a>  <span class="bu">std::</span>uint8_t<span class="op"> </span>num_buttons<span class="op">;</span></span>
<span id="cb8-4"><a href="/entry/2018/10/14/boost-asio-posix-stream_descriptor/#cb8-4" aria-hidden="true" tabindex="-1"></a>  <span class="bu">std::</span>vector<span class="op">&lt;</span><span class="bu">std::</span>int16_t<span class="op">&gt;</span> axes<span class="op">;</span></span>
<span id="cb8-5"><a href="/entry/2018/10/14/boost-asio-posix-stream_descriptor/#cb8-5" aria-hidden="true" tabindex="-1"></a>  <span class="bu">std::</span>vector<span class="op">&lt;</span><span class="bu">std::</span>int16_t<span class="op">&gt;</span> buttons<span class="op">;</span></span>
<span id="cb8-6"><a href="/entry/2018/10/14/boost-asio-posix-stream_descriptor/#cb8-6" aria-hidden="true" tabindex="-1"></a><span class="op">};</span></span>
<span id="cb8-7"><a href="/entry/2018/10/14/boost-asio-posix-stream_descriptor/#cb8-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-8"><a href="/entry/2018/10/14/boost-asio-posix-stream_descriptor/#cb8-8" aria-hidden="true" tabindex="-1"></a><span class="co">// ...</span></span>
<span id="cb8-9"><a href="/entry/2018/10/14/boost-asio-posix-stream_descriptor/#cb8-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-10"><a href="/entry/2018/10/14/boost-asio-posix-stream_descriptor/#cb8-10" aria-hidden="true" tabindex="-1"></a><span class="ex">boost::</span>asio<span class="ex">::</span>io_context<span class="op"> </span>ctx<span class="op">{};</span></span>
<span id="cb8-11"><a href="/entry/2018/10/14/boost-asio-posix-stream_descriptor/#cb8-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-12"><a href="/entry/2018/10/14/boost-asio-posix-stream_descriptor/#cb8-12" aria-hidden="true" tabindex="-1"></a><span class="ex">boost::</span>asio<span class="ex">::</span>posix<span class="ex">::</span>stream_descriptor<span class="op"> </span>joystick<span class="op">{</span>ctx<span class="op">};</span></span>
<span id="cb8-13"><a href="/entry/2018/10/14/boost-asio-posix-stream_descriptor/#cb8-13" aria-hidden="true" tabindex="-1"></a>joystick_state state<span class="op">{};</span></span>
<span id="cb8-14"><a href="/entry/2018/10/14/boost-asio-posix-stream_descriptor/#cb8-14" aria-hidden="true" tabindex="-1"></a><span class="op">{</span></span>
<span id="cb8-15"><a href="/entry/2018/10/14/boost-asio-posix-stream_descriptor/#cb8-15" aria-hidden="true" tabindex="-1"></a>  <span class="at">const</span> <span class="dt">int</span> fd <span class="op">=</span> <span class="op">::</span>open<span class="op">(</span>argv<span class="op">[</span><span class="dv">1</span><span class="op">],</span> O_RDONLY<span class="op">);</span></span>
<span id="cb8-16"><a href="/entry/2018/10/14/boost-asio-posix-stream_descriptor/#cb8-16" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> <span class="op">(</span>fd <span class="op">&lt;</span> <span class="dv">0</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb8-17"><a href="/entry/2018/10/14/boost-asio-posix-stream_descriptor/#cb8-17" aria-hidden="true" tabindex="-1"></a>    <span class="bu">std::</span>cerr<span class="op"> &lt;&lt;</span> argv<span class="op">[</span><span class="dv">1</span><span class="op">]</span> <span class="op">&lt;&lt;</span> <span class="st">&quot;: &quot;</span> <span class="op">&lt;&lt;</span> <span class="bu">std::</span>strerror<span class="op">(</span>errno<span class="op">)</span> <span class="op">&lt;&lt;</span> <span class="bu">std::</span>endl<span class="op">;</span></span>
<span id="cb8-18"><a href="/entry/2018/10/14/boost-asio-posix-stream_descriptor/#cb8-18" aria-hidden="true" tabindex="-1"></a>    <span class="bu">std::</span>exit<span class="op">(</span><span class="dv">1</span><span class="op">);</span></span>
<span id="cb8-19"><a href="/entry/2018/10/14/boost-asio-posix-stream_descriptor/#cb8-19" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb8-20"><a href="/entry/2018/10/14/boost-asio-posix-stream_descriptor/#cb8-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-21"><a href="/entry/2018/10/14/boost-asio-posix-stream_descriptor/#cb8-21" aria-hidden="true" tabindex="-1"></a>  <span class="op">::</span>ioctl<span class="op">(</span>fd<span class="op">,</span> JSIOCGAXES<span class="op">,</span> <span class="op">&amp;</span>state<span class="op">.</span>num_axes<span class="op">);</span></span>
<span id="cb8-22"><a href="/entry/2018/10/14/boost-asio-posix-stream_descriptor/#cb8-22" aria-hidden="true" tabindex="-1"></a>  state<span class="op">.</span>axes<span class="op">.</span>resize<span class="op">(</span>state<span class="op">.</span>num_axes<span class="op">);</span></span>
<span id="cb8-23"><a href="/entry/2018/10/14/boost-asio-posix-stream_descriptor/#cb8-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-24"><a href="/entry/2018/10/14/boost-asio-posix-stream_descriptor/#cb8-24" aria-hidden="true" tabindex="-1"></a>  <span class="op">::</span>ioctl<span class="op">(</span>fd<span class="op">,</span> JSIOCGBUTTONS<span class="op">,</span> <span class="op">&amp;</span>state<span class="op">.</span>num_buttons<span class="op">);</span></span>
<span id="cb8-25"><a href="/entry/2018/10/14/boost-asio-posix-stream_descriptor/#cb8-25" aria-hidden="true" tabindex="-1"></a>  state<span class="op">.</span>buttons<span class="op">.</span>resize<span class="op">(</span>state<span class="op">.</span>num_buttons<span class="op">);</span></span>
<span id="cb8-26"><a href="/entry/2018/10/14/boost-asio-posix-stream_descriptor/#cb8-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-27"><a href="/entry/2018/10/14/boost-asio-posix-stream_descriptor/#cb8-27" aria-hidden="true" tabindex="-1"></a>  joystick<span class="op">.</span>assign<span class="op">(</span>fd<span class="op">);</span></span>
<span id="cb8-28"><a href="/entry/2018/10/14/boost-asio-posix-stream_descriptor/#cb8-28" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>上に書いたように、今回は stackful coroutine を使って非同期処理を書いていきます。<a href="https://www.boost.org/doc/libs/1_68_0/doc/html/boost_asio/reference/spawn.html" target="_blank" rel="nofollow noopener"><code>spawn</code></a> を使って、一定時間毎 (1/60 [s]) に状態を表示するものと、Joystick のイベント監視 &amp; 内部状態更新をするものの2つの coroutine を起動します。<code>spawn</code> の第1引数には <code>io_context</code> を直接渡すこともできますが、<a href="https://www.boost.org/doc/libs/1_68_0/doc/html/boost_asio/reference/io_context__strand.html" target="_blank" rel="nofollow noopener"><code>io_context::strand</code></a> を渡しています。今回のように <code>io_context</code> をシングルスレッドで利用している場合はあまり意味がありませんが、<code>io_context::strand</code> は登録されたハンドラを直列に (同時に実行されることなく) 実行するためのものです。</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb9-1"><a href="/entry/2018/10/14/boost-asio-posix-stream_descriptor/#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="ex">boost::</span>asio<span class="ex">::</span>io_context<span class="ex">::</span>strand<span class="op"> </span>strand<span class="op">{</span>ctx<span class="op">};</span></span>
<span id="cb9-2"><a href="/entry/2018/10/14/boost-asio-posix-stream_descriptor/#cb9-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-3"><a href="/entry/2018/10/14/boost-asio-posix-stream_descriptor/#cb9-3" aria-hidden="true" tabindex="-1"></a><span class="ex">boost::</span>asio<span class="ex">::</span>steady_timer<span class="op"> </span>timer<span class="op">{</span>ctx<span class="op">};</span></span>
<span id="cb9-4"><a href="/entry/2018/10/14/boost-asio-posix-stream_descriptor/#cb9-4" aria-hidden="true" tabindex="-1"></a><span class="ex">boost::</span>asio<span class="ex">::</span>spawn<span class="op">(</span>strand<span class="op">,</span> <span class="op">[&amp;</span>state<span class="op">,</span> <span class="op">&amp;</span>timer<span class="op">](</span><span class="kw">auto</span><span class="op">&amp;&amp;</span> yield<span class="op">)</span> <span class="op">{</span></span>
<span id="cb9-5"><a href="/entry/2018/10/14/boost-asio-posix-stream_descriptor/#cb9-5" aria-hidden="true" tabindex="-1"></a>  <span class="co">// 一定時間毎 (1/60 [s]) に状態を表示する</span></span>
<span id="cb9-6"><a href="/entry/2018/10/14/boost-asio-posix-stream_descriptor/#cb9-6" aria-hidden="true" tabindex="-1"></a><span class="op">});</span></span>
<span id="cb9-7"><a href="/entry/2018/10/14/boost-asio-posix-stream_descriptor/#cb9-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-8"><a href="/entry/2018/10/14/boost-asio-posix-stream_descriptor/#cb9-8" aria-hidden="true" tabindex="-1"></a><span class="ex">boost::</span>asio<span class="ex">::</span>spawn<span class="op">(</span>strand<span class="op">,</span> <span class="op">[&amp;</span>joystick<span class="op">,</span> <span class="op">&amp;</span>state<span class="op">](</span><span class="kw">auto</span><span class="op">&amp;&amp;</span> yield<span class="op">)</span> <span class="op">{</span></span>
<span id="cb9-9"><a href="/entry/2018/10/14/boost-asio-posix-stream_descriptor/#cb9-9" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Joystick のイベント監視 &amp; 内部状態更新をする</span></span>
<span id="cb9-10"><a href="/entry/2018/10/14/boost-asio-posix-stream_descriptor/#cb9-10" aria-hidden="true" tabindex="-1"></a><span class="op">});</span></span>
<span id="cb9-11"><a href="/entry/2018/10/14/boost-asio-posix-stream_descriptor/#cb9-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-12"><a href="/entry/2018/10/14/boost-asio-posix-stream_descriptor/#cb9-12" aria-hidden="true" tabindex="-1"></a>ctx<span class="op">.</span>run<span class="op">();</span></span></code></pre></div>
<p>一定時間毎 (1/60 [s]) に状態を表示する処理をしている coroutine の実装がこんな感じです。タイマーには <a href="https://www.boost.org/doc/libs/1_68_0/doc/html/boost_asio/reference/steady_timer.html" target="_blank" rel="nofollow noopener"><code>steady_timer</code></a> を用いました。<code>timer</code> にあらかじめ次の発火時刻をセットしてから状態を表示し、その後次の発火まで待つ、を繰り返しているイメージです。</p>
<div class="sourceCode" id="cb10"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb10-1"><a href="/entry/2018/10/14/boost-asio-posix-stream_descriptor/#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="kw">using</span> <span class="kw">namespace</span> <span class="bu">std::</span>chrono_literals<span class="op">;</span></span>
<span id="cb10-2"><a href="/entry/2018/10/14/boost-asio-posix-stream_descriptor/#cb10-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-3"><a href="/entry/2018/10/14/boost-asio-posix-stream_descriptor/#cb10-3" aria-hidden="true" tabindex="-1"></a><span class="co">// ...</span></span>
<span id="cb10-4"><a href="/entry/2018/10/14/boost-asio-posix-stream_descriptor/#cb10-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-5"><a href="/entry/2018/10/14/boost-asio-posix-stream_descriptor/#cb10-5" aria-hidden="true" tabindex="-1"></a><span class="ex">boost::</span>asio<span class="ex">::</span>steady_timer<span class="op"> </span>timer<span class="op">{</span>ctx<span class="op">};</span></span>
<span id="cb10-6"><a href="/entry/2018/10/14/boost-asio-posix-stream_descriptor/#cb10-6" aria-hidden="true" tabindex="-1"></a><span class="ex">boost::</span>asio<span class="ex">::</span>spawn<span class="op">(</span>strand<span class="op">,</span> <span class="op">[&amp;</span>state<span class="op">,</span> <span class="op">&amp;</span>timer<span class="op">](</span><span class="kw">auto</span><span class="op">&amp;&amp;</span> yield<span class="op">)</span> <span class="op">{</span></span>
<span id="cb10-7"><a href="/entry/2018/10/14/boost-asio-posix-stream_descriptor/#cb10-7" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> <span class="op">(;;)</span> <span class="op">{</span></span>
<span id="cb10-8"><a href="/entry/2018/10/14/boost-asio-posix-stream_descriptor/#cb10-8" aria-hidden="true" tabindex="-1"></a>    timer<span class="op">.</span>expires_after<span class="op">(</span><span class="dv">16&#39;666&#39;666</span><span class="bu">ns</span><span class="op">);</span></span>
<span id="cb10-9"><a href="/entry/2018/10/14/boost-asio-posix-stream_descriptor/#cb10-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-10"><a href="/entry/2018/10/14/boost-asio-posix-stream_descriptor/#cb10-10" aria-hidden="true" tabindex="-1"></a>    <span class="bu">std::</span>printf<span class="op">(</span><span class="st">&quot;</span><span class="sc">\r</span><span class="st">&quot;</span><span class="op">);</span></span>
<span id="cb10-11"><a href="/entry/2018/10/14/boost-asio-posix-stream_descriptor/#cb10-11" aria-hidden="true" tabindex="-1"></a>    <span class="bu">std::</span>printf<span class="op">(</span><span class="st">&quot;axes: &quot;</span><span class="op">);</span></span>
<span id="cb10-12"><a href="/entry/2018/10/14/boost-asio-posix-stream_descriptor/#cb10-12" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> <span class="op">(</span><span class="kw">auto</span><span class="op">&amp;&amp;</span> v <span class="op">:</span> state<span class="op">.</span>axes<span class="op">)</span> <span class="op">{</span></span>
<span id="cb10-13"><a href="/entry/2018/10/14/boost-asio-posix-stream_descriptor/#cb10-13" aria-hidden="true" tabindex="-1"></a>      <span class="bu">std::</span>printf<span class="op">(</span><span class="st">&quot;%6&quot;</span> PRId16 <span class="st">&quot; &quot;</span><span class="op">,</span> v<span class="op">);</span></span>
<span id="cb10-14"><a href="/entry/2018/10/14/boost-asio-posix-stream_descriptor/#cb10-14" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb10-15"><a href="/entry/2018/10/14/boost-asio-posix-stream_descriptor/#cb10-15" aria-hidden="true" tabindex="-1"></a>    <span class="bu">std::</span>printf<span class="op">(</span><span class="st">&quot;buttons: &quot;</span><span class="op">);</span></span>
<span id="cb10-16"><a href="/entry/2018/10/14/boost-asio-posix-stream_descriptor/#cb10-16" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> <span class="op">(</span><span class="kw">auto</span><span class="op">&amp;&amp;</span> v <span class="op">:</span> state<span class="op">.</span>buttons<span class="op">)</span> <span class="op">{</span></span>
<span id="cb10-17"><a href="/entry/2018/10/14/boost-asio-posix-stream_descriptor/#cb10-17" aria-hidden="true" tabindex="-1"></a>      <span class="bu">std::</span>printf<span class="op">(</span><span class="st">&quot;%&quot;</span> PRId16 <span class="st">&quot; &quot;</span><span class="op">,</span> v<span class="op">);</span></span>
<span id="cb10-18"><a href="/entry/2018/10/14/boost-asio-posix-stream_descriptor/#cb10-18" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb10-19"><a href="/entry/2018/10/14/boost-asio-posix-stream_descriptor/#cb10-19" aria-hidden="true" tabindex="-1"></a>    <span class="bu">std::</span>fflush<span class="op">(</span>stdout<span class="op">);</span></span>
<span id="cb10-20"><a href="/entry/2018/10/14/boost-asio-posix-stream_descriptor/#cb10-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-21"><a href="/entry/2018/10/14/boost-asio-posix-stream_descriptor/#cb10-21" aria-hidden="true" tabindex="-1"></a>    timer<span class="op">.</span>async_wait<span class="op">(</span>yield<span class="op">);</span></span>
<span id="cb10-22"><a href="/entry/2018/10/14/boost-asio-posix-stream_descriptor/#cb10-22" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb10-23"><a href="/entry/2018/10/14/boost-asio-posix-stream_descriptor/#cb10-23" aria-hidden="true" tabindex="-1"></a><span class="op">});</span></span></code></pre></div>
<p>続いて Joystick のイベント監視 &amp; 内部状態更新をするほうの coroutine の実装がこんな感じです。<code>joystick</code> からの読み込みを <a href="https://www.boost.org/doc/libs/1_68_0/doc/html/boost_asio/reference/async_read/overload1.html" target="_blank" rel="nofollow noopener"><code>async_read</code></a> で行います。今回は読み込む量が決まっているので、<a href="https://www.boost.org/doc/libs/1_68_0/doc/html/boost_asio/reference/streambuf.html" target="_blank" rel="nofollow noopener"><code>streambuf</code></a> は使わず、<a href="https://www.boost.org/doc/libs/1_68_0/doc/html/boost_asio/reference/buffer/overload5.html" target="_blank" rel="nofollow noopener"><code>buffer</code></a> を使って <code>js_event</code> に直接読み込みます。<code>async_read</code> で読み込む量の指定は第3引数に <a href="https://www.boost.org/doc/libs/1_68_0/doc/html/boost_asio/reference/async_read.html" target="_blank" rel="nofollow noopener"><code>CompletionCondition</code></a> を取る overload に <a href="https://www.boost.org/doc/libs/1_68_0/doc/html/boost_asio/reference/transfer_exactly.html" target="_blank" rel="nofollow noopener"><code>transfer_exactly</code></a> を渡すなどでも可能ですが、以下の実装で <code>async_read</code> の処理が完了する条件はドキュメントにあるとおり与えたバッファが一杯になる、またはエラーが発生したときとあるので、これで問題ないでしょう。</p>
<div class="sourceCode" id="cb11"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb11-1"><a href="/entry/2018/10/14/boost-asio-posix-stream_descriptor/#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="ex">boost::</span>asio<span class="ex">::</span>spawn<span class="op">(</span>strand<span class="op">,</span> <span class="op">[&amp;</span>joystick<span class="op">,</span> <span class="op">&amp;</span>state<span class="op">](</span><span class="kw">auto</span><span class="op">&amp;&amp;</span> yield<span class="op">)</span> <span class="op">{</span></span>
<span id="cb11-2"><a href="/entry/2018/10/14/boost-asio-posix-stream_descriptor/#cb11-2" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> <span class="op">(;;)</span> <span class="op">{</span></span>
<span id="cb11-3"><a href="/entry/2018/10/14/boost-asio-posix-stream_descriptor/#cb11-3" aria-hidden="true" tabindex="-1"></a>    <span class="op">::</span>js_event jse<span class="op">{};</span></span>
<span id="cb11-4"><a href="/entry/2018/10/14/boost-asio-posix-stream_descriptor/#cb11-4" aria-hidden="true" tabindex="-1"></a>    <span class="ex">boost::</span>system<span class="ex">::</span>error_code<span class="op"> </span>error<span class="op">{};</span></span>
<span id="cb11-5"><a href="/entry/2018/10/14/boost-asio-posix-stream_descriptor/#cb11-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-6"><a href="/entry/2018/10/14/boost-asio-posix-stream_descriptor/#cb11-6" aria-hidden="true" tabindex="-1"></a>    <span class="ex">boost::</span>asio<span class="ex">::</span>async_read<span class="op">(</span>joystick<span class="op">,</span> <span class="ex">boost::</span>asio<span class="ex">::</span>buffer<span class="op">(&amp;</span>jse<span class="op">,</span> <span class="kw">sizeof</span> jse<span class="op">),</span> yield<span class="op">[</span>error<span class="op">]);</span></span>
<span id="cb11-7"><a href="/entry/2018/10/14/boost-asio-posix-stream_descriptor/#cb11-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-8"><a href="/entry/2018/10/14/boost-asio-posix-stream_descriptor/#cb11-8" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>error <span class="op">==</span> <span class="ex">boost::</span>asio<span class="ex">::</span>error<span class="ex">::</span>eof<span class="op">)</span> <span class="op">{</span></span>
<span id="cb11-9"><a href="/entry/2018/10/14/boost-asio-posix-stream_descriptor/#cb11-9" aria-hidden="true" tabindex="-1"></a>      joystick<span class="op">.</span>get_io_service<span class="op">().</span>stop<span class="op">();</span></span>
<span id="cb11-10"><a href="/entry/2018/10/14/boost-asio-posix-stream_descriptor/#cb11-10" aria-hidden="true" tabindex="-1"></a>      <span class="cf">break</span><span class="op">;</span></span>
<span id="cb11-11"><a href="/entry/2018/10/14/boost-asio-posix-stream_descriptor/#cb11-11" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span> <span class="cf">else</span> <span class="cf">if</span> <span class="op">(</span>error<span class="op">)</span> <span class="op">{</span></span>
<span id="cb11-12"><a href="/entry/2018/10/14/boost-asio-posix-stream_descriptor/#cb11-12" aria-hidden="true" tabindex="-1"></a>      <span class="bu">std::</span>cerr<span class="op"> &lt;&lt;</span> <span class="st">&quot;</span><span class="sc">\n</span><span class="st">error: &quot;</span> <span class="op">&lt;&lt;</span> error<span class="op">.</span>message<span class="op">()</span> <span class="op">&lt;&lt;</span> <span class="bu">std::</span>endl<span class="op">;</span></span>
<span id="cb11-13"><a href="/entry/2018/10/14/boost-asio-posix-stream_descriptor/#cb11-13" aria-hidden="true" tabindex="-1"></a>      <span class="bu">std::</span>exit<span class="op">(</span><span class="dv">1</span><span class="op">);</span></span>
<span id="cb11-14"><a href="/entry/2018/10/14/boost-asio-posix-stream_descriptor/#cb11-14" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb11-15"><a href="/entry/2018/10/14/boost-asio-posix-stream_descriptor/#cb11-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-16"><a href="/entry/2018/10/14/boost-asio-posix-stream_descriptor/#cb11-16" aria-hidden="true" tabindex="-1"></a>    <span class="cf">switch</span> <span class="op">(</span>jse<span class="op">.</span>type <span class="op">&amp;</span> <span class="op">~</span>JS_EVENT_INIT<span class="op">)</span> <span class="op">{</span></span>
<span id="cb11-17"><a href="/entry/2018/10/14/boost-asio-posix-stream_descriptor/#cb11-17" aria-hidden="true" tabindex="-1"></a>      <span class="cf">case</span> JS_EVENT_AXIS<span class="op">:</span></span>
<span id="cb11-18"><a href="/entry/2018/10/14/boost-asio-posix-stream_descriptor/#cb11-18" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="op">(</span>jse<span class="op">.</span>number <span class="op">&lt;</span> state<span class="op">.</span>num_axes<span class="op">)</span> <span class="op">{</span></span>
<span id="cb11-19"><a href="/entry/2018/10/14/boost-asio-posix-stream_descriptor/#cb11-19" aria-hidden="true" tabindex="-1"></a>          state<span class="op">.</span>axes<span class="op">.</span>at<span class="op">(</span>jse<span class="op">.</span>number<span class="op">)</span> <span class="op">=</span> jse<span class="op">.</span>value<span class="op">;</span></span>
<span id="cb11-20"><a href="/entry/2018/10/14/boost-asio-posix-stream_descriptor/#cb11-20" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb11-21"><a href="/entry/2018/10/14/boost-asio-posix-stream_descriptor/#cb11-21" aria-hidden="true" tabindex="-1"></a>        <span class="cf">break</span><span class="op">;</span></span>
<span id="cb11-22"><a href="/entry/2018/10/14/boost-asio-posix-stream_descriptor/#cb11-22" aria-hidden="true" tabindex="-1"></a>      <span class="cf">case</span> JS_EVENT_BUTTON<span class="op">:</span></span>
<span id="cb11-23"><a href="/entry/2018/10/14/boost-asio-posix-stream_descriptor/#cb11-23" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="op">(</span>jse<span class="op">.</span>number <span class="op">&lt;</span> state<span class="op">.</span>num_buttons<span class="op">)</span> <span class="op">{</span></span>
<span id="cb11-24"><a href="/entry/2018/10/14/boost-asio-posix-stream_descriptor/#cb11-24" aria-hidden="true" tabindex="-1"></a>          state<span class="op">.</span>buttons<span class="op">.</span>at<span class="op">(</span>jse<span class="op">.</span>number<span class="op">)</span> <span class="op">=</span> jse<span class="op">.</span>value<span class="op">;</span></span>
<span id="cb11-25"><a href="/entry/2018/10/14/boost-asio-posix-stream_descriptor/#cb11-25" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb11-26"><a href="/entry/2018/10/14/boost-asio-posix-stream_descriptor/#cb11-26" aria-hidden="true" tabindex="-1"></a>        <span class="cf">break</span><span class="op">;</span></span>
<span id="cb11-27"><a href="/entry/2018/10/14/boost-asio-posix-stream_descriptor/#cb11-27" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb11-28"><a href="/entry/2018/10/14/boost-asio-posix-stream_descriptor/#cb11-28" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb11-29"><a href="/entry/2018/10/14/boost-asio-posix-stream_descriptor/#cb11-29" aria-hidden="true" tabindex="-1"></a><span class="op">});</span></span></code></pre></div>
<p>これで必要な実装は完了です。ソースコード全体がこんな感じになります。</p>
<div class="sourceCode" id="cb12"><pre class="sourceCode cpp"><code class="sourceCode cpp"><span id="cb12-1"><a href="/entry/2018/10/14/boost-asio-posix-stream_descriptor/#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;chrono&gt;</span></span>
<span id="cb12-2"><a href="/entry/2018/10/14/boost-asio-posix-stream_descriptor/#cb12-2" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;cinttypes&gt;</span></span>
<span id="cb12-3"><a href="/entry/2018/10/14/boost-asio-posix-stream_descriptor/#cb12-3" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;cstdint&gt;</span></span>
<span id="cb12-4"><a href="/entry/2018/10/14/boost-asio-posix-stream_descriptor/#cb12-4" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;cstdlib&gt;</span></span>
<span id="cb12-5"><a href="/entry/2018/10/14/boost-asio-posix-stream_descriptor/#cb12-5" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;iostream&gt;</span></span>
<span id="cb12-6"><a href="/entry/2018/10/14/boost-asio-posix-stream_descriptor/#cb12-6" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;vector&gt;</span></span>
<span id="cb12-7"><a href="/entry/2018/10/14/boost-asio-posix-stream_descriptor/#cb12-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-8"><a href="/entry/2018/10/14/boost-asio-posix-stream_descriptor/#cb12-8" aria-hidden="true" tabindex="-1"></a><span class="pp">#define BOOST_COROUTINES_NO_DEPRECATION_WARNING</span></span>
<span id="cb12-9"><a href="/entry/2018/10/14/boost-asio-posix-stream_descriptor/#cb12-9" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;boost/asio.hpp&gt;</span></span>
<span id="cb12-10"><a href="/entry/2018/10/14/boost-asio-posix-stream_descriptor/#cb12-10" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;boost/asio/spawn.hpp&gt;</span></span>
<span id="cb12-11"><a href="/entry/2018/10/14/boost-asio-posix-stream_descriptor/#cb12-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-12"><a href="/entry/2018/10/14/boost-asio-posix-stream_descriptor/#cb12-12" aria-hidden="true" tabindex="-1"></a><span class="at">extern</span> <span class="st">&quot;C&quot;</span> <span class="op">{</span></span>
<span id="cb12-13"><a href="/entry/2018/10/14/boost-asio-posix-stream_descriptor/#cb12-13" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;fcntl.h&gt;</span></span>
<span id="cb12-14"><a href="/entry/2018/10/14/boost-asio-posix-stream_descriptor/#cb12-14" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;linux/joystick.h&gt;</span></span>
<span id="cb12-15"><a href="/entry/2018/10/14/boost-asio-posix-stream_descriptor/#cb12-15" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;sys/ioctl.h&gt;</span></span>
<span id="cb12-16"><a href="/entry/2018/10/14/boost-asio-posix-stream_descriptor/#cb12-16" aria-hidden="true" tabindex="-1"></a><span class="pp">#include </span><span class="im">&lt;unistd.h&gt;</span></span>
<span id="cb12-17"><a href="/entry/2018/10/14/boost-asio-posix-stream_descriptor/#cb12-17" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb12-18"><a href="/entry/2018/10/14/boost-asio-posix-stream_descriptor/#cb12-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-19"><a href="/entry/2018/10/14/boost-asio-posix-stream_descriptor/#cb12-19" aria-hidden="true" tabindex="-1"></a><span class="kw">using</span> <span class="kw">namespace</span> <span class="bu">std::</span>chrono_literals<span class="op">;</span></span>
<span id="cb12-20"><a href="/entry/2018/10/14/boost-asio-posix-stream_descriptor/#cb12-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-21"><a href="/entry/2018/10/14/boost-asio-posix-stream_descriptor/#cb12-21" aria-hidden="true" tabindex="-1"></a><span class="kw">struct</span> joystick_state <span class="op">{</span></span>
<span id="cb12-22"><a href="/entry/2018/10/14/boost-asio-posix-stream_descriptor/#cb12-22" aria-hidden="true" tabindex="-1"></a>  <span class="bu">std::</span>uint8_t<span class="op"> </span>num_axes<span class="op">;</span></span>
<span id="cb12-23"><a href="/entry/2018/10/14/boost-asio-posix-stream_descriptor/#cb12-23" aria-hidden="true" tabindex="-1"></a>  <span class="bu">std::</span>uint8_t<span class="op"> </span>num_buttons<span class="op">;</span></span>
<span id="cb12-24"><a href="/entry/2018/10/14/boost-asio-posix-stream_descriptor/#cb12-24" aria-hidden="true" tabindex="-1"></a>  <span class="bu">std::</span>vector<span class="op">&lt;</span><span class="bu">std::</span>int16_t<span class="op">&gt;</span> axes<span class="op">;</span></span>
<span id="cb12-25"><a href="/entry/2018/10/14/boost-asio-posix-stream_descriptor/#cb12-25" aria-hidden="true" tabindex="-1"></a>  <span class="bu">std::</span>vector<span class="op">&lt;</span><span class="bu">std::</span>int16_t<span class="op">&gt;</span> buttons<span class="op">;</span></span>
<span id="cb12-26"><a href="/entry/2018/10/14/boost-asio-posix-stream_descriptor/#cb12-26" aria-hidden="true" tabindex="-1"></a><span class="op">};</span></span>
<span id="cb12-27"><a href="/entry/2018/10/14/boost-asio-posix-stream_descriptor/#cb12-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-28"><a href="/entry/2018/10/14/boost-asio-posix-stream_descriptor/#cb12-28" aria-hidden="true" tabindex="-1"></a><span class="kw">auto</span> main<span class="op">(</span><span class="dt">int</span> argc<span class="op">,</span> <span class="dt">char</span><span class="op">**</span> argv<span class="op">)</span> <span class="op">-&gt;</span> <span class="dt">int</span> <span class="op">{</span></span>
<span id="cb12-29"><a href="/entry/2018/10/14/boost-asio-posix-stream_descriptor/#cb12-29" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> <span class="op">(</span>argc <span class="op">!=</span> <span class="dv">2</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb12-30"><a href="/entry/2018/10/14/boost-asio-posix-stream_descriptor/#cb12-30" aria-hidden="true" tabindex="-1"></a>    <span class="bu">std::</span>cerr<span class="op"> &lt;&lt;</span> <span class="st">&quot;usage: &quot;</span> <span class="op">&lt;&lt;</span> argv<span class="op">[</span><span class="dv">0</span><span class="op">]</span> <span class="op">&lt;&lt;</span> <span class="st">&quot; &lt;device&gt;&quot;</span> <span class="op">&lt;&lt;</span> <span class="bu">std::</span>endl<span class="op">;</span></span>
<span id="cb12-31"><a href="/entry/2018/10/14/boost-asio-posix-stream_descriptor/#cb12-31" aria-hidden="true" tabindex="-1"></a>    <span class="bu">std::</span>exit<span class="op">(</span><span class="dv">1</span><span class="op">);</span></span>
<span id="cb12-32"><a href="/entry/2018/10/14/boost-asio-posix-stream_descriptor/#cb12-32" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb12-33"><a href="/entry/2018/10/14/boost-asio-posix-stream_descriptor/#cb12-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-34"><a href="/entry/2018/10/14/boost-asio-posix-stream_descriptor/#cb12-34" aria-hidden="true" tabindex="-1"></a>  <span class="ex">boost::</span>asio<span class="ex">::</span>io_context<span class="op"> </span>ctx<span class="op">{};</span></span>
<span id="cb12-35"><a href="/entry/2018/10/14/boost-asio-posix-stream_descriptor/#cb12-35" aria-hidden="true" tabindex="-1"></a>  <span class="ex">boost::</span>asio<span class="ex">::</span>io_context<span class="ex">::</span>strand<span class="op"> </span>strand<span class="op">{</span>ctx<span class="op">};</span></span>
<span id="cb12-36"><a href="/entry/2018/10/14/boost-asio-posix-stream_descriptor/#cb12-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-37"><a href="/entry/2018/10/14/boost-asio-posix-stream_descriptor/#cb12-37" aria-hidden="true" tabindex="-1"></a>  <span class="ex">boost::</span>asio<span class="ex">::</span>posix<span class="ex">::</span>stream_descriptor<span class="op"> </span>joystick<span class="op">{</span>ctx<span class="op">};</span></span>
<span id="cb12-38"><a href="/entry/2018/10/14/boost-asio-posix-stream_descriptor/#cb12-38" aria-hidden="true" tabindex="-1"></a>  joystick_state state<span class="op">{};</span></span>
<span id="cb12-39"><a href="/entry/2018/10/14/boost-asio-posix-stream_descriptor/#cb12-39" aria-hidden="true" tabindex="-1"></a>  <span class="op">{</span></span>
<span id="cb12-40"><a href="/entry/2018/10/14/boost-asio-posix-stream_descriptor/#cb12-40" aria-hidden="true" tabindex="-1"></a>    <span class="at">const</span> <span class="dt">int</span> fd <span class="op">=</span> <span class="op">::</span>open<span class="op">(</span>argv<span class="op">[</span><span class="dv">1</span><span class="op">],</span> O_RDONLY<span class="op">);</span></span>
<span id="cb12-41"><a href="/entry/2018/10/14/boost-asio-posix-stream_descriptor/#cb12-41" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>fd <span class="op">&lt;</span> <span class="dv">0</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb12-42"><a href="/entry/2018/10/14/boost-asio-posix-stream_descriptor/#cb12-42" aria-hidden="true" tabindex="-1"></a>      <span class="bu">std::</span>cerr<span class="op"> &lt;&lt;</span> argv<span class="op">[</span><span class="dv">1</span><span class="op">]</span> <span class="op">&lt;&lt;</span> <span class="st">&quot;: &quot;</span> <span class="op">&lt;&lt;</span> <span class="bu">std::</span>strerror<span class="op">(</span>errno<span class="op">)</span> <span class="op">&lt;&lt;</span> <span class="bu">std::</span>endl<span class="op">;</span></span>
<span id="cb12-43"><a href="/entry/2018/10/14/boost-asio-posix-stream_descriptor/#cb12-43" aria-hidden="true" tabindex="-1"></a>      <span class="bu">std::</span>exit<span class="op">(</span><span class="dv">1</span><span class="op">);</span></span>
<span id="cb12-44"><a href="/entry/2018/10/14/boost-asio-posix-stream_descriptor/#cb12-44" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb12-45"><a href="/entry/2018/10/14/boost-asio-posix-stream_descriptor/#cb12-45" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-46"><a href="/entry/2018/10/14/boost-asio-posix-stream_descriptor/#cb12-46" aria-hidden="true" tabindex="-1"></a>    <span class="op">::</span>ioctl<span class="op">(</span>fd<span class="op">,</span> JSIOCGAXES<span class="op">,</span> <span class="op">&amp;</span>state<span class="op">.</span>num_axes<span class="op">);</span></span>
<span id="cb12-47"><a href="/entry/2018/10/14/boost-asio-posix-stream_descriptor/#cb12-47" aria-hidden="true" tabindex="-1"></a>    state<span class="op">.</span>axes<span class="op">.</span>resize<span class="op">(</span>state<span class="op">.</span>num_axes<span class="op">);</span></span>
<span id="cb12-48"><a href="/entry/2018/10/14/boost-asio-posix-stream_descriptor/#cb12-48" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-49"><a href="/entry/2018/10/14/boost-asio-posix-stream_descriptor/#cb12-49" aria-hidden="true" tabindex="-1"></a>    <span class="op">::</span>ioctl<span class="op">(</span>fd<span class="op">,</span> JSIOCGBUTTONS<span class="op">,</span> <span class="op">&amp;</span>state<span class="op">.</span>num_buttons<span class="op">);</span></span>
<span id="cb12-50"><a href="/entry/2018/10/14/boost-asio-posix-stream_descriptor/#cb12-50" aria-hidden="true" tabindex="-1"></a>    state<span class="op">.</span>buttons<span class="op">.</span>resize<span class="op">(</span>state<span class="op">.</span>num_buttons<span class="op">);</span></span>
<span id="cb12-51"><a href="/entry/2018/10/14/boost-asio-posix-stream_descriptor/#cb12-51" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-52"><a href="/entry/2018/10/14/boost-asio-posix-stream_descriptor/#cb12-52" aria-hidden="true" tabindex="-1"></a>    joystick<span class="op">.</span>assign<span class="op">(</span>fd<span class="op">);</span></span>
<span id="cb12-53"><a href="/entry/2018/10/14/boost-asio-posix-stream_descriptor/#cb12-53" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb12-54"><a href="/entry/2018/10/14/boost-asio-posix-stream_descriptor/#cb12-54" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-55"><a href="/entry/2018/10/14/boost-asio-posix-stream_descriptor/#cb12-55" aria-hidden="true" tabindex="-1"></a>  <span class="ex">boost::</span>asio<span class="ex">::</span>steady_timer<span class="op"> </span>timer<span class="op">{</span>ctx<span class="op">};</span></span>
<span id="cb12-56"><a href="/entry/2018/10/14/boost-asio-posix-stream_descriptor/#cb12-56" aria-hidden="true" tabindex="-1"></a>  <span class="ex">boost::</span>asio<span class="ex">::</span>spawn<span class="op">(</span>strand<span class="op">,</span> <span class="op">[&amp;</span>state<span class="op">,</span> <span class="op">&amp;</span>timer<span class="op">](</span><span class="kw">auto</span><span class="op">&amp;&amp;</span> yield<span class="op">)</span> <span class="op">{</span></span>
<span id="cb12-57"><a href="/entry/2018/10/14/boost-asio-posix-stream_descriptor/#cb12-57" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> <span class="op">(;;)</span> <span class="op">{</span></span>
<span id="cb12-58"><a href="/entry/2018/10/14/boost-asio-posix-stream_descriptor/#cb12-58" aria-hidden="true" tabindex="-1"></a>      timer<span class="op">.</span>expires_after<span class="op">(</span><span class="dv">16&#39;666&#39;666</span><span class="bu">ns</span><span class="op">);</span></span>
<span id="cb12-59"><a href="/entry/2018/10/14/boost-asio-posix-stream_descriptor/#cb12-59" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-60"><a href="/entry/2018/10/14/boost-asio-posix-stream_descriptor/#cb12-60" aria-hidden="true" tabindex="-1"></a>      <span class="bu">std::</span>printf<span class="op">(</span><span class="st">&quot;</span><span class="sc">\r</span><span class="st">&quot;</span><span class="op">);</span></span>
<span id="cb12-61"><a href="/entry/2018/10/14/boost-asio-posix-stream_descriptor/#cb12-61" aria-hidden="true" tabindex="-1"></a>      <span class="bu">std::</span>printf<span class="op">(</span><span class="st">&quot;axes: &quot;</span><span class="op">);</span></span>
<span id="cb12-62"><a href="/entry/2018/10/14/boost-asio-posix-stream_descriptor/#cb12-62" aria-hidden="true" tabindex="-1"></a>      <span class="cf">for</span> <span class="op">(</span><span class="kw">auto</span><span class="op">&amp;&amp;</span> v <span class="op">:</span> state<span class="op">.</span>axes<span class="op">)</span> <span class="op">{</span></span>
<span id="cb12-63"><a href="/entry/2018/10/14/boost-asio-posix-stream_descriptor/#cb12-63" aria-hidden="true" tabindex="-1"></a>        <span class="bu">std::</span>printf<span class="op">(</span><span class="st">&quot;%6&quot;</span> PRId16 <span class="st">&quot; &quot;</span><span class="op">,</span> v<span class="op">);</span></span>
<span id="cb12-64"><a href="/entry/2018/10/14/boost-asio-posix-stream_descriptor/#cb12-64" aria-hidden="true" tabindex="-1"></a>      <span class="op">}</span></span>
<span id="cb12-65"><a href="/entry/2018/10/14/boost-asio-posix-stream_descriptor/#cb12-65" aria-hidden="true" tabindex="-1"></a>      <span class="bu">std::</span>printf<span class="op">(</span><span class="st">&quot;buttons: &quot;</span><span class="op">);</span></span>
<span id="cb12-66"><a href="/entry/2018/10/14/boost-asio-posix-stream_descriptor/#cb12-66" aria-hidden="true" tabindex="-1"></a>      <span class="cf">for</span> <span class="op">(</span><span class="kw">auto</span><span class="op">&amp;&amp;</span> v <span class="op">:</span> state<span class="op">.</span>buttons<span class="op">)</span> <span class="op">{</span></span>
<span id="cb12-67"><a href="/entry/2018/10/14/boost-asio-posix-stream_descriptor/#cb12-67" aria-hidden="true" tabindex="-1"></a>        <span class="bu">std::</span>printf<span class="op">(</span><span class="st">&quot;%&quot;</span> PRId16 <span class="st">&quot; &quot;</span><span class="op">,</span> v<span class="op">);</span></span>
<span id="cb12-68"><a href="/entry/2018/10/14/boost-asio-posix-stream_descriptor/#cb12-68" aria-hidden="true" tabindex="-1"></a>      <span class="op">}</span></span>
<span id="cb12-69"><a href="/entry/2018/10/14/boost-asio-posix-stream_descriptor/#cb12-69" aria-hidden="true" tabindex="-1"></a>      <span class="bu">std::</span>fflush<span class="op">(</span>stdout<span class="op">);</span></span>
<span id="cb12-70"><a href="/entry/2018/10/14/boost-asio-posix-stream_descriptor/#cb12-70" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-71"><a href="/entry/2018/10/14/boost-asio-posix-stream_descriptor/#cb12-71" aria-hidden="true" tabindex="-1"></a>      timer<span class="op">.</span>async_wait<span class="op">(</span>yield<span class="op">);</span></span>
<span id="cb12-72"><a href="/entry/2018/10/14/boost-asio-posix-stream_descriptor/#cb12-72" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb12-73"><a href="/entry/2018/10/14/boost-asio-posix-stream_descriptor/#cb12-73" aria-hidden="true" tabindex="-1"></a>  <span class="op">});</span></span>
<span id="cb12-74"><a href="/entry/2018/10/14/boost-asio-posix-stream_descriptor/#cb12-74" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-75"><a href="/entry/2018/10/14/boost-asio-posix-stream_descriptor/#cb12-75" aria-hidden="true" tabindex="-1"></a>  <span class="ex">boost::</span>asio<span class="ex">::</span>spawn<span class="op">(</span>strand<span class="op">,</span> <span class="op">[&amp;</span>joystick<span class="op">,</span> <span class="op">&amp;</span>state<span class="op">](</span><span class="kw">auto</span><span class="op">&amp;&amp;</span> yield<span class="op">)</span> <span class="op">{</span></span>
<span id="cb12-76"><a href="/entry/2018/10/14/boost-asio-posix-stream_descriptor/#cb12-76" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> <span class="op">(;;)</span> <span class="op">{</span></span>
<span id="cb12-77"><a href="/entry/2018/10/14/boost-asio-posix-stream_descriptor/#cb12-77" aria-hidden="true" tabindex="-1"></a>      <span class="op">::</span>js_event jse<span class="op">{};</span></span>
<span id="cb12-78"><a href="/entry/2018/10/14/boost-asio-posix-stream_descriptor/#cb12-78" aria-hidden="true" tabindex="-1"></a>      <span class="ex">boost::</span>system<span class="ex">::</span>error_code<span class="op"> </span>error<span class="op">{};</span></span>
<span id="cb12-79"><a href="/entry/2018/10/14/boost-asio-posix-stream_descriptor/#cb12-79" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-80"><a href="/entry/2018/10/14/boost-asio-posix-stream_descriptor/#cb12-80" aria-hidden="true" tabindex="-1"></a>      <span class="ex">boost::</span>asio<span class="ex">::</span>async_read<span class="op">(</span>joystick<span class="op">,</span> <span class="ex">boost::</span>asio<span class="ex">::</span>buffer<span class="op">(&amp;</span>jse<span class="op">,</span> <span class="kw">sizeof</span> jse<span class="op">),</span> yield<span class="op">[</span>error<span class="op">]);</span></span>
<span id="cb12-81"><a href="/entry/2018/10/14/boost-asio-posix-stream_descriptor/#cb12-81" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-82"><a href="/entry/2018/10/14/boost-asio-posix-stream_descriptor/#cb12-82" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> <span class="op">(</span>error <span class="op">==</span> <span class="ex">boost::</span>asio<span class="ex">::</span>error<span class="ex">::</span>eof<span class="op">)</span> <span class="op">{</span></span>
<span id="cb12-83"><a href="/entry/2018/10/14/boost-asio-posix-stream_descriptor/#cb12-83" aria-hidden="true" tabindex="-1"></a>        joystick<span class="op">.</span>get_io_service<span class="op">().</span>stop<span class="op">();</span></span>
<span id="cb12-84"><a href="/entry/2018/10/14/boost-asio-posix-stream_descriptor/#cb12-84" aria-hidden="true" tabindex="-1"></a>        <span class="cf">break</span><span class="op">;</span></span>
<span id="cb12-85"><a href="/entry/2018/10/14/boost-asio-posix-stream_descriptor/#cb12-85" aria-hidden="true" tabindex="-1"></a>      <span class="op">}</span> <span class="cf">else</span> <span class="cf">if</span> <span class="op">(</span>error<span class="op">)</span> <span class="op">{</span></span>
<span id="cb12-86"><a href="/entry/2018/10/14/boost-asio-posix-stream_descriptor/#cb12-86" aria-hidden="true" tabindex="-1"></a>        <span class="bu">std::</span>cerr<span class="op"> &lt;&lt;</span> <span class="st">&quot;</span><span class="sc">\n</span><span class="st">error: &quot;</span> <span class="op">&lt;&lt;</span> error<span class="op">.</span>message<span class="op">()</span> <span class="op">&lt;&lt;</span> <span class="bu">std::</span>endl<span class="op">;</span></span>
<span id="cb12-87"><a href="/entry/2018/10/14/boost-asio-posix-stream_descriptor/#cb12-87" aria-hidden="true" tabindex="-1"></a>        <span class="bu">std::</span>exit<span class="op">(</span><span class="dv">1</span><span class="op">);</span></span>
<span id="cb12-88"><a href="/entry/2018/10/14/boost-asio-posix-stream_descriptor/#cb12-88" aria-hidden="true" tabindex="-1"></a>      <span class="op">}</span></span>
<span id="cb12-89"><a href="/entry/2018/10/14/boost-asio-posix-stream_descriptor/#cb12-89" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-90"><a href="/entry/2018/10/14/boost-asio-posix-stream_descriptor/#cb12-90" aria-hidden="true" tabindex="-1"></a>      <span class="cf">switch</span> <span class="op">(</span>jse<span class="op">.</span>type <span class="op">&amp;</span> <span class="op">~</span>JS_EVENT_INIT<span class="op">)</span> <span class="op">{</span></span>
<span id="cb12-91"><a href="/entry/2018/10/14/boost-asio-posix-stream_descriptor/#cb12-91" aria-hidden="true" tabindex="-1"></a>        <span class="cf">case</span> JS_EVENT_AXIS<span class="op">:</span></span>
<span id="cb12-92"><a href="/entry/2018/10/14/boost-asio-posix-stream_descriptor/#cb12-92" aria-hidden="true" tabindex="-1"></a>          <span class="cf">if</span> <span class="op">(</span>jse<span class="op">.</span>number <span class="op">&lt;</span> state<span class="op">.</span>num_axes<span class="op">)</span> <span class="op">{</span></span>
<span id="cb12-93"><a href="/entry/2018/10/14/boost-asio-posix-stream_descriptor/#cb12-93" aria-hidden="true" tabindex="-1"></a>            state<span class="op">.</span>axes<span class="op">.</span>at<span class="op">(</span>jse<span class="op">.</span>number<span class="op">)</span> <span class="op">=</span> jse<span class="op">.</span>value<span class="op">;</span></span>
<span id="cb12-94"><a href="/entry/2018/10/14/boost-asio-posix-stream_descriptor/#cb12-94" aria-hidden="true" tabindex="-1"></a>          <span class="op">}</span></span>
<span id="cb12-95"><a href="/entry/2018/10/14/boost-asio-posix-stream_descriptor/#cb12-95" aria-hidden="true" tabindex="-1"></a>          <span class="cf">break</span><span class="op">;</span></span>
<span id="cb12-96"><a href="/entry/2018/10/14/boost-asio-posix-stream_descriptor/#cb12-96" aria-hidden="true" tabindex="-1"></a>        <span class="cf">case</span> JS_EVENT_BUTTON<span class="op">:</span></span>
<span id="cb12-97"><a href="/entry/2018/10/14/boost-asio-posix-stream_descriptor/#cb12-97" aria-hidden="true" tabindex="-1"></a>          <span class="cf">if</span> <span class="op">(</span>jse<span class="op">.</span>number <span class="op">&lt;</span> state<span class="op">.</span>num_buttons<span class="op">)</span> <span class="op">{</span></span>
<span id="cb12-98"><a href="/entry/2018/10/14/boost-asio-posix-stream_descriptor/#cb12-98" aria-hidden="true" tabindex="-1"></a>            state<span class="op">.</span>buttons<span class="op">.</span>at<span class="op">(</span>jse<span class="op">.</span>number<span class="op">)</span> <span class="op">=</span> jse<span class="op">.</span>value<span class="op">;</span></span>
<span id="cb12-99"><a href="/entry/2018/10/14/boost-asio-posix-stream_descriptor/#cb12-99" aria-hidden="true" tabindex="-1"></a>          <span class="op">}</span></span>
<span id="cb12-100"><a href="/entry/2018/10/14/boost-asio-posix-stream_descriptor/#cb12-100" aria-hidden="true" tabindex="-1"></a>          <span class="cf">break</span><span class="op">;</span></span>
<span id="cb12-101"><a href="/entry/2018/10/14/boost-asio-posix-stream_descriptor/#cb12-101" aria-hidden="true" tabindex="-1"></a>      <span class="op">}</span></span>
<span id="cb12-102"><a href="/entry/2018/10/14/boost-asio-posix-stream_descriptor/#cb12-102" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb12-103"><a href="/entry/2018/10/14/boost-asio-posix-stream_descriptor/#cb12-103" aria-hidden="true" tabindex="-1"></a>  <span class="op">});</span></span>
<span id="cb12-104"><a href="/entry/2018/10/14/boost-asio-posix-stream_descriptor/#cb12-104" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-105"><a href="/entry/2018/10/14/boost-asio-posix-stream_descriptor/#cb12-105" aria-hidden="true" tabindex="-1"></a>  ctx<span class="op">.</span>run<span class="op">();</span></span>
<span id="cb12-106"><a href="/entry/2018/10/14/boost-asio-posix-stream_descriptor/#cb12-106" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code></pre></div>
<p>実行してみるとこんな感じ。<code>boost_coroutine</code> や <code>boost_system</code>、<code>pthread</code> ライブラリをリンクする必要があります。</p>
<p style="text-align: center;">
<object data="/entry/2018/10/14/boost-asio-posix-stream_descriptor/joy.svg" style="max-width: 100%">
</object>
</p>
<h2 id="まとめ">まとめ</h2>
<p>Boost.Asio の <code>posix::stream_descriptor</code> を使って、Linux マシンに接続したデバイスを非同期に扱う方法を紹介しました。小規模なプログラムではわざわざ C++ で Boost.Asio を使って書く必要は無いかもしれませんが、扱うデバイスが増えたり、ネットワークやシリアル通信など Boost.Asio で扱える他の要素と組み合わせるような場合には、かなり便利なんじゃないかなぁと思います。</p>
<section class="footnotes footnotes-end-of-document" role="doc-endnotes">
<hr />
<ol>
<li id="fn1" role="doc-endnote"><p>ただ、この API はいつの間にか legacy 扱いされており、これからは evdev を使うようにとありますね…<a href="/entry/2018/10/14/boost-asio-posix-stream_descriptor/#fnref1" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
<li id="fn2" role="doc-endnote"><p>状態の逐次表示はイベントを取得した時に表示を更新するだけで実現できるのでこんなことをする必要はないですが、あくまで例なので…<a href="/entry/2018/10/14/boost-asio-posix-stream_descriptor/#fnref2" class="footnote-back" role="doc-backlink">↩︎</a></p></li>
</ol>
</section></div><aside class="comments"><div id="disqus_thread"></div><script>(function() { var d = document, s = d.createElement('script');s.src = 'https://tosainu.disqus.com/embed.js';s.setAttribute('data-timestamp', +new Date());(d.head || d.body).appendChild(s); })();</script><noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript" target="_blank" rel="nofollow noopener">comments powered by Disqus.</a></noscript></aside></div></article></main><footer class="site-footer"><div class="footer-widgets"><div class="container"><div class="col"><section class="about-me"><h4><svg class="svg-inline--fa fa-user fa-fw" focusable="false" aria-hidden="true" role="img" viewBox="0 0 448 512" data-icon="user" data-prefix="fas" xmlns="http://www.w3.org/2000/svg"><path d="M224 256c70.7 0 128-57.3 128-128S294.7 0 224 0S96 57.3 96 128s57.3 128 128 128zm-45.7 48C79.8 304 0 383.8 0 482.3C0 498.7 13.3 512 29.7 512H418.3c16.4 0 29.7-13.3 29.7-29.7C448 383.8 368.2 304 269.7 304H178.3z" fill="currentColor"></path></svg> About Me</h4><div class="about"><div class="avatar"><img src="/images/icon/cocoa.svg" class="icon" alt="avatar"></div><div class="info"><div class="name"><a href="https://myon.info" target="_blank" rel="nofollow noopener">Tosainu</a></div><div class="info">❤ Arch Linux, ごちうさ</div></div></div></section><section class="recent-posts"><h4><svg class="svg-inline--fa fa-file fa-fw" focusable="false" aria-hidden="true" role="img" viewBox="0 0 384 512" data-icon="file" data-prefix="fas" xmlns="http://www.w3.org/2000/svg"><path d="M0 64C0 28.7 28.7 0 64 0H224V128c0 17.7 14.3 32 32 32H384V448c0 35.3-28.7 64-64 64H64c-35.3 0-64-28.7-64-64V64zm384 64H256V0L384 128z" fill="currentColor"></path></svg> Recent Posts</h4><ul><li><a href="/entry/2022/09/19/earthly-zynqmp/">とにかく複雑な Zynq のソフトウェアを Earthly でビルドする</a></li><li><a href="/entry/2020/11/29/archlinux-arm-on-zu/">Ultra96 で Arch Linux ARM を動かす</a></li><li><a href="/entry/2020/09/01/thinkpad-x13/">ThinkPad X13 を買いました</a></li><li><a href="/entry/2020/07/05/bus-blaster/">Bus Blaster で Raspberry Pi Model B を JTAG デバッグしてみる</a></li><li><a href="/entry/2019/10/21/make-own-language-and-compiler/">Brainf**k からはじめる自作コンパイラ</a></li></ul></section></div><section class="tag-cloud"><h4><svg class="svg-inline--fa fa-tags fa-fw" focusable="false" aria-hidden="true" role="img" viewBox="0 0 512 512" data-icon="tags" data-prefix="fas" xmlns="http://www.w3.org/2000/svg"><path d="M345 39.1L472.8 168.4c52.4 53 52.4 138.2 0 191.2L360.8 472.9c-9.3 9.4-24.5 9.5-33.9 .2s-9.5-24.5-.2-33.9L438.6 325.9c33.9-34.3 33.9-89.4 0-123.7L310.9 72.9c-9.3-9.4-9.2-24.6 .2-33.9s24.6-9.2 33.9 .2zM0 229.5V80C0 53.5 21.5 32 48 32H197.5c17 0 33.3 6.7 45.3 18.7l168 168c25 25 25 65.5 0 90.5L277.3 442.7c-25 25-65.5 25-90.5 0l-168-168C6.7 262.7 0 246.5 0 229.5zM144 144c0-17.7-14.3-32-32-32s-32 14.3-32 32s14.3 32 32 32s32-14.3 32-32z" fill="currentColor"></path></svg> Tags</h4><ul class="tag-list"><li><a href="/entry/tags/android/"><span>Android</span></a></li><li><a href="/entry/tags/arch-linux/"><span>Arch Linux</span></a></li><li><a href="/entry/tags/arduino/"><span>Arduino</span></a></li><li><a href="/entry/tags/c/"><span>C++</span></a></li><li><a href="/entry/tags/ctf/"><span>CTF</span></a></li><li><a href="/entry/tags/diy-pc/"><span>DIY PC</span></a></li><li><a href="/entry/tags/docker/"><span>Docker</span></a></li><li><a href="/entry/tags/fpga/"><span>FPGA</span></a></li><li><a href="/entry/tags/game/"><span>Game</span></a></li><li><a href="/entry/tags/gochiusa/"><span>Gochiusa</span></a></li><li><a href="/entry/tags/hakyll/"><span>Hakyll</span></a></li><li><a href="/entry/tags/haskell/"><span>Haskell</span></a></li><li><a href="/entry/tags/linux/"><span>Linux</span></a></li><li><a href="/entry/tags/machine-learning/"><span>Machine learning</span></a></li><li><a href="/entry/tags/network/"><span>Network</span></a></li><li><a href="/entry/tags/raspberry-pi/"><span>Raspberry Pi</span></a></li><li><a href="/entry/tags/rust/"><span>Rust</span></a></li><li><a href="/entry/tags/slack/"><span>Slack</span></a></li><li><a href="/entry/tags/thinkpad-x13/"><span>ThinkPad X13</span></a></li><li><a href="/entry/tags/vaio-z2/"><span>VAIO Z2</span></a></li><li><a href="/entry/tags/vim/"><span>Vim</span></a></li><li><a href="/entry/tags/walkmanz/"><span>WalkmanZ</span></a></li><li><a href="/entry/tags/website/"><span>Website</span></a></li><li><a href="/entry/tags/xperia-nx/"><span>Xperia NX</span></a></li><li><a href="/entry/tags/xperia-arc/"><span>Xperia arc</span></a></li><li><a href="/entry/tags/xperia2011/"><span>Xperia2011</span></a></li><li><a href="/entry/tags/seccamp/"><span>seccamp</span></a></li></ul></section><section class="archives"><h4><svg class="svg-inline--fa fa-box-archive fa-fw" focusable="false" aria-hidden="true" role="img" viewBox="0 0 512 512" data-icon="box-archive" data-prefix="fas" xmlns="http://www.w3.org/2000/svg"><path d="M32 32H480c17.7 0 32 14.3 32 32V96c0 17.7-14.3 32-32 32H32C14.3 128 0 113.7 0 96V64C0 46.3 14.3 32 32 32zm0 128H480V416c0 35.3-28.7 64-64 64H96c-35.3 0-64-28.7-64-64V160zm128 80c0 8.8 7.2 16 16 16H336c8.8 0 16-7.2 16-16s-7.2-16-16-16H176c-8.8 0-16 7.2-16 16z" fill="currentColor"></path></svg> Archives</h4><ul class="archive-tree"><li><input class="tree-toggle" type="checkbox" id="tree-label-2022"><label class="tree-toggle-button" for="tree-label-2022"><svg class="svg-inline--fa fa-angle-right fa-fw" focusable="false" aria-hidden="true" role="img" viewBox="0 0 320 512" data-icon="angle-right" data-prefix="fas" xmlns="http://www.w3.org/2000/svg"><path d="M278.6 233.4c12.5 12.5 12.5 32.8 0 45.3l-160 160c-12.5 12.5-32.8 12.5-45.3 0s-12.5-32.8 0-45.3L210.7 256 73.4 118.6c-12.5-12.5-12.5-32.8 0-45.3s32.8-12.5 45.3 0l160 160z" fill="currentColor"></path></svg><svg class="svg-inline--fa fa-angle-down fa-fw" focusable="false" aria-hidden="true" role="img" viewBox="0 0 448 512" data-icon="angle-down" data-prefix="fas" xmlns="http://www.w3.org/2000/svg"><path d="M201.4 374.6c12.5 12.5 32.8 12.5 45.3 0l160-160c12.5-12.5 12.5-32.8 0-45.3s-32.8-12.5-45.3 0L224 306.7 86.6 169.4c-12.5-12.5-32.8-12.5-45.3 0s-12.5 32.8 0 45.3l160 160z" fill="currentColor"></path></svg><a href="/entry/2022/">2022 (1)</a></label><ul class="tree-child"><li><a href="/entry/2022/09/">2022/09 (1)</a></li></ul></li><li><input class="tree-toggle" type="checkbox" id="tree-label-2020"><label class="tree-toggle-button" for="tree-label-2020"><svg class="svg-inline--fa fa-angle-right fa-fw" focusable="false" aria-hidden="true" role="img" viewBox="0 0 320 512" data-icon="angle-right" data-prefix="fas" xmlns="http://www.w3.org/2000/svg"><path d="M278.6 233.4c12.5 12.5 12.5 32.8 0 45.3l-160 160c-12.5 12.5-32.8 12.5-45.3 0s-12.5-32.8 0-45.3L210.7 256 73.4 118.6c-12.5-12.5-12.5-32.8 0-45.3s32.8-12.5 45.3 0l160 160z" fill="currentColor"></path></svg><svg class="svg-inline--fa fa-angle-down fa-fw" focusable="false" aria-hidden="true" role="img" viewBox="0 0 448 512" data-icon="angle-down" data-prefix="fas" xmlns="http://www.w3.org/2000/svg"><path d="M201.4 374.6c12.5 12.5 32.8 12.5 45.3 0l160-160c12.5-12.5 12.5-32.8 0-45.3s-32.8-12.5-45.3 0L224 306.7 86.6 169.4c-12.5-12.5-32.8-12.5-45.3 0s-12.5 32.8 0 45.3l160 160z" fill="currentColor"></path></svg><a href="/entry/2020/">2020 (3)</a></label><ul class="tree-child"><li><a href="/entry/2020/11/">2020/11 (1)</a></li><li><a href="/entry/2020/09/">2020/09 (1)</a></li><li><a href="/entry/2020/07/">2020/07 (1)</a></li></ul></li><li><input class="tree-toggle" type="checkbox" id="tree-label-2019"><label class="tree-toggle-button" for="tree-label-2019"><svg class="svg-inline--fa fa-angle-right fa-fw" focusable="false" aria-hidden="true" role="img" viewBox="0 0 320 512" data-icon="angle-right" data-prefix="fas" xmlns="http://www.w3.org/2000/svg"><path d="M278.6 233.4c12.5 12.5 12.5 32.8 0 45.3l-160 160c-12.5 12.5-32.8 12.5-45.3 0s-12.5-32.8 0-45.3L210.7 256 73.4 118.6c-12.5-12.5-12.5-32.8 0-45.3s32.8-12.5 45.3 0l160 160z" fill="currentColor"></path></svg><svg class="svg-inline--fa fa-angle-down fa-fw" focusable="false" aria-hidden="true" role="img" viewBox="0 0 448 512" data-icon="angle-down" data-prefix="fas" xmlns="http://www.w3.org/2000/svg"><path d="M201.4 374.6c12.5 12.5 32.8 12.5 45.3 0l160-160c12.5-12.5 12.5-32.8 0-45.3s-32.8-12.5-45.3 0L224 306.7 86.6 169.4c-12.5-12.5-32.8-12.5-45.3 0s-12.5 32.8 0 45.3l160 160z" fill="currentColor"></path></svg><a href="/entry/2019/">2019 (4)</a></label><ul class="tree-child"><li><a href="/entry/2019/10/">2019/10 (1)</a></li><li><a href="/entry/2019/08/">2019/08 (2)</a></li><li><a href="/entry/2019/05/">2019/05 (1)</a></li></ul></li><li><input class="tree-toggle" type="checkbox" id="tree-label-2018" checked><label class="tree-toggle-button" for="tree-label-2018"><svg class="svg-inline--fa fa-angle-right fa-fw" focusable="false" aria-hidden="true" role="img" viewBox="0 0 320 512" data-icon="angle-right" data-prefix="fas" xmlns="http://www.w3.org/2000/svg"><path d="M278.6 233.4c12.5 12.5 12.5 32.8 0 45.3l-160 160c-12.5 12.5-32.8 12.5-45.3 0s-12.5-32.8 0-45.3L210.7 256 73.4 118.6c-12.5-12.5-12.5-32.8 0-45.3s32.8-12.5 45.3 0l160 160z" fill="currentColor"></path></svg><svg class="svg-inline--fa fa-angle-down fa-fw" focusable="false" aria-hidden="true" role="img" viewBox="0 0 448 512" data-icon="angle-down" data-prefix="fas" xmlns="http://www.w3.org/2000/svg"><path d="M201.4 374.6c12.5 12.5 32.8 12.5 45.3 0l160-160c12.5-12.5 12.5-32.8 0-45.3s-32.8-12.5-45.3 0L224 306.7 86.6 169.4c-12.5-12.5-32.8-12.5-45.3 0s-12.5 32.8 0 45.3l160 160z" fill="currentColor"></path></svg><a href="/entry/2018/">2018 (5)</a></label><ul class="tree-child"><li><a href="/entry/2018/10/">2018/10 (1)</a></li><li><a href="/entry/2018/09/">2018/09 (1)</a></li><li><a href="/entry/2018/08/">2018/08 (1)</a></li><li><a href="/entry/2018/03/">2018/03 (1)</a></li><li><a href="/entry/2018/01/">2018/01 (1)</a></li></ul></li><li><input class="tree-toggle" type="checkbox" id="tree-label-2017"><label class="tree-toggle-button" for="tree-label-2017"><svg class="svg-inline--fa fa-angle-right fa-fw" focusable="false" aria-hidden="true" role="img" viewBox="0 0 320 512" data-icon="angle-right" data-prefix="fas" xmlns="http://www.w3.org/2000/svg"><path d="M278.6 233.4c12.5 12.5 12.5 32.8 0 45.3l-160 160c-12.5 12.5-32.8 12.5-45.3 0s-12.5-32.8 0-45.3L210.7 256 73.4 118.6c-12.5-12.5-12.5-32.8 0-45.3s32.8-12.5 45.3 0l160 160z" fill="currentColor"></path></svg><svg class="svg-inline--fa fa-angle-down fa-fw" focusable="false" aria-hidden="true" role="img" viewBox="0 0 448 512" data-icon="angle-down" data-prefix="fas" xmlns="http://www.w3.org/2000/svg"><path d="M201.4 374.6c12.5 12.5 32.8 12.5 45.3 0l160-160c12.5-12.5 12.5-32.8 0-45.3s-32.8-12.5-45.3 0L224 306.7 86.6 169.4c-12.5-12.5-32.8-12.5-45.3 0s-12.5 32.8 0 45.3l160 160z" fill="currentColor"></path></svg><a href="/entry/2017/">2017 (5)</a></label><ul class="tree-child"><li><a href="/entry/2017/09/">2017/09 (1)</a></li><li><a href="/entry/2017/05/">2017/05 (1)</a></li><li><a href="/entry/2017/02/">2017/02 (3)</a></li></ul></li><li><input class="tree-toggle" type="checkbox" id="tree-label-2016"><label class="tree-toggle-button" for="tree-label-2016"><svg class="svg-inline--fa fa-angle-right fa-fw" focusable="false" aria-hidden="true" role="img" viewBox="0 0 320 512" data-icon="angle-right" data-prefix="fas" xmlns="http://www.w3.org/2000/svg"><path d="M278.6 233.4c12.5 12.5 12.5 32.8 0 45.3l-160 160c-12.5 12.5-32.8 12.5-45.3 0s-12.5-32.8 0-45.3L210.7 256 73.4 118.6c-12.5-12.5-12.5-32.8 0-45.3s32.8-12.5 45.3 0l160 160z" fill="currentColor"></path></svg><svg class="svg-inline--fa fa-angle-down fa-fw" focusable="false" aria-hidden="true" role="img" viewBox="0 0 448 512" data-icon="angle-down" data-prefix="fas" xmlns="http://www.w3.org/2000/svg"><path d="M201.4 374.6c12.5 12.5 32.8 12.5 45.3 0l160-160c12.5-12.5 12.5-32.8 0-45.3s-32.8-12.5-45.3 0L224 306.7 86.6 169.4c-12.5-12.5-32.8-12.5-45.3 0s-12.5 32.8 0 45.3l160 160z" fill="currentColor"></path></svg><a href="/entry/2016/">2016 (8)</a></label><ul class="tree-child"><li><a href="/entry/2016/08/">2016/08 (2)</a></li><li><a href="/entry/2016/07/">2016/07 (1)</a></li><li><a href="/entry/2016/06/">2016/06 (1)</a></li><li><a href="/entry/2016/05/">2016/05 (1)</a></li><li><a href="/entry/2016/03/">2016/03 (1)</a></li><li><a href="/entry/2016/01/">2016/01 (2)</a></li></ul></li><li><input class="tree-toggle" type="checkbox" id="tree-label-2015"><label class="tree-toggle-button" for="tree-label-2015"><svg class="svg-inline--fa fa-angle-right fa-fw" focusable="false" aria-hidden="true" role="img" viewBox="0 0 320 512" data-icon="angle-right" data-prefix="fas" xmlns="http://www.w3.org/2000/svg"><path d="M278.6 233.4c12.5 12.5 12.5 32.8 0 45.3l-160 160c-12.5 12.5-32.8 12.5-45.3 0s-12.5-32.8 0-45.3L210.7 256 73.4 118.6c-12.5-12.5-12.5-32.8 0-45.3s32.8-12.5 45.3 0l160 160z" fill="currentColor"></path></svg><svg class="svg-inline--fa fa-angle-down fa-fw" focusable="false" aria-hidden="true" role="img" viewBox="0 0 448 512" data-icon="angle-down" data-prefix="fas" xmlns="http://www.w3.org/2000/svg"><path d="M201.4 374.6c12.5 12.5 32.8 12.5 45.3 0l160-160c12.5-12.5 12.5-32.8 0-45.3s-32.8-12.5-45.3 0L224 306.7 86.6 169.4c-12.5-12.5-32.8-12.5-45.3 0s-12.5 32.8 0 45.3l160 160z" fill="currentColor"></path></svg><a href="/entry/2015/">2015 (12)</a></label><ul class="tree-child"><li><a href="/entry/2015/12/">2015/12 (1)</a></li><li><a href="/entry/2015/08/">2015/08 (1)</a></li><li><a href="/entry/2015/06/">2015/06 (2)</a></li><li><a href="/entry/2015/05/">2015/05 (2)</a></li><li><a href="/entry/2015/04/">2015/04 (1)</a></li><li><a href="/entry/2015/03/">2015/03 (2)</a></li><li><a href="/entry/2015/02/">2015/02 (1)</a></li><li><a href="/entry/2015/01/">2015/01 (2)</a></li></ul></li><li><input class="tree-toggle" type="checkbox" id="tree-label-2014"><label class="tree-toggle-button" for="tree-label-2014"><svg class="svg-inline--fa fa-angle-right fa-fw" focusable="false" aria-hidden="true" role="img" viewBox="0 0 320 512" data-icon="angle-right" data-prefix="fas" xmlns="http://www.w3.org/2000/svg"><path d="M278.6 233.4c12.5 12.5 12.5 32.8 0 45.3l-160 160c-12.5 12.5-32.8 12.5-45.3 0s-12.5-32.8 0-45.3L210.7 256 73.4 118.6c-12.5-12.5-12.5-32.8 0-45.3s32.8-12.5 45.3 0l160 160z" fill="currentColor"></path></svg><svg class="svg-inline--fa fa-angle-down fa-fw" focusable="false" aria-hidden="true" role="img" viewBox="0 0 448 512" data-icon="angle-down" data-prefix="fas" xmlns="http://www.w3.org/2000/svg"><path d="M201.4 374.6c12.5 12.5 32.8 12.5 45.3 0l160-160c12.5-12.5 12.5-32.8 0-45.3s-32.8-12.5-45.3 0L224 306.7 86.6 169.4c-12.5-12.5-32.8-12.5-45.3 0s-12.5 32.8 0 45.3l160 160z" fill="currentColor"></path></svg><a href="/entry/2014/">2014 (62)</a></label><ul class="tree-child"><li><a href="/entry/2014/12/">2014/12 (7)</a></li><li><a href="/entry/2014/11/">2014/11 (4)</a></li><li><a href="/entry/2014/10/">2014/10 (3)</a></li><li><a href="/entry/2014/09/">2014/09 (3)</a></li><li><a href="/entry/2014/08/">2014/08 (5)</a></li><li><a href="/entry/2014/07/">2014/07 (6)</a></li><li><a href="/entry/2014/06/">2014/06 (6)</a></li><li><a href="/entry/2014/05/">2014/05 (4)</a></li><li><a href="/entry/2014/04/">2014/04 (6)</a></li><li><a href="/entry/2014/03/">2014/03 (7)</a></li><li><a href="/entry/2014/02/">2014/02 (5)</a></li><li><a href="/entry/2014/01/">2014/01 (6)</a></li></ul></li><li><input class="tree-toggle" type="checkbox" id="tree-label-2013"><label class="tree-toggle-button" for="tree-label-2013"><svg class="svg-inline--fa fa-angle-right fa-fw" focusable="false" aria-hidden="true" role="img" viewBox="0 0 320 512" data-icon="angle-right" data-prefix="fas" xmlns="http://www.w3.org/2000/svg"><path d="M278.6 233.4c12.5 12.5 12.5 32.8 0 45.3l-160 160c-12.5 12.5-32.8 12.5-45.3 0s-12.5-32.8 0-45.3L210.7 256 73.4 118.6c-12.5-12.5-12.5-32.8 0-45.3s32.8-12.5 45.3 0l160 160z" fill="currentColor"></path></svg><svg class="svg-inline--fa fa-angle-down fa-fw" focusable="false" aria-hidden="true" role="img" viewBox="0 0 448 512" data-icon="angle-down" data-prefix="fas" xmlns="http://www.w3.org/2000/svg"><path d="M201.4 374.6c12.5 12.5 32.8 12.5 45.3 0l160-160c12.5-12.5 12.5-32.8 0-45.3s-32.8-12.5-45.3 0L224 306.7 86.6 169.4c-12.5-12.5-32.8-12.5-45.3 0s-12.5 32.8 0 45.3l160 160z" fill="currentColor"></path></svg><a href="/entry/2013/">2013 (116)</a></label><ul class="tree-child"><li><a href="/entry/2013/12/">2013/12 (8)</a></li><li><a href="/entry/2013/11/">2013/11 (6)</a></li><li><a href="/entry/2013/10/">2013/10 (5)</a></li><li><a href="/entry/2013/09/">2013/09 (5)</a></li><li><a href="/entry/2013/08/">2013/08 (4)</a></li><li><a href="/entry/2013/07/">2013/07 (3)</a></li><li><a href="/entry/2013/06/">2013/06 (12)</a></li><li><a href="/entry/2013/05/">2013/05 (16)</a></li><li><a href="/entry/2013/04/">2013/04 (16)</a></li><li><a href="/entry/2013/03/">2013/03 (27)</a></li><li><a href="/entry/2013/02/">2013/02 (7)</a></li><li><a href="/entry/2013/01/">2013/01 (7)</a></li></ul></li><li><input class="tree-toggle" type="checkbox" id="tree-label-2012"><label class="tree-toggle-button" for="tree-label-2012"><svg class="svg-inline--fa fa-angle-right fa-fw" focusable="false" aria-hidden="true" role="img" viewBox="0 0 320 512" data-icon="angle-right" data-prefix="fas" xmlns="http://www.w3.org/2000/svg"><path d="M278.6 233.4c12.5 12.5 12.5 32.8 0 45.3l-160 160c-12.5 12.5-32.8 12.5-45.3 0s-12.5-32.8 0-45.3L210.7 256 73.4 118.6c-12.5-12.5-12.5-32.8 0-45.3s32.8-12.5 45.3 0l160 160z" fill="currentColor"></path></svg><svg class="svg-inline--fa fa-angle-down fa-fw" focusable="false" aria-hidden="true" role="img" viewBox="0 0 448 512" data-icon="angle-down" data-prefix="fas" xmlns="http://www.w3.org/2000/svg"><path d="M201.4 374.6c12.5 12.5 32.8 12.5 45.3 0l160-160c12.5-12.5 12.5-32.8 0-45.3s-32.8-12.5-45.3 0L224 306.7 86.6 169.4c-12.5-12.5-32.8-12.5-45.3 0s-12.5 32.8 0 45.3l160 160z" fill="currentColor"></path></svg><a href="/entry/2012/">2012 (11)</a></label><ul class="tree-child"><li><a href="/entry/2012/12/">2012/12 (3)</a></li><li><a href="/entry/2012/09/">2012/09 (1)</a></li><li><a href="/entry/2012/07/">2012/07 (4)</a></li><li><a href="/entry/2012/04/">2012/04 (1)</a></li><li><a href="/entry/2012/03/">2012/03 (1)</a></li><li><a href="/entry/2012/01/">2012/01 (1)</a></li></ul></li><li><input class="tree-toggle" type="checkbox" id="tree-label-2011"><label class="tree-toggle-button" for="tree-label-2011"><svg class="svg-inline--fa fa-angle-right fa-fw" focusable="false" aria-hidden="true" role="img" viewBox="0 0 320 512" data-icon="angle-right" data-prefix="fas" xmlns="http://www.w3.org/2000/svg"><path d="M278.6 233.4c12.5 12.5 12.5 32.8 0 45.3l-160 160c-12.5 12.5-32.8 12.5-45.3 0s-12.5-32.8 0-45.3L210.7 256 73.4 118.6c-12.5-12.5-12.5-32.8 0-45.3s32.8-12.5 45.3 0l160 160z" fill="currentColor"></path></svg><svg class="svg-inline--fa fa-angle-down fa-fw" focusable="false" aria-hidden="true" role="img" viewBox="0 0 448 512" data-icon="angle-down" data-prefix="fas" xmlns="http://www.w3.org/2000/svg"><path d="M201.4 374.6c12.5 12.5 32.8 12.5 45.3 0l160-160c12.5-12.5 12.5-32.8 0-45.3s-32.8-12.5-45.3 0L224 306.7 86.6 169.4c-12.5-12.5-32.8-12.5-45.3 0s-12.5 32.8 0 45.3l160 160z" fill="currentColor"></path></svg><a href="/entry/2011/">2011 (12)</a></label><ul class="tree-child"><li><a href="/entry/2011/09/">2011/09 (1)</a></li><li><a href="/entry/2011/06/">2011/06 (1)</a></li><li><a href="/entry/2011/05/">2011/05 (1)</a></li><li><a href="/entry/2011/03/">2011/03 (6)</a></li><li><a href="/entry/2011/02/">2011/02 (1)</a></li><li><a href="/entry/2011/01/">2011/01 (2)</a></li></ul></li></ul></section></div></div><div class="footer-bottom"><div class="container"><div class="copyright">© 2011-2022 Tosainu. Site generated by <a href="https://jaspervdj.be/hakyll/" target="_blank" rel="nofollow noopener">Hakyll</a>.</div></div></div></footer></body></html>
